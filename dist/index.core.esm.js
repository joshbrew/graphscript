function C(f=""){let t=n=>n.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),r=(n=>{let a=n.indexOf("=>")+1;return a<=0&&(a=n.indexOf("){")),a<=0&&(a=n.indexOf(") {")),n.slice(0,n.indexOf("{",a)+1)})(f),s=t(f),i;if(r.includes("function")){let n=r.split("(")[1].split(")")[0];i=new Function(n,s)}else if(r.substring(0,6)===s.substring(0,6)){let n=r.split("(")[1].split(")")[0];i=new Function(n,s.substring(s.indexOf("{")+1,s.length-1))}else try{i=(0,eval)(r+s+"}")}catch{}return i}var O=class{constructor(t){this.pushToState={};this.data={};this.triggers={};this.setState=t=>{Object.assign(this.data,t);for(let e of Object.getOwnPropertyNames(t))this.triggers[e]&&this.triggers[e].forEach(r=>r.onchange(this.data[e]));return this.data};this.subscribeTrigger=(t,e)=>{if(t){this.triggers[t]||(this.triggers[t]=[]);let r=this.triggers[t].length;return this.triggers[t].push({idx:r,onchange:e}),this.triggers[t].length-1}else return};this.unsubscribeTrigger=(t,e)=>{let r=this.triggers[t];if(r)if(!e)delete this.triggers[t];else{let s;return r.find((n,a)=>{if(n.idx===e)return s=a,!0})&&r.splice(s,1),!0}};this.subscribeTriggerOnce=(t,e)=>{let r,s=i=>{e(i),this.unsubscribeTrigger(t,r)};r=this.subscribeTrigger(t,s)};typeof t=="object"&&(this.data=t)}},_=new O;function A(f){if(f||(f=this._initial),!!f){this._state||(this._state={},this._events=new O(this._state));for(let t in f)t==="_state"||t==="graph"||(this._state[t]=f[t],t in this?this[t]=f[t]:Object.defineProperty(this,t,{get:()=>{this._state[t]},set:e=>{this.state.triggers[this._unique]&&this.setState({[this._unique]:this}),this._events.setState({[t]:e})},enumerable:!0,configurable:!0}))}}var y=class{constructor(t={},e,r){this.nodes=new Map;this._initial={};this._unique=`${Math.random()}`;this.state=_;this.isLooping=!1;this.isAnimating=!1;this.looper=void 0;this.animation=void 0;this.forward=!0;this.backward=!1;this.reactive=!1;this.runSync=!1;this.firstRun=!0;this.DEBUGNODE=!1;this.addLocalState=A;this.operator=(...t)=>t;this.runOp=(...t)=>{this.DEBUGNODE&&console.time(this.tag);let e=this.operator(...t);return e instanceof Promise?e.then(r=>(r!==void 0&&this.setState({[this.tag]:r}),this.DEBUGNODE&&(console.timeEnd(this.tag),e!==void 0&&console.log(`${this.tag} result:`,e)),r)):(e!==void 0&&this.setState({[this.tag]:e}),this.DEBUGNODE&&(console.timeEnd(this.tag),e!==void 0&&console.log(`${this.tag} result:`,e))),e};this.setOperator=t=>(typeof t=="string"&&(this.graph&&this.graph.get(t)?t=this.graph.get(t).operator:this.nodes.get(t)&&(t=this.nodes.get(t))),typeof t!="function"||(this.operator=t.bind(this)),t);this.runAsync=(...t)=>new Promise((e,r)=>{e(this.run(...t))});this.transformArgs=(t=[])=>t;this.isRunSync=()=>!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||this.branch);this.run=(...t)=>{if(typeof this.transformArgs=="function"&&(t=this.transformArgs(t,this)),!(this.firstRun&&(this.firstRun=!1,this.runSync=this.isRunSync(),this.animate&&!this.isAnimating&&this.runAnimation(this.animation,t),this.loop&&typeof this.loop=="number"&&!this.isLooping&&this.runLoop(this.looper,t),this.loop||this.animate)))return this.runSync?this.runOp(...t):new Promise(async e=>{if(this){let r=(i,n=0,...a)=>new Promise(async o=>{n++;let c=await i.runOp(...a);if(i.repeat){for(;n<i.repeat;){if(i.delay){setTimeout(async()=>{o(await r(i,n,...a))},i.delay);break}else if(i.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{o(await r(i,n,...a))});break}else c=await i.runOp(...a);n++}if(n===i.repeat){o(c);return}}else if(i.recursive){for(;n<i.recursive;){if(i.delay){setTimeout(async()=>{o(await r(i,n,...c))},i.delay);break}else if(i.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{o(await r(i,n,...c))});break}else c=await i.runOp(...c);n++}if(n===i.recursive){o(c);return}}else{o(c);return}}),s=async()=>{let i=await r(this,void 0,...t);return i!==void 0&&(this.backward&&this.parent instanceof y&&(Array.isArray(i)?await this.runParent(this,...i):await this.runParent(this,i)),this.children&&this.forward&&(Array.isArray(i)?await this.runChildren(this,...i):await this.runChildren(this,i)),this.branch&&this.runBranch(this,i)),i};this.delay?setTimeout(async()=>{e(await s())},this.delay):this.frame&&window?.requestAnimationFrame?requestAnimationFrame(async()=>{e(await s())}):e(await s())}else e(void 0)})};this.runParent=async(t,...e)=>{t.backward&&t.parent&&(typeof t.parent=="string"&&(t.graph&&t.graph?.get(t.parent)?(t.parent=t.graph,t.parent&&this.nodes.set(t.parent.tag,t.parent)):t.parent=this.nodes.get(t.parent)),t.parent instanceof y&&await t.parent.run(...e))};this.runChildren=async(t,...e)=>{if(typeof t.children=="object")for(let r in t.children)typeof t.children[r]=="string"?(t.graph&&t.graph?.get(t.children[r])&&(t.children[r]=t.graph.get(t.children[r]),t.nodes.get(t.children[r].tag)||t.nodes.set(t.children[r].tag,t.children[r])),!t.children[r]&&t.nodes.get(t.children[r])&&(t.children[r]=t.nodes.get(t.children[r]))):(typeof t.children[r]>"u"||t.children[r]===!0)&&(t.graph&&t.graph?.get(r)&&(t.children[r]=t.graph.get(r),t.nodes.get(t.children[r].tag)||t.nodes.set(t.children[r].tag,t.children[r])),!t.children[r]&&t.nodes.get(r)&&(t.children[r]=t.nodes.get(r))),t.children[r]?.runOp&&await t.children[r].run(...e)};this.runBranch=async(t,e)=>{if(t.branch){let r=Object.keys(t.branch);await Promise.all(r.map(async s=>{typeof t.branch[s].if=="object"&&(t.branch[s].if=S(t.branch[s].if));let i=!1;return typeof t.branch[s].if=="function"?i=t.branch[s].if(e):typeof e=="object"?S(e)===t.branch[s].if&&(i=!0):e===t.branch[s].if&&(i=!0),i&&(t.branch[s].then.run?Array.isArray(e)?await t.branch[s].then.run(...e):await t.branch[s].then.run(...e):typeof t.branch[s].then=="function"?Array.isArray(e)?await t.branch[s].then(...e):await t.branch[s].then(e):typeof t.branch[s].then=="string"&&(t.graph?t.branch[s].then=t.graph.nodes.get(t.branch[s].then):t.branch[s].then=t.nodes.get(t.branch[s].then),t.branch[s].then.run&&(Array.isArray(e)?await t.branch[s].then.run(...e):await t.branch[s].then.run(...e)))),i}))}};this.runAnimation=(t=this.animation,e=[])=>{if(this.animation=t,t||(this.animation=this.operator),this.animate&&!this.isAnimating&&"requestAnimationFrame"in window){this.isAnimating=!0;let r=async()=>{if(this.isAnimating){this.DEBUGNODE&&console.time(this.tag);let s=this.animation.call(this,...e);s instanceof Promise&&(s=await s),this.DEBUGNODE&&(console.timeEnd(this.tag),s!==void 0&&console.log(`${this.tag} result:`,s)),s!==void 0&&(this.tag&&this.setState({[this.tag]:s}),this.backward&&this.parent?.run&&(Array.isArray(s)?await this.runParent(this,...s):await this.runParent(this,s)),this.children&&this.forward&&(Array.isArray(s)?await this.runChildren(this,...s):await this.runChildren(this,s)),this.branch&&this.runBranch(this,s),this.setState({[this.tag]:s})),requestAnimationFrame(r)}};requestAnimationFrame(r)}};this.runLoop=(t=this.looper,e=[],r=this.loop)=>{if(this.looper=t,t||(this.looper=this.operator),typeof r=="number"&&!this.isLooping){this.isLooping=!0;let s=async()=>{if(this.isLooping){this.DEBUGNODE&&console.time(this.tag);let i=this.looper.call(this,...e);i instanceof Promise&&(i=await i),this.DEBUGNODE&&(console.timeEnd(this.tag),i!==void 0&&console.log(`${this.tag} result:`,i)),i!==void 0&&(this.tag&&this.setState({[this.tag]:i}),this.backward&&this.parent?.run&&(Array.isArray(i)?await this.runParent(this,...i):await this.runParent(this,i)),this.children&&this.forward&&(Array.isArray(i)?await this.runChildren(this,...i):await this.runChildren(this,i)),this.branch&&this.runBranch(this,i),this.setState({[this.tag]:i})),setTimeout(async()=>{await s()},r)}};s()}};this.setParent=t=>{this.parent=t,this.backward&&(this.runSync=!1)};this.setChildren=t=>{this.children=t,this.forward&&(this.runSync=!1)};this.add=(t={})=>(typeof t=="function"&&(t={operator:t}),t?.node instanceof y&&(t=t.node),t instanceof y||(t=new y(t.node??t,this,this.graph)),this.nodes.set(t.tag,t),this.graph&&(this.graph.nodes.set(t.tag,t),this.graph.nNodes=this.graph.nodes.size),t);this.append=(t,e=this)=>{typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes&&(e.addChildren(t),t.forward&&(t.runSync=!1))};this.subscribe=(t,e=this.tag)=>{if(typeof t=="string"&&(this.graph?t=this.graph.get(t):t=this.nodes.get(t)),typeof t=="function")return this.state.subscribeTrigger(e,t);if(t)return this.state.subscribeTrigger(e,r=>{t.run(r)})};this.unsubscribe=(t,e=this.tag)=>this.state.unsubscribeTrigger(e,t);this.subscribeState=t=>{if(this.reactive){if(typeof t=="string"&&(this.graph?t=this.graph.get(t):t=this.nodes.get(t)),typeof t=="function")return this.state.subscribeTrigger(this._unique,t);if(t)return this.state.subscribeTrigger(this._unique,e=>{t.run(e)})}else return};this.addChildren=t=>{this.children||(this.children={}),typeof t=="object"&&Object.assign(this.children,t),this.convertChildrenToNodes(),this.forward&&(this.runSync=!1)};this.callParent=(...t)=>{if(typeof this.parent=="string"&&(this.graph&&this.graph?.get(this.parent)?(this.parent=this.graph,this.parent&&this.nodes.set(this.parent.tag,this.parent)):this.parent=this.nodes.get(this.parent)),typeof this.parent?.operator=="function")return this.parent.runOp(...t)};this.callChildren=(...t)=>{let e;if(typeof this.children=="object")for(let r in this.children)this.children[r]?.runOp&&this.children[r].runOp(...t);return e};this.getProps=(t=this,e=!0)=>{let r={tag:t.tag,operator:t.operator,graph:t.graph,children:t.children,parent:t.parent,forward:t.forward,backward:t.bacward,loop:t.loop,animate:t.animate,frame:t.frame,delay:t.delay,recursive:t.recursive,repeat:t.repeat,branch:t.branch,oncreate:t.oncreate,reactive:t.reactive,DEBUGNODE:t.DEBUGNODE};if(e)return Object.assign(r,this._initial);{let s={};for(let i in this._initial)s[i]=this[i];return Object.assign(r,s)}};this.setProps=(t={})=>{let e=Object.assign({},t);e.children&&(this.addChildren(t.children),delete e.children),e.operator&&(this.setOperator(t.operator),delete e.operator),Object.assign(e,t),this.runSync=this.isRunSync()};this.remove=t=>{typeof t=="string"&&(t=this.nodes.get(t)),t instanceof y&&(this.nodes.delete(t.tag),this.children[t.tag]&&delete this.children[t.tag],t.graph&&(t.graph.nodes.delete(t.tag),t.graph.nNodes=t.graph.nodes.size),this.nodes.forEach(e=>{e.nodes.get(t.tag)&&(e.nodes.delete(t.tag),e.children[t.tag]&&delete e.children[t.tag],e.parent?.tag===t.tag&&delete e.parent)}),t.cleanup())};this.cleanup=()=>{if(this.stopNode(),typeof this._state=="object"&&this.state.unsubscribeTrigger(this._unique),typeof this.reactive=="object"){for(let t in this.reactive)if(typeof this.reactive[t]=="function")if(t.includes(".")){let e=t.split(".");if(e[0]==="self"&&this._events)this._events.unsubscribeTrigger(t,this.reactive[t]);else if(e[0]==="parent"&&this.parent?._events)this.parent._events.unsubscribeTrigger(t,this.reactive[t]);else if(e[0]==="children"){let r=this.reactive[t];for(let s in this.children)this.children[s]?._events&&this.children[s]._events.unsubscribeTrigger(t,r[s])}else this.nodes.get(e[0])?._events&&this.nodes.get(t)._events.unsubscribeTrigger(t,this.reactive[t])}else if(t==="self")this.reactive[t]=this.state.unsubscribeTrigger(this._unique,this.reactive[t]);else if(t==="parent"&&this.parent?.state)this.reactive[t]=this.parent.state.unsubscribeTrigger(this.parent._unique,this.reactive[t]);else if(t==="children"&&this.children){let e=this.reactive[t];for(let r in this.children)this.children[r]?.state&&this.children[r].state.unsubscribeTrigger(this.children[r]._unique,e[r])}else this.nodes.get(t)?.state&&this.nodes.get(t).state.unsubscribeTrigger(this.nodes.get(t)._unique,this.reactive[t])}this.ondelete&&this.ondelete(this)};this.removeTree=t=>{if(typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes){let e={},r=s=>{if(typeof s.children=="object"&&!e[s.tag]){e[s.tag]=!0;for(let i in s.children)this.remove(s.children[i]),r(s.children[i])}};t.tag&&(this.remove(t),r(t))}};this.checkNodesHaveChildMapped=(t,e,r={})=>{let s=t.tag;s||(s=t.name),r[s]||(r[s]=!0,t.children&&e.tag in t.children&&t.children[e.tag]instanceof y&&(t.nodes.get(e.tag)||t.nodes.set(e.tag,e),t.children[e.tag]=e,t.firstRun||(t.firstRun=!0)),t.parent instanceof y&&(t.nodes.get(e.tag)&&t.parent.nodes.set(e.tag,e),t.parent.children?this.checkNodesHaveChildMapped(t.parent,e,r):t.nodes&&t.nodes.forEach(i=>{r[i.tag]||this.checkNodesHaveChildMapped(i,e,r)})),t.graph&&t.parent&&t.parent.name!==t.graph.name&&t.graph.nodes.forEach(i=>{r[i.tag]||this.checkNodesHaveChildMapped(i,e,r)}))};this.convertChildrenToNodes=(t=this)=>{if(t?.children){for(let e in t.children)if(!(t.children[e]instanceof y))if(typeof t.children[e]=="object")t.children[e].tag||(t.children[e].tag=e),t.nodes.get(t.children[e].tag)||(t.children[e]=new y(t.children[e],t,t.graph),this.checkNodesHaveChildMapped(t,t.children[e]));else{if(typeof t.children[e]>"u"||t.children[e]==!0)t.children[e]=t.graph.get(e),t.children[e]||(t.children[e]=t.nodes.get(e));else if(typeof t.children[e]=="string"){let r=t.children[e];t.children[e]=t.graph.get(r),t.children[e]||(t.children[e]=t.nodes.get(e))}t.children[e]instanceof y&&(t.nodes.set(t.children[e].tag,t.children[e]),this.checkNodesHaveChildMapped(t,t.children[e]),t.children[e].tag in t||(t[t.children[e].tag]=t.children[e]))}}return t.children};this.stopLooping=(t=this)=>{t.isLooping=!1};this.stopAnimating=(t=this)=>{t.isAnimating=!1};this.stopNode=(t=this)=>{t.stopAnimating(t),t.stopLooping(t)};this.subscribeNode=t=>{if(typeof t=="string"&&(t=this.nodes.get(t)),t.tag&&this.nodes.set(t.tag,t),t)return this.state.subscribeTrigger(this.tag,e=>{Array.isArray(e)?t.run(...e):t.run(e)})};this.print=(t=this,e=!0,r=[])=>{let s=new y;if(typeof t=="string"&&(t=this.nodes.get(t)),t instanceof y){r.push(t.tag);let i={tag:t.tag,operator:t.operator.toString()};if(t.parent&&(i.parent=t.parent.tag),typeof t.children=="object")for(let n in t.children)return typeof t.children[n]=="string"?t.children[n]:r.includes(t.children[n].tag)?t.children[n].tag:e?t.children[n].print(t.children[n],e,r):t.children[n].tag;for(let n in t)n==="parent"||n==="children"||typeof s[n]>"u"&&(typeof t[n]=="function"?i[n]=t[n].toString():typeof t[n]=="object"?i[n]=JSON.stringifyWithCircularRefs(t[n]):i[n]=t[n]);return JSON.stringify(i)}};this.reconstruct=t=>{let e=j(t);if(e)return this.add(e)};this.setState=t=>{this.state.setState(t)};this.DEBUGNODES=(t=!0)=>{this.DEBUGNODE=t,this.nodes.forEach(e=>{t?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};if(typeof t=="function")t={operator:t},t.operator.name&&(t.tag=t.operator.name);else if(typeof t.operator=="string"&&r){let s=r.get(t.operator);s&&(t.operator=s.operator),!t.tag&&t.operator.name&&(t.tag=t.operator.name)}if(typeof t=="object"){if(t instanceof y&&t._initial&&Object.assign(t,t._initial),t instanceof N){let i=t;t={source:i,operator:n=>{if(typeof n=="object"){let a={};for(let o in n)typeof i[o]=="function"?Array.isArray(n[o])?a[o]=i[o](...n[o]):a[o]=i[o](n[o]):(i[o]=n[o],a[o]=i[o]);return a}return i}},i.operator&&(t.operator=i.operator),i.children&&(t.children=i.children),i.forward&&(t.forward=i.forward),i.backward&&(t.backward=i.backward),i.repeat&&(t.repeat=i.repeat),i.recursive&&(t.recursive=i.recursive),i.loop&&(t.loop=i.loop),i.animate&&(t.animate=i.animate),i.looper&&(t.looper=i.looper),i.animation&&(t.animation=i.animation),i.delay&&(t.delay=i.delay),i.oncreate&&(t.oncreate=i.oncreate),i.node&&i.node._initial&&Object.assign(t,i.node._initial),i._initial&&Object.assign(t,i._initial),i.tag&&(t.tag=i.tag),this.nodes=i.nodes,i.node=this,r&&i.nodes.forEach(n=>{r.nodes.get(n.tag)||(r.nodes.set(n.tag,n),r.nNodes++)})}if(typeof e=="string"&&(r?e=r.nodes.get(e):e=void 0),t.tag&&(r||e)){let i;if(r?.nodes&&(i=r.nodes.get(t.tag)),!i&&e?.nodes&&(i=e.nodes.get(t.tag)),i){this.reactive&&this.addLocalState(i._initial),this.source||(this.source=i);let n=i.getProps();delete n.graph,delete n.parent;for(let a in n){let o=Object.getOwnPropertyDescriptor(t,a);o&&o.get&&!o.set?t=Object.assign({},t):t[a]=n[a]}}}t?.operator&&(t.operator=this.setOperator(t.operator)),!t.tag&&r?t.tag=`node${r.nNodes}`:t.tag||(t.tag=`node${Math.floor(Math.random()*1e10)}`);let s=Object.getOwnPropertyNames(this);for(let i in t)s.includes(i)||(this._initial[i]=t[i]);if(t.children&&(this._initial.children=Object.assign({},t.children)),Object.assign(this,t),this.tag||(r?this.tag=`node${r.nNodes}`:this.tag=`node${Math.floor(Math.random()*1e10)}`),r&&(this.graph=r,r.nodes.get(this.tag)&&(this.tag=`${this.tag}${r.nNodes+1}`),r.nodes.set(this.tag,this),r.nNodes++,this.state=r.state),typeof e=="object"&&(this.parent=e,(e instanceof y||e instanceof N)&&e.nodes.set(this.tag,this)),typeof t.tree=="object")for(let i in t.tree){typeof t.tree[i]=="object"&&(!t.tree[i]).tag&&(t.tree[i].tag=i);let n=new y(t.tree[i],this,r);this.nodes.set(n.tag,n)}if(this.children&&this.convertChildrenToNodes(this),(this.parent instanceof y||this.parent instanceof N)&&this.checkNodesHaveChildMapped(this.parent,this),this.reactive){if(this.addLocalState(t),typeof this.reactive=="function")this.state.subscribeTrigger(this._unique,this.reactive);else if(typeof this.reactive=="object"){for(let i in this.reactive)if(typeof this.reactive[i]=="function")if(i.includes(".")){let n=i.split(".");if(n[0]==="self")this._state||this.addLocalState(),this.reactive[i]=this._events.subscribeTrigger(i,this.reactive[i]);else if(n[0]==="parent"&&this.parent)this.parent._state||this.addLocalState(),this.reactive[i]=this.parent._events.subscribeTrigger(i,this.reactive[i]);else if(n[0]==="children"){let a={};for(let o in this.children)this.children[o]?.state&&(this.children[o]._state||this.children[o].addLocalState(),a[o]=this.children[o]._events.subscribeTrigger(i,this.reactive[i]));this.reactive[i]=a}else this.nodes.get(n[0])&&(this.nodes.get(i)._state||this.nodes.get(i).addLocalState(),this.reactive[i]=this.nodes.get(i)._events.subscribeTrigger(i,this.reactive[i]))}else if(i==="self")this._state||this.parent.addLocalState(),this.reactive[i]=this.state.subscribeTrigger(this._unique,this.reactive[i]);else if(i==="parent"&&this.parent)this.parent._state||this.parent.addLocalState(),this.reactive[i]=this.parent.state.subscribeTrigger(this.parent._unique,this.reactive[i]);else if(i==="children"&&this.children){let n={};for(let a in this.children)this.children[a]?.state&&(this.children[a]._state||this.children[a].addLocalState(),n[a]=this.children[a].state.subscribeTrigger(this.children[a]._unique,this.reactive[i]));this.reactive[i]=n}else this.nodes.get(i)&&(this.nodes.get(i)._state||this.nodes.get(i).addLocalState(),this.reactive[i]=this.nodes.get(i).state.subscribeTrigger(this.nodes.get(i)._unique,this.reactive[i]))}}typeof this.oncreate=="function"&&this.oncreate(this),this.firstRun||(this.firstRun=!0),this.animation&&!this.animate&&(this.animate=!0)}else return t}},N=class{constructor(t,e,r){this.nNodes=0;this.nodes=new Map;this.state=new O;this._unique=`${Math.random()}`;this.tree={};this.addLocalState=A;this.add=(t={})=>{t?.node instanceof y&&(t=t.node);let e=t;return t instanceof y?(this.nNodes=this.nodes.size,t.tag&&(this.tree[t.tag]=e,this.nodes.set(t.tag,t))):t=new y(e?.node??e,this,this),t};this.setTree=(t=this.tree)=>{if(!!t){for(let e in t){let r=this.nodes.get(e);if(r){if(typeof t[e]=="function")r.setOperator(t[e]);else if(typeof t[e]=="object")if(t[e]instanceof y)this.add(t[e]);else if(t[e]instanceof N){let s=t[e],i={};s.operator&&(i.operator=s.operator),s.children&&(i.children=s.children),s.forward&&(i.forward=s.forward),s.backward&&(i.backward=s.backward),s.repeat&&(i.repeat=s.repeat),s.recursive&&(i.recursive=s.recursive),s.loop&&(i.loop=s.loop),s.animate&&(i.animate=s.animate),s.looper&&(i.looper=s.looper),s.animation&&(i.animation=s.animation),s.delay&&(i.delay=s.delay),s.tag&&(i.tag=s.tag),s.oncreate&&(i.oncreate=s.oncreate),s.node?._initial&&Object.assign(i,s.node._initial),i.nodes=s.nodes,i.source=s,r.setProps(i)}else r.setProps(t[e])}else if(typeof t[e]=="function")this.add({tag:e,operator:t[e]});else if(typeof t[e]=="object"&&!Array.isArray(t[e])){t[e].tag||(t[e].tag=e);let s=this.add(t[e]);t[e].aliases&&t[e].aliases.forEach(i=>{this.nodes.set(i,s)})}else this.add({tag:e,operator:(...s)=>t[e]})}this.nodes.forEach(e=>{if(typeof e.children=="object")for(let r in e.children)typeof e.children[r]=="string"?this.nodes.get(e.children[r])&&(e.children[r]=this.nodes.get(e.children[r])):(e.children[r]===!0||typeof e.children[r]>"u")&&this.nodes.get(r)&&(e.children[r]=this.nodes.get(r)),e.children[r]instanceof y&&e.checkNodesHaveChildMapped(e,e.children[r]);typeof e.parent=="string"&&this.nodes.get(e.parent)&&(e.parent=this.nodes.get(e.parent),e.nodes.set(e.parent.tag,e.parent))})}};this.get=t=>this.nodes.get(t);this.set=t=>this.nodes.set(t.tag,t);this.run=(t,...e)=>{if(typeof t=="string"&&(t=this.nodes.get(t)),t?.run)return t.run(...e)};this.runAsync=(t,...e)=>(typeof t=="string"&&(t=this.nodes.get(t)),t?.run?new Promise((r,s)=>{r(t.run(...e))}):new Promise((r,s)=>{r(void 0)}));this.removeTree=(t,e)=>{if(t&&typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes){e||(e={});let r=s=>{if(typeof s.children=="object"&&!e[s.tag]){e[s.tag]=!0;for(let i in s.children)s.children[i]instanceof y&&(this.remove(s.children[i]),r(s.children[i]))}};t.stopNode&&t.stopNode(),t.tag&&(this.remove(t),r(t))}};this.remove=t=>(typeof t=="string"&&(t=this.nodes.get(t)),t instanceof y&&(t.stopNode&&t.stopNode(),t?.tag&&this.nodes.get(t.tag)&&(this.nodes.delete(t.tag),t.cleanup(),this.parent?.tag===t.tag&&delete this.parent,this[t.tag]instanceof y&&delete this[t.tag],this.nodes.forEach(e=>{e?.tag&&(e.nodes.get(t.tag)&&e.nodes.delete(t.tag),e.children?.[t.tag]instanceof y&&delete e.children[t.tag])}))),t);this.append=(t,e)=>{e.addChildren(t)};this.callParent=async(t,...e)=>{if(t?.parent)return await t.callParent(...e)};this.callChildren=async(t,...e)=>{if(t?.children)return await t.callChildren(...e)};this.subscribe=(t,e)=>{if(!!e){if(t?.subscribe&&typeof e=="function")return t.subscribe(e);if(e instanceof y||typeof e=="string")return this.subscribeNode(t,e);if(typeof t=="string")return this.state.subscribeTrigger(t,e)}};this.unsubscribe=(t,e)=>this.state.unsubscribeTrigger(t,e);this.subscribeState=t=>{if(this.reactive){if(typeof t=="string"&&(this.graph?t=this.graph.get(t):t=this.nodes.get(t)),typeof t=="function")return this.state.subscribeTrigger(this._unique,t);if(t)return this.state.subscribeTrigger(this._unique,e=>{t.run(e)})}else return};this.subscribeNode=(t,e)=>{let r;if(t?.tag?r=t.tag:typeof t=="string"&&(r=t),typeof e=="string"&&(e=this.nodes.get(e)),t&&e)return this.state.subscribeTrigger(r,i=>{Array.isArray(i)?e.run(...i):e.run(i)})};this.stopNode=t=>{typeof t=="string"&&(t=this.nodes.get(t)),t?.stopNode&&t.stopNode()};this.print=(t,e=!0)=>{if(t?.print)return t.print(t,e);{let r="{";return this.nodes.forEach(s=>{r+=`
"${s.tag}:${s.print(s,e)}"`}),r}};this.reconstruct=t=>{let e=j(t);if(e)return this.add(e)};this.create=(t,e,r)=>R(t,e,r,this);this.setState=t=>{this.state.setState(t)};this.DEBUGNODES=(t=!0)=>{this.nodes.forEach(e=>{t?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};this.tag=e||`graph${Math.floor(Math.random()*1e11)}`,r&&(console.log(r,r.constructor.name),r.reactive?this.addLocalState(r):Object.assign(this,r),this._initial=r),(t||Object.keys(this.tree).length>0)&&this.setTree(t)}};function P(f,t,e){let r=j(f);if(r)return new y(r,t,e)}function j(f="{}"){try{let t=typeof f=="string"?JSON.parse(f):f,e=r=>{for(let s in r)if(typeof r[s]=="string"){let i=C(r[s]);typeof i=="function"&&(r[s]=i)}else typeof r[s]=="object"&&e(r[s]);return r};return e(t)}catch(t){console.error(t);return}}var w=function(){let f=new Map,t=[],e=["this"];function r(){f.clear(),t.length=0,e.length=1}function s(n,a){var o=t.length-1,c=t[o];if(typeof c=="object")if(c[n]===a||o===0)e.push(n),t.push(a.pushed);else for(;o-->=0;){if(c=t[o],typeof c=="object"&&c[n]===a){o+=2,t.length=o,e.length=o,--o,t[o]=a,e[o]=n;break}o--}}function i(n,a){if(a!=null&&typeof a=="object"){n&&s(n,a);let o=f.get(a);if(o)return"[Circular Reference]"+o;f.set(a,e.join("."))}return a}return function(a,o){try{return t.push(a),JSON.stringify(a,i,o)}finally{r()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=w);var S=function(){let f=new Map,t=[],e=["this"];function r(){f.clear(),t.length=0,e.length=1}function s(n,a){var o=t.length-1;if(t[o]){var c=t[o];if(typeof c=="object")if(c[n]===a||o===0)e.push(n),t.push(a.pushed);else for(;o-->=0;){if(c=t[o],typeof c=="object"&&c[n]===a){o+=2,t.length=o,e.length=o,--o,t[o]=a,e[o]=n;break}o++}}}function i(n,a){let o;if(a!=null)if(typeof a=="object"){let c=a.constructor.name;n&&c==="Object"&&s(n,a);let b=f.get(a);if(b)return"[Circular Reference]"+b;if(f.set(a,e.join(".")),c==="Array")a.length>20?o=a.slice(a.length-20):o=a;else if(c.includes("Set"))o=Array.from(a);else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean")o="instanceof_"+c;else if(c==="Object"){let h={};for(let l in a)if(a[l]==null)h[l]=a[l];else if(Array.isArray(a[l]))a[l].length>20?h[l]=a[l].slice(a[l].length-20):h[l]=a[l];else if(a[l].constructor.name==="Object"){h[l]={};for(let g in a[l])if(Array.isArray(a[l][g]))a[l][g].length>20?h[l][g]=a[l][g].slice(a[l][g].length-20):h[l][g]=a[l][g];else if(a[l][g]!=null){let u=a[l][g].constructor.name;u.includes("Set")?h[l][g]=Array.from(a[l][g]):u!=="Number"&&u!=="String"&&u!=="Boolean"?h[l][g]="instanceof_"+u:h[l][g]=a[l][g]}else h[l][g]=a[l][g]}else{let g=a[l].constructor.name;g.includes("Set")?h[l]=Array.from(a[l]):g!=="Number"&&g!=="String"&&g!=="Boolean"?h[l]="instanceof_"+g:h[l]=a[l]}o=h}else o=a}else o=a;return o}return function(a,o){t.push(a);let c=JSON.stringify(a,i,o);return r(),c}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=S);function R(f,t,e,r){return typeof e=="object"?(e.operator=f,new y(e,t,r)):new y({operator:f},t,r)}var G=class extends N{constructor(e={}){super(void 0,e.name?e.name:`service${Math.floor(Math.random()*1e14)}`,e.props);this.routes={};this.loadDefaultRoutes=!1;this.keepState=!0;this.firstLoad=!0;this.customRoutes={};this.customChildren={};this.init=e=>{e?e=Object.assign({},e):e={},e.customRoutes?Object.assign(e.customRoutes,this.customRoutes):e.customRoutes=this.customRoutes,e.customChildren?Object.assign(e.customChildren,this.customChildren):e.customChildren=this.customChildren,Array.isArray(e.routes)?e.routes.forEach(r=>{this.load(r,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren,e.sharedState)}):(e.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)&&this.load(e.routes,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren,e.sharedState)};this.load=(e,r=!0,s=".",i=this.customRoutes,n=this.customChildren,a=!0)=>{if(!e&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;this.firstLoad&&(this.firstLoad=!1),i?i=Object.assign(this.customRoutes,i):i=this.customRoutes;let o,c={};if(e){if(!(e instanceof N)&&e?.name&&!e.setTree)if(e.module){let h=e;e={},Object.getOwnPropertyNames(e.module).forEach(l=>{r?e[h.name+s+l]=e.module[l]:e[l]=e.module[l]})}else typeof e=="function"&&(o=new e({loadDefaultRoutes:this.loadDefaultRoutes}),o.load(),a&&(o.state=this.state),e=o.routes,o.customRoutes&&!this.customRoutes?this.customRoutes=o.customRoutes:o.customRoutes&&this.customRoutes&&Object.assign(this.customRoutes,o.customRoutes),o.customChildren&&!this.customChildren?this.customChildren=o.customChildren:o.customChildren&&this.customChildren&&Object.assign(this.customChildren,o.customChildren));else if(e instanceof N||e.source instanceof N||e.setTree){if(o=e,e={},a&&(o.state=this.state),r){let h=o.name;h||(h=o.tag,o.name=h),h||(h=`graph${Math.floor(Math.random()*1e15)}`,o.name=h,o.tag=h)}o.customRoutes&&!this.customRoutes?this.customRoutes=o.customRoutes:o.customRoutes&&this.customRoutes&&Object.assign(this.customRoutes,o.customRoutes),o.customChildren&&!this.customChildren?this.customChildren=o.customChildren:o.customChildren&&this.customChildren&&Object.assign(this.customChildren,o.customChildren),o.nodes.forEach(h=>{e[h.tag]=h;let l={},g=(u,p)=>{if((!l[u.tag]||p&&r&&!l[p?.tag+s+u.tag])&&(p?l[p.tag+s+u.tag]=!0:l[u.tag]=!0,u instanceof N||u.source instanceof N||u.setTree)){if(a&&(u.state=this.state),r){let d=u.name;d||(d=u.tag,u.name=d),d||(d=`graph${Math.floor(Math.random()*1e15)}`,u.name=d,u.tag=d)}u.nodes.forEach(d=>{r&&!e[u.tag+s+d.tag]?e[u.tag+s+d.tag]=d:e[d.tag]||(e[d.tag]=d),g(d,u)})}};g(h)})}else if(typeof e=="object"){let h=e.constructor.name;if(h==="Object"&&(h=Object.prototype.toString.call(e),h&&(h=h.split(" ")[1]),h&&(h=h.split("]")[0])),h&&h!=="Object"){let l=e;e={},Object.getOwnPropertyNames(l).forEach(g=>{r?e[h+s+g]=l[g]:e[g]=l[g]})}}if((o instanceof N||o?.setTree)&&o.name&&r){e=Object.assign({},e);for(let h in e){let l=e[h];delete e[h],e[o.name+s+h]=l}}}if(this.loadDefaultRoutes){let h=Object.assign({},this.defaultRoutes);e?(Object.assign(h,this.routes),e=Object.assign(h,e)):e=Object.assign(h,this.routes),this.loadDefaultRoutes=!1}e||(e=this.routes);let b=0;for(let h in e){b++;let l=(g,u)=>{if(typeof g=="object"&&(g.tag||(g.tag=u),typeof g?.children=="object")){e:for(let p in g.children)if(b++,typeof g.children[p]=="object"){let d=g.children[p];if(d.tag&&c[d.tag])continue;if(n){for(let v in n)if(d=n[v](d,p,g,e,c),!d)continue e}d.id&&!d.tag&&(d.tag=d.id);let m;if(d.tag)if(c[d.tag]){let v=`${d.tag}${b}`;c[v]=d,d.tag=v,l(c[v],p),m=v}else c[d.tag]=d,l(c[d.tag],p),m=d.tag;else if(c[p]){let v=`${p}${b}`;c[v]=d,d.tag=v,l(c[v],p),m=v}else c[p]=d,l(c[p],p),m=p;o?.name&&r?(c[o.name+s+m]=d,delete c[m]):c[m]=d}}};c[h]=e[h],l(e[h],h)}e:for(let h in c)if(typeof c[h]=="object"){let l=c[h];if(typeof l=="object"){if(i){for(let g in i)if(l=i[g](l,h,c),!l)continue e}l.get&&l.get,l.post,l.delete,l.put,l.head,l.patch,l.options,l.connect,l.trace,l.post&&!l.operator?c[h].operator=l.post:!l.operator&&typeof l.get=="function"&&(c[h].operator=l.get)}}for(let h in e)typeof e[h]=="object"?this.routes[h]?typeof this.routes[h]=="object"?Object.assign(this.routes[h],e[h]):this.routes[h]=e[h]:this.routes[h]=e[h]:this.routes[h]?typeof this.routes[h]=="object"?Object.assign(this.routes[h],e[h]):this.routes[h]=e[h]:this.routes[h]=e[h];if(o)for(let h in this.routes)(this.routes[h]instanceof y||this.routes[h].constructor.name.includes("GraphNode"))&&(this.nodes.set(h,this.routes[h]),this.nNodes=this.nodes.size);else this.setTree(this.routes);for(let h in e)e[h]?.aliases&&e[h].aliases.forEach(g=>{o?.name&&r?this.routes[o.name+s+g]=e[h]:this.routes[g]=e[h]});return this.routes};this.unload=(e=this.routes)=>{if(!e)return;let r;!(e instanceof G)&&typeof e=="function"?(r=new G,e=r.routes):e instanceof G&&(e=e.routes);for(let s in e)delete this.routes[s],this.nodes.get(s)&&this.remove(s);return this.routes};this.handleMethod=(e,r,s)=>{let i=r.toLowerCase(),n=this.nodes.get(e);return n||(n=this.routes[e],n||(n=this.tree[e])),n?.[i]?n[i]instanceof Function?n[i](s):(s&&(n[i]=s),n[i]):this.handleServiceMessage({route:e,args:s,method:r})};this.transmit=(...e)=>typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e;this.receive=(...e)=>{if(e[0]&&typeof e[0]=="string"){let r=e[0].substring(0,8);(r.includes("{")||r.includes("["))&&(r.includes("\\")&&(e[0]=e[0].replace(/\\/g,"")),e[0][0]==='"'&&(e[0]=e[0].substring(1,e[0].length-1)),e[0]=JSON.parse(e[0]))}return typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e};this.pipe=(e,r,s,i,n)=>{if(e instanceof y)return n?e.subscribe(a=>{let o=n(a);o!==void 0?this.transmit({route:r,args:o,method:i}):this.transmit({route:r,args:a,method:i},s)}):this.subscribe(e,a=>{this.transmit({route:r,args:a,method:i},s)});if(typeof e=="string")return this.subscribe(e,a=>{this.transmit({route:r,args:a,method:i},s)})};this.pipeOnce=(e,r,s,i,n)=>{if(e instanceof y)return n?e.state.subscribeTriggerOnce(e.tag,a=>{let o=n(a);o!==void 0?this.transmit({route:r,args:o,method:i}):this.transmit({route:r,args:a,method:i},s)}):this.state.subscribeTriggerOnce(e.tag,a=>{this.transmit({route:r,args:a,method:i},s)});if(typeof e=="string")return this.state.subscribeTriggerOnce(e,a=>{this.transmit({route:r,args:a,method:i},s)})};this.terminate=(...e)=>{this.nodes.forEach(r=>{r.stopNode()})};this.recursivelyAssign=(e,r)=>{for(let s in r)typeof r[s]=="object"&&!Array.isArray(r[s])?typeof e[s]=="object"&&!Array.isArray(e[s])?this.recursivelyAssign(e[s],r[s]):e[s]=this.recursivelyAssign({},r[s]):e[s]=r[s];return e};this.defaultRoutes={"/":{get:()=>this.print(),aliases:[""]},ping:()=>(console.log("ping"),"pong"),echo:(...e)=>(this.transmit(...e),e),assign:e=>typeof e=="object"?(Object.assign(this,e),!0):!1,recursivelyAssign:e=>typeof e=="object"?(this.recursivelyAssign(this,e),!0):!1,log:{post:(...e)=>{console.log("Log: ",...e)},aliases:["info"]},error:e=>{let r=new Error(e);return console.error(e),r},state:e=>e?this.state.data[e]:this.state.data,printState:e=>e?w(this.state.data[e]):w(this.state.data),spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};e.name?this.name=e.name:e.name=this.tag,"loadDefaultRoutes"in e&&(this.loadDefaultRoutes=e.loadDefaultRoutes,this.routes=Object.assign(this.defaultRoutes,this.routes)),(e||Object.keys(this.routes).length>0)&&this.init(e)}handleServiceMessage(e){let r;return typeof e=="object"&&(e.route?r=e.route:e.node&&(r=e.node)),r?Array.isArray(e.args)?this.run(r,...e.args):this.run(r,e.args):e}handleGraphNodeCall(e,r){if(!e)return r;if(r?.args)this.handleServiceMessage(r);else return Array.isArray(r)?this.run(e,...r):this.run(e,r)}isTypedArray(e){return ArrayBuffer.isView(e)&&Object.prototype.toString.call(e)!=="[object DataView]"}spliceTypedArray(e,r,s){let i=e.subarray(0,r),n;s&&(n=e.subarray(s+1));let a;return(i.length>0||n?.length>0)&&(a=new e.constructor(i.length+n.length)),i.length>0&&a.set(i),n&&n.length>0&&a.set(n,i.length),a}};var F={setRoute:function(f,t){if(typeof f=="string"&&(f=C(f)),typeof f=="function"){if(t||(t=f.name),this.graph.get(t))this.graph.get(t).setOperator(f.bind(this.graph.get(t)));else{let e=this.graph.add({tag:t,operator:f});this.graph instanceof G&&this.graph.load({[t]:e})}return!0}return!1},setNode:function(f,t){return typeof f=="string"&&(f=C(f)),typeof f=="function"?(t||(t=f.name),this.graph.get(t)?this.graph.get(t).setOperator(f):this.graph.add({tag:t,operator:f}),!0):!1},setMethod:function(f,t,e){return typeof t=="string"&&(t=C(t)),typeof t=="function"?(e||(e=t.name),this.graph.get(f)?this.graph.get(f)[e]=t:this.graph.add({tag:e,[e]:t}),!0):!1},assignRoute:function(f,t){this.graph.get(f)&&typeof t=="object"&&Object.assign(this.graph.get(f),t)},transferClass:(f,t)=>{if(typeof f=="object"){let e=f.toString();return{route:"receiveClass",args:[e,t]}}return!1},receiveClass:function(f,t){if(typeof f=="string"&&f.indexOf("class")===0){let e=(0,eval)("("+f+")"),r=t;return r||(r=e.name),this.graph[r]=e,!0}return!1},setGlobal:(f,t)=>(globalThis[f]=t,!0),assignGlobalObject:(f,t)=>globalThis[f]?(typeof t=="object"&&Object.assign(globalThis[f],t),!0):!1,setValue:function(f,t){return this.graph[f]=t,!0},assignObject:function(f,t){return this.graph[f]?(typeof t=="object"&&Object.assign(this.graph[f],t),!0):!1},setGlobalFunction:(f,t)=>(typeof f=="string"&&(f=C(f)),typeof f=="function"?(t||(t=f.name),globalThis[t]=f,!0):!1),assignFunctionToGlobalObject:function(f,t,e){return globalThis[f]?(typeof t=="string"&&(t=C(t)),typeof t=="function"?(e||(e=t.name),this.graph[f][e]=t,!0):!1):!1},setFunction:function(f,t){return typeof f=="string"&&(f=C(f)),typeof f=="function"?(t||(t=f.name),this.graph[t]=f,!0):!1},assignFunctionToObject:function(f,t,e){return this.graph[f]?(typeof t=="string"&&(t=C(t)),typeof t=="function"?(e||(e=t.name),this.graph[f][e]=t,!0):!1):!1}};var T=class extends G{constructor(e){super(e);this.name="router";this.connections={};this.sources={};this.services={};this.serviceConnections={};this.users={};this.addUser=async(e,r,s,i)=>{e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`);let n=Object.assign({},e);if(r){for(let u in r)typeof r[u]=="object"&&(r[u].connection._id||await new Promise((p,d)=>{let m=performance.now(),v=()=>{r[u].connection._id?p(!0):performance.now()-m>3e3?(delete r[u],d(!1)):setTimeout(()=>{v()},100)};v()}).catch(p=>{console.error("Connections timed out:",p)}));for(let u in r)r[u]=this.addConnection(r[u],n._id)}if(s)for(let u in s)this.openConnection(s[u].service,s[u],n._id,s[u].args);let a=(u,...p)=>{let d=this.getConnection(n._id,"send");if(d?.send)return d.send(u,...p)},o=(u,p,...d)=>{let m=this.getConnection(n._id,"request");if(m?.request)return m.request(u,p,...d)},c=(u,p,d,...m)=>{let v=this.getConnection(n._id,"post");if(v?.post)return v.post(u,p,d,...m)},b=(u,p,d,...m)=>{let v=this.getConnection(n._id,"run");if(v?.run)return v.run(u,p,d,...m)},h=(u,p,...d)=>{let m=this.getConnection(n._id,"subscribe");if(m?.subscribe)return m.subscribe(u,p,...d)},l=(u,p,...d)=>{let m=this.getConnection(n._id,"unsubscribe");if(m?.unsubscribe)return m.unsubscribe(u,p,...d)},g=()=>this.removeUser(n);if(n.send=a,n.request=o,n.post=c,n.run=b,n.subscribe=h,n.unsubscribe=l,n.terminate=g,this.users[n._id]=n,r&&!i){let u={},p=!1;Object.keys(r).map((d,m)=>{r[d]?._id&&(u[`${m}`]=r[d]?._id,p=!0)}),p&&n.send({route:"addUser",args:[{_id:n._id},u,void 0,!0]})}return n};this.getConnection=(e,r)=>{if(this.sources[e])if(this.order)for(let s=0;s<this.order.length;s++){let i=this.order[s];for(let n in this.sources[e])if(this.sources[e][n].service){if(typeof this.sources[e][n].service=="object"){if(this.sources[e][n].service.tag===i){if(this.sources[e][n].connectionType&&this.sources[e][n].service?.name&&!this.serviceConnections[this.sources[e][n].service.name]){this.removeConnection(this.sources[e][n]);continue}return this.sources[e][n]}}else if(this.sources[e][n].service===i){if(this.sources[e][n].connectionType&&this.sources[e][n].service?.name){this.serviceConnections[this.sources[e][n].service.name]||this.removeConnection(this.sources[e][n]);continue}return this.sources[e][n]}}}else for(let s in this.sources[e]){if(this.sources[e][s].connectionType&&this.sources[e][s].service?.name&&!this.serviceConnections[this.sources[e][s].service.name]){this.removeConnection(this.sources[e][s]);continue}return r&&this.sources[e][s][r]?this.sources[e][s]:this.sources[e][s]}else if(this.order)for(let s=0;s<this.order.length;s++){let i=this.order[s];if(this.sources[i]?.[e]){if(this.sources[i][e].connectionType&&this.sources[i][e].service?.name&&!this.serviceConnections[this.sources[i][e].service.service.name]){this.removeConnection(this.sources[i][e].service);continue}return r&&this.sources[i][e]?.[r]?this.sources[i][e]:this.sources[i][e]}}if(typeof e=="string"&&this.connections[e]&&this.connections[e].send)return this.connections[e]};this.getConnections=(e,r,s)=>{if(this.sources[e]){if(!s&&!r)return this.sources[e];let i={};for(let n in this.sources[e])if(typeof this.sources[e][n]=="object"){if(this.sources[e][n]._id){let a=!0;r&&!this.sources[e][n][r]&&(a=!1);for(let o in s)if(typeof this.sources[e][n][o]=="object"&&typeof s[o]=="object"){for(let c in s[o])if(s[o][c]!==this.sources[e][n][o][c]){a=!1;break}}else if(this.sources[e][n][o]!==s[o])a=!1;else{a=!1;break}a&&this.getConnection(this.sources[e][n],r)&&(i[this.sources[e][n]._id]=this.sources[e][n])}else for(let a in this.sources[e][n])if(typeof this.sources[e][n][a]=="object"){let o=!0;r&&!this.sources[e][n][a][r]&&(o=!1);for(let c in s)if(typeof this.sources[e][n][a][c]=="object"&&typeof s[c]=="object"){for(let b in s[c])if(s[c][b]!==this.sources[e][n][a][c][b]){o=!1;break}}else if(this.sources[e][n][a][c]!==s[c])o=!1;else{o=!1;break}o&&(i[this.sources[e][n][a]._id]=this.sources[e][n][a])}}}};this.addConnection=(e,r)=>{let s={};if(typeof e=="string"){if(this.connections[e])e=this.connections[e];else for(let i in this.serviceConnections)for(let n in this.serviceConnections[i])if(this.serviceConnections[i][n][e]){e={connection:this.serviceConnections[i][n][e]},e.service=i,s.connectionType=i,s.connectionsKey=n;break}typeof e=="string"&&this.nodes.get(e)&&(e={connection:this.nodes.get(e)})}if(!(!e||typeof e=="string")){if(r&&(s.source=r),e.connection instanceof y){s.connection=e.connection;let i=s.connection;if(s.send=async n=>n.method?Array.isArray(n.args)?i[n.method]?.(...n.args):i[n.method]?.(n.args):Array.isArray(n.args)?i.run(...n.args):i.run(n.args),s.request=async(n,a)=>a?Array.isArray(n.args)?i[a]?.(...n.args):i[a]?.(n.args):Array.isArray(n.args)?i.run(...n.args):i.run(n.args),s.post=async(n,a,o)=>{if(n&&i.get(n)){let c=i.get(n);return o?Array.isArray(a)?c[o]?.(...a):c[o]?.(a):Array.isArray(a)?c.run(...a):c.run(a)}else return o?Array.isArray(a)?i[o]?.(...a):i[o]?.(a):Array.isArray(a)?i.run(...a):i.run(a)},s.run=s.post,s.subscribe=async(n,a)=>i.subscribe(a,n),s.unsubscribe=async(n,a)=>i.unsubscribe(a,n),s.terminate=()=>(i.graph.remove(i),!0),s.onclose=e.onclose,s.onclose){let n;i.ondelete&&(n=i.ondelete),i.ondelete=a=>{s.onclose&&s.onclose(s,a),n&&n(a)}}}else if(e.connection instanceof N){e.connection.nodes.get("open")&&(s.service=e.connection);let i=s.connection;s.send=async n=>{Array.isArray(n.args)?i.run(n.route,...n.args):i.run(n.route,n.args)},s.request=async(n,a)=>{if(!!n.route)return a?Array.isArray(n.args)?i.nodes.get(n.route)[a]?.(...n.args):i.nodes.get(n.route)[a]?.(n.args):Array.isArray(n.args)?i.run(n.route,...n.args):i.run(n.route,n.args)},s.post=async(n,a,o)=>{if(n&&i.get(n)){let c=i.get(n);return o?Array.isArray(a)?c[o]?.(...a):c[o]?.(a):Array.isArray(a)?c.run(...a):c.run(a)}},s.run=s.post,s.subscribe=async(n,a)=>i.subscribe(n,a),s.unsubscribe=async(n,a)=>i.unsubscribe(n,a),s.terminate=n=>(i.remove(n),!0)}else if(!(e._id&&this.connections[e._id])){let i=e.connection;if(typeof i=="string"){if(this.connections[i])i=this.connections[i];else if(e.service){if(typeof e.service=="string"&&(e.service=this.services[e.service]),typeof e.service=="object"&&e.service.connections){for(let n in e.service.connections)if(e.service.connections[n][i]){i=e.service.connections[n][i],s.connectionType=n,s.connectionsKey=i;break}}}else for(let n in this.serviceConnections)for(let a in this.serviceConnections[n])if(this.serviceConnections[n][a][i]){i=this.serviceConnections[n][a][i],e.service=n,s.connectionType=n,s.connectionsKey=a;break}}if(typeof i!="object")return;if(s._id=i._id,s.send=i.send,s.request=i.request,s.run=i.run,s.post=i.post,s.subscribe=i.subscribe,s.unsubscribe=i.unsubscribe,s.terminate=i.terminate,s.onclose=e.onclose,s.onclose){if(!(i.onclose&&s.onclose.toString()===i.onclose.toString())){let n=i.onclose;i.onclose=(...a)=>{s.onclose&&s.onclose(s,...a),this.users[s.source]&&Object.keys(this.sources[s.source]).length===0&&this.removeUser(s.source,!1),n&&n(...a)}}}else{let n=i.onclose;i.onclose=(...a)=>{this.removeConnection(s),this.users[s.source]&&Object.keys(this.sources[s.source]).length===0&&this.removeUser(s.source,!1),n&&n(...a)}}e.service?(typeof e.service=="string"&&(e.service=this.services[e.service]),s.service=e.service):i.graph&&(s.service=i.graph)}return!s.source&&e.source?s.source=e.source:!s.source&&e.service?s.source=typeof e.service=="object"?e.service.name:void 0:!s.source&&(s.connection instanceof y||s.connection instanceof N)&&(s.source="local",this.order.indexOf("local")||this.order.unshift("local")),s._id||(s._id=`connection${Math.floor(Math.random()*1e15)}`),s.source&&(this.sources[s.source]||(this.sources[s.source]={}),this.sources[s.source][s._id]=s),this.connections[s._id]||(this.connections[s._id]=s),s}};this.removeConnection=(e,r=!1)=>{if(typeof e=="object"&&e._id&&(e=e._id),typeof e=="string"){if(this.connections[e]){r&&this.connections[e]&&this.connections[e].terminate(),delete this.connections[e];for(let s in this.sources)if(this.sources[s][e])delete this.sources[s][e];else for(let i in this.sources[s])this.sources[s][i]?.[e]&&delete this.sources[s][e];return!0}else if(this.sources[e]){for(let s in this.sources[e])this.removeConnection(this.sources[e][s],r);return!0}}};this.addService=(e,r,s,i,n,a,o)=>{if(this.load(e,s,i,this.customRoutes,this.customChildren),this.services[e.name]=e,r)if(typeof r=="string")this.addServiceConnections(e,r,a);else for(let c in r)this.addServiceConnections(e,c,a);n&&this.syncServices(),o?this.order=o:(this.order||(this.order=[]),this.order.push(e.name))};this.addServiceConnections=(e,r,s)=>{if(typeof e=="string"&&(e=this.services[e]),r&&e[r]){let i={};this.serviceConnections[e.name]||(this.serviceConnections[e.name]={}),this.serviceConnections[e.name][r]=e[r];for(let n in e[r])this.connections[n]||(i[n]=this.addConnection({connection:e[r][n],service:e},s),i[n].connectionType=r);return i}};this.openConnection=async(e,r,s,...i)=>{if(typeof e=="string"&&(e=this.services[e]),e instanceof G){let n=e.run("open",r,...i);if(n instanceof Promise)return n.then(async a=>{a._id||await new Promise((o,c)=>{let b=performance.now(),h=()=>{a._id?o(!0):performance.now()-b>3e3?c(!1):setTimeout(()=>{h()},100)};h()}).catch(o=>{console.error("Connections timed out:",o)}),a._id&&this.addConnection({connection:a,service:e},s)});if(n&&(n._id||await new Promise((a,o)=>{let c=performance.now(),b=()=>{n._id?a(!0):performance.now()-c>3e3?o(!1):setTimeout(()=>{b()},100)};b()}).catch(a=>{console.error("Connections timed out:",a)}),n._id))return this.addConnection({connection:n,service:e},s)}};this.terminate=e=>(typeof e=="string"&&(e=this.connections[e]),e.terminate());this.subscribeThroughConnection=(e,r,s,i,...n)=>{if(typeof r=="string"&&(r=this.getConnection(r,"run")),typeof r=="object")return new Promise((a,o)=>{r.run("routeConnections",[e,s,r._id,...n]).then(c=>{this.subscribe(s,b=>{b?.callbackId===e&&(i?typeof i=="string"?this.setState({[i]:b.args}):i(b.args):this.setState({[s]:b.args}))}),a(c)}).catch(o)})};this.routeConnections=(e,r,s,...i)=>{let n;if(typeof s=="string"&&(this.sources[s]&&(n=s),s=this.getConnection(s,"send")),typeof r=="string"&&(r=this.getConnection(r,"subscribe")),r?.subscribe&&s?.send)return new Promise((o,c)=>{r.subscribe(e,r._id,b=>{!this.connections[s._id]&&n&&this.sources[n]&&(n=s,Object.keys(this.sources[n]).forEach(h=>{this.sources[s][h].send&&(s=this.sources[s][h])})),this.connections[s._id]&&s.send({callbackId:e,args:b})},...i).then(b=>{o(b)})})};this.syncServices=()=>{for(let e in this.services)"users"in this.services[e]&&(this.services[e].users=this.users),this.nodes.forEach((r,s)=>{this.services[e].nodes.get(r.tag)?!this.services[e].nodes.get(s)&&r._UNIQUE!==this.services[e].nodes.get(r.tag)._UNIQUE&&this.services[e].nodes.set(s,r):this.services[e].nodes.set(r.tag,r)})};this.setUserData=(e,r)=>{if(e&&typeof e=="string"&&(e=this.users[e],!e))return!1;if(r&&typeof r=="string"&&(r=JSON.parse(r)),typeof r=="object")return this.recursivelyAssign(e,r),!0};this.routes={addUser:this.addUser,removeUser:this.removeUser,getConnection:this.getConnection,addConnection:this.addConnection,removeConnection:this.removeConnection,addService:this.addService,addServiceConnections:this.addServiceConnections,openConnection:this.openConnection,terminate:this.terminate,routeConnections:this.routeConnections,subscribeThroughConnection:this.subscribeThroughConnection,syncServices:this.syncServices};if(this.load(this.routes),e&&(e.order&&(this.order=e.order),e.services))for(let r in e.services){let s=e.services[r];if(s instanceof G)s.service.name=r,s.service.tag=r,this.addService(s.service,s.connections,e.includeClassName,e.routeFormat,e.syncServices);else if(typeof s=="function"){let i=new s;i.name=r,i.tag=r,i&&this.addService(i,i.connections,e.includeClassName,e.routeFormat,e.syncServices)}else{if(typeof s.service=="function"){let i=new s.service({name:r});i.name=r,i.tag=r,i&&this.addService(i,void 0,e.includeClassName,e.routeFormat,e.syncServices),s.service=i}else s.service instanceof G&&(s.service.name=r,s.service.tag=r,this.addService(s.service,void 0,e.includeClassName,e.routeFormat,e.syncServices));if(typeof s.service=="object"&&(s.connections&&(Array.isArray(s.connections)?s.connections.forEach(i=>{this.addServiceConnections(s[r].service,i)}):this.addServiceConnections(s.service,s.connections)),s.config))for(let i in s.config)this.openConnection(s.service,s.config[i],s.config[i].source,s.config[i].args)}}}removeUser(e,r){return r&&this.removeConnection(e,r),typeof e=="string"&&(e=this.users[e]),typeof e=="object"&&e._id&&(delete this.users[e._id],e.onclose&&e.onclose(e)),!0}};export{O as EventHandler,N as Graph,y as GraphNode,T as Router,G as Service,R as createNode,C as parseFunctionFromText,P as reconstructNode,j as reconstructObject,_ as state,S as stringifyFast,w as stringifyWithCircularRefs,F as unsafeRoutes};
