function C(c=""){let t=n=>n.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),r=(n=>{let a=n.indexOf("=>")+1;return a<=0&&(a=n.indexOf("){")),a<=0&&(a=n.indexOf(") {")),n.slice(0,n.indexOf("{",a)+1)})(c),i=t(c),s;if(r.includes("function")){let n=r.split("(")[1].split(")")[0];s=new Function(n,i)}else if(r.substring(0,6)===i.substring(0,6)){let n=r.split("(")[1].split(")")[0];s=new Function(n,i.substring(i.indexOf("{")+1,i.length-1))}else try{s=(0,eval)(r+i+"}")}catch{}return s}var O=class{constructor(){this.pushToState={};this.data={};this.triggers={};this.setState=t=>{Object.assign(this.data,t);for(let e of Object.getOwnPropertyNames(t))this.triggers[e]&&this.triggers[e].forEach(r=>r.onchange(this.data[e]));return this.data};this.subscribeTrigger=(t,e)=>{if(t){this.triggers[t]||(this.triggers[t]=[]);let r=this.triggers[t].length;return this.triggers[t].push({idx:r,onchange:e}),this.triggers[t].length-1}else return};this.unsubscribeTrigger=(t,e)=>{let r=this.triggers[t];if(r)if(!e)delete this.triggers[t];else{let i;return r.find((n,a)=>{if(n.idx===e)return i=a,!0})&&r.splice(i,1),!0}};this.subscribeTriggerOnce=(t,e)=>{let r,i=s=>{e(s),this.unsubscribeTrigger(t,r)};r=this.subscribeTrigger(t,i)}}},R=new O;function S(c){this._state||(this._state={});for(let t in c)t==="_state"||t==="graph"||(this._state[t]=c[t],t in this?this[t]=c[t]:Object.defineProperty(this,t,{get:()=>{this._state[t]},set:e=>{this._state[t]=e,this.state.triggers[this._unique]&&this.setState({[this._unique]:this._state})},enumerable:!0,configurable:!0}))}var y=class{constructor(t={},e,r){this.nodes=new Map;this._initial={};this._unique=`${Math.random()}`;this.state=R;this.isLooping=!1;this.isAnimating=!1;this.looper=void 0;this.animation=void 0;this.forward=!0;this.backward=!1;this.reactive=!1;this.runSync=!1;this.firstRun=!0;this.DEBUGNODE=!1;this.addLocalState=S;this.operator=(...t)=>t;this.runOp=(...t)=>{this.DEBUGNODE&&console.time(this.tag);let e=this.operator(...t);return e instanceof Promise?e.then(r=>(r!==void 0&&this.setState({[this.tag]:r}),this.DEBUGNODE&&(console.timeEnd(this.tag),e!==void 0&&console.log(`${this.tag} result:`,e)),r)):(e!==void 0&&this.setState({[this.tag]:e}),this.DEBUGNODE&&(console.timeEnd(this.tag),e!==void 0&&console.log(`${this.tag} result:`,e))),e};this.setOperator=t=>(typeof t!="function"||(this.operator=t.bind(this)),t);this.runAsync=(...t)=>new Promise((e,r)=>{e(this.run(...t))});this.transformArgs=(t=[])=>t;this.isRunSync=()=>!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||this.branch);this.run=(...t)=>{if(typeof this.transformArgs=="function"&&(t=this.transformArgs(t,this)),!(this.firstRun&&(this.firstRun=!1,this.runSync=this.isRunSync(),this.animate&&!this.isAnimating&&this.runAnimation(this.animation,t),this.loop&&typeof this.loop=="number"&&!this.isLooping&&this.runLoop(this.looper,t),this.loop||this.animate)))return this.runSync?this.runOp(...t):new Promise(async e=>{if(this){let r=(s,n=0,...a)=>new Promise(async o=>{n++;let f=await s.runOp(...a);if(s.repeat){for(;n<s.repeat;){if(s.delay){setTimeout(async()=>{o(await r(s,n,...a))},s.delay);break}else if(s.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{o(await r(s,n,...a))});break}else f=await s.runOp(...a);n++}if(n===s.repeat){o(f);return}}else if(s.recursive){for(;n<s.recursive;){if(s.delay){setTimeout(async()=>{o(await r(s,n,...f))},s.delay);break}else if(s.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{o(await r(s,n,...f))});break}else f=await s.runOp(...f);n++}if(n===s.recursive){o(f);return}}else{o(f);return}}),i=async()=>{let s=await r(this,void 0,...t);return s!==void 0&&(this.backward&&this.parent instanceof y&&(Array.isArray(s)?await this.runParent(this,...s):await this.runParent(this,s)),this.children&&this.forward&&(Array.isArray(s)?await this.runChildren(this,...s):await this.runChildren(this,s)),this.branch&&this.runBranch(this,s)),s};this.delay?setTimeout(async()=>{e(await i())},this.delay):this.frame&&window?.requestAnimationFrame?requestAnimationFrame(async()=>{e(await i())}):e(await i())}else e(void 0)})};this.runParent=async(t,...e)=>{t.backward&&t.parent&&(typeof t.parent=="string"&&(t.graph&&t.graph?.get(t.parent)?(t.parent=t.graph,t.parent&&this.nodes.set(t.parent.tag,t.parent)):t.parent=this.nodes.get(t.parent)),t.parent instanceof y&&await t.parent.run(...e))};this.runChildren=async(t,...e)=>{if(typeof t.children=="object")for(let r in t.children)typeof t.children[r]=="string"?(t.graph&&t.graph?.get(t.children[r])&&(t.children[r]=t.graph.get(t.children[r]),t.nodes.get(t.children[r].tag)||t.nodes.set(t.children[r].tag,t.children[r])),!t.children[r]&&t.nodes.get(t.children[r])&&(t.children[r]=t.nodes.get(t.children[r]))):(typeof t.children[r]>"u"||t.children[r]===!0)&&(t.graph&&t.graph?.get(r)&&(t.children[r]=t.graph.get(r),t.nodes.get(t.children[r].tag)||t.nodes.set(t.children[r].tag,t.children[r])),!t.children[r]&&t.nodes.get(r)&&(t.children[r]=t.nodes.get(r))),t.children[r]?.runOp&&await t.children[r].run(...e)};this.runBranch=async(t,e)=>{if(t.branch){let r=Object.keys(t.branch);await Promise.all(r.map(async i=>{typeof t.branch[i].if=="object"&&(t.branch[i].if=j(t.branch[i].if));let s=!1;return typeof t.branch[i].if=="function"?s=t.branch[i].if(e):typeof e=="object"?j(e)===t.branch[i].if&&(s=!0):e===t.branch[i].if&&(s=!0),s&&(t.branch[i].then.run?Array.isArray(e)?await t.branch[i].then.run(...e):await t.branch[i].then.run(...e):typeof t.branch[i].then=="function"?Array.isArray(e)?await t.branch[i].then(...e):await t.branch[i].then(e):typeof t.branch[i].then=="string"&&(t.graph?t.branch[i].then=t.graph.nodes.get(t.branch[i].then):t.branch[i].then=t.nodes.get(t.branch[i].then),t.branch[i].then.run&&(Array.isArray(e)?await t.branch[i].then.run(...e):await t.branch[i].then.run(...e)))),s}))}};this.runAnimation=(t=this.animation,e=[])=>{if(this.animation=t,t||(this.animation=this.operator),this.animate&&!this.isAnimating&&"requestAnimationFrame"in window){this.isAnimating=!0;let r=async()=>{if(this.isAnimating){this.DEBUGNODE&&console.time(this.tag);let i=this.animation.call(this,...e);i instanceof Promise&&(i=await i),this.DEBUGNODE&&(console.timeEnd(this.tag),i!==void 0&&console.log(`${this.tag} result:`,i)),i!==void 0&&(this.tag&&this.setState({[this.tag]:i}),this.backward&&this.parent?.run&&(Array.isArray(i)?await this.runParent(this,...i):await this.runParent(this,i)),this.children&&this.forward&&(Array.isArray(i)?await this.runChildren(this,...i):await this.runChildren(this,i)),this.branch&&this.runBranch(this,i),this.setState({[this.tag]:i})),requestAnimationFrame(r)}};requestAnimationFrame(r)}};this.runLoop=(t=this.looper,e=[],r=this.loop)=>{if(this.looper=t,t||(this.looper=this.operator),typeof r=="number"&&!this.isLooping){this.isLooping=!0;let i=async()=>{if(this.isLooping){this.DEBUGNODE&&console.time(this.tag);let s=this.looper.call(this,...e);s instanceof Promise&&(s=await s),this.DEBUGNODE&&(console.timeEnd(this.tag),s!==void 0&&console.log(`${this.tag} result:`,s)),s!==void 0&&(this.tag&&this.setState({[this.tag]:s}),this.backward&&this.parent?.run&&(Array.isArray(s)?await this.runParent(this,...s):await this.runParent(this,s)),this.children&&this.forward&&(Array.isArray(s)?await this.runChildren(this,...s):await this.runChildren(this,s)),this.branch&&this.runBranch(this,s),this.setState({[this.tag]:s})),setTimeout(async()=>{await i()},r)}};i()}};this.setParent=t=>{this.parent=t,this.backward&&(this.runSync=!1)};this.setChildren=t=>{this.children=t,this.forward&&(this.runSync=!1)};this.add=(t={})=>(typeof t=="function"&&(t={operator:t}),t?.node instanceof y&&(t=t.node),t instanceof y||(t=new y(t.node??t,this,this.graph)),this.nodes.set(t.tag,t),this.graph&&(this.graph.nodes.set(t.tag,t),this.graph.nNodes=this.graph.nodes.size),t);this.remove=t=>{typeof t=="string"&&(t=this.nodes.get(t)),t?.tag&&(this.nodes.delete(t.tag),this.children[t.tag]&&delete this.children[t.tag],this.graph&&(this.graph.nodes.delete(t.tag),this.graph.nNodes=this.graph.nodes.size),this.nodes.forEach(e=>{e.nodes.get(e.tag)&&(e.nodes.delete(e.tag),e.children[e.tag]&&delete e.children[e.tag],e.parent?.tag===e.tag&&delete e.parent)}),t.ondelete&&t.ondelete(t)),typeof this._state=="object"&&this.state.unsubscribeTrigger(this._unique)};this.append=(t,e=this)=>{typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes&&(e.addChildren(t),t.forward&&(t.runSync=!1))};this.subscribe=(t,e=this.tag)=>{if(typeof t=="string"&&(this.graph?t=this.graph.get(t):t=this.nodes.get(t)),typeof t=="function")return this.state.subscribeTrigger(e,t);if(t)return this.state.subscribeTrigger(e,r=>{t.run(r)})};this.unsubscribe=(t,e=this.tag)=>this.state.unsubscribeTrigger(e,t);this.subscribeState=t=>{if(this.reactive){if(typeof t=="string"&&(this.graph?t=this.graph.get(t):t=this.nodes.get(t)),typeof t=="function")return this.state.subscribeTrigger(this._unique,t);if(t)return this.state.subscribeTrigger(this._unique,e=>{t.run(e)})}else return};this.addChildren=t=>{this.children||(this.children={}),typeof t=="object"&&Object.assign(this.children,t),this.convertChildrenToNodes(),this.forward&&(this.runSync=!1)};this.callParent=(...t)=>{if(typeof this.parent=="string"&&(this.graph&&this.graph?.get(this.parent)?(this.parent=this.graph,this.parent&&this.nodes.set(this.parent.tag,this.parent)):this.parent=this.nodes.get(this.parent)),typeof this.parent?.operator=="function")return this.parent.runOp(...t)};this.callChildren=(...t)=>{let e;if(typeof this.children=="object")for(let r in this.children)this.children[r]?.runOp&&this.children[r].runOp(...t);return e};this.getProps=(t=this,e=!0)=>{let r={tag:t.tag,operator:t.operator,graph:t.graph,children:t.children,parent:t.parent,forward:t.forward,backward:t.bacward,loop:t.loop,animate:t.animate,frame:t.frame,delay:t.delay,recursive:t.recursive,repeat:t.repeat,branch:t.branch,oncreate:t.oncreate,reactive:t.reactive,DEBUGNODE:t.DEBUGNODE};if(e)return{tag:t.tag,operator:t.operator,graph:t.graph,children:t.children,parent:t.parent,forward:t.forward,backward:t.bacward,loop:t.loop,animate:t.animate,frame:t.frame,delay:t.delay,recursive:t.recursive,repeat:t.repeat,branch:t.branch,oncreate:t.oncreate,reactive:t.reactive,DEBUGNODE:t.DEBUGNODE,...this._initial};{let i={};for(let s in this._initial)i[s]=this[s];return Object.assign(r,i)}};this.setProps=(t={})=>{let e=Object.assign({},t);e.children&&(this.addChildren(t.children),delete e.children),e.operator&&(this.setOperator(t.operator),delete e.operator),Object.assign(e,t),this.runSync=this.isRunSync()};this.removeTree=t=>{if(t&&typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes){let e={},r=i=>{if(typeof i.children=="object"&&!e[i.tag]){e[i.tag]=!0;for(let s in i.children)i.children[s].stopNode&&i.children[s].stopNode(),i.children[s].tag&&(this.nodes.get(i.children[s].tag)&&this.nodes.delete(i.children[s].tag),this.nodes.forEach(n=>{n.nodes.get(i.children[s].tag)&&n.nodes.delete(i.children[s].tag),n.children?.[s]instanceof y&&delete n.children[s]}),i.children[s].ondelete&&!this.graph&&i.children[s].ondelete(i.children[s]),r(i.children[s]))}};t.stopNode&&t.stopNode(),t.tag&&(this.nodes.delete(t.tag),this.children?.[t.tag]&&delete this.children[t.tag],this.parent?.tag===t.tag&&delete this.parent,this[t.tag]instanceof y&&delete this[t.tag],this.nodes.forEach(i=>{i?.tag&&(i.nodes.get(i.tag)&&i.nodes.delete(i.tag),i.children?.[i.tag]instanceof y&&delete i.children[i.tag])}),r(t),this.graph?this.graph.removeTree(t,e):t.ondelete&&t.ondelete(t))}};this.checkNodesHaveChildMapped=(t,e,r={})=>{let i=t.tag;i||(i=t.name),r[i]||(r[i]=!0,t.children&&e.tag in t.children&&t.children[e.tag]instanceof y&&(t.nodes.get(e.tag)||t.nodes.set(e.tag,e),t.children[e.tag]=e,t.firstRun||(t.firstRun=!0)),t.parent instanceof y&&(t.nodes.get(e.tag)&&t.parent.nodes.set(e.tag,e),t.parent.children?this.checkNodesHaveChildMapped(t.parent,e,r):t.nodes&&t.nodes.forEach(s=>{r[s.tag]||this.checkNodesHaveChildMapped(s,e,r)})),t.graph&&t.parent&&t.parent.name!==t.graph.name&&t.graph.nodes.forEach(s=>{r[s.tag]||this.checkNodesHaveChildMapped(s,e,r)}))};this.convertChildrenToNodes=(t=this)=>{if(t?.children){for(let e in t.children)if(!(t.children[e]instanceof y))if(typeof t.children[e]=="object")t.children[e].tag||(t.children[e].tag=e),t.nodes.get(t.children[e].tag)||(t.children[e]=new y(t.children[e],t,t.graph),this.checkNodesHaveChildMapped(t,t.children[e]));else{if(typeof t.children[e]>"u"||t.children[e]==!0)t.children[e]=t.graph.get(e),t.children[e]||(t.children[e]=t.nodes.get(e));else if(typeof t.children[e]=="string"){let r=t.children[e];t.children[e]=t.graph.get(r),t.children[e]||(t.children[e]=t.nodes.get(e))}t.children[e]instanceof y&&(t.nodes.set(t.children[e].tag,t.children[e]),this.checkNodesHaveChildMapped(t,t.children[e]),t.children[e].tag in t||(t[t.children[e].tag]=t.children[e]))}}return t.children};this.stopLooping=(t=this)=>{t.isLooping=!1};this.stopAnimating=(t=this)=>{t.isAnimating=!1};this.stopNode=(t=this)=>{t.stopAnimating(t),t.stopLooping(t)};this.subscribeNode=t=>{if(typeof t=="string"&&(t=this.nodes.get(t)),t.tag&&this.nodes.set(t.tag,t),t)return this.state.subscribeTrigger(this.tag,e=>{Array.isArray(e)?t.run(...e):t.run(e)})};this.print=(t=this,e=!0,r=[])=>{let i=new y;if(typeof t=="string"&&(t=this.nodes.get(t)),t instanceof y){r.push(t.tag);let s={tag:t.tag,operator:t.operator.toString()};if(t.parent&&(s.parent=t.parent.tag),typeof t.children=="object")for(let n in t.children)return typeof t.children[n]=="string"?t.children[n]:r.includes(t.children[n].tag)?t.children[n].tag:e?t.children[n].print(t.children[n],e,r):t.children[n].tag;for(let n in t)n==="parent"||n==="children"||typeof i[n]>"u"&&(typeof t[n]=="function"?s[n]=t[n].toString():typeof t[n]=="object"?s[n]=JSON.stringifyWithCircularRefs(t[n]):s[n]=t[n]);return JSON.stringify(s)}};this.reconstruct=t=>{let e=A(t);if(e)return this.add(e)};this.setState=t=>{this.state.setState(t)};this.DEBUGNODES=(t=!0)=>{this.DEBUGNODE=t,this.nodes.forEach(e=>{t?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};if(typeof t=="function"&&(t={operator:t}),typeof t=="object"){if(t instanceof y&&t._initial&&Object.assign(t,t._initial),t instanceof v){let s=t;t={source:s,operator:n=>{if(typeof n=="object"){let a={};for(let o in n)typeof s[o]=="function"?Array.isArray(n[o])?a[o]=s[o](...n[o]):a[o]=s[o](n[o]):(s[o]=n[o],a[o]=s[o]);return a}return s}},s.operator&&(t.operator=s.operator),s.children&&(t.children=s.children),s.forward&&(t.forward=s.forward),s.backward&&(t.backward=s.backward),s.repeat&&(t.repeat=s.repeat),s.recursive&&(t.recursive=s.recursive),s.loop&&(t.loop=s.loop),s.animate&&(t.animate=s.animate),s.looper&&(t.looper=s.looper),s.animation&&(t.animation=s.animation),s.delay&&(t.delay=s.delay),s.oncreate&&(t.oncreate=s.oncreate),s.node&&s.node._initial&&Object.assign(t,s.node._initial),s._initial&&Object.assign(t,s._initial),s.tag&&(t.tag=s.tag),this.nodes=s.nodes,s.node=this,r&&s.nodes.forEach(n=>{r.nodes.get(n.tag)||(r.nodes.set(n.tag,n),r.nNodes++)})}if(typeof e=="string"&&(r?e=r.nodes.get(e):e=void 0),t.tag&&(r||e)){let s;if(r?.nodes&&(s=r.nodes.get(t.tag)),!s&&e?.nodes&&(s=e.nodes.get(t.tag)),s){this.reactive&&this.addLocalState(s),this.source||(this.source=s);let n=s.getProps();delete n.graph,delete n.parent;for(let a in n){let o=Object.getOwnPropertyDescriptor(t,a);o&&o.get&&!o.set?t=Object.assign({},t):t[a]=n[a]}}}t?.operator&&(t.operator=this.setOperator(t.operator)),!t.tag&&r?t.tag=`node${r.nNodes}`:t.tag||(t.tag=`node${Math.floor(Math.random()*1e10)}`);let i=Object.getOwnPropertyNames(this);for(let s in t)i.includes(s)||(this._initial[s]=t[s]);if(t.children&&(this._initial.children=Object.assign({},t.children)),Object.assign(this,t),this.tag||(r?this.tag=`node${r.nNodes}`:this.tag=`node${Math.floor(Math.random()*1e10)}`),r&&(this.graph=r,r.nodes.get(this.tag)&&(this.tag=`${this.tag}${r.nNodes+1}`),r.nodes.set(this.tag,this),r.nNodes++,this.state=r.state),this.reactive&&(S(t),typeof this.reactive=="function"&&this.state.subscribeTrigger(this._unique,this.reactive)),typeof e=="object"&&(this.parent=e,(e instanceof y||e instanceof v)&&e.nodes.set(this.tag,this)),typeof t.tree=="object")for(let s in t.tree){typeof t.tree[s]=="object"&&(!t.tree[s]).tag&&(t.tree[s].tag=s);let n=new y(t.tree[s],this,r);this.nodes.set(n.tag,n)}this.children&&this.convertChildrenToNodes(this),(this.parent instanceof y||this.parent instanceof v)&&this.checkNodesHaveChildMapped(this.parent,this),typeof this.oncreate=="function"&&this.oncreate(this),this.firstRun||(this.firstRun=!0),this.animation&&!this.animate&&(this.animate=!0)}else return t}},v=class{constructor(t,e,r){this.nNodes=0;this.nodes=new Map;this.state=new O;this._unique=`${Math.random()}`;this.tree={};this.addLocalState=S;this.add=(t={})=>{t?.node instanceof y&&(t=t.node);let e=t;return t instanceof y?(this.nNodes=this.nodes.size,t.tag&&(this.tree[t.tag]=e,this.nodes.set(t.tag,t))):t=new y(e?.node??e,this,this),t};this.setTree=(t=this.tree)=>{if(!!t){for(let e in t){let r=this.nodes.get(e);if(r){if(typeof t[e]=="function")r.setOperator(t[e]);else if(typeof t[e]=="object")if(t[e]instanceof y)this.add(t[e]);else if(t[e]instanceof v){let i=t[e],s={};i.operator&&(s.operator=i.operator),i.children&&(s.children=i.children),i.forward&&(s.forward=i.forward),i.backward&&(s.backward=i.backward),i.repeat&&(s.repeat=i.repeat),i.recursive&&(s.recursive=i.recursive),i.loop&&(s.loop=i.loop),i.animate&&(s.animate=i.animate),i.looper&&(s.looper=i.looper),i.animation&&(s.animation=i.animation),i.delay&&(s.delay=i.delay),i.tag&&(s.tag=i.tag),i.oncreate&&(s.oncreate=i.oncreate),i.node?._initial&&Object.assign(s,i.node._initial),s.nodes=i.nodes,s.source=i,r.setProps(s)}else r.setProps(t[e])}else if(typeof t[e]=="function")this.add({tag:e,operator:t[e]});else if(typeof t[e]=="object"&&!Array.isArray(t[e])){t[e].tag||(t[e].tag=e);let i=this.add(t[e]);t[e].aliases&&t[e].aliases.forEach(s=>{this.nodes.set(s,i)})}else this.add({tag:e,operator:(...i)=>t[e]})}this.nodes.forEach(e=>{if(typeof e.children=="object")for(let r in e.children)typeof e.children[r]=="string"?this.nodes.get(e.children[r])&&(e.children[r]=this.nodes.get(e.children[r])):(e.children[r]===!0||typeof e.children[r]>"u")&&this.nodes.get(r)&&(e.children[r]=this.nodes.get(r)),e.children[r]instanceof y&&e.checkNodesHaveChildMapped(e,e.children[r]);typeof e.parent=="string"&&this.nodes.get(e.parent)&&(e.parent=this.nodes.get(e.parent),e.nodes.set(e.parent.tag,e.parent))})}};this.get=t=>this.nodes.get(t);this.set=t=>this.nodes.set(t.tag,t);this.run=(t,...e)=>{if(typeof t=="string"&&(t=this.nodes.get(t)),t?.run)return t.run(...e)};this.runAsync=(t,...e)=>(typeof t=="string"&&(t=this.nodes.get(t)),t?.run?new Promise((r,i)=>{r(t.run(...e))}):new Promise((r,i)=>{r(void 0)}));this.removeTree=(t,e)=>{if(t&&typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes){let r={},i=s=>{if(typeof s.children=="object"&&!r[s.tag]){r[s.tag]=!0;for(let n in s.children)s.children[n]?.stopNode&&s.children[n].stopNode(),s.children[n]?.tag&&(this.nodes.get(s.children[n].tag)&&this.nodes.delete(s.children[n].tag),this.nodes.forEach(a=>{a.nodes.get(s.children[n].tag)&&a.nodes.delete(s.children[n].tag),a.children?.[n]instanceof y&&delete a.children[n]}),s.children[n].ondelete&&s.children[n].ondelete(s.children[n]),i(s.children[n]))}};t.stopNode&&t.stopNode(),t.tag&&(this.nodes.delete(t.tag),this.parent?.tag===t.tag&&delete this.parent,this[t.tag]instanceof y&&delete this[t.tag],this.nodes.forEach(s=>{s?.tag&&(s.nodes.get(s.tag)&&s.nodes.delete(s.tag),s.children?.[s.tag]instanceof y&&delete s.children[s.tag])}),i(t),t.ondelete&&t.ondelete(t))}};this.remove=t=>(typeof t=="string"&&(t=this.nodes.get(t)),t?.nodes&&(t.stopNode&&t.stopNode(),t?.tag&&this.nodes.get(t.tag)&&(this.nodes.delete(t.tag),this.nodes.forEach(e=>{e.nodes.get(e.tag)&&e.nodes.delete(e.tag)})),t.ondelete&&t.ondelete(t)),t);this.append=(t,e)=>{e.addChildren(t)};this.callParent=async(t,...e)=>{if(t?.parent)return await t.callParent(...e)};this.callChildren=async(t,...e)=>{if(t?.children)return await t.callChildren(...e)};this.subscribe=(t,e)=>{if(!!e){if(t?.subscribe&&typeof e=="function")return t.subscribe(e);if(e instanceof y||typeof e=="string")return this.subscribeNode(t,e);if(typeof t=="string")return this.state.subscribeTrigger(t,e)}};this.unsubscribe=(t,e)=>this.state.unsubscribeTrigger(t,e);this.subscribeState=t=>{if(this.reactive){if(typeof t=="string"&&(this.graph?t=this.graph.get(t):t=this.nodes.get(t)),typeof t=="function")return this.state.subscribeTrigger(this._unique,t);if(t)return this.state.subscribeTrigger(this._unique,e=>{t.run(e)})}else return};this.subscribeNode=(t,e)=>{let r;if(t?.tag?r=t.tag:typeof t=="string"&&(r=t),typeof e=="string"&&(e=this.nodes.get(e)),t&&e)return this.state.subscribeTrigger(r,s=>{Array.isArray(s)?e.run(...s):e.run(s)})};this.stopNode=t=>{typeof t=="string"&&(t=this.nodes.get(t)),t?.stopNode&&t.stopNode()};this.print=(t,e=!0)=>{if(t?.print)return t.print(t,e);{let r="{";return this.nodes.forEach(i=>{r+=`
"${i.tag}:${i.print(i,e)}"`}),r}};this.reconstruct=t=>{let e=A(t);if(e)return this.add(e)};this.create=(t,e,r)=>P(t,e,r,this);this.setState=t=>{this.state.setState(t)};this.DEBUGNODES=(t=!0)=>{this.nodes.forEach(e=>{t?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};this.tag=e||`graph${Math.floor(Math.random()*1e11)}`,r&&(console.log(r,r.constructor.name),r.reactive?this.addLocalState(r):Object.assign(this,r),this._initial=r),(t||Object.keys(this.tree).length>0)&&this.setTree(t)}};function E(c,t,e){let r=A(c);if(r)return new y(r,t,e)}function A(c="{}"){try{let t=typeof c=="string"?JSON.parse(c):c,e=r=>{for(let i in r)if(typeof r[i]=="string"){let s=C(r[i]);typeof s=="function"&&(r[i]=s)}else typeof r[i]=="object"&&e(r[i]);return r};return e(t)}catch(t){console.error(t);return}}var w=function(){let c=new Map,t=[],e=["this"];function r(){c.clear(),t.length=0,e.length=1}function i(n,a){var o=t.length-1,f=t[o];if(typeof f=="object")if(f[n]===a||o===0)e.push(n),t.push(a.pushed);else for(;o-->=0;){if(f=t[o],typeof f=="object"&&f[n]===a){o+=2,t.length=o,e.length=o,--o,t[o]=a,e[o]=n;break}o--}}function s(n,a){if(a!=null&&typeof a=="object"){n&&i(n,a);let o=c.get(a);if(o)return"[Circular Reference]"+o;c.set(a,e.join("."))}return a}return function(a,o){try{return t.push(a),JSON.stringify(a,s,o)}finally{r()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=w);var j=function(){let c=new Map,t=[],e=["this"];function r(){c.clear(),t.length=0,e.length=1}function i(n,a){var o=t.length-1;if(t[o]){var f=t[o];if(typeof f=="object")if(f[n]===a||o===0)e.push(n),t.push(a.pushed);else for(;o-->=0;){if(f=t[o],typeof f=="object"&&f[n]===a){o+=2,t.length=o,e.length=o,--o,t[o]=a,e[o]=n;break}o++}}}function s(n,a){let o;if(a!=null)if(typeof a=="object"){let f=a.constructor.name;n&&f==="Object"&&i(n,a);let b=c.get(a);if(b)return"[Circular Reference]"+b;if(c.set(a,e.join(".")),f==="Array")a.length>20?o=a.slice(a.length-20):o=a;else if(f.includes("Set"))o=Array.from(a);else if(f!=="Object"&&f!=="Number"&&f!=="String"&&f!=="Boolean")o="instanceof_"+f;else if(f==="Object"){let h={};for(let l in a)if(a[l]==null)h[l]=a[l];else if(Array.isArray(a[l]))a[l].length>20?h[l]=a[l].slice(a[l].length-20):h[l]=a[l];else if(a[l].constructor.name==="Object"){h[l]={};for(let g in a[l])if(Array.isArray(a[l][g]))a[l][g].length>20?h[l][g]=a[l][g].slice(a[l][g].length-20):h[l][g]=a[l][g];else if(a[l][g]!=null){let u=a[l][g].constructor.name;u.includes("Set")?h[l][g]=Array.from(a[l][g]):u!=="Number"&&u!=="String"&&u!=="Boolean"?h[l][g]="instanceof_"+u:h[l][g]=a[l][g]}else h[l][g]=a[l][g]}else{let g=a[l].constructor.name;g.includes("Set")?h[l]=Array.from(a[l]):g!=="Number"&&g!=="String"&&g!=="Boolean"?h[l]="instanceof_"+g:h[l]=a[l]}o=h}else o=a}else o=a;return o}return function(a,o){t.push(a);let f=JSON.stringify(a,s,o);return r(),f}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=j);function P(c,t,e,r){return typeof e=="object"?(e.operator=c,new y(e,t,r)):new y({operator:c},t,r)}var G=class extends v{constructor(e={}){super(void 0,e.name?e.name:`service${Math.floor(Math.random()*1e14)}`,e.props);this.routes={};this.loadDefaultRoutes=!1;this.keepState=!0;this.firstLoad=!0;this.customRoutes={};this.customChildren={};this.init=e=>{e?e=Object.assign({},e):e={},e.customRoutes?Object.assign(e.customRoutes,this.customRoutes):e.customRoutes=this.customRoutes,e.customChildren?Object.assign(e.customChildren,this.customChildren):e.customChildren=this.customChildren,Array.isArray(e.routes)?e.routes.forEach(r=>{this.load(r,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren,e.sharedState)}):(e.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)&&this.load(e.routes,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren,e.sharedState)};this.load=(e,r=!0,i=".",s=this.customRoutes,n=this.customChildren,a=!0)=>{if(!e&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;this.firstLoad&&(this.firstLoad=!1),s?s=Object.assign(this.customRoutes,s):s=this.customRoutes;let o,f={};if(e){if(!(e instanceof v)&&e?.name&&!e.setTree)if(e.module){let h=e;e={},Object.getOwnPropertyNames(e.module).forEach(l=>{r?e[h.name+i+l]=e.module[l]:e[l]=e.module[l]})}else typeof e=="function"&&(o=new e({loadDefaultRoutes:this.loadDefaultRoutes}),o.load(),a&&(o.state=this.state),e=o.routes,o.customRoutes&&!this.customRoutes?this.customRoutes=o.customRoutes:o.customRoutes&&this.customRoutes&&Object.assign(this.customRoutes,o.customRoutes),o.customChildren&&!this.customChildren?this.customChildren=o.customChildren:o.customChildren&&this.customChildren&&Object.assign(this.customChildren,o.customChildren));else if(e instanceof v||e.source instanceof v||e.setTree){if(o=e,e={},a&&(o.state=this.state),r){let h=o.name;h||(h=o.tag,o.name=h),h||(h=`graph${Math.floor(Math.random()*1e15)}`,o.name=h,o.tag=h)}o.customRoutes&&!this.customRoutes?this.customRoutes=o.customRoutes:o.customRoutes&&this.customRoutes&&Object.assign(this.customRoutes,o.customRoutes),o.customChildren&&!this.customChildren?this.customChildren=o.customChildren:o.customChildren&&this.customChildren&&Object.assign(this.customChildren,o.customChildren),o.nodes.forEach(h=>{e[h.tag]=h;let l={},g=(u,p)=>{if((!l[u.tag]||p&&r&&!l[p?.tag+i+u.tag])&&(p?l[p.tag+i+u.tag]=!0:l[u.tag]=!0,u instanceof v||u.source instanceof v||u.setTree)){if(a&&(u.state=this.state),r){let d=u.name;d||(d=u.tag,u.name=d),d||(d=`graph${Math.floor(Math.random()*1e15)}`,u.name=d,u.tag=d)}u.nodes.forEach(d=>{r&&!e[u.tag+i+d.tag]?e[u.tag+i+d.tag]=d:e[d.tag]||(e[d.tag]=d),g(d,u)})}};g(h)})}else if(typeof e=="object"){let h=e.constructor.name;if(h==="Object"&&(h=Object.prototype.toString.call(e),h&&(h=h.split(" ")[1]),h&&(h=h.split("]")[0])),h&&h!=="Object"){let l=e;e={},Object.getOwnPropertyNames(l).forEach(g=>{r?e[h+i+g]=l[g]:e[g]=l[g]})}}if((o instanceof v||o?.setTree)&&o.name&&r){e=Object.assign({},e);for(let h in e){let l=e[h];delete e[h],e[o.name+i+h]=l}}}if(this.loadDefaultRoutes){let h=Object.assign({},this.defaultRoutes);e?(Object.assign(h,this.routes),e=Object.assign(h,e)):e=Object.assign(h,this.routes),this.loadDefaultRoutes=!1}e||(e=this.routes);let b=0;for(let h in e){b++;let l=(g,u)=>{if(typeof g=="object"&&(g.tag||(g.tag=u),typeof g?.children=="object")){e:for(let p in g.children)if(b++,typeof g.children[p]=="object"){let d=g.children[p];if(d.tag&&f[d.tag])continue;if(n){for(let N in n)if(d=n[N](d,p,g,e,f),!d)continue e}d.id&&!d.tag&&(d.tag=d.id);let m;if(d.tag)if(f[d.tag]){let N=`${d.tag}${b}`;f[N]=d,d.tag=N,l(f[N],p),m=N}else f[d.tag]=d,l(f[d.tag],p),m=d.tag;else if(f[p]){let N=`${p}${b}`;f[N]=d,d.tag=N,l(f[N],p),m=N}else f[p]=d,l(f[p],p),m=p;o?.name&&r?(f[o.name+i+m]=d,delete f[m]):f[m]=d}}};f[h]=e[h],l(e[h],h)}e:for(let h in f)if(typeof f[h]=="object"){let l=f[h];if(typeof l=="object"){if(s){for(let g in s)if(l=s[g](l,h,f),!l)continue e}l.get&&l.get,l.post,l.delete,l.put,l.head,l.patch,l.options,l.connect,l.trace,l.post&&!l.operator?f[h].operator=l.post:!l.operator&&typeof l.get=="function"&&(f[h].operator=l.get)}}for(let h in e)typeof e[h]=="object"?this.routes[h]?typeof this.routes[h]=="object"?Object.assign(this.routes[h],e[h]):this.routes[h]=e[h]:this.routes[h]=e[h]:this.routes[h]?typeof this.routes[h]=="object"?Object.assign(this.routes[h],e[h]):this.routes[h]=e[h]:this.routes[h]=e[h];if(o)for(let h in this.routes)(this.routes[h]instanceof y||this.routes[h].constructor.name.includes("GraphNode"))&&(this.nodes.set(h,this.routes[h]),this.nNodes=this.nodes.size);else this.setTree(this.routes);for(let h in e)e[h]?.aliases&&e[h].aliases.forEach(g=>{o?.name&&r?this.routes[o.name+i+g]=e[h]:this.routes[g]=e[h]});return this.routes};this.unload=(e=this.routes)=>{if(!e)return;let r;!(e instanceof G)&&typeof e=="function"?(r=new G,e=r.routes):e instanceof G&&(e=e.routes);for(let i in e)delete this.routes[i],this.nodes.get(i)&&this.remove(i);return this.routes};this.handleMethod=(e,r,i)=>{let s=r.toLowerCase(),n=this.nodes.get(e);return n||(n=this.routes[e],n||(n=this.tree[e])),n?.[s]?n[s]instanceof Function?n[s](i):(i&&(n[s]=i),n[s]):this.handleServiceMessage({route:e,args:i,method:r})};this.transmit=(...e)=>typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e;this.receive=(...e)=>{if(e[0]&&typeof e[0]=="string"){let r=e[0].substring(0,8);(r.includes("{")||r.includes("["))&&(r.includes("\\")&&(e[0]=e[0].replace(/\\/g,"")),e[0][0]==='"'&&(e[0]=e[0].substring(1,e[0].length-1)),e[0]=JSON.parse(e[0]))}return typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e};this.pipe=(e,r,i,s,n)=>{if(e instanceof y)return n?e.subscribe(a=>{let o=n(a);o!==void 0?this.transmit({route:r,args:o,method:s}):this.transmit({route:r,args:a,method:s},i)}):this.subscribe(e,a=>{this.transmit({route:r,args:a,method:s},i)});if(typeof e=="string")return this.subscribe(e,a=>{this.transmit({route:r,args:a,method:s},i)})};this.pipeOnce=(e,r,i,s,n)=>{if(e instanceof y)return n?e.state.subscribeTriggerOnce(e.tag,a=>{let o=n(a);o!==void 0?this.transmit({route:r,args:o,method:s}):this.transmit({route:r,args:a,method:s},i)}):this.state.subscribeTriggerOnce(e.tag,a=>{this.transmit({route:r,args:a,method:s},i)});if(typeof e=="string")return this.state.subscribeTriggerOnce(e,a=>{this.transmit({route:r,args:a,method:s},i)})};this.terminate=(...e)=>{this.nodes.forEach(r=>{r.stopNode()})};this.recursivelyAssign=(e,r)=>{for(let i in r)typeof r[i]=="object"&&!Array.isArray(r[i])?typeof e[i]=="object"&&!Array.isArray(e[i])?this.recursivelyAssign(e[i],r[i]):e[i]=this.recursivelyAssign({},r[i]):e[i]=r[i];return e};this.defaultRoutes={"/":{get:()=>this.print(),aliases:[""]},ping:()=>(console.log("ping"),"pong"),echo:(...e)=>(this.transmit(...e),e),assign:e=>typeof e=="object"?(Object.assign(this,e),!0):!1,recursivelyAssign:e=>typeof e=="object"?(this.recursivelyAssign(this,e),!0):!1,log:{post:(...e)=>{console.log("Log: ",...e)},aliases:["info"]},error:e=>{let r=new Error(e);return console.error(e),r},state:e=>e?this.state.data[e]:this.state.data,printState:e=>e?w(this.state.data[e]):w(this.state.data),spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};e.name?this.name=e.name:e.name=this.tag,"loadDefaultRoutes"in e&&(this.loadDefaultRoutes=e.loadDefaultRoutes,this.routes=Object.assign(this.defaultRoutes,this.routes)),(e||Object.keys(this.routes).length>0)&&this.init(e)}handleServiceMessage(e){let r;return typeof e=="object"&&(e.route?r=e.route:e.node&&(r=e.node)),r?Array.isArray(e.args)?this.run(r,...e.args):this.run(r,e.args):e}handleGraphNodeCall(e,r){if(!e)return r;if(r?.args)this.handleServiceMessage(r);else return Array.isArray(r)?this.run(e,...r):this.run(e,r)}isTypedArray(e){return ArrayBuffer.isView(e)&&Object.prototype.toString.call(e)!=="[object DataView]"}spliceTypedArray(e,r,i){let s=e.subarray(0,r),n;i&&(n=e.subarray(i+1));let a;return(s.length>0||n?.length>0)&&(a=new e.constructor(s.length+n.length)),s.length>0&&a.set(s),n&&n.length>0&&a.set(n,s.length),a}};var B={setRoute:function(c,t){if(typeof c=="string"&&(c=C(c)),typeof c=="function"){if(t||(t=c.name),this.graph.get(t))this.graph.get(t).setOperator(c.bind(this.graph.get(t)));else{let e=this.graph.add({tag:t,operator:c});this.graph instanceof G&&this.graph.load({[t]:e})}return!0}return!1},setNode:function(c,t){return typeof c=="string"&&(c=C(c)),typeof c=="function"?(t||(t=c.name),this.graph.get(t)?this.graph.get(t).setOperator(c):this.graph.add({tag:t,operator:c}),!0):!1},setMethod:function(c,t,e){return typeof t=="string"&&(t=C(t)),typeof t=="function"?(e||(e=t.name),this.graph.get(c)?this.graph.get(c)[e]=t:this.graph.add({tag:e,[e]:t}),!0):!1},assignRoute:function(c,t){this.graph.get(c)&&typeof t=="object"&&Object.assign(this.graph.get(c),t)},transferClass:(c,t)=>{if(typeof c=="object"){let e=c.toString();return{route:"receiveClass",args:[e,t]}}return!1},receiveClass:function(c,t){if(typeof c=="string"&&c.indexOf("class")===0){let e=(0,eval)("("+c+")"),r=t;return r||(r=e.name),this.graph[r]=e,!0}return!1},setGlobal:(c,t)=>(globalThis[c]=t,!0),assignGlobalObject:(c,t)=>globalThis[c]?(typeof t=="object"&&Object.assign(globalThis[c],t),!0):!1,setValue:function(c,t){return this.graph[c]=t,!0},assignObject:function(c,t){return this.graph[c]?(typeof t=="object"&&Object.assign(this.graph[c],t),!0):!1},setGlobalFunction:(c,t)=>(typeof c=="string"&&(c=C(c)),typeof c=="function"?(t||(t=c.name),globalThis[t]=c,!0):!1),assignFunctionToGlobalObject:function(c,t,e){return globalThis[c]?(typeof t=="string"&&(t=C(t)),typeof t=="function"?(e||(e=t.name),this.graph[c][e]=t,!0):!1):!1},setFunction:function(c,t){return typeof c=="string"&&(c=C(c)),typeof c=="function"?(t||(t=c.name),this.graph[t]=c,!0):!1},assignFunctionToObject:function(c,t,e){return this.graph[c]?(typeof t=="string"&&(t=C(t)),typeof t=="function"?(e||(e=t.name),this.graph[c][e]=t,!0):!1):!1}};var T=class extends G{constructor(e){super(e);this.name="router";this.connections={};this.sources={};this.services={};this.serviceConnections={};this.users={};this.addUser=async(e,r,i,s)=>{e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`);let n=Object.assign({},e);if(r){for(let u in r)typeof r[u]=="object"&&(r[u].connection._id||await new Promise((p,d)=>{let m=performance.now(),N=()=>{r[u].connection._id?p(!0):performance.now()-m>3e3?(delete r[u],d(!1)):setTimeout(()=>{N()},100)};N()}).catch(p=>{console.error("Connections timed out:",p)}));for(let u in r)r[u]=this.addConnection(r[u],n._id)}if(i)for(let u in i)this.openConnection(i[u].service,i[u],n._id,i[u].args);let a=(u,...p)=>{let d=this.getConnection(n._id,"send");if(d?.send)return d.send(u,...p)},o=(u,p,...d)=>{let m=this.getConnection(n._id,"request");if(m?.request)return m.request(u,p,...d)},f=(u,p,d,...m)=>{let N=this.getConnection(n._id,"post");if(N?.post)return N.post(u,p,d,...m)},b=(u,p,d,...m)=>{let N=this.getConnection(n._id,"run");if(N?.run)return N.run(u,p,d,...m)},h=(u,p,...d)=>{let m=this.getConnection(n._id,"subscribe");if(m?.subscribe)return m.subscribe(u,p,...d)},l=(u,p,...d)=>{let m=this.getConnection(n._id,"unsubscribe");if(m?.unsubscribe)return m.unsubscribe(u,p,...d)},g=()=>this.removeUser(n);if(n.send=a,n.request=o,n.post=f,n.run=b,n.subscribe=h,n.unsubscribe=l,n.terminate=g,this.users[n._id]=n,r&&!s){let u={},p=!1;Object.keys(r).map((d,m)=>{r[d]?._id&&(u[`${m}`]=r[d]?._id,p=!0)}),p&&n.send({route:"addUser",args:[{_id:n._id},u,void 0,!0]})}return n};this.getConnection=(e,r)=>{if(this.sources[e])if(this.order)for(let i=0;i<this.order.length;i++){let s=this.order[i];for(let n in this.sources[e])if(this.sources[e][n].service){if(typeof this.sources[e][n].service=="object"){if(this.sources[e][n].service.tag===s){if(this.sources[e][n].connectionType&&this.sources[e][n].service?.name&&!this.serviceConnections[this.sources[e][n].service.name]){this.removeConnection(this.sources[e][n]);continue}return this.sources[e][n]}}else if(this.sources[e][n].service===s){if(this.sources[e][n].connectionType&&this.sources[e][n].service?.name){this.serviceConnections[this.sources[e][n].service.name]||this.removeConnection(this.sources[e][n]);continue}return this.sources[e][n]}}}else for(let i in this.sources[e]){if(this.sources[e][i].connectionType&&this.sources[e][i].service?.name&&!this.serviceConnections[this.sources[e][i].service.name]){this.removeConnection(this.sources[e][i]);continue}return r&&this.sources[e][i][r]?this.sources[e][i]:this.sources[e][i]}else if(this.order)for(let i=0;i<this.order.length;i++){let s=this.order[i];if(this.sources[s]?.[e]){if(this.sources[s][e].connectionType&&this.sources[s][e].service?.name&&!this.serviceConnections[this.sources[s][e].service.service.name]){this.removeConnection(this.sources[s][e].service);continue}return r&&this.sources[s][e]?.[r]?this.sources[s][e]:this.sources[s][e]}}if(typeof e=="string"&&this.connections[e]&&this.connections[e].send)return this.connections[e]};this.getConnections=(e,r,i)=>{if(this.sources[e]){if(!i&&!r)return this.sources[e];let s={};for(let n in this.sources[e])if(typeof this.sources[e][n]=="object"){if(this.sources[e][n]._id){let a=!0;r&&!this.sources[e][n][r]&&(a=!1);for(let o in i)if(typeof this.sources[e][n][o]=="object"&&typeof i[o]=="object"){for(let f in i[o])if(i[o][f]!==this.sources[e][n][o][f]){a=!1;break}}else if(this.sources[e][n][o]!==i[o])a=!1;else{a=!1;break}a&&this.getConnection(this.sources[e][n],r)&&(s[this.sources[e][n]._id]=this.sources[e][n])}else for(let a in this.sources[e][n])if(typeof this.sources[e][n][a]=="object"){let o=!0;r&&!this.sources[e][n][a][r]&&(o=!1);for(let f in i)if(typeof this.sources[e][n][a][f]=="object"&&typeof i[f]=="object"){for(let b in i[f])if(i[f][b]!==this.sources[e][n][a][f][b]){o=!1;break}}else if(this.sources[e][n][a][f]!==i[f])o=!1;else{o=!1;break}o&&(s[this.sources[e][n][a]._id]=this.sources[e][n][a])}}}};this.addConnection=(e,r)=>{let i={};if(typeof e=="string"){if(this.connections[e])e=this.connections[e];else for(let s in this.serviceConnections)for(let n in this.serviceConnections[s])if(this.serviceConnections[s][n][e]){e={connection:this.serviceConnections[s][n][e]},e.service=s,i.connectionType=s,i.connectionsKey=n;break}typeof e=="string"&&this.nodes.get(e)&&(e={connection:this.nodes.get(e)})}if(!(!e||typeof e=="string")){if(r&&(i.source=r),e.connection instanceof y){i.connection=e.connection;let s=i.connection;if(i.send=async n=>n.method?Array.isArray(n.args)?s[n.method]?.(...n.args):s[n.method]?.(n.args):Array.isArray(n.args)?s.run(...n.args):s.run(n.args),i.request=async(n,a)=>a?Array.isArray(n.args)?s[a]?.(...n.args):s[a]?.(n.args):Array.isArray(n.args)?s.run(...n.args):s.run(n.args),i.post=async(n,a,o)=>{if(n&&s.get(n)){let f=s.get(n);return o?Array.isArray(a)?f[o]?.(...a):f[o]?.(a):Array.isArray(a)?f.run(...a):f.run(a)}else return o?Array.isArray(a)?s[o]?.(...a):s[o]?.(a):Array.isArray(a)?s.run(...a):s.run(a)},i.run=i.post,i.subscribe=async(n,a)=>s.subscribe(a,n),i.unsubscribe=async(n,a)=>s.unsubscribe(a,n),i.terminate=()=>(s.graph.remove(s),!0),i.onclose=e.onclose,i.onclose){let n;s.ondelete&&(n=s.ondelete),s.ondelete=a=>{i.onclose&&i.onclose(i,a),n&&n(a)}}}else if(e.connection instanceof v){e.connection.nodes.get("open")&&(i.service=e.connection);let s=i.connection;i.send=async n=>{Array.isArray(n.args)?s.run(n.route,...n.args):s.run(n.route,n.args)},i.request=async(n,a)=>{if(!!n.route)return a?Array.isArray(n.args)?s.nodes.get(n.route)[a]?.(...n.args):s.nodes.get(n.route)[a]?.(n.args):Array.isArray(n.args)?s.run(n.route,...n.args):s.run(n.route,n.args)},i.post=async(n,a,o)=>{if(n&&s.get(n)){let f=s.get(n);return o?Array.isArray(a)?f[o]?.(...a):f[o]?.(a):Array.isArray(a)?f.run(...a):f.run(a)}},i.run=i.post,i.subscribe=async(n,a)=>s.subscribe(n,a),i.unsubscribe=async(n,a)=>s.unsubscribe(n,a),i.terminate=n=>(s.remove(n),!0)}else if(!(e._id&&this.connections[e._id])){let s=e.connection;if(typeof s=="string"){if(this.connections[s])s=this.connections[s];else if(e.service){if(typeof e.service=="string"&&(e.service=this.services[e.service]),typeof e.service=="object"&&e.service.connections){for(let n in e.service.connections)if(e.service.connections[n][s]){s=e.service.connections[n][s],i.connectionType=n,i.connectionsKey=s;break}}}else for(let n in this.serviceConnections)for(let a in this.serviceConnections[n])if(this.serviceConnections[n][a][s]){s=this.serviceConnections[n][a][s],e.service=n,i.connectionType=n,i.connectionsKey=a;break}}if(typeof s!="object")return;if(i._id=s._id,i.send=s.send,i.request=s.request,i.run=s.run,i.post=s.post,i.subscribe=s.subscribe,i.unsubscribe=s.unsubscribe,i.terminate=s.terminate,i.onclose=e.onclose,i.onclose){if(!(s.onclose&&i.onclose.toString()===s.onclose.toString())){let n=s.onclose;s.onclose=(...a)=>{i.onclose&&i.onclose(i,...a),this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),n&&n(...a)}}}else{let n=s.onclose;s.onclose=(...a)=>{this.removeConnection(i),this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),n&&n(...a)}}e.service?(typeof e.service=="string"&&(e.service=this.services[e.service]),i.service=e.service):s.graph&&(i.service=s.graph)}return!i.source&&e.source?i.source=e.source:!i.source&&e.service?i.source=typeof e.service=="object"?e.service.name:void 0:!i.source&&(i.connection instanceof y||i.connection instanceof v)&&(i.source="local",this.order.indexOf("local")||this.order.unshift("local")),i._id||(i._id=`connection${Math.floor(Math.random()*1e15)}`),i.source&&(this.sources[i.source]||(this.sources[i.source]={}),this.sources[i.source][i._id]=i),this.connections[i._id]||(this.connections[i._id]=i),i}};this.removeConnection=(e,r=!1)=>{if(typeof e=="object"&&e._id&&(e=e._id),typeof e=="string"){if(this.connections[e]){r&&this.connections[e]&&this.connections[e].terminate(),delete this.connections[e];for(let i in this.sources)if(this.sources[i][e])delete this.sources[i][e];else for(let s in this.sources[i])this.sources[i][s]?.[e]&&delete this.sources[i][e];return!0}else if(this.sources[e]){for(let i in this.sources[e])this.removeConnection(this.sources[e][i],r);return!0}}};this.addService=(e,r,i,s,n,a,o)=>{if(this.load(e,i,s,this.customRoutes,this.customChildren),this.services[e.name]=e,r)if(typeof r=="string")this.addServiceConnections(e,r,a);else for(let f in r)this.addServiceConnections(e,f,a);n&&this.syncServices(),o?this.order=o:(this.order||(this.order=[]),this.order.push(e.name))};this.addServiceConnections=(e,r,i)=>{if(typeof e=="string"&&(e=this.services[e]),r&&e[r]){let s={};this.serviceConnections[e.name]||(this.serviceConnections[e.name]={}),this.serviceConnections[e.name][r]=e[r];for(let n in e[r])this.connections[n]||(s[n]=this.addConnection({connection:e[r][n],service:e},i),s[n].connectionType=r);return s}};this.openConnection=async(e,r,i,...s)=>{if(typeof e=="string"&&(e=this.services[e]),e instanceof G){let n=e.run("open",r,...s);if(n instanceof Promise)return n.then(async a=>{a._id||await new Promise((o,f)=>{let b=performance.now(),h=()=>{a._id?o(!0):performance.now()-b>3e3?f(!1):setTimeout(()=>{h()},100)};h()}).catch(o=>{console.error("Connections timed out:",o)}),a._id&&this.addConnection({connection:a,service:e},i)});if(n&&(n._id||await new Promise((a,o)=>{let f=performance.now(),b=()=>{n._id?a(!0):performance.now()-f>3e3?o(!1):setTimeout(()=>{b()},100)};b()}).catch(a=>{console.error("Connections timed out:",a)}),n._id))return this.addConnection({connection:n,service:e},i)}};this.terminate=e=>(typeof e=="string"&&(e=this.connections[e]),e.terminate());this.subscribeThroughConnection=(e,r,i,s,...n)=>{if(typeof r=="string"&&(r=this.getConnection(r,"run")),typeof r=="object")return new Promise((a,o)=>{r.run("routeConnections",[e,i,r._id,...n]).then(f=>{this.subscribe(i,b=>{b?.callbackId===e&&(s?typeof s=="string"?this.setState({[s]:b.args}):s(b.args):this.setState({[i]:b.args}))}),a(f)}).catch(o)})};this.routeConnections=(e,r,i,...s)=>{let n;if(typeof i=="string"&&(this.sources[i]&&(n=i),i=this.getConnection(i,"send")),typeof r=="string"&&(r=this.getConnection(r,"subscribe")),r?.subscribe&&i?.send)return new Promise((o,f)=>{r.subscribe(e,r._id,b=>{!this.connections[i._id]&&n&&this.sources[n]&&(n=i,Object.keys(this.sources[n]).forEach(h=>{this.sources[i][h].send&&(i=this.sources[i][h])})),this.connections[i._id]&&i.send({callbackId:e,args:b})},...s).then(b=>{o(b)})})};this.syncServices=()=>{for(let e in this.services)"users"in this.services[e]&&(this.services[e].users=this.users),this.nodes.forEach((r,i)=>{this.services[e].nodes.get(r.tag)?!this.services[e].nodes.get(i)&&r._UNIQUE!==this.services[e].nodes.get(r.tag)._UNIQUE&&this.services[e].nodes.set(i,r):this.services[e].nodes.set(r.tag,r)})};this.setUserData=(e,r)=>{if(e&&typeof e=="string"&&(e=this.users[e],!e))return!1;if(r&&typeof r=="string"&&(r=JSON.parse(r)),typeof r=="object")return this.recursivelyAssign(e,r),!0};this.routes={addUser:this.addUser,removeUser:this.removeUser,getConnection:this.getConnection,addConnection:this.addConnection,removeConnection:this.removeConnection,addService:this.addService,addServiceConnections:this.addServiceConnections,openConnection:this.openConnection,terminate:this.terminate,routeConnections:this.routeConnections,subscribeThroughConnection:this.subscribeThroughConnection,syncServices:this.syncServices};if(this.load(this.routes),e&&(e.order&&(this.order=e.order),e.services))for(let r in e.services){let i=e.services[r];if(i instanceof G)i.service.name=r,i.service.tag=r,this.addService(i.service,i.connections,e.includeClassName,e.routeFormat,e.syncServices);else if(typeof i=="function"){let s=new i;s.name=r,s.tag=r,s&&this.addService(s,s.connections,e.includeClassName,e.routeFormat,e.syncServices)}else{if(typeof i.service=="function"){let s=new i.service({name:r});s.name=r,s.tag=r,s&&this.addService(s,void 0,e.includeClassName,e.routeFormat,e.syncServices),i.service=s}else i.service instanceof G&&(i.service.name=r,i.service.tag=r,this.addService(i.service,void 0,e.includeClassName,e.routeFormat,e.syncServices));if(typeof i.service=="object"&&(i.connections&&(Array.isArray(i.connections)?i.connections.forEach(s=>{this.addServiceConnections(i[r].service,s)}):this.addServiceConnections(i.service,i.connections)),i.config))for(let s in i.config)this.openConnection(i.service,i.config[s],i.config[s].source,i.config[s].args)}}}removeUser(e,r){return r&&this.removeConnection(e,r),typeof e=="string"&&(e=this.users[e]),typeof e=="object"&&e._id&&(delete this.users[e._id],e.onclose&&e.onclose(e)),!0}};export{O as EventHandler,v as Graph,y as GraphNode,T as Router,G as Service,P as createNode,C as parseFunctionFromText,E as reconstructNode,A as reconstructObject,R as state,j as stringifyFast,w as stringifyWithCircularRefs,B as unsafeRoutes};
