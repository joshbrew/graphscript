var g=class{constructor(e){this.pushToState={};this.data={};this.triggers={};this.setState=e=>{Object.assign(this.data,e);for(let n of Object.getOwnPropertyNames(e))this.triggers[n]&&this.triggers[n].forEach(t=>t.onchange(this.data[n]));return this.data};this.setValue=(e,n)=>{this.data[e]=n,this.triggers[e]&&this.triggers[e].forEach(t=>t.onchange(this.data[e]))};this.subscribeTrigger=(e,n)=>{if(e){this.triggers[e]||(this.triggers[e]=[]);let t=this.triggers[e].length;return this.triggers[e].push({sub:t,onchange:n}),this.triggers[e].length-1}else return};this.unsubscribeTrigger=(e,n)=>{let t=this.triggers[e];if(t)if(!n)delete this.triggers[e];else{let s,i=t.find((r,a)=>{if(r.sub===s)return s=a,!0});return i&&t.splice(s,1),this.onRemoved&&this.onRemoved(i),!0}};this.subscribeTriggerOnce=(e,n)=>{let t,s=i=>{n(i),this.unsubscribeTrigger(e,t)};t=this.subscribeTrigger(e,s)};this.getTrigger=(e,n)=>{for(let t in this.triggers[e])if(this.triggers[e][t].sub===n)return this.triggers[e][t]};typeof e=="object"&&(this.data=e)}};var y=new g,h=class{constructor(e,n,t){this.__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,state:y};this.__subscribe=(e,n,t,s,i)=>{let r=(o,f=(u,l)=>u,d=e)=>{let u=this.__node.state.subscribeTrigger(o,d),l=this.__node.state.getTrigger(o,u);return l.source=this.__node.tag,n&&(l.key=n),l.target=f(e),s&&(l.bound=s),u},a=o=>{if(!this.__node.graph.get(o)&&o.includes(".")){let d=this.__node.graph.get(o.substring(0,o.lastIndexOf("."))),u=o.substring(o.lastIndexOf(".")+1);d&&typeof d[u]=="function"&&(o=(...l)=>d[u](...l))}};if(n){this.__node.localState||this.__addLocalState(this),typeof e=="string"&&(typeof this[e]=="function"?e=this[e]:this.__node.graph&&a(e));let o,f=t?this.__node.unique+"."+n+"input":this.__node.unique+"."+n;return typeof e=="function"?o=r(f):e?.__node&&(o=r(f,(d,u)=>u||d.__node.unique,d=>{e.__operator&&e.__operator(d)})),o}else{typeof e=="string"&&(this.__node.graph?e=this.__node.graph.get(e):e=this.__node.graph.nodes.get(e));let o,f=t?this.__node.unique+"input":this.__node.unique;return typeof e=="function"?o=r(f):e?.__node&&(o=r(f,(d,u)=>u||d.__node.unique,d=>{e.__operator&&e.__operator(d)})),o}};this.__unsubscribe=(e,n,t)=>n?this.__node.state.unsubscribeTrigger(t?this.__node.unique+"."+n+"input":this.__node.unique+"."+n,e):this.__node.state.unsubscribeTrigger(t?this.__node.unique+"input":this.__node.unique,e);this.__setOperator=e=>(e=e.bind(this),this.__operator=(...n)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"input",n);let t=e(...n);return typeof t?.then=="function"?t.then(s=>{s!==void 0&&this.__node.state.setValue(this.__node.unique,s)}).catch(console.error):t!==void 0&&this.__node.state.setValue(this.__node.unique,t),t},this.__operator);this.__proxyObject=e=>{function n(s){var i=[],r=s;do if(r.constructor?.name!=="Object"){var a=Object.getOwnPropertyNames(r);a.forEach(function(o){i.indexOf(o)===-1&&i.push(o)})}while(r=Object.getPrototypeOf(r));return i}let t=n(e);for(let s of t)typeof this[s]>"u"&&(typeof e[s]=="function"?this[s]=(...i)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"."+s+"input",i);let r=e[s](...i);return this.__node.state.triggers[this.__node.unique+"."+s]&&(typeof r?.then=="function"?r.then(a=>{this.__node.state.setValue(this.__node.unique+"."+s,a)}).catch(console.error):this.__node.state.setValue(this.__node.unique+"."+s,r)),r}:Object.defineProperty(this,s,{get:()=>e[s],set:r=>{e[s]=r,this.__node.state.triggers[this.__node.unique+"."+s]&&this.__node.state.setValue(this.__node.unique+"."+s,r)},enumerable:!0,configurable:!0}))};let s=e;if(typeof e=="function"?e={__operator:e,__node:{forward:!0,tag:e.name}}:typeof e=="string"&&t?.get(e)&&(e=t.get(e)),e.__node.initial||(e.__node.initial=s),typeof e=="object"){if(e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props)),typeof e.__node=="string"?t?.get(e.__node.tag)?e=t.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),!e.__parent&&n&&(e.__parent=n),t&&(e.__node.graph=t),e.__operator){if(typeof e.__operator=="string"&&t){let i=t.get(e.__operator);i&&(e.__operator=i.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator))}if(e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`),n?.__node&&!(n instanceof c||e instanceof c)&&(e.__node.tag=n.__node.tag+"."+e.__node.tag),n instanceof c&&e instanceof c&&(e.__node.loaders&&Object.assign(n.__node.loaders?n.__node.loaders:{},e.__node.loaders),n.__node.mapGraphs)){e.__node.nodes.forEach(r=>{n.set(e.__node.tag+"."+r.__node.tag,r)});let i=()=>{e.__node.nodes.forEach(r=>{n.__node.nodes.delete(e.__node.tag+"."+r.__node.tag)})};this.__addDisconnected(i)}e.__node=Object.assign(this.__node,e.__node);for(let i in e)this[i]=e[i];if(e.__operator&&n instanceof h&&n.__operator){let i=n.__subscribe(this),r=()=>{n?.__unsubscribe(i)};this.__addDisconnected(r)}else if(typeof e.default=="function"&&!e.__operator){let i=e.default.bind(this);this.default=(...r)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"input",r);let a=i(...r);return typeof a?.then=="function"?a.then(o=>{o!==void 0&&this.__node.state.setValue(this.__node.unique,o)}).catch(console.error):a!==void 0&&this.__node.state.setValue(this.__node.unique,a),a},e.default=this.default}e instanceof c&&(this.__node.source=e)}}__addLocalState(e){if(!e)return;this.__node.localState||(this.__node.localState={});let n=this.__node.localState;for(let t in e)if(!(this.__props&&this.__props[t]))if(typeof e[t]=="function"){if(!t.startsWith("_")){let s=e[t].bind(this);e[t]=(...i)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"."+t+"input",i);let r=s(...i);return typeof r?.then=="function"?this.__node.state.triggers[this.__node.unique+"."+t]&&r.then(a=>{this.__node.state.setValue(this.__node.unique+"."+t,a)}).catch(console.error):this.__node.state.triggers[this.__node.unique+"."+t]&&this.__node.state.setValue(this.__node.unique+"."+t,r),r},this[t]=e[t]}}else{n[t]=e[t];let s={get:()=>n[t],set:i=>{n[t]=i,this.__node.state.triggers[this.__node.unique+"."+t]&&this.__node.state.setValue(this.__node.unique+"."+t,i)},enumerable:!0,configurable:!0};if(Object.defineProperty(this,t,s),typeof this.__node.initial=="object"){let i=Object.getOwnPropertyDescriptor(this.__node.initial,t);(i===void 0||i?.configurable)&&Object.defineProperty(this.__node.initial,t,s)}}}__addOnconnected(e){Array.isArray(this.__ondisconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addDisconnected(e){Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){typeof this.__onconnected=="function"?this.__onconnected(this):Array.isArray(this.__onconnected)&&this.__onconnected.forEach(n=>{n(this)})}__callDisconnected(e=this){typeof this.__ondisconnected=="function"?this.__ondisconnected(this):Array.isArray(this.__ondisconnected)&&this.__ondisconnected.forEach(n=>{n(this)})}},c=class{constructor(e){this.__node={tag:`graph${Math.floor(Math.random()*1e15)}`,nodes:new Map,state:y};this.init=e=>{e&&(p(this.__node,e),e.tree&&this.setTree(e.tree))};this.setTree=e=>{this.__node.tree=Object.assign(this.__node.tree?this.__node.tree:{},e);let n=Object.assign({},e);delete n.__node;let t=this.recursiveSet(n,this);if(e.__node){if(!e.__node.tag)e.__node._tag=`tree${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let s=new h(e,this,this);for(let i in this.__node.loaders)this.__node.loaders[i](s,this,this,e,e);this.set(s.__node.tag,s),s.__listeners&&(t[s.__node.tag]=s.__listeners)}}this.setListeners(t)};this.setLoaders=(e,n)=>(n?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);this.add=(e,n)=>{let t={};typeof n=="string"&&(n=this.get(n)),typeof e=="function"?e={__operator:e}:typeof e=="string"&&(e=this.__node.tree[e]);let s=Object.assign({},e);if(s.__node||(s.__node={}),s.__node.initial=e,typeof e=="object"&&(!s?.__node?.tag||!this.get(s.__node.tag))){let i=new h(s,n,this);for(let r in this.__node.loaders)this.__node.loaders[r](i,n,this,this.__node.tree,e);return this.set(i.__node.tag,i),this.__node.tree[i.__node.tag]=e,i.__listeners&&(t[i.__node.tag]=i.__listeners),i.__children&&(i.__children=Object.assign({},i.__children),this.recursiveSet(i.__children,i,t)),this.setListeners(t),i.__callConnected(),i}};this.recursiveSet=(e,n,t={})=>{for(let s in e){let i=e[s];if(!Array.isArray(i)&&(typeof i=="function"?i={__operator:i}:typeof i=="string"?i=this.__node.tree[i]:typeof i=="boolean"&&(i=this.__node.tree[s]),typeof i=="object")){if(i=Object.assign({},i),i.__node||(i.__node={}),i.__node.tag||(i.__node.tag=s),i.__node.initial=e[s],this.get(i.__node.tag)&&!(n?.__node&&this.get(n.__node.tag+"."+i.__node.tag))||n?.__node&&this.get(n.__node.tag+"."+i.__node.tag))continue;let r=new h(i,n,this);for(let a in this.__node.loaders)this.__node.loaders[a](r,n,this,e,e[s]);e[s]=r,this.__node.tree[r.__node.tag]=i,this.set(r.__node.tag,r),r.__listeners?t[r.__node.tag]=r.__listeners:r.__children&&(r.__children=Object.assign({},r.__children),this.recursiveSet(r.__children,r,t)),r.__callConnected()}}return t};this.remove=(e,n=!0)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof h){this.delete(e.__node.tag),delete this.__node.tree[e.__node.tag],n&&this.clearListeners(e),e.__callDisconnected();let t=s=>{for(let i in s)this.unsubscribe(s[i]),this.delete(s[i].__node.tag),delete this.__node.tree[s[i].__node.tag],this.delete(i),delete this.__node.tree[i],s[i].__node.tag=s[i].__node.tag.substring(s[i].__node.tag.lastIndexOf(".")+1),n&&this.clearListeners(s[i]),s[i].__callDisconnected(),s[i].__children&&t(s[i].__children)};e.__children&&t(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e};this.run=(e,...n)=>{if(typeof e=="string"){let t=this.get(e);if(!t&&e.includes(".")){if(t=this.get(e.substring(0,e.lastIndexOf("."))),typeof t?.[e.substring(e.lastIndexOf(".")+1)]=="function")return t[e.substring(e.lastIndexOf(".")+1)](...n)}else if(t?.__operator)return t.__operator(...n)}if(e?.__operator)return e?.__operator(...n)};this.setListeners=e=>{for(let n in e){let t=this.get(n);if(typeof e[n]=="object")for(let s in e[n]){let i=this.get(s),r;if(typeof e[n][s]!="object"&&(e[n][s]={callback:e[n][s]}),typeof e[n][s].callback=="function"&&(e[n][s].callback=e[n][s].callback.bind(t)),typeof t.__listeners!="object"&&(t.__listeners={}),i)r=this.subscribe(i,e[n][s].callback,void 0,e[n][s].inputState,n,s),typeof t.__listeners[s]!="object"&&(t.__listeners[s]={callback:e[n][s].callback,inputState:e[n][s]?.inputState}),t.__listeners[s].sub=r;else{let a=s.substring(0,s.lastIndexOf("."));i=this.get(a),i&&(r=this.subscribe(i,e[n][s].callback,s.substring(s.lastIndexOf(".")+1),e[n][s].inputState,n,s),typeof t.__listeners[s]!="object"&&(t.__listeners[s]={callback:e[n][s].callback,inputState:e[n][s]?.inputState}),t.__listeners[s].sub=r)}}}};this.clearListeners=(e,n)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let t in e.__listeners){if(n&&t!==n||typeof e.__listeners[t].sub!="number")continue;let s=this.get(t);s?this.unsubscribe(s,e.__listeners[t].sub,void 0,e.__listeners[t].inputState):(s=this.get(t.substring(0,t.lastIndexOf("."))),s&&this.unsubscribe(s,e.__listeners[t].sub,t.substring(t.lastIndexOf(".")+1),e.__listeners[t].inputState)),delete e.__listeners[t]}};this.get=e=>this.__node.nodes.get(e);this.set=(e,n)=>this.__node.nodes.set(e,n);this.delete=e=>this.__node.nodes.delete(e);this.getProps=(e,n)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof h){let t;n?t=Object.assign({},this.__node.tree[e.__node.tag]):(t=Object.assign({},e),delete t.__unsubscribe,delete t.__setOperator,delete t.__node,delete t.__subscribeState,delete t.__subscribe)}};this.subscribe=(e,n,t,s,i,r)=>{let a=e;e instanceof h||(a=this.get(e));let o;if(typeof n=="string")if(i){let f=this.get(i)?.[n];typeof f=="function"&&(n=f)}else n=this.get(n)?.__operator;if(a instanceof h){o=a.__subscribe(n,t,s,i,r);let f=()=>{a.__unsubscribe(o,t,s)};a.__addDisconnected(f)}else if(typeof e=="string")if(this.get(e))if(n instanceof h&&n.__operator){o=this.get(e).__subscribe(n.__operator,t,s,i,r);let f=()=>{this.get(e).__unsubscribe(o)};n.__addDisconnected(f)}else(typeof n=="function"||typeof n=="string")&&(o=this.get(e).__subscribe(n,t,s,i,r),this.__node.state.getTrigger(this.get(e).__node.unique,o).source=e);else typeof n=="string"&&(n=this.__node.nodes.get(n).__operator),typeof n=="function"&&(o=this.__node.state.subscribeTrigger(e,n));return o};this.unsubscribe=(e,n,t,s)=>e instanceof h?e.__unsubscribe(n,t,s):this.get(e)?.__unsubscribe(n,t,s);this.setState=e=>{this.__node.state.setState(e)};this.init(e)}};function p(_,e){for(let n in e)e[n]?.constructor.name==="Object"&&!Array.isArray(e[n])?_[n]?.constructor.name==="Object"&&!Array.isArray(_[n])?p(_[n],e[n]):_[n]=p({},e[n]):_[n]=e[n];return _}var b=(_,e,n)=>{_.__node.backward&&e instanceof h&&n.setListeners({[e.__node.tag]:{[_.__node.tag]:e}})},G=(_,e,n)=>{if(_.__operator&&!_.__node.looperSet){if(_.__node.looperSet=!0,typeof _.__node.delay=="number"){let t=_.__operator;_.__operator=(...s)=>new Promise((i,r)=>{setTimeout(async()=>{i(await t(...s))},_.__node.delay)})}else if(_.__node.frame===!0){let t=_.__operator;_.__operator=(...s)=>new Promise((i,r)=>{requestAnimationFrame(async()=>{i(await t(...s))})})}if(typeof _.__node.repeat=="number"||typeof _.__node.recursive=="number"){let t=_.__operator;_.__operator=async(...s)=>{let i=_.__node.repeat?_.__node.repeat:_.__node.recursive,r,a=async(o,...f)=>{for(;o>0;){if(_.__node.delay||_.__node.frame){t(...f).then(async d=>{_.__node.recursive?await a(o,d):await a(o,...f)});break}else r=await t(...s);o--}};return await a(i,...s),r}}if(_.__node.loop&&typeof _.__node.loop=="number"){let t=_.__operator;_.__operator=(...i)=>{"looping"in _.__node||(_.__node.looping=!0),_.__node.looping&&(t(...i),setTimeout(()=>{_.__operator(...i)},_.__node.loop))},_.__node.looping&&_.__operator();let s=i=>{i.__node.looping&&(i.__node.looping=!1)};_.__addDisconnected(s)}}},m=(_,e,n)=>{if(_.__node.animate===!0||_.__node.animation){typeof _.__node.animate=="function"&&(_.__node.animate=_.__node.animate.bind(_)),requestAnimationFrame(i=>{let r=i.__operator;i.__operator=(...a)=>{"animating"in i.__node||(i.__node.animating=!0),i.__node.animating&&(typeof i.__node.animate=="function"?i.__node.animate(...a):r(...a),requestAnimationFrame(()=>{i.__operator(...a)}))},i.__node.animating&&i.__node.animation()});let s=i=>{i.__node.animating&&(i.__node.animating=!1)};_.__addDisconnected(s)}},N=(_,e,n)=>{if(typeof _.__node.branch=="object"&&_.__operator&&!_.__node.branchApplied){let t=_.__operator;_.__node.branchApplied=!0,_.__operator=(...s)=>{let i=t(...s);for(let r in _.__node.branch){let a=()=>{typeof _.__node.branch[r].then=="function"?_.__node.branch[r].then(i):_.__node.branch[r].then instanceof h&&_.__node.branch[r].then.__operator?_.__node.branch[r].then.__operator(i):i=_.__node.branch[r].then};typeof _.__node.branch[r].if=="function"?_.__node.branch[r].if(i)&&a():_.__node.branch[r].if===i&&a()}return i}}if(_.__listeners){for(let t in _.__listeners)if(typeof _.__listeners[t]=="object"&&_.__listeners[t].branch&&!_.__listeners[t].branchApplied){let s=_.__listeners[t].callback;_.__listeners[t].branchApplied=!0,_.__listeners.callback=i=>{let r=()=>{typeof _.__listeners[t].branch.then=="function"?i=_.__listeners[t].branch.then(i):_.__listeners[t].branch.then instanceof h&&_.__listeners[t].branch.then.__operator?i=_.__listeners[t].branch.then.__operator(i):i=_.__listeners[t].branch.then};return typeof _.__listeners[t].branch.if=="function"?_.__listeners[t].branch.if(i)&&r():_.__listeners[t].branch.if===i&&r(),s(i)}}}},O=(_,e,n)=>{if(_.__listeners)for(let t in _.__listeners)typeof _.__listeners[t]=="object"&&_.__listeners[t].oncreate&&_.__listeners[t].callback(_.__listeners[t].oncreate)},j=(_,e,n)=>{if(_.__listeners)for(let t in _.__listeners)typeof _.__listeners[t]=="object"&&typeof _.__listeners[t].binding=="object"&&(_.__listeners.callback=_.__listeners.callback.bind(_.__listeners[t].binding))},q=(_,e,n)=>{if(_.__listeners){for(let t in _.__listeners)if(typeof _.__listeners[t]=="object"&&typeof _.__listeners[t].transform=="function"&&!_.__listeners[t].transformApplied){let s=_.__listeners[t].callback;_.__listeners[t].transformApplied=!0,_.__listeners.callback=i=>(i=_.__listeners[t].transform(i),s(i))}}},v=(_,e,n)=>{_.post&&!_.__operator?_.__setOperator(_.post):!_.__operator&&typeof _.get=="function"&&_.__setOperator(_.get),!_.get&&_.__operator&&(_.get=_.__operator),_.aliases&&_.aliases.forEach(t=>{n.set(t,_);let s=i=>{n.__node.nodes.delete(t)};_.__addDisconnected(s)}),typeof n.__node.tree[_.__node.tag]=="object"&&_.get&&(n.__node.tree[_.__node.tag].get=_.get)},V={backprop:b,loop:G,animate:m,branching:N,triggerListenerOncreate:O,bindListener:j,transformListenerResult:q,substitute__operator:v};export{c as Graph,h as GraphNode,m as animate,b as backprop,j as bindListener,N as branching,V as loaders,G as loop,y as state,v as substitute__operator,q as transformListenerResult,O as triggerListenerOncreate};
