(()=>{var P=/([^,]*)/g;function E(l){var s=l.toString();let e=s.indexOf("("),t=s.indexOf(")"),i=(h,f=0)=>{let d=f+h.indexOf("{");return d<t&&d>e?i(h.slice(d),f+d):d},r=i(s),n;if(r===-1||t<r?n=s.slice(s.indexOf("(")+1,s.indexOf(")")):n=s.match(/([a-zA-Z]\w*|\([a-zA-Z]\w*(,\s*[a-zA-Z]\w*)*\)) =>/)?.[1],!n)return;let a=n.match(P).filter(h=>!!h),o=new Map;return a.forEach(h=>{let[f,d]=h.split("=");f=f.trim(),f=f.replace(/\d+$/,"");let c=f.includes("...");f=f.replace("...","");try{f&&o.set(f,{state:(0,eval)(`(${d})`),spread:c})}catch{o.set(f,{})}}),o}function T(l){var s=l.toString();return s.match(/\(.*?\)/)[0].replace(/[()]/gi,"").replace(/\s/gi,"").split(",")}function k(l=""){let s=n=>n.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=(n=>{let a=n.indexOf("=>")+1;return a<=0&&(a=n.indexOf("){")),a<=0&&(a=n.indexOf(") {")),n.slice(0,n.indexOf("{",a)+1)})(l),i=s(l),r;if(t.includes("function")){let n=t.split("(")[1].split(")")[0];r=new Function(n,i)}else if(t.substring(0,6)===i.substring(0,6)){let n=t.split("(")[1].split(")")[0];r=new Function(n,i.substring(i.indexOf("{")+1,i.length-1))}else try{r=(0,eval)(t+i+"}")}catch{}return r}var S={pushToState:{},data:{},triggers:{},setState(l){Object.assign(S.data,l);for(let s of Object.getOwnPropertyNames(l))S.triggers[s]&&S.triggers[s].forEach(e=>e.onchange(S.data[s]));return S.data},subscribeTrigger(l,s){if(l){S.triggers[l]||(S.triggers[l]=[]);let e=S.triggers[l].length;return S.triggers[l].push({idx:e,onchange:s}),S.triggers[l].length-1}else return},unsubscribeTrigger(l,s){let e,t=S.triggers[l];if(t)if(!s)delete S.triggers[l];else return t.find(r=>{if(r.idx===s)return!0})&&t.splice(e,1),!0},subscribeTriggerOnce(l,s){let e,t=i=>{s(i),S.unsubscribeTrigger(l,e)};e=S.subscribeTrigger(l,t)}},g=class{constructor(s={},e,t){this.nodes=new Map;this._initial={};this.state=S;this.isLooping=!1;this.isAnimating=!1;this.looper=void 0;this.animation=void 0;this.forward=!0;this.backward=!1;this.runSync=!1;this.firstRun=!0;this.DEBUGNODE=!1;this.operator=(s=this,e,...t)=>t;this.runOp=(s=this,e=this,...t)=>{s.DEBUGNODE&&console.time(s.tag);let i=s.operator(s,e,...t);return i instanceof Promise?i.then(r=>(r!==void 0&&this.setState({[s.tag]:r}),s.DEBUGNODE&&(console.timeEnd(s.tag),i!==void 0&&console.log(`${s.tag} result:`,i)),r)):(i!==void 0&&this.setState({[s.tag]:i}),s.DEBUGNODE&&(console.timeEnd(s.tag),i!==void 0&&console.log(`${s.tag} result:`,i))),i};this.setOperator=s=>{if(typeof s!="function")return s;let e=E(s),t=!1;if(e){let i=e.keys(),r=i.next().value,n=i.next().value,a=["self","node"],o=["origin","parent","graph","router"];r&&a.forEach(h=>{r.includes(h)&&(t=!0)}),n&&o.forEach(h=>{n.includes(h)&&(t=!0)})}if(!t){let i=s;s=(r,n,...a)=>i(...a)}return this.operator=s,s};this.run=(...s)=>this._run(this,void 0,...s);this.runAsync=(...s)=>new Promise((e,t)=>{e(this._run(this,void 0,...s))});this.transformArgs=(s=[])=>s;this._run=(s=this,e,...t)=>{if(typeof this.transformArgs=="function"&&(t=this.transformArgs(t,s)),typeof s!="object"){if(typeof s=="string"){let i;this.graph&&(i=this.graph.nodes.get(s)),i||(i=this.nodes.get(s)),s=i}if(!s)return}if(!(s.firstRun&&(s.firstRun=!1,s.children&&s.forward||s.parent&&s.backward||s.repeat||s.delay||s.frame||s.recursive||s.branch||(s.runSync=!0),s.animate&&!s.isAnimating&&s.runAnimation(s.animation,t,s,e),s.loop&&typeof s.loop=="number"&&!s.isLooping&&s.runLoop(s.looper,t,s,e),s.loop||s.animate)))return s.runSync?s.runOp(s,e,...t):new Promise(async i=>{if(s){let r=(a,o=0,...h)=>new Promise(async f=>{o++;let d=await a.runOp(a,e,...h);if(a.repeat){for(;o<a.repeat;){if(a.delay){setTimeout(async()=>{f(await r(a,o,...h))},a.delay);break}else if(a.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{f(await r(a,o,...h))});break}else d=await a.runOp(a,e,...h);o++}if(o===a.repeat){f(d);return}}else if(a.recursive){for(;o<a.recursive;){if(a.delay){setTimeout(async()=>{f(await r(a,o,...d))},a.delay);break}else if(a.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{f(await r(a,o,...d))});break}else d=await a.runOp(a,e,...d);o++}if(o===a.recursive){f(d);return}}else{f(d);return}}),n=async()=>{let a=await r(s,void 0,...t);return a!==void 0&&(s.backward&&s.parent instanceof g&&(Array.isArray(a)?await this.runParent(s,...a):await this.runParent(s,a)),s.children&&s.forward&&(Array.isArray(a)?await this.runChildren(s,...a):await this.runChildren(s,a)),s.branch&&this.runBranch(s,a)),a};s.delay?setTimeout(async()=>{i(await n())},s.delay):s.frame&&window?.requestAnimationFrame?requestAnimationFrame(async()=>{i(await n())}):i(await n())}else i(void 0)})};this.runParent=async(s,...e)=>{s.backward&&s.parent&&(typeof s.parent=="string"&&(s.graph&&s.graph?.get(s.parent)?(s.parent=s.graph,s.parent&&this.nodes.set(s.parent.tag,s.parent)):s.parent=this.nodes.get(s.parent)),s.parent instanceof g&&await s.parent._run(s.parent,this,...e))};this.runChildren=async(s,...e)=>{if(typeof s.children=="object")for(let t in s.children)typeof s.children[t]=="string"?(s.graph&&s.graph?.get(s.children[t])&&(s.children[t]=s.graph.get(s.children[t]),s.nodes.get(s.children[t].tag)||s.nodes.set(s.children[t].tag,s.children[t])),!s.children[t]&&s.nodes.get(s.children[t])&&(s.children[t]=s.nodes.get(s.children[t]))):(typeof s.children[t]>"u"||s.children[t]===!0)&&(s.graph&&s.graph?.get(t)&&(s.children[t]=s.graph.get(t),s.nodes.get(s.children[t].tag)||s.nodes.set(s.children[t].tag,s.children[t])),!s.children[t]&&s.nodes.get(t)&&(s.children[t]=s.nodes.get(t))),s.children[t]?.runOp&&await s.children[t]._run(s.children[t],s,...e)};this.runBranch=async(s,e)=>{if(s.branch){let t=Object.keys(s.branch);await Promise.all(t.map(async i=>{typeof s.branch[i].if=="object"&&(s.branch[i].if=v(s.branch[i].if));let r=!1;return typeof s.branch[i].if=="function"?r=s.branch[i].if(e):typeof e=="object"?v(e)===s.branch[i].if&&(r=!0):e===s.branch[i].if&&(r=!0),r&&(s.branch[i].then instanceof g?Array.isArray(e)?await s.branch[i].then._run(s.branch[i].then,s,...e):await s.branch[i].then._run(s.branch[i].then,s,...e):typeof s.branch[i].then=="function"?Array.isArray(e)?await s.branch[i].then(...e):await s.branch[i].then(e):typeof s.branch[i].then=="string"&&(s.graph?s.branch[i].then=s.graph.nodes.get(s.branch[i].then):s.branch[i].then=s.nodes.get(s.branch[i].then),s.branch[i].then instanceof g&&(Array.isArray(e)?await s.branch[i].then._run(s.branch[i].then,s,...e):await s.branch[i].then._run(s.branch[i].then,s,...e)))),r}))}};this.runAnimation=(s=this.animation,e=[],t=this,i)=>{if(this.animation=s,s||(this.animation=this.operator),t.animate&&!t.isAnimating&&"requestAnimationFrame"in window){t.isAnimating=!0;let r=async()=>{if(t.isAnimating){t.DEBUGNODE&&console.time(t.tag);let n=this.animation(t,i,...e);n instanceof Promise&&(n=await n),t.DEBUGNODE&&(console.timeEnd(t.tag),n!==void 0&&console.log(`${t.tag} result:`,n)),n!==void 0&&(this.tag&&this.setState({[this.tag]:n}),t.backward&&t.parent?._run&&(Array.isArray(n)?await this.runParent(t,...n):await this.runParent(t,n)),t.children&&t.forward&&(Array.isArray(n)?await this.runChildren(t,...n):await this.runChildren(t,n)),t.branch&&this.runBranch(t,n),this.setState({[t.tag]:n})),requestAnimationFrame(r)}};requestAnimationFrame(r)}};this.runLoop=(s=this.looper,e=[],t=this,i,r=t.loop)=>{if(t.looper=s,s||(t.looper=t.operator),typeof r=="number"&&!t.isLooping){t.isLooping=!0;let n=async()=>{if(t.isLooping){t.DEBUGNODE&&console.time(t.tag);let a=t.looper(t,i,...e);a instanceof Promise&&(a=await a),t.DEBUGNODE&&(console.timeEnd(t.tag),a!==void 0&&console.log(`${t.tag} result:`,a)),a!==void 0&&(t.tag&&t.setState({[t.tag]:a}),t.backward&&t.parent?._run&&(Array.isArray(a)?await this.runParent(t,...a):await this.runParent(t,a)),t.children&&t.forward&&(Array.isArray(a)?await this.runChildren(t,...a):await this.runChildren(t,a)),t.branch&&this.runBranch(t,a),t.setState({[t.tag]:a})),setTimeout(async()=>{await n()},r)}};n()}};this.setParent=s=>{this.parent=s,this.backward&&(this.runSync=!1)};this.setChildren=s=>{this.children=s,this.forward&&(this.runSync=!1)};this.add=(s={})=>(typeof s=="function"&&(s={operator:s}),s instanceof g||(s=new g(s,this,this.graph)),this.nodes.set(s.tag,s),this.graph&&(this.graph.nodes.set(s.tag,s),this.graph.nNodes=this.graph.nodes.size),s);this.remove=s=>{typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&(this.nodes.delete(s.tag),this.children[s.tag]&&delete this.children[s.tag],this.graph&&(this.graph.nodes.delete(s.tag),this.graph.nNodes=this.graph.nodes.size),this.nodes.forEach(e=>{e.nodes.get(e.tag)&&(e.nodes.delete(e.tag),e.children[e.tag]&&delete e.children[e.tag],e.parent?.tag===e.tag&&delete e.parent)}),s.ondelete&&s.ondelete(s))};this.append=(s,e=this)=>{typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&(e.addChildren(s),s.forward&&(s.runSync=!1))};this.subscribe=(s,e=this.tag)=>s instanceof g?this.subscribeNode(s):this.state.subscribeTrigger(e,s);this.unsubscribe=(s,e=this.tag)=>{this.state.unsubscribeTrigger(e,s)};this.addChildren=s=>{this.children||(this.children={}),typeof s=="object"&&Object.assign(this.children,s),this.convertChildrenToNodes(),this.forward&&(this.runSync=!1)};this.callParent=(...s)=>{let e=this;if(typeof this.parent=="string"&&(this.graph&&this.graph?.get(this.parent)?(this.parent=this.graph,this.parent&&this.nodes.set(this.parent.tag,this.parent)):this.parent=this.nodes.get(this.parent)),typeof this.parent?.operator=="function")return this.parent.runOp(this.parent,e,...s)};this.callChildren=(s,...e)=>{let t=this,i;if(typeof this.children=="object")for(let r in this.children)this.children[r]?.runOp&&this.children[r].runOp(this.children[r],t,...e);return i};this.getProps=(s=this)=>({tag:s.tag,operator:s.operator,graph:s.graph,children:s.children,parent:s.parent,forward:s.forward,backward:s.bacward,loop:s.loop,animate:s.animate,frame:s.frame,delay:s.delay,recursive:s.recursive,repeat:s.repeat,branch:s.branch,oncreate:s.oncreate,DEBUGNODE:s.DEBUGNODE,...this._initial});this.setProps=(s={})=>{let e=Object.assign({},s);e.children&&(this.addChildren(s.children),delete e.children),e.operator&&(this.setOperator(s.operator),delete e.operator),Object.assign(e,s),this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||(this.runSync=!0)};this.removeTree=s=>{if(s&&typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g){let e={},t=i=>{if(typeof i.children=="object"&&!e[i.tag]){e[i.tag]=!0;for(let r in i.children)i.children[r].stopNode&&i.children[r].stopNode(),i.children[r].tag&&(this.nodes.get(i.children[r].tag)&&this.nodes.delete(i.children[r].tag),this.nodes.forEach(n=>{n.nodes.get(i.children[r].tag)&&n.nodes.delete(i.children[r].tag),n.children[r]instanceof g&&delete n.children[r]}),t(i.children[r]))}};s.stopNode&&s.stopNode(),s.tag&&(this.nodes.delete(s.tag),this.children[s.tag]&&delete this.children[s.tag],this.parent?.tag===s.tag&&delete this.parent,this[s.tag]instanceof g&&delete this[s.tag],this.nodes.forEach(i=>{i?.tag&&(i.nodes.get(i.tag)&&i.nodes.delete(i.tag),i.children[i.tag]instanceof g&&delete i.children[i.tag])}),t(s),this.graph?this.graph.removeTree(s,e):s.ondelete&&s.ondelete(s))}};this.checkNodesHaveChildMapped=(s,e,t={})=>{let i=s.tag;i||(i=s.name),t[i]||(t[i]=!0,s.children&&e.tag in s.children&&s.children[e.tag]instanceof g&&(s.nodes.get(e.tag)||s.nodes.set(e.tag,e),s.children[e.tag]=e,s.firstRun||(s.firstRun=!0)),s.parent instanceof g&&(s.nodes.get(e.tag)&&!s.parent.nodes.get(e.tag)&&s.parent.nodes.set(e.tag,e),s.parent.children?this.checkNodesHaveChildMapped(s.parent,e,t):s.nodes&&s.nodes.forEach(r=>{t[r.tag]||this.checkNodesHaveChildMapped(r,e,t)})),s.graph&&s.parent&&s.parent.name!==s.graph.name&&s.graph.nodes.forEach(r=>{t[r.tag]||this.checkNodesHaveChildMapped(r,e,t)}))};this.convertChildrenToNodes=(s=this)=>{if(s?.children){for(let e in s.children)if(!(s.children[e]instanceof g))if(typeof s.children[e]=="object")s.children[e].tag||(s.children[e].tag=e),s.nodes.get(s.children[e].tag)||(s.children[e]=new g(s.children[e],s,s.graph),this.checkNodesHaveChildMapped(s,s.children[e]));else{if(typeof s.children[e]>"u"||s.children[e]==!0)s.children[e]=s.graph.get(e),s.children[e]||(s.children[e]=s.nodes.get(e));else if(typeof s.children[e]=="string"){let t=s.children[e];s.children[e]=s.graph.get(t),s.children[e]||(s.children[e]=s.nodes.get(e))}if(s.children[e]instanceof g){if(s.graph){let t=s.children[e].getProps();delete t.parent,delete t.graph,s.source instanceof m?s.children[e]=new g(t,s,s.source):s.children[e]=new g(t,s,s.graph)}s.nodes.set(s.children[e].tag,s.children[e]),this.checkNodesHaveChildMapped(s,s.children[e]),s.children[e].tag in s||(s[s.children[e].tag]=s.children[e])}}}return s.children};this.stopLooping=(s=this)=>{s.isLooping=!1};this.stopAnimating=(s=this)=>{s.isAnimating=!1};this.stopNode=(s=this)=>{s.stopAnimating(s),s.stopLooping(s)};this.subscribeNode=s=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s.tag&&this.nodes.set(s.tag,s),s)return this.state.subscribeTrigger(this.tag,e=>{Array.isArray(e)?s._run(s,this,...e):s._run(s,this,e)})};this.print=(s=this,e=!0,t=[])=>{let i=new g;if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g){t.push(s.tag);let r={tag:s.tag,operator:s.operator.toString()};if(s.parent&&(r.parent=s.parent.tag),typeof s.children=="object")for(let n in s.children)return typeof s.children[n]=="string"?s.children[n]:t.includes(s.children[n].tag)?s.children[n].tag:e?s.children[n].print(s.children[n],e,t):s.children[n].tag;for(let n in s)n==="parent"||n==="children"||typeof i[n]>"u"&&(typeof s[n]=="function"?r[n]=s[n].toString():typeof s[n]=="object"?r[n]=JSON.stringifyWithCircularRefs(s[n]):r[n]=s[n]);return JSON.stringify(r)}};this.reconstruct=s=>{let e=_(s);if(e)return this.add(e)};this.setState=this.state.setState;this.DEBUGNODES=(s=!0)=>{this.DEBUGNODE=s,this.nodes.forEach(e=>{s?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};if(typeof s=="function"&&(s={operator:s}),typeof s=="object"){if(s instanceof g&&s._initial&&Object.assign(s,s._initial),s instanceof m){let r=s;s={source:r,operator:n=>{if(typeof n=="object"){let a={};for(let o in n)typeof r[o]=="function"?Array.isArray(n[o])?a[o]=r[o](...n[o]):a[o]=r[o](n[o]):(r[o]=n[o],a[o]=r[o]);return a}return r}},r.operator&&(s.operator=r.operator),r.children&&(s.children=r.children),r.forward&&(s.forward=r.forward),r.backward&&(s.backward=r.backward),r.repeat&&(s.repeat=r.repeat),r.recursive&&(s.recursive=r.recursive),r.loop&&(s.loop=r.loop),r.animate&&(s.animate=r.animate),r.looper&&(s.looper=r.looper),r.animation&&(s.animation=r.animation),r.delay&&(s.delay=r.delay),r.tag&&(s.tag=r.tag),r.oncreate&&(s.oncreate=r.oncreate),r.node&&r.node._initial&&Object.assign(s,r.node._initial),r._initial&&Object.assign(s,r._initial),this.nodes=r.nodes,r.node=this,t&&r.nodes.forEach(n=>{t.nodes.get(n.tag)||(t.nodes.set(n.tag,n),t.nNodes++)})}if(s.tag&&(t||e)){let r;if(t?.nodes&&(r=t.nodes.get(s.tag)),!r&&e?.nodes&&(r=e.nodes.get(s.tag)),r){Object.assign(this,r),this.source||(this.source=r);let n=r.getProps();delete n.graph,delete n.parent,Object.assign(s,n)}}s?.operator&&(s.operator=this.setOperator(s.operator)),!s.tag&&t?s.tag=`node${t.nNodes}`:s.tag||(s.tag=`node${Math.floor(Math.random()*1e10)}`);let i=Object.getOwnPropertyNames(this);for(let r in s)i.includes(r)||(this._initial[r]=s[r]);if(s.children&&(this._initial.children=Object.assign({},s.children)),Object.assign(this,s),this.tag||(t?this.tag=`node${t.nNodes}`:this.tag=`node${Math.floor(Math.random()*1e10)}`),t&&(this.graph=t,t.nodes.get(this.tag)&&(this.tag=`${this.tag}${t.nNodes+1}`),t.nodes.set(this.tag,this),t.nNodes++),e&&(this.parent=e,(e instanceof g||e instanceof m)&&e.nodes.set(this.tag,this)),typeof s.tree=="object")for(let r in s.tree){typeof s.tree[r]=="object"&&(!s.tree[r]).tag&&(s.tree[r].tag=r);let n=new g(s.tree[r],this,t);this.nodes.set(n.tag,n)}this.children&&this.convertChildrenToNodes(this),(this.parent instanceof g||this.parent instanceof m)&&this.checkNodesHaveChildMapped(this.parent,this),typeof this.oncreate=="function"&&this.oncreate(this),this.firstRun||(this.firstRun=!0)}else return s}},m=class{constructor(s,e,t){this.nNodes=0;this.nodes=new Map;this.state=S;this.tree={};this.add=(s={})=>{let e=s;return s instanceof g?(this.nNodes=this.nodes.size,s.tag&&(this.tree[s.tag]=e,this.nodes.set(s.tag,s))):s=new g(e,this,this),s};this.setTree=(s=this.tree)=>{if(!!s){for(let e in s)if(this.nodes.get(e)){let t=this.nodes.get(e);if(typeof s[e]=="function")t.setOperator(s[e]);else if(typeof s[e]=="object")if(s[e]instanceof g)this.add(s[e]);else if(s[e]instanceof m){let i=s[e],r={};i.operator&&(r.operator=i.operator),i.children&&(r.children=i.children),i.forward&&(r.forward=i.forward),i.backward&&(r.backward=i.backward),i.repeat&&(r.repeat=i.repeat),i.recursive&&(r.recursive=i.recursive),i.loop&&(r.loop=i.loop),i.animate&&(r.animate=i.animate),i.looper&&(r.looper=i.looper),i.animation&&(r.animation=i.animation),i.delay&&(r.delay=i.delay),i.tag&&(r.tag=i.tag),i.oncreate&&(r.oncreate=i.oncreate),i.node?._initial&&Object.assign(r,i.node._initial),r.nodes=i.nodes,r.source=i,t.setProps(r)}else t.setProps(s[e])}else if(typeof s[e]=="function")this.add({tag:e,operator:s[e]});else if(typeof s[e]=="object"&&!Array.isArray(s[e])){s[e].tag||(s[e].tag=e);let t=this.add(s[e]);s[e].aliases&&s[e].aliases.forEach(i=>{this.nodes.set(i,t)})}else this.add({tag:e,operator:(t,i,...r)=>s[e]});this.nodes.forEach(e=>{if(typeof e.children=="object")for(let t in e.children)typeof e.children[t]=="string"?this.nodes.get(e.children[t])&&(e.children[t]=this.nodes.get(e.children[t])):(e.children[t]===!0||typeof e.children[t]>"u")&&this.nodes.get(t)&&(e.children[t]=this.nodes.get(t)),e.children[t]instanceof g&&e.checkNodesHaveChildMapped(e,e.children[t]);typeof e.parent=="string"&&this.nodes.get(e.parent)&&(e.parent=this.nodes.get(e.parent),e.nodes.set(e.parent.tag,e.parent))})}};this.get=s=>this.nodes.get(s);this.set=s=>this.nodes.set(s.tag,s);this.run=(s,...e)=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g)return s._run(s,this,...e)};this.runAsync=(s,...e)=>(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g?new Promise((t,i)=>{t(s._run(s,this,...e))}):new Promise((t,i)=>{t(void 0)}));this._run=(s,e=this,...t)=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g)return s._run(s,e,...t)};this.removeTree=(s,e)=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g){e||(e={});let t=i=>{i.children&&!e[i.tag]&&(e[i.tag]=!0,Array.isArray(i.children)?i.children.forEach(r=>{r.stopNode&&r.stopNode(),r.tag&&this.nodes.get(r.tag)&&this.nodes.delete(r.tag),this.nodes.forEach(n=>{n.nodes.get(r.tag)&&n.nodes.delete(r.tag)}),t(r)}):typeof i.children=="object"&&(i.stopNode&&i.stopNode(),i.tag&&this.nodes.get(i.tag)&&this.nodes.delete(i.tag),this.nodes.forEach(r=>{r.nodes.get(i.tag)&&r.nodes.delete(i.tag)}),t(i)))};s.stopNode&&s.stopNode(),s.tag&&(this.nodes.delete(s.tag),this.nodes.forEach(i=>{i.nodes.get(i.tag)&&i.nodes.delete(i.tag)}),this.nNodes=this.nodes.size,t(s)),s.ondelete&&s.ondelete(s)}return s};this.remove=s=>(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&(s.stopNode(),s?.tag&&this.nodes.get(s.tag)&&(this.nodes.delete(s.tag),this.nodes.forEach(e=>{e.nodes.get(e.tag)&&e.nodes.delete(e.tag)})),s.ondelete&&s.ondelete(s)),s);this.append=(s,e)=>{e.addChildren(s)};this.callParent=async(s,e=s,...t)=>{if(s?.parent)return await s.callParent(s,e,...t)};this.callChildren=async(s,e,...t)=>{if(s?.children)return await s.callChildren(e,...t)};this.subscribe=(s,e)=>{if(!!e){if(s instanceof g&&typeof e=="function")return s.subscribe(e);if(e instanceof g||typeof e=="string")return this.subscribeNode(s,e);if(typeof s=="string")return this.state.subscribeTrigger(s,e)}};this.unsubscribe=(s,e)=>{this.state.unsubscribeTrigger(s,e)};this.subscribeNode=(s,e)=>{let t;if(s?.tag?t=s.tag:typeof s=="string"&&(t=s),typeof e=="string"&&(e=this.nodes.get(e)),s&&e)return this.state.subscribeTrigger(t,r=>{Array.isArray(r)?e.run(...r):e.run(r)})};this.stopNode=s=>{typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&s.stopNode()};this.print=(s=void 0,e=!0)=>{if(s instanceof g)return s.print(s,e);{let t="{";return this.nodes.forEach(i=>{t+=`
"${i.tag}:${i.print(i,e)}"`}),t}};this.reconstruct=s=>{let e=_(s);if(e)return this.add(e)};this.create=(s,e,t)=>R(s,e,t,this);this.setState=this.state.setState;this.DEBUGNODES=(s=!0)=>{this.nodes.forEach(e=>{s?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};this.tag=e||`graph${Math.floor(Math.random()*1e11)}`,t&&(Object.assign(this,t),this._initial=t),(s||Object.keys(this.tree).length>0)&&this.setTree(s)}};function U(l,s,e){let t=_(l);if(t)return new g(t,s,e)}function _(l="{}"){try{let s=typeof l=="string"?JSON.parse(l):l,e=t=>{for(let i in t)if(typeof t[i]=="string"){let r=k(t[i]);typeof r=="function"&&(t[i]=r)}else typeof t[i]=="object"&&e(t[i]);return t};return e(s)}catch(s){console.error(s);return}}var G=function(){let l=new Map,s=[],e=["this"];function t(){l.clear(),s.length=0,e.length=1}function i(n,a){var o=s.length-1,h=s[o];if(typeof h=="object")if(h[n]===a||o===0)e.push(n),s.push(a.pushed);else for(;o-->=0;){if(h=s[o],typeof h=="object"&&h[n]===a){o+=2,s.length=o,e.length=o,--o,s[o]=a,e[o]=n;break}o--}}function r(n,a){if(a!=null&&typeof a=="object"){n&&i(n,a);let o=l.get(a);if(o)return"[Circular Reference]"+o;l.set(a,e.join("."))}return a}return function(a,o){try{return s.push(a),JSON.stringify(a,r,o)}finally{t()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=G);var v=function(){let l=new Map,s=[],e=["this"];function t(){l.clear(),s.length=0,e.length=1}function i(n,a){var o=s.length-1;if(s[o]){var h=s[o];if(typeof h=="object")if(h[n]===a||o===0)e.push(n),s.push(a.pushed);else for(;o-->=0;){if(h=s[o],typeof h=="object"&&h[n]===a){o+=2,s.length=o,e.length=o,--o,s[o]=a,e[o]=n;break}o++}}}function r(n,a){let o;if(a!=null)if(typeof a=="object"){let h=a.constructor.name;n&&h==="Object"&&i(n,a);let f=l.get(a);if(f)return"[Circular Reference]"+f;if(l.set(a,e.join(".")),h==="Array")a.length>20?o=a.slice(a.length-20):o=a;else if(h.includes("Set"))o=Array.from(a);else if(h!=="Object"&&h!=="Number"&&h!=="String"&&h!=="Boolean")o="instanceof_"+h;else if(h==="Object"){let d={};for(let c in a)if(a[c]==null)d[c]=a[c];else if(Array.isArray(a[c]))a[c].length>20?d[c]=a[c].slice(a[c].length-20):d[c]=a[c];else if(a[c].constructor.name==="Object"){d[c]={};for(let p in a[c])if(Array.isArray(a[c][p]))a[c][p].length>20?d[c][p]=a[c][p].slice(a[c][p].length-20):d[c][p]=a[c][p];else if(a[c][p]!=null){let u=a[c][p].constructor.name;u.includes("Set")?d[c][p]=Array.from(a[c][p]):u!=="Number"&&u!=="String"&&u!=="Boolean"?d[c][p]="instanceof_"+u:d[c][p]=a[c][p]}else d[c][p]=a[c][p]}else{let p=a[c].constructor.name;p.includes("Set")?d[c]=Array.from(a[c]):p!=="Number"&&p!=="String"&&p!=="Boolean"?d[c]="instanceof_"+p:d[c]=a[c]}o=d}else o=a}else o=a;return o}return function(a,o){s.push(a);let h=JSON.stringify(a,r,o);return t(),h}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=v);function R(l,s,e,t){return typeof e=="object"?(e.operator=l,new g(e,s,t)):new g({operator:l},s,t)}var O=class extends m{constructor(e={}){super(void 0,e.name?e.name:`service${Math.floor(Math.random()*1e14)}`,e.props);this.routes={};this.loadDefaultRoutes=!1;this.keepState=!0;this.firstLoad=!0;this.init=e=>{e?e=Object.assign({},e):e={},e.customRoutes?Object.assign(e.customRoutes,this.customRoutes):e.customRoutes=this.customRoutes,e.customChildren?Object.assign(e.customChildren,this.customChildren):e.customChildren=this.customChildren,Array.isArray(e.routes)?e.routes.forEach(t=>{this.load(t,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren)}):(e.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)&&this.load(e.routes,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren)};this.load=(e,t=!0,i=".",r,n)=>{if(!e&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;this.firstLoad&&(this.firstLoad=!1),r?r=Object.assign(this.customRoutes,r):r=this.customRoutes,n&&(n=Object.assign(this.customChildren,n));let a,o={};if(e){if(!(e instanceof m)&&e?.name)if(e.module){let f=e;e={},Object.getOwnPropertyNames(e.module).forEach(d=>{t?e[f.name+i+d]=e.module[d]:e[d]=e.module[d]})}else typeof e=="function"&&(a=new e({loadDefaultRoutes:this.loadDefaultRoutes}),a.load(),e=a.routes);else if(e instanceof m||e.source instanceof m){a=e,e={};let f;t&&(f=a.name,f||(f=a.tag,a.name=f),f||(f=`graph${Math.floor(Math.random()*1e15)}`,a.name=f,a.tag=f)),a.customRoutes&&!this.customRoutes?this.customRoutes=a.customRoutes:a.customRoutes&&this.customRoutes&&Object.assign(this.customRoutes,a.customRoutes),a.customChildren&&!this.customChildren?this.customChildren=a.customChildren:a.customChildren&&this.customChildren&&Object.assign(this.customChildren,a.customChildren),a.nodes.forEach(d=>{e[d.tag]=d;let c={},p=(u,y)=>{if((!c[u.tag]||y&&t&&!c[y?.tag+i+u.tag])&&(y?c[y.tag+i+u.tag]=!0:c[u.tag]=!0,u instanceof m||u.source instanceof m)){if(t){let b=u.name;b||(b=u.tag,u.name=b),b||(b=`graph${Math.floor(Math.random()*1e15)}`,u.name=b,u.tag=b)}u.nodes.forEach(b=>{t&&!e[u.tag+i+b.tag]?e[u.tag+i+b.tag]=b:e[b.tag]||(e[b.tag]=b),p(b,u)})}};p(d)})}else if(typeof e=="object"){let f=e.constructor.name;if(f==="Object"&&(f=Object.prototype.toString.call(e),f&&(f=f.split(" ")[1]),f&&(f=f.split("]")[0])),f&&f!=="Object"){let d=e;e={},Object.getOwnPropertyNames(d).forEach(c=>{t?e[f+i+c]=d[c]:e[c]=d[c]})}}if(a instanceof m&&a.name&&t){e=Object.assign({},e);for(let f in e){let d=e[f];delete e[f],e[a.name+i+f]=d}}}if(this.loadDefaultRoutes){let f=Object.assign({},this.defaultRoutes);e?(Object.assign(f,this.routes),e=Object.assign(f,e)):e=Object.assign(f,this.routes),this.loadDefaultRoutes=!1}e||(e=this.routes);let h=0;for(let f in e){h++;let d=(c,p)=>{if(typeof c=="object"&&(c.tag||(c.tag=p),typeof c?.children=="object")){e:for(let u in c.children)if(h++,typeof c.children[u]=="object"){let y=c.children[u];if(y.tag&&o[y.tag])continue;if(n){for(let w in n)if(y=n[w](y,u,c,e,o),!y)continue e}y.id&&!y.tag&&(y.tag=y.id);let b;if(y.tag)if(o[y.tag]){let w=`${y.tag}${h}`;o[w]=y,y.tag=w,d(o[w],u),b=w}else o[y.tag]=y,d(o[y.tag],u),b=y.tag;else if(o[u]){let w=`${u}${h}`;o[w]=y,y.tag=w,d(o[w],u),b=w}else o[u]=y,d(o[u],u),b=u;a?.name&&t?(o[a.name+i+b]=y,delete o[b]):o[b]=y}}};o[f]=e[f],d(e[f],f)}e:for(let f in o)if(typeof o[f]=="object"){let d=o[f];if(typeof d=="object"){if(r){for(let c in r)if(d=r[c](d,f,o),!d)continue e}d.get&&d.get,d.post,d.delete,d.put,d.head,d.patch,d.options,d.connect,d.trace,d.post&&!d.operator?o[f].operator=d.post:!d.operator&&typeof d.get=="function"&&(o[f].operator=d.get)}}for(let f in e)typeof e[f]=="object"?this.routes[f]?typeof this.routes[f]=="object"?Object.assign(this.routes[f],e[f]):this.routes[f]=e[f]:this.routes[f]=e[f]:this.routes[f]?typeof this.routes[f]=="object"?Object.assign(this.routes[f],e[f]):this.routes[f]=e[f]:this.routes[f]=e[f];if(a)for(let f in this.routes)this.routes[f]instanceof g&&(this.nodes.set(f,this.routes[f]),this.nNodes=this.nodes.size);else this.setTree(this.routes);for(let f in this.routes)this.routes[f]?.aliases&&this.routes[f].aliases.forEach(c=>{a?.name&&t?e[a.name+i+c]=this.routes[f]:e[c]=this.routes[f]});return this.routes};this.unload=(e=this.routes)=>{if(!e)return;let t;!(e instanceof O)&&typeof e=="function"?(t=new O,e=t.routes):e instanceof O&&(e=e.routes);for(let i in e)delete this.routes[i],this.nodes.get(i)&&this.remove(i);return this.routes};this.handleMethod=(e,t,i,r)=>{let n=t.toLowerCase();return n==="get"&&this.routes[e]?.get?.transform instanceof Function?Array.isArray(i)?this.routes[e].get.transform(...i):this.routes[e].get.transform(i):this.routes[e]?.[n]?this.routes[e][n]instanceof Function?this.routes[e][n](i):(i&&(this.routes[e][n]=i),this.routes[e][n]):this.handleServiceMessage({route:e,args:i,method:t,origin:r})};this.transmit=(...e)=>typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args,e[0].origin):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e;this.receive=(...e)=>{if(e[0]&&typeof e[0]=="string"){let t=e[0].substring(0,8);(t.includes("{")||t.includes("["))&&(t.includes("\\")&&(e[0]=e[0].replace(/\\/g,"")),e[0][0]==='"'&&(e[0]=e[0].substring(1,e[0].length-1)),e[0]=JSON.parse(e[0]))}return typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args,e[0].origin):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e};this.pipe=(e,t,i,r,n,a)=>{if(e instanceof g)return a?e.subscribe(o=>{let h=a(o);h!==void 0?this.transmit({route:t,args:h,origin:r,method:n}):this.transmit({route:t,args:o,origin:r,method:n},i)}):this.subscribe(e,o=>{this.transmit({route:t,args:o,origin:r,method:n},i)});if(typeof e=="string")return this.subscribe(e,o=>{this.transmit({route:t,args:o,origin:r,method:n},i)})};this.pipeOnce=(e,t,i,r,n,a)=>{if(e instanceof g)return a?e.state.subscribeTriggerOnce(e.tag,o=>{let h=a(o);h!==void 0?this.transmit({route:t,args:h,origin:r,method:n}):this.transmit({route:t,args:o,origin:r,method:n},i)}):this.state.subscribeTriggerOnce(e.tag,o=>{this.transmit({route:t,args:o,origin:r,method:n},i)});if(typeof e=="string")return this.state.subscribeTriggerOnce(e,o=>{this.transmit({route:t,args:o,origin:r,method:n},i)})};this.terminate=(...e)=>{this.nodes.forEach(t=>{t.stopNode()})};this.recursivelyAssign=(e,t)=>{for(let i in t)typeof t[i]=="object"?typeof e[i]=="object"?this.recursivelyAssign(e[i],t[i]):e[i]=this.recursivelyAssign({},t[i]):e[i]=t[i];return e};this.defaultRoutes={"/":{get:()=>this.print(),aliases:[""]},ping:()=>(console.log("ping"),"pong"),echo:(...e)=>(this.transmit(...e),e),assign:e=>typeof e=="object"?(Object.assign(this,e),!0):!1,recursivelyAssign:e=>typeof e=="object"?(this.recursivelyAssign(this,e),!0):!1,log:{post:(...e)=>{console.log("Log: ",...e)},aliases:["info"]},error:e=>{let t=new Error(e);return console.error(e),t},state:e=>e?this.state.data[e]:this.state.data,printState:e=>e?G(this.state.data[e]):G(this.state.data),spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,_run:this._run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};e.name?this.name=e.name:e.name=this.tag,"loadDefaultRoutes"in e&&(this.loadDefaultRoutes=e.loadDefaultRoutes,this.routes=Object.assign(this.defaultRoutes,this.routes)),(e||Object.keys(this.routes).length>0)&&this.init(e)}handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?e.origin?Array.isArray(e.args)?this._run(t,e.origin,...e.args):this._run(t,e.origin,e.args):Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t,i){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return i?Array.isArray(t)?this._run(e,i,...t):this._run(e,i,t):Array.isArray(t)?this.run(e,...t):this.run(e,t)}isTypedArray(e){return ArrayBuffer.isView(e)&&Object.prototype.toString.call(e)!=="[object DataView]"}spliceTypedArray(e,t,i){let r=e.subarray(0,t),n;i&&(n=e.subarray(i+1));let a;return(r.length>0||n?.length>0)&&(a=new e.constructor(r.length+n.length)),r.length>0&&a.set(r),n&&n.length>0&&a.set(n,r.length),a}};var N=class{constructor(s,e){this.id=`router${Math.floor(Math.random()*1e15)}`;this.service=new O;this.nodes=this.service.nodes;this.run=this.service.run;this._run=this.service._run;this.add=this.service.add;this.remove=this.service.remove;this.stopNode=this.service.stopNode;this.subscribe=this.service.subscribe;this.unsubscribe=this.service.unsubscribe;this.get=this.service.get;this.reconstruct=this.service.reconstruct;this.setState=this.service.setState;this.recursivelyAssign=this.service.recursivelyAssign;this.state=this.service.state;this.routes=this.service.routes;this.services={};this.loadDefaultRoutes=!1;this.load=(s,e=!0,t=!0,i=".",r,n)=>{if(!(s instanceof m)&&typeof s=="function")s=new s({loadDefaultRoutes:this.loadDefaultRoutes,name:s.name}),s.load();else if(!s)return;if(s instanceof m&&s.name)this.services[s.name]=s;else if(s.constructor.name==="Object"){let o=Object.prototype.toString.call(s);o&&(o=o.split(" ")[1]),o&&(o=o.split("]")[0]),o&&o!=="Object"&&o!=="Function"&&(this.services[o]=s)}else this.services[s.constructor.name]=s;let a=this.service.load(s,t,i,r,n);return e&&this.syncServices(),a};this.syncServices=()=>{for(let s in this.services)this.service.nodes.forEach(e=>{this.services[s]?.nodes&&(this.services[s].nodes.get(e.tag)||this.services[s].nodes.set(e.tag,e))})};this.pipe=(s,e,t,i,r,n)=>{if(!t&&s&&e)return n?this.subscribe(s,a=>{let o=n(a);o&&(a=o),this.run(e,a)}):this.subscribe(s,a=>{this.run(e,a)});if(t){t==="sockets"&&(t="wss");let a=this.services[t];if(a)return n?this.subscribe(s,o=>{let h=n(o);h&&(o=h),a.transmit({route:e,args:o,origin:i,method:r})}):this.subscribe(s,o=>{a.transmit({route:e,args:o,origin:i,method:r})});{let o=this.getEndpointInfo(t);if(o)return this.services[o.service].pipe(s,e,t,i,r,n)}}return!1};this.pipeOnce=(s,e,t,i,r,n)=>{if(s instanceof g&&(s=s.tag),!t&&typeof s=="string"&&e)return n?this.state.subscribeTriggerOnce(s,a=>{let o=n(a);o&&(a=o),this.run(e,a)}):this.state.subscribeTriggerOnce(s,a=>{this.run(e,a)});if(t){t==="sockets"&&(t="wss");let a=this.services[t];if(a)return n?this.state.subscribeTriggerOnce(s,o=>{let h=n(o);h&&(o=h),a.transmit({route:e,args:o,origin:i,method:r})}):this.state.subscribeTriggerOnce(s,o=>{a.transmit({route:e,args:o,origin:i,method:r})});{let o=this.getEndpointInfo(t);if(o)return this.services[o.service].pipeOnce(s,e,t,i,r,n)}}return!1};this.sendAll=(s,e,t)=>{let i=!1;if(typeof e=="object")for(let r in e)for(let n in e[r]){let a=e[r][n];if(a.socket)a.socket.readyState===1?(a.socket.send(s),i=!0):delete e[r][n];else if(a.wss)a.wss.clients.forEach(o=>{o.send(s)}),i=!0;else if(a.sessions)if(t)a.channel.broadcast(s,t),i=!0;else for(let o in a.sessions)a.sessions[o].isConnected&&(a.sessions[o].push(s),i=!0);else if(a.session)t?(a.served.channel.broadcast(s,t),i=!0):a.session.isConnected?(a.session.push(s),i=!0):delete e[r][n];else if(a.rtc)if(t&&a.channels[t])a.channels[t].send(s),i=!0;else if(a.channels.data)a.channels.data.send(s),i=!0;else{let o=Object.keys(a.channels)[0];a.channels[o].send(s),i=!0}else a.server&&this.services.http&&(this.services.http.transmit(s,t),i=!0)}return i};this.getEndpointInfo=(s,e)=>{if(!s)return;let t=(i,r)=>{if(this.services[r]){if(this.services[r].rtc?.[i])return this.services[r].rtc[i];if(this.services[r].servers?.[i])return this.services[r].servers[i];if(this.services[r].sockets?.[i])return this.services[r].sockets[i];if(this.services[r].eventsources?.[i])return this.services[r].eventsources[i];if(this.services[r].workers?.[i])return this.services[r].workers[i]}};if(e){let i=t(s,e);if(i)return{endpoint:i,service:e}}for(let i in this.services){let r=t(s,i);if(r)return{endpoint:r,service:i}}};this.pipeFastest=(s,e,t,i,r,n=this.services)=>{for(let a in n){if(n[a].rtc)return this.pipe(s,e,"webrtc",t,i,r);if(n[a].eventsources){let o=Object.keys(n[a].eventsources);if(o[0]&&this.services[a].eventsources[o[0]].sessions)return this.pipe(s,e,"sse",t,i,r)}if(n[a].sockets)return this.pipe(s,e,"wss",t,i,r);if(n[a].servers)return this.pipe(s,e,"http",t,i,r);if(n[a].workers)return this.pipe(s,e,"worker",t,i,r)}return!1};this.getFirstRemoteEndpoint=(s=this.services)=>{let e;for(let i in s){if(s[i].rtc&&(e=s[i].rtc),s[i].eventsources&&!e){let r=Object.keys(s[i].eventsources);r[0]&&this.services[i].eventsources[r[0]]?.sessions&&(e=s[i].eventsources)}s[i].sockets&&!e&&(e=s[i].sockets),s[i].servers&&!e&&(e=s[i].servers),s[i].workers&&!e&&(e=s[i].workers)}let t=Object.keys(e);return t[0]?e[t[0]]:!1};this.STREAMLATEST=0;this.STREAMALLLATEST=1;this.streamSettings={};this.streamFunctions={allLatestValues:(s,e)=>{let t;if(Array.isArray(s))s.length!==e.lastRead&&(t=s.slice(e.lastRead),e.lastRead=s.length);else if(typeof s=="object"){t={};for(let i in s)Array.isArray(s[i])?(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),s[i].length!==e[i].lastRead&&(t[i]=s[i].slice(e[i].lastRead),e[i].lastRead=s[i].length)):(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),e[i].lastRead!==s[i]&&(t[i]=s[i],e[i].lastRead=s[i]));Object.keys(t).length===0&&(t=void 0)}else e.lastRead!==s&&(t=s,e.lastRead=s);return t},latestValue:(s,e)=>{let t;if(Array.isArray(s))s.length!==e.lastRead&&(t=s[s.length-1],e.lastRead=s.length);else if(typeof s=="object"){t={};for(let i in s)Array.isArray(s[i])?(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),s[i].length!==e[i].lastRead&&(t[i]=s[i][s[i].length-1],e[i].lastRead=s[i].length)):(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),e[i].lastRead!==s[i]&&(t[i]=s[i],e[i].lastRead=s[i]))}else e.lastRead!==s&&(t=s,e.lastRead=s);return t}};this.setStreamFunc=(s,e,t=this.streamFunctions.allLatestValues)=>(this.streamSettings[s].settings[e]||(this.streamSettings[s].settings[e]={lastRead:0}),t===this.STREAMLATEST?this.streamSettings[s].settings[e].callback=this.streamFunctions.latestValue:t===this.STREAMALLLATEST?this.streamSettings[s].settings[e].callback=this.streamFunctions.allLatestValues:typeof t=="string"?this.streamSettings[s].settings[e].callback=this.streamFunctions[t]:typeof t=="function"&&(this.streamSettings[s].settings[e].callback=t),this.streamSettings[s].settings[e].callback||(this.streamSettings[s].settings[e].callback=this.streamFunctions.allLatestValues),!0);this.addStreamFunc=(s,e=t=>{})=>{this.streamFunctions[s]=e};this.setStream=(s={},e={},t=`stream${Math.floor(Math.random()*1e10)}`)=>{if(e.keys){if(e.keys.length===0){let i=Object.keys(s);i.length>0&&(e.keys=Array.from(i))}}else e.keys=Array.from(Object.keys(s));return this.streamSettings[t]={object:s,settings:e},e.keys.forEach(i=>{e[i]?.callback?this.setStreamFunc(t,i,e[i].callback):this.setStreamFunc(t,i,e.callback)}),this.streamSettings[t]};this.removeStream=(s,e)=>{if(s&&!e)delete this.streamSettings[s];else if(e&&this.streamSettings[s]?.settings?.keys){let t=this.streamSettings[s].settings.keys.indexOf(e);return t>-1&&this.streamSettings[s].settings.keys.splice(t,1),this.streamSettings[s].settings[e]&&delete this.streamSettings[s].settings[e],!0}return!1};this.updateStreamData=(s,e={})=>this.streamSettings[s]?(Object.assign(this.streamSettings[s].object,e),this.streamSettings[s].object):!1;this.streamLoop=(s,e)=>{let t={};for(let i in this.streamSettings)this.streamSettings[i].settings.keys.forEach(r=>{if(this.streamSettings[i].settings[r]){let n=this.streamSettings[i].settings[r].callback(this.streamSettings[i].object[r],this.streamSettings[i].settings[r]);n!==void 0&&(t[r]=n)}});return s&&this.sendAll(t,s,e),t};this.receive=(s,e,...t)=>{if(e){for(let i in this.services)if(i===e||this.services[i].name===e)return this.services[i].receive(s,...t)}return this.service.receive(s,...t)};this.transmit=(s,e,...t)=>{if(e){for(let i in this.services)if(i===e||this.services[i].name===e)return this.services[i].transmit(s,...t)}return this.service.transmit(s,...t)};this.defaultRoutes={getEndpointInfo:this.getEndpointInfo,pipeOnce:this.pipeOnce,pipeFastest:this.pipeFastest,setStream:this.setStream,removeStream:this.removeStream,updateStreamData:this.updateStreamData,addStreamFunc:this.addStreamFunc,setStreamFunc:this.setStreamFunc,sendAll:this.sendAll,streamLoop:{operator:this.streamLoop,loop:10}};e&&"loadDefaultRoutes"in e&&(this.loadDefaultRoutes=e.loadDefaultRoutes),this.loadDefaultRoutes&&this.load(this.defaultRoutes,e?.linkServices,e?.includeClassName,e?.routeFormat,e?.customRoutes,e?.customChildren),Array.isArray(s)?s.forEach(t=>this.load(t,e?.linkServices,e?.includeClassName,e?.routeFormat,e?.customRoutes,e?.customChildren)):typeof s=="object"&&Object.keys(s).forEach(t=>this.load(s[t],e?.linkServices,e?.includeClassName,e?.routeFormat,e?.customRoutes,e?.customChildren))}};var j=class extends N{constructor(e,t){super(e,t);this.users={};this.sessions={private:{},shared:{}};this.runAs=(e,t,...i)=>(typeof t=="object"&&(t=t._id),this._run(e,t,...i));this.pipeAs=(e,t,i,r,n,a)=>(typeof r=="object"&&(r=r._id),this.pipe(e,t,i,r,n,a));this._initConnections=e=>{if(e.sockets&&this.services.wss)for(let t in e.sockets){if(e.sockets[t]._id){if(this.services.wss.servers){for(let i in this.services.wss.servers)for(let r in this.services.wss.servers[i].clients)if(r===e.sockets[t]._id){e.sockets[t]={socket:this.services.wss.servers[i].clients[r],_id:r,address:t};break}}if(!e.sockets[t].socket){for(let i in this.services.wss.sockets)if(this.services.wss.sockets[i]._id===e.sockets[t]._id){e.sockets[t]=this.services.wss.sockets[t];break}}}e.sockets[t].socket||(e.sockets[t]=this.run("wss/openWS",e.sockets[t])),e.onmessage&&e.sockets[t].socket.addEventListener("message",e.onmessage),e.onclose&&e.sockets[t].socket.addEventListener("close",e.onclose)}if(e.wss&&this.services.wss)for(let t in e.wss){if(e.wss[t]._id){for(let i in this.services.wss.servers)if(this.services.wss.servers[i]._id===e.server[t]._id){e.wss[t]=this.services.wss.server[t];break}}e.wss[t].wss||(e.wss[t]=this.run("wss/openWSS",e.wss[t])),e.onmessage&&e.wss[t].wss.addEventListener("message",e.onmessage),e.onclose&&e.wss[t].wss.addEventListener("close",e.onclose)}if(e.eventsources&&this.services.sse)for(let t in e.eventsources){if(e.eventsources[t]._id){for(let i in this.services.sse.eventsources)if(this.services.sse.eventsources[i]._id===e.eventsources[t]._id){e.eventsources[t]=this.services.sse.eventsources[i];break}else if(this.services.sse.eventsources[i].sessions?.[e.eventsources[t]._id]){e.eventsources[t]={session:this.services.sse.eventsources[i].sessions[e.eventsources[t]._id],_id:t};break}else if(this.services.sse.eventsources[i].session?.[e.eventsources[t]._id]){e.eventsources[t]=this.services.sse.eventsources[i];break}}!e.eventsources[t].source&&!e.eventsources[t].sessions&&!e.eventsources[t].session&&(e.eventsources[t]=this.run("sse/openSSE",e.eventsources[t])),e.eventsources[t].source&&(e.onmessage&&e.eventsources[t].source.addEventListener("message",e.onmessage),e.onclose&&e.eventsources[t].source.addEventListener("close",e.onclose))}if(e.servers&&this.services.http)for(let t in e.servers)e.servers[t].server||(e.servers[t]=this.run("http/setupServer",e.servers[t])),e.onmessage&&this.subscribe(t,e.onmessage);if(e.webrtc&&this.services.webrtc){for(let t in e.webrtc)if(e.webrtc[t].rtc){let i=e.webrtc[t].channels.data;i||(i=e.webrtc[t].channels[Object.keys(e.webrtc[t].channels)[0]]),i&&i.addEventListener("message",e.onmessage)}}if(e.sessions&&e._id)for(let t in e.sessions)typeof e.sessions[t]=="string"?e.sessions[t]=this.joinSession(e.sessions[t],e._id):typeof e.sessions[t]=="object"&&(e.sessions[t]=this.joinSession(t,e._id,e.sessions[t]))};this.addUser=async(e,t=5e3)=>{if(e||(e={}),e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`),e.tag=e._id,typeof e=="object"&&(e.onmessage||(e.onmessage=i=>{this.setState({[e.tag]:i})}),e.onclose||(e.onclose=()=>{this.removeUser(e._id)}),e.operator=e.onmessage,e.send||(e.send=(i,r)=>{if(!!this.users[e._id])if(typeof this.users[e._id].sendAll=="object"){i.route&&!i.origin&&(i.origin=e._id),typeof i=="object"&&(i=JSON.stringify(i));for(let n in this.users[e._id].sendAll)for(let a in this.users[e._id].sendAll[n]){let o=this.users[e._id].sendAll[n][a];if(o.socket)o.socket.readyState===1?o.socket.send(i):delete this.users[e._id].sendAll[n][a];else if(o.rtc)if(r&&o.channels[r])o.channels[r].send(i);else if(o.channels.data)o.channels.data.send(i);else{let h=Object.keys(o.channels)[0];o.channels[h].send(i)}else if(o.wss)o.wss.clients.forEach(h=>{h.send(i)});else if(o.sessions)if(r)o.channel.broadcast(i,r);else for(let h in o.sessions)o.sessions[h].isConnected&&o.sessions[h].push(i);else o.session?r?o.served.channel.broadcast(i,r):o.session.isConnected?o.session.push(i):delete this.users[e._id].sendAll[n][a]:o.server&&this.services.http&&this.services.http.transmit(i,r)}}else{let n;if(this.users[e._id].sendAll&&typeof this.users[e._id].sendAll=="string"&&(n=this.user[this.users[e._id].sendAll],this.users[e._id].sendAll={}),!n){if(this.users[e._id].sendAll={},this.users[e._id].webrtc){let a=Object.keys(this.users[e._id].webrtc)[0];a&&(this.users[e._id].sendAll.webrtc={[a]:this.users[e._id].webrtc[a]})}else if(this.users[e._id].eventsources&&this.users[e._id].eventsources[Object.keys(this.users[e._id].eventsources)[0]].session){let a=Object.keys(this.users[e._id].eventsources)[0];a&&(this.users[e._id].sendAll.eventsources={[a]:this.users[e._id].eventsources[a]})}else if(this.users[e._id].eventsources&&this.users[e._id].eventsources[Object.keys(this.users[e._id].eventsources)[0]].sessions){let a=Object.keys(this.users[e._id].eventsources)[0];a&&(this.users[e._id].sendAll.eventsources={[a]:this.users[e._id].eventsources[a]})}else if(this.users[e._id].sockets){let a=Object.keys(this.users[e._id].sockets)[0];a&&(this.users[e._id].sendAll.sockets={[a]:this.users[e._id].sockets[a]})}else if(this.users[e._id].wss){let a=Object.keys(this.users[e._id].wss)[0];a&&(this.users[e._id].sendAll.wss={[a]:this.users[e._id].wss[a]})}else if(this.users[e._id].servers){let a=Object.keys(this.users[e._id].servers)[0];a&&(this.users[e._id].sendAll.servers={[a]:this.users[e._id].servers[a]})}}this.users[e._id].sendAll&&Object.keys(this.users[e._id].sendAll).length>0&&this.users[e._id].send(i,r)}}),e.request||(e.request=(i,r,n,a,o)=>{if(!r){if(this.users[e._id].sockets){for(let d in this.users[e._id].sockets)if(this.users[e._id].sockets[d].socket){if(n=this.users[e._id].sockets[d]._id,!n)continue;r=this.users[e._id].sockets[d].socket;break}}if(!r&&this.users[e._id].webrtc){for(let d in this.users[e._id].webrtc)if(this.users[e._id].webrtc[d].channels.data){if(n=this.users[e._id].webrtc[d]._id,!n)return;r=this.users[e._id].webrtc[d].channels.data;break}else if(Object.keys(this.users[e._id].webrtc[d].channels).length>0){if(n=this.users[e._id].webrtc[d]._id,!n)return;r=this.users[e._id].webrtc[d].channels[Object.keys(this.users[e._id].webrtc[d].channels)[0]];break}}if(!r)return}let h=`${Math.random()}`,f={route:"runRequest",args:[i,n,h],origin:e._id};return o&&(f.method=o),a&&(f.origin=a),new Promise((d,c)=>{let p=u=>{let y=u.data;typeof y=="string"&&y.includes("callbackId")&&(y=JSON.parse(y)),typeof y=="object"&&y.callbackId===h&&(r.removeEventListener("message",p),d(y.args))};r.addEventListener("message",p),r.send(JSON.stringify(f))})}),this._initConnections(e),e instanceof g||(this.users[e._id]=new g(e,void 0,this.service)),this.users[e._id].sockets||this.users[e._id].eventsources||this.users[e._id].webrtc)){let i=[];for(let r in this.users[e._id].sockets)this.users[e._id].sockets[r]._id||i.push(this.users[e._id].sockets[r]);for(let r in this.users[e._id].eventsources)!this.users[e._id].eventsources[r]._id&&this.users[e._id].eventsources[r].source&&i.push(this.users[e._id].eventsources[r]);for(let r in this.users[e._id].webrtc)this.users[e._id].webrtc[r]._id||i.push(this.users[e._id].webrtc[r]);if(i.length>0)return await new Promise((r,n)=>{let a=performance.now(),o=()=>{let h=i.filter(f=>{if(!f._id)return!0});if(h.length>0){if(performance.now()-a>t)return n(h),this.users[e._id];setTimeout(()=>{o()},100)}else return r(this.users[e._id]),this.users[e._id]};o()}).catch(r=>{console.error("Connections timed out:",r)})}return await this.users[e._id]};this.removeUser=e=>{if(typeof e=="string"&&(e=this.users[e]),!e)return!1;if(e.sockets)for(let t in e.sockets)e.sockets[t].socket&&this.run("wss/terminate",t);if(e.wss)for(let t in e.wss)e.wss[t].wss&&this.run("wss/terminate",t);if(e.eventsources)for(let t in e.eventsources)(e.eventsources[t].source||e.eventsources[t].sessions)&&this.run("sse/terminate",t);if(e.servers)for(let t in e.servers)e.servers[t].server&&this.run("http/terminate",t);if(e.webrtc)for(let t in e.webrtc)e.webrtc[t].rtc&&this.run("webrtc/terminate",t);return e.sessions,delete this.users[e._id],!0};this.updateUser=(e,t)=>(typeof e=="string"&&(e=this.users[e]),e?(this._initConnections(t),t._id!==e._id&&(delete this.users[e._id],e._id=t._id,this.users[e._id]=e),this.recursivelyAssign(this.users[e._id],t),e):!1);this.setUser=(e,t)=>e&&typeof e=="string"&&(e=this.users[e],!e)?!1:(t&&typeof t=="string"&&(t=JSON.parse(t)),this.recursivelyAssign(e,t),!0);this.getConnectionInfo=e=>{let t={_id:e._id};if(e.sockets){t.sockets={};for(let i in e.sockets)e.sockets[i]._id&&(t.sockets[i]={_id:e.sockets[i]._id,host:e.sockets[i].host,port:e.sockets[i].port,path:e.sockets[i].path,address:e.sockets[i].address})}if(e.eventsources){t.eventsources={};for(let i in e.eventsources)e.eventsources[i]._id&&(t.eventsources[i]={_id:e.eventsources[i]._id,url:e.eventsources[i].url})}if(e.webrtc){t.webrtc={};for(let i in e.webrtc)e.webrtc[i]._id&&(t.webrtc[i]={_id:e.webrtc[i]._id,icecandidate:e.webrtc[i].icecandidate})}if(e.servers){t.servers={};for(let i in e.servers)e.servers[i].server&&(t.servers[i]={host:e.servers[i].host,port:e.servers[i].port,protocol:e.servers[i].protocol,address:e.servers[i].address})}if(e.wss){t.wss={};for(let i in e.wss)e.wss[i]._id&&(t.wss[i]={host:e.wss[i].host,port:e.wss[i].port,path:e.wss[i].path,address:e.wss[i].address})}if(e.sessions){t.sessions={};for(let i in e.sessions)e.sessions[i]._id&&(t.sessions[i]={_id:e.sessions[i]._id,type:e.sessions[i].type,users:e.sessions[i].users})}return t};this.getSessionInfo=(e,t)=>{if(typeof t=="object"&&(t=t._id),e)if(this.sessions.private[e]){let i=this.sessions.private[e];if(i.settings&&(i.settings.source===t||i.settings.listener===t||i.settings.ownerId===t||i.settings.admins?.[t]||i.settings.moderators?.[t]))return{private:{[e]:i}}}else{if(this.sessions.shared[e])return{shared:{[e]:this.sessions.shared[e]}};{let i={};for(let r in this.sessions.shared)this.sessions.shared[r].settings?.name&&(i[r]=this.sessions.shared.settings);if(Object.keys(i).length>0)return i}}else return this.sessions.shared};this.openPrivateSession=(e={},t)=>{if(typeof t=="object"&&(t=t._id),e._id||(e._id=`private${Math.floor(Math.random()*1e15)}`,this.sessions.private[e._id]&&(delete e._id,this.openPrivateSession(e,t))),e._id){if(t&&(e.settings||(e.settings={listener:t,source:t,propnames:{latency:!0},admins:{[t]:!0},ownerId:t}),e.settings.listener||(e.settings.listener=t),e.settings.source||(e.settings.source=t),this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e._id]=e),e.data||(e.data={}),this.sessions.private[e._id])return this.updateSession(e,t);e.settings?.listener&&e.settings.source&&(this.sessions.private[e._id]=e)}return e};this.openSharedSession=(e,t)=>{if(typeof t=="object"&&(t=t._id),e._id||(e._id=`shared${Math.floor(Math.random()*1e15)}`,this.sessions.shared[e._id]&&(delete e._id,this.openSharedSession(e,t))),e._id){if(typeof t=="string"?(e.settings||(e.settings={name:"shared",propnames:{latency:!0},users:{[t]:!0},admins:{[t]:!0},ownerId:t}),e.settings.users||(e.settings.users={[t]:!0}),e.settings.admins||(e.settings.admins={[t]:!0}),e.settings.ownerId||(e.settings.ownerId=t),this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e._id]=e):e.settings||(e.settings={name:"shared",propnames:{latency:!0},users:{}}),e.data||(e.data={private:{},shared:{}}),e.settings.name||(e.name=e.id),this.sessions.shared[e._id])return this.updateSession(e,t);this.sessions.shared[e._id]=e}return e};this.updateSession=(e,t)=>{typeof t=="object"&&(t=t._id);let i;if(e._id&&typeof t=="string")if(i=this.sessions.private[e._id],i||(i=this.sessions.shared[e._id]),this.sesh.private[e._id]){let r=this.sessions.shared[e._id];if(r.settings&&(r?.settings.source===t||r.settings.admins?.[t]||r.settings.moderators?.[t]||r.settings.ownerId===t))return Object.assign(this.session.shared[e._id],e)}else return e.settings?.source?this.openPrivateSession(e,t):this.openSharedSession(e,t);return!1};this.joinSession=(e,t,i)=>{if(typeof t=="object"&&(t=t._id),!t)return!1;let r=this.sessions.shared[e];return r?.settings?r.settings?.banned&&r.settings.banned[t]||r.settings?.password&&(!i?.settings?.password||i.settings.password!==r.settings.password)?!1:(r.settings.users[t]=!0,this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e]=r,i?this.updateSession(i,t):r):i?.source||i?.listener?this.openPrivateSession(i,t):i?this.openSharedSession(i,t):!1};this.leaveSession=(e,t,i=!0)=>{typeof t=="object"&&(t=t._id);let r=this.sessions.private[e];return r||(r=this.sessions.shared[e]),r?(this.sessions.private[e]?(t===r.settings.source||t===r.settings.listener||r.settings.admins?.[t]||r.settings.moderators?.[t])&&(delete this.sessions.private[e],delete this.users[t].sessions[e],i&&(r.settings.admins?.[t]&&delete(this.sessions.shared[e].settings?.admins)[t],r.settings.moderators?.[t]&&delete(this.sessions.shared[e].settings?.moderators)[t])):this.sessions.shared[e]&&(delete this.sessions.shared.settings.users[t],delete this.users[t].sessions[e],i&&(r.settings.admins?.[t]&&delete(this.sessions.shared[e].settings?.admins)[t],r.settings.moderators?.[t]&&delete(this.sessions.shared[e].settings?.moderators)[t],r.data.shared[t]&&delete this.sessions.shared[e].data?.shared[t],r.settings.host===t&&(delete r.settings.host,delete r.data.shared,r.data.shared={},this.swapHost(r)))),!0):!1};this.swapHost=(e,t)=>{if(typeof e=="string"&&(this.sessions.private[e]?e=this.sessions.private[e]:this.sessions.shared[e]&&(e=this.sessions.shared[e])),typeof e=="object"&&e.settings){if(delete e.settings.host,t&&e.settings.users[t]&&(e.settings.host=t),e.settings.ownerId&&!e.settings.host&&e.settings.users[e.settings.ownerId]&&(e.settings.host=e.settings.ownerId),e.settings.admins&&!e.settings.host){let i=this.getFirstMatch(e.settings.users,e.settings.admins);i&&(e.settings.host=i)}if(e.settings.moderators&&!e.settings.host){let i=this.getFirstMatch(e.settings.users,e.settings.moderators);i&&(e.settings.host=i)}return e.settings.host||(e.settings.host=Object.keys(e.settings.users)[0]),!0}return!1};this.deleteSession=(e,t)=>{typeof t=="object"&&(t=t._id);let i=this.sessions.private[e];if(i||(i=this.sessions.shared[e]),i&&(i.source===t||i.listener===t||i.admins?.[t]||i.ownerId===t)){for(let r in i.settings.users)delete this.users.sessions[e];this.sessions.private[e]?delete this.sessions.private[e]:this.sessions.shared[e]&&delete this.sessions.private[e]}return!0};this.subscribeToSession=(e,t,i,r,n)=>{if(typeof t=="object"&&(t=t._id),typeof e=="string"){let a=this.sessions.private[e];if(a||(a=this.sessions.shared[e]),!a)return;e=a}if(typeof e.onopen=="function"){let a=this.subscribe("joinSession",o=>{o._id===e._id&&e.onopen(e,t),this.unsubscribe("joinSession",a)})}return typeof e=="object"&&(i&&(e.onmessage=i),r&&(e.onclose=r),n&&(e.onclose=n)),e};this.sessionLoop=(e=!0)=>{let t={private:{},shared:{}};for(let i in this.sessions.private){let r=this.sessions.private[i],n={_id:r._id,settings:{listener:r.listener,source:r.source},data:{}};if(!this.users[r.source]){delete this.sessions.private[i];break}if(r.settings&&r.data)for(let a in r.settings.propnames)this.users[r.source][a]?this.sessions.private[i].data?typeof r.data[a]=="object"?this.users[r.source][a]&&(v(r.data[a])!==v(this.users[r.source][a])||!(a in r.data))&&(n.data[a]=this.users[r.source][a]):this.users[r.source][a]&&(r.data[a]!==this.users[r.source][a]||!(a in r.data))&&(n.data[a]=this.users[r.source][a]):n.data[a]=this.users[r.source][a]:this.sessions.private[i]?.data?.[a]&&delete this.sessions.private[i].data[a];Object.keys(n.data).length>0&&(this.recursivelyAssign(this.sessions.private[i].data,n.data),t.private[r._id]=n)}for(let i in this.sessions.shared){let r=this.sessions.shared[i],n={_id:r._id,settings:{name:r.name},data:{}};if(r.settings?.host){let a={},o={};for(let h in r.settings.users){if(!this.users[h]){delete r.settings.users[h],r.data?.shared[h]&&delete r.data.shared[h],r.data?.private?.[h]&&delete r.data.shared[h],r.settings.host===h&&this.swapHost(r),n.settings.users=r.settings.users,n.settings.host=r.settings.host;continue}if(h!==r.settings.host){a[h]={};for(let f in r.settings.propnames)this.users[h][f]?r.data?.private&&!(h in r.data.private)?typeof this.users[h][f]=="object"?a[h][f]=this.recursivelyAssign({},this.users[h][f]):a[h][f]=this.users[h][f]:typeof a[h][f]=="object"&&r.data?this.users[h][f]&&(v(r.data?.shared[h][f])!==v(this.users[h][f])||!(f in r.data))&&(a[h][f]=this.users[h][f]):this.users[h][f]&&r.data?.private?.[f]!==this.users[h][f]&&(a[h][f]=this.users[h][f]):r.data?.private?.[h]?.[f]&&delete r.data.private[h][f];Object.keys(a[h]).length===0&&delete a[h]}else{o[h]={};for(let f in r.settings.hostprops)this.users[h][f]?r.data&&!(h in r.data.shared)?typeof this.users[h][f]=="object"?o[h][f]=this.recursivelyAssign({},this.users[h][f]):o[h][f]=this.users[h][f]:typeof o[h][f]=="object"&&r.data?this.users[h][f]&&(v(r.data?.shared[h][f])!==v(this.users[h][f])||!(f in r.data.shared[h]))&&(o[h][f]=this.users[h][f]):this.users[h][f]&&r.data?.shared[h][f]!==this.users[h][f]&&(o[h][f]=this.users[h][f]):r.data?.shared[h]?.[f]&&delete r.data.shared[h][f]}}Object.keys(a).length>0&&(n.data.private=a),Object.keys(o).length>0&&(n.data.shared=o)}else{let a={};if(r.settings?.users){for(let o in r.settings.users){if(!this.users[o]){delete r.settings.users[o],r.data?.shared[o]&&delete r.data.shared[o],r.data?.private?.[o]&&delete r.data.shared[o],r.settings.host===o&&this.swapHost(r),n.settings.users=r.settings.users,n.settings.host=r.settings.host;continue}a[o]={};for(let h in r.settings.propnames)this.users[o][h]?r.data&&!(o in r.data.shared)?typeof this.users[o][h]=="object"?a[o][h]=this.recursivelyAssign({},this.users[o][h]):a[o][h]=this.users[o][h]:typeof r.data?.shared[o][h]=="object"?(v(r.data.shared[o][h])!==v(this.users[o][h])||!(h in r.data.shared[o]))&&(a[o][h]=this.users[o][h]):r.data?.shared[o][h]!==this.users[o][h]&&(a[o][h]=this.users[o][h]):r.data?.shared[o]?.[h]&&delete r.data.shared[o][h];Object.keys(a[o]).length===0&&delete a[o]}Object.keys(a).length>0&&(n.data.shared=a)}}(n.data.shared||n.data.private)&&(t.shared[r._id]=n),n.data.shared&&this.recursivelyAssign(this.sessions.shared[i].data?.shared,n.data.shared),n.data.private&&this.recursivelyAssign(this.sessions.shared[i].data?.private,n.data.private)}if(Object.keys(t.private).length===0&&delete t.private,Object.keys(t.shared).length===0&&delete t.shared,Object.keys(t).length!==0)return e&&this.transmitSessionUpdates(t),t};this.transmitSessionUpdates=e=>{let t={};if(e.private)for(let r in e.private){let n=this.sessions.private[r];if(n?.settings){let a=n.settings.listener;t[a]?t[a].private||(t[a].private={}):t[a]={private:{}},t[a].private[r]=e.private[r]}}if(e.shared)for(let r in e.shared){let n=this.sessions.shared[r];if(n?.settings){let a;n.settings.host&&(a=Object.assign({},e.shared[r]),delete a.data.private);for(let o in n.settings.users)t[o]?t[o].shared||(t[o].shared={}):t[o]={shared:{}},n.settings.host&&o!==n.settings.host?t[o].shared[r]=a:t[o].shared[r]=e.shared[r]}}let i={route:"receiveSessionUpdates",args:null,origin:null};for(let r in t)i.args=t[r],i.origin=r,this.users[r].send&&this.users[r].send(JSON.stringify(i));return t};this.receiveSessionUpdates=(e=this,t,i)=>{if(i&&typeof i=="string"&&(i=JSON.parse(i)),typeof i=="object"){typeof t=="object"&&(t=t._id);let r=this.users[t];if(!r)return;if(r.sessions||(r.sessions={}),i.private)for(let n in i.private)!r.sessions[n]||(this.recursivelyAssign(r.sessions[n].data,i.private[n].data),r.sessions[n].onmessage&&r.sessions[n].onmessage(r.sessions[n],r._id));if(i.shared)for(let n in i.shared)!r.sessions[n]||(i.shared[n].settings.users&&(r.sessions[n].settings.users=i.shared[n].settings.users),i.shared[n].settings.host&&(r.sessions[n].settings.host=i.shared[n].settings.host),i.shared[n].data.private&&this.recursivelyAssign(r.sessions[n].data.private,i.shared[n].data.private),i.shared[n].data.shared&&this.recursivelyAssign(r.sessions[n].data.shared,i.shared[n].data.shared),r.sessions[n].onmessage&&r.sessions[n].onmessage(r.sessions[n],r._id));return r}};this.getUpdatedUserData=e=>{let t={};for(let i in e.sessions){let r=e.sessions[i];if((r.settings.users[e._id]||r.settings.source===e._id)&&!r.settings.spectators?.[e._id])if(r.settings.host===e._id)for(let n in r.settings.hostprops)!t[n]&&n in e&&(r.data.shared?.[e._id]&&n in r.data.shared?.[e._id]?typeof e[n]=="object"?v(r.data.shared[e._id][n])!==v(e[n])&&(t[n]=e[n]):r.data.shared[e._id][n]!==e[n]&&(t[n]=e[n]):t[n]=e[n]);else for(let n in r.settings.propnames)!t[n]&&e[n]!==void 0&&(r.settings.source?typeof e[n]=="object"&&n in r.data?v(r.data[n])!==v(e[n])&&(t[n]=e[n]):r.data[n]!==e[n]&&(t[n]=e[n]):r.data.shared?.[e._id]&&n in r.data.shared?.[e._id]?typeof e[n]=="object"?v(r.data.shared[e._id][n])!==v(e[n])&&(t[n]=e[n]):r.data.shared[e._id][n]!==e[n]&&(t[n]=e[n]):t[n]=e[n])}return t};this.userUpdateCheck=e=>{if(e.sessions){let t=this.getUpdatedUserData(e);if(Object.keys(t).length>0)return e.send&&e.send({route:"setUser",args:t,origin:e._id}),t}};this.routes={runAs:this.runAs,pipeAs:this.pipeAs,addUser:this.addUser,setUser:(e,t,i)=>this.setUser(t,i),removeUser:this.removeUser,updateUser:this.updateUser,getConnectionInfo:this.getConnectionInfo,getSessionInfo:this.getSessionInfo,openPrivateSession:this.openPrivateSession,openSharedSession:this.openSharedSession,joinSession:this.joinSession,leaveSession:this.leaveSession,subscribeToSession:this.subscribeToSession,transmitSessionUpdates:this.transmitSessionUpdates,receiveSessionUpdates:this.receiveSessionUpdates,swapHost:this.swapHost,getupdateUserData:this.getUpdatedUserData,userUpdateCheck:this.userUpdateCheck,userUpdateLoop:{operator:this.userUpdateCheck,loop:10},sessionLoop:{operator:this.sessionLoop,loop:10}};this.load(this.routes,t?.linkServices,t?.includeClassName,t?.routeFormat,t?.customRoutes,t?.customChildren)}getFirstMatch(e,t){for(let i in e)for(let r in t)if(i===r)return i;return!1}};var ee={setRoute:(l,s,e,t)=>(typeof e=="string"&&(e=k(e)),typeof e=="function"?(t||(t=e.name),l.graph.get(t)?l.graph.get(t).setOperator(e):l.graph.load({[t]:{operator:e}}),!0):!1),setNode:(l,s,e,t)=>(typeof e=="string"&&(e=k(e)),typeof e=="function"?(t||(t=e.name),l.graph.get(t)?l.graph.get(t).setOperator(e):l.graph.add({tag:t,operator:e}),!0):!1),setMethod:(l,s,e,t,i)=>(typeof t=="string"&&(t=k(t)),typeof t=="function"?(i||(i=t.name),l.graph.get(e)?l.graph.get(e)[i]=t:l.graph.add({tag:i,[i]:t}),!0):!1),assignRoute:(l,s,e,t)=>{l.graph.get(e)&&typeof t=="object"&&Object.assign(l.graph.get(e),t)},transferClass:(l,s)=>{if(typeof l=="object"){let e=l.toString();return{route:"receiveClass",args:[e,s]}}return!1},receiveClass:(l,s,e,t)=>{if(typeof e=="string"&&e.indexOf("class")===0){let i=(0,eval)("("+e+")"),r=t;return r||(r=i.name),l.graph[r]=i,!0}return!1},setGlobal:(l,s,e,t)=>(globalThis[e]=t,!0),assignGlobalObject:(l,s,e,t)=>globalThis[e]?(typeof t=="object"&&Object.assign(globalThis[e],t),!0):!1,setValue:(l,s,e,t)=>(l.graph[e]=t,!0),assignObject:(l,s,e,t)=>l.graph[e]?(typeof t=="object"&&Object.assign(l.graph[e],t),!0):!1,setGlobalFunction:(l,s,e,t)=>(typeof e=="string"&&(e=k(e)),typeof e=="function"?(t||(t=e.name),globalThis[t]=e,!0):!1),assignFunctionToGlobalObject:(l,s,e,t,i)=>globalThis[e]?(typeof t=="string"&&(t=k(t)),typeof t=="function"?(i||(i=t.name),l.graph[e][i]=t,!0):!1):!1,setFunction:(l,s,e,t)=>(typeof e=="string"&&(e=k(e)),typeof e=="function"?(t||(t=e.name),l.graph[t]=e,!0):!1),assignFunctionToObject:(l,s,e,t,i)=>l.graph[e]?(typeof t=="string"&&(t=k(t)),typeof t=="function"?(i||(i=t.name),l.graph[e][i]=t,!0):!1):!1};var A=class extends O{constructor(e){super(e);this.entities={};this.systems={};this.map=new Map;this.order=[];this.animating=!0;this.updateEntities=(e=this.order,t)=>{e.forEach(i=>{this.systems[i]&&(t?this.systems[i]._run(this.systems[i],this,this.map.get(i)):this.systems[i]._run(this.systems[i],this,this.entities))})};this.animate=(e=!0,t)=>{requestAnimationFrame(()=>{this.animating&&(this.updateEntities(t,e),this.animate(e,t))})};this.stop=()=>{this.animating=!1};this.start=e=>{this.animating=!0,this.animate(e)};this.addEntities=(e,t={},i=1)=>{let r=0,n={};for(;r<i;){let a=this.addEntity(e,t);n[a.tag]=a,r++}return Object.keys(n)};this.addEntity=(e={},t={})=>{if(!e)return;let i=this.recursivelyAssign({},e);if(i.components=t,Object.keys(t).length===0&&Object.keys(this.systems).forEach(r=>{t[r]=!0}),i.tag&&this.entities[i.tag]){let r=i.tag,n=2;for(;this.entities[i.tag];)i.tag=`${r}${n}`,n++}else i.tag||(i.tag=`entity${Math.floor(Math.random()*1e15)}`);return this.load({[i.tag]:i}),this.entities[i.tag]=this.nodes.get(i.tag),this.setupEntity(this.entities[i.tag]),this.entities[i.tag]};this.addSystems=(e={},t)=>{for(let i in e)e[i].tag=i,this.addSystem(e[i],void 0,void 0,t);return this.systems};this.addSystem=(e,t,i,r)=>{if(!e)return;let n=this.recursivelyAssign({},e);if(t&&(n.setupEntities=t),i&&(n.operator=i),n.tag&&this.systems[n.tag]){let a=n.tag,o=2;for(;this.systems[n.tag];)n.tag=`${a}${o}`,o++}else n.tag||(n.tag=`system${Math.floor(Math.random()*1e15)}`);if(this.load({[n.tag]:n}),this.systems[n.tag]=this.nodes.get(n.tag),this.map.get(n.tag)||this.map.set(n.tag,{}),this.systems[n.tag]?.setupEntities){let a=this.filterObject(this.entities,(o,h)=>{if(h.components[n.tag])return!0});this.systems[n.tag].setupEntities(n,a),Object.assign(this.map.get(n.tag),a)}return r?this.order=r:this.order.push(n.tag),this.systems[n.tag]};this.setupEntity=e=>{if(e?.components)for(let t in e.components)this.systems[t]&&(this.systems[t].setupEntity(this.systems[t],e),this.map.get(t)[e.tag]=e)};this.removeEntity=e=>{let t=this.entities[e];for(let i in t.components)this.map.get(i)&&delete this.map.get(i)[t.tag];return delete this.entities[e],this.remove(e)};this.removeSystem=e=>(delete this.systems[e],this.map.delete(e),this.order.splice(this.order.indexOf(e),1),this.remove(e));this.bufferValues=(e,t,i,r)=>{if(!Array.isArray(i)&&typeof i=="object"&&(i=Object.keys(i)),!r){let a=Object.keys(e);i?r=new Float32Array(a.length*i.length):typeof e[a[0]][t]=="object"?(i=Object.keys(e[a[0]][t]),r=new Float32Array(a.length*i.length)):r=new Float32Array(a.length)}let n=0;for(let a in e)if(e[a][t])if(i)for(let o=0;o<i.length;o++)r[n]=e[a][t][i[o]],n++;else r[n]=e[a][t],n++;return r};this.routes={animateEntities:this.animate,startEntityAnimation:this.start,stopEntityAnimation:this.stop,addEntity:this.addEntity,addSystem:this.addSystem,addSystems:this.addSystems,removeEntity:this.removeEntity,removeSystem:this.removeSystem,setupEntity:this.setupEntity,addEntities:this.addEntities,filterObject:this.filterObject,bufferValues:this.bufferValues};if(this.routes&&this.load(this.routes),e.systems)for(let t in e.systems)this.addSystem(e.systems[t],void 0,void 0,e.order);if(e.entities)for(let t in e.entities)this.addEntity(e.entities[t],e.entities[t].components)}filterObject(e,t){return Object.fromEntries(Object.entries(e).filter(([i,r])=>{t(i,r)}))}};})();
