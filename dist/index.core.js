(()=>{var g=class{constructor(e){this.pushToState={};this.data={};this.triggers={};this.setState=e=>{Object.assign(this.data,e);for(let n of Object.getOwnPropertyNames(e))this.triggers[n]&&this.triggers[n].forEach(t=>t.onchange(this.data[n]));return this.data};this.setValue=(e,n)=>{this.data[e]=n,this.triggers[e]&&this.triggers[e].forEach(t=>t.onchange(this.data[e]))};this.subscribeTrigger=(e,n)=>{if(e){this.triggers[e]||(this.triggers[e]=[]);let t=this.triggers[e].length;return this.triggers[e].push({sub:t,onchange:n}),this.triggers[e].length-1}else return};this.unsubscribeTrigger=(e,n)=>{let t=this.triggers[e];if(t)if(!n)delete this.triggers[e];else{let _,i=t.find((r,o)=>{if(r.sub===_)return _=o,!0});return i&&t.splice(_,1),this.onRemoved&&this.onRemoved(i),!0}};this.subscribeTriggerOnce=(e,n)=>{let t,_=i=>{n(i),this.unsubscribeTrigger(e,t)};t=this.subscribeTrigger(e,_)};this.getTrigger=(e,n)=>{for(let t in this.triggers[e])if(this.triggers[e][t].sub===n)return this.triggers[e][t]};typeof e=="object"&&(this.data=e)}};var y=new g,h=class{constructor(e,n,t){this.__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,state:y};this.__subscribe=(e,n,t,_,i)=>{let r=(a,f=(u,c)=>u,d=e)=>{let u=this.__node.state.subscribeTrigger(a,d),c=this.__node.state.getTrigger(a,u);return c.source=this.__node.tag,n&&(c.key=n),c.target=f(e),_&&(c.bound=_),u},o=a=>{if(!this.__node.graph.get(a)&&a.includes(".")){let d=this.__node.graph.get(a.substring(0,a.lastIndexOf("."))),u=a.substring(a.lastIndexOf(".")+1);d&&typeof d[u]=="function"&&(a=(...c)=>d[u](...c))}};if(n){this.__node.localState||this.__addLocalState(this),typeof e=="string"&&(typeof this[e]=="function"?e=this[e]:this.__node.graph&&o(e));let a,f=t?this.__node.unique+"."+n+"input":this.__node.unique+"."+n;return typeof e=="function"?a=r(f):e?.__node&&(a=r(f,(d,u)=>u||d.__node.unique,d=>{e.__operator&&e.__operator(d)})),a}else{typeof e=="string"&&(this.__node.graph?e=this.__node.graph.get(e):e=this.__node.graph.nodes.get(e));let a,f=t?this.__node.unique+"input":this.__node.unique;return typeof e=="function"?a=r(f):e?.__node&&(a=r(f,(d,u)=>u||d.__node.unique,d=>{e.__operator&&e.__operator(d)})),a}};this.__unsubscribe=(e,n,t)=>n?this.__node.state.unsubscribeTrigger(t?this.__node.unique+"."+n+"input":this.__node.unique+"."+n,e):this.__node.state.unsubscribeTrigger(t?this.__node.unique+"input":this.__node.unique,e);this.__setOperator=e=>(e=e.bind(this),this.__operator=(...n)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"input",n);let t=e(...n);return typeof t?.then=="function"?t.then(_=>{_!==void 0&&this.__node.state.setValue(this.__node.unique,_)}).catch(console.error):t!==void 0&&this.__node.state.setValue(this.__node.unique,t),t},this.__operator);this.__proxyObject=e=>{function n(_){var i=[],r=_;do if(r.constructor?.name!=="Object"){var o=Object.getOwnPropertyNames(r);o.forEach(function(a){i.indexOf(a)===-1&&i.push(a)})}while(r=Object.getPrototypeOf(r));return i}let t=n(e);for(let _ of t)typeof this[_]>"u"&&(typeof e[_]=="function"?this[_]=(...i)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"."+_+"input",i);let r=e[_](...i);return this.__node.state.triggers[this.__node.unique+"."+_]&&(typeof r?.then=="function"?r.then(o=>{this.__node.state.setValue(this.__node.unique+"."+_,o)}).catch(console.error):this.__node.state.setValue(this.__node.unique+"."+_,r)),r}:Object.defineProperty(this,_,{get:()=>e[_],set:r=>{e[_]=r,this.__node.state.triggers[this.__node.unique+"."+_]&&this.__node.state.setValue(this.__node.unique+"."+_,r)},enumerable:!0,configurable:!0}))};if(typeof e=="function"?e={__operator:e,__node:{forward:!0,tag:e.name}}:typeof e=="string"&&t?.get(e)&&(e=t.get(e)),typeof e=="object"){if(e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props)),typeof e.__node=="string"?t?.get(e.__node.tag)?e=t.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),!e.__parent&&n&&(e.__parent=n),t&&(e.__node.graph=t),e.__operator){if(typeof e.__operator=="string"&&t){let _=t.get(e.__operator);_&&(e.__operator=_.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator))}if(e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`),n?.__node&&!(n instanceof l||e instanceof l)&&(e.__node.tag=n.__node.tag+"."+e.__node.tag),n instanceof l&&e instanceof l&&(e.__node.loaders&&Object.assign(n.__node.loaders?n.__node.loaders:{},e.__node.loaders),n.__node.mapGraphs)){e.__node.nodes.forEach(i=>{n.set(e.__node.tag+"."+i.__node.tag,i)});let _=()=>{e.__node.nodes.forEach(i=>{n.__node.nodes.delete(e.__node.tag+"."+i.__node.tag)})};this.__addDisconnected(_)}e.__node.initial=e,e.__node=Object.assign(this.__node,e.__node);for(let _ in e)this[_]=e[_];if(e.__operator&&n instanceof h&&n.__operator){let _=n.__subscribe(this),i=()=>{n?.__unsubscribe(_)};this.__addDisconnected(i)}else if(typeof e.default=="function"&&!e.__operator){let _=e.default.bind(this);this.default=(...i)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"input",i);let r=_(...i);return typeof r?.then=="function"?r.then(o=>{o!==void 0&&this.__node.state.setValue(this.__node.unique,o)}).catch(console.error):r!==void 0&&this.__node.state.setValue(this.__node.unique,r),r},e.default=this.default}e instanceof l&&(this.__node.source=e)}}__addLocalState(e){if(!e)return;this.__node.localState||(this.__node.localState={});let n=this.__node.localState;for(let t in e)if(!(this.__props&&this.__props[t]))if(typeof e[t]=="function"){if(!t.startsWith("_")){let _=e[t].bind(this);e[t]=(...i)=>{this.__node.inputState&&this.__node.state.setValue(this.__node.unique+"."+t+"input",i);let r=_(...i);return typeof r?.then=="function"?this.__node.state.triggers[this.__node.unique+"."+t]&&r.then(o=>{this.__node.state.setValue(this.__node.unique+"."+t,o)}).catch(console.error):this.__node.state.triggers[this.__node.unique+"."+t]&&this.__node.state.setValue(this.__node.unique+"."+t,r),r},this[t]=e[t]}}else{n[t]=e[t];let _={get:()=>n[t],set:o=>{n[t]=o,this.__node.state.triggers[this.__node.unique+"."+t]&&this.__node.state.setValue(this.__node.unique+"."+t,o)},enumerable:!0,configurable:!0};Object.defineProperty(this,t,_);let i=this.__node.initial,r=Object.getOwnPropertyDescriptor(i,t);(r===void 0||r?.configurable)&&Object.defineProperty(i,t,_)}}__addOnconnected(e){Array.isArray(this.__ondisconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addDisconnected(e){Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){typeof this.__onconnected=="function"?this.__onconnected(this):Array.isArray(this.__onconnected)&&this.__onconnected.forEach(n=>{n(this)})}__callDisconnected(e=this){typeof this.__ondisconnected=="function"?this.__ondisconnected(this):Array.isArray(this.__ondisconnected)&&this.__ondisconnected.forEach(n=>{n(this)})}},l=class{constructor(e){this.__node={tag:`graph${Math.floor(Math.random()*1e15)}`,nodes:new Map,state:y};this.init=e=>{e&&(p(this.__node,e),e.tree&&this.setTree(e.tree))};this.setTree=e=>{this.__node.tree=Object.assign(this.__node.tree?this.__node.tree:{},e);let n=Object.assign({},e);delete n.__node;let t=this.recursiveSet(n,this);if(e.__node){if(!e.__node.tag)e.__node._tag=`tree${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let _=new h(e,this,this);for(let i in this.__node.loaders)this.__node.loaders[i](_,this,this,e,e);this.set(_.__node.tag,_),_.__listeners&&(t[_.__node.tag]=_.__listeners)}}this.setListeners(t)};this.setLoaders=(e,n)=>(n?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);this.add=(e,n)=>{let t={};typeof n=="string"&&(n=this.get(n));let _=Object.assign({},e);if(e.__node&&(_.__node=Object.assign({},e.__node)),!_.__node?.tag||!this.get(_.__node.tag)){let i=new h(_,n,this);for(let r in this.__node.loaders)this.__node.loaders[r](i,n,this,this.__node.tree,e);return this.set(i.__node.tag,i),this.__node.tree[i.__node.tag]=e,i.__listeners&&(t[i.__node.tag]=i.__listeners),i.__children&&(i.__children=Object.assign({},i.__children),this.recursiveSet(i.__children,i,t)),this.setListeners(t),i.__callConnected(),i}};this.recursiveSet=(e,n,t={})=>{for(let _ in e){let i=e[_];if(!Array.isArray(i)&&(typeof i=="function"?i={__operator:i}:typeof i=="string"?i=this.__node.tree[i]:typeof i=="boolean"&&(i=this.__node.tree[_]),typeof i=="object")){if(i=Object.assign({},i),i.__node||(i.__node={}),i.__node.tag||(i.__node.tag=_),this.get(i.__node.tag)||n?.__node&&this.get(n.__node.tag+"."+i.__node.tag))continue;let r=Object.assign({},i);r.__node=Object.assign({},i.__node);let o=new h(r,n,this);for(let a in this.__node.loaders)this.__node.loaders[a](o,n,this,e,i);e[_]=o,this.__node.tree[o.__node.tag]=i,this.set(o.__node.tag,o),o.__listeners?t[o.__node.tag]=o.__listeners:o.__children&&(o.__children=Object.assign({},o.__children),this.recursiveSet(o.__children,o,t)),o.__callConnected()}}return t};this.remove=(e,n=!0)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof h){this.delete(e.__node.tag),delete this.__node.tree[e.__node.tag],n&&this.clearListeners(e),e.__callDisconnected();let t=_=>{for(let i in _)this.unsubscribe(_[i]),this.delete(_[i].__node.tag),delete this.__node.tree[_[i].__node.tag],this.delete(i),delete this.__node.tree[i],_[i].__node.tag=_[i].__node.tag.substring(_[i].__node.tag.lastIndexOf(".")+1),n&&this.clearListeners(_[i]),_[i].__callDisconnected(),_[i].__children&&t(_[i].__children)};e.__children&&t(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e};this.run=(e,...n)=>{if(typeof e=="string"){let t=this.get(e);if(!t&&e.includes(".")){if(t=this.get(e.substring(0,e.lastIndexOf("."))),typeof t?.[e.substring(e.lastIndexOf(".")+1)]=="function")return t[e.substring(e.lastIndexOf(".")+1)](...n)}else if(t?.__operator)return t.__operator(...n)}if(e?.__operator)return e?.__operator(...n)};this.setListeners=e=>{for(let n in e){let t=this.get(n);if(typeof e[n]=="object")for(let _ in e[n]){let i=this.get(_),r;if(typeof e[n][_]!="object"&&(e[n][_]={callback:e[n][_]}),typeof e[n][_].callback=="function"&&(e[n][_].callback=e[n][_].callback.bind(t)),typeof t.__listeners!="object"&&(t.__listeners={}),i)r=this.subscribe(i,e[n][_].callback,void 0,e[n][_].inputState,n,_),typeof t.__listeners[_]!="object"&&(t.__listeners[_]={callback:e[n][_].callback,inputState:e[n][_]?.inputState}),t.__listeners[_].sub=r;else{let o=_.substring(0,_.lastIndexOf("."));i=this.get(o),i&&(r=this.subscribe(i,e[n][_].callback,_.substring(_.lastIndexOf(".")+1),e[n][_].inputState,n,_),typeof t.__listeners[_]!="object"&&(t.__listeners[_]={callback:e[n][_].callback,inputState:e[n][_]?.inputState}),t.__listeners[_].sub=r)}}}};this.clearListeners=(e,n)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let t in e.__listeners){if(n&&t!==n||typeof e.__listeners[t].sub!="number")continue;let _=this.get(t);_?this.unsubscribe(_,e.__listeners[t].sub,void 0,e.__listeners[t].inputState):(_=this.get(t.substring(0,t.lastIndexOf("."))),_&&this.unsubscribe(_,e.__listeners[t].sub,t.substring(t.lastIndexOf(".")+1),e.__listeners[t].inputState)),delete e.__listeners[t]}};this.get=e=>this.__node.nodes.get(e);this.set=(e,n)=>this.__node.nodes.set(e,n);this.delete=e=>this.__node.nodes.delete(e);this.getProps=(e,n)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof h){let t;n?t=Object.assign({},this.__node.tree[e.__node.tag]):(t=Object.assign({},e),delete t.__unsubscribe,delete t.__setOperator,delete t.__node,delete t.__subscribeState,delete t.__subscribe)}};this.subscribe=(e,n,t,_,i,r)=>{let o=e;e instanceof h||(o=this.get(e));let a;if(typeof n=="string")if(i){let f=this.get(i)?.[n];typeof f=="function"&&(n=f)}else n=this.get(n)?.__operator;if(o instanceof h){a=o.__subscribe(n,t,_,i,r);let f=()=>{o.__unsubscribe(a,t,_)};o.__addDisconnected(f)}else if(typeof e=="string")if(this.get(e))if(n instanceof h&&n.__operator){a=this.get(e).__subscribe(n.__operator,t,_,i,r);let f=()=>{this.get(e).__unsubscribe(a)};n.__addDisconnected(f)}else(typeof n=="function"||typeof n=="string")&&(a=this.get(e).__subscribe(n,t,_,i,r),this.__node.state.getTrigger(this.get(e).__node.unique,a).source=e);else typeof n=="string"&&(n=this.__node.nodes.get(n).__operator),typeof n=="function"&&(a=this.__node.state.subscribeTrigger(e,n));return a};this.unsubscribe=(e,n,t,_)=>e instanceof h?e.__unsubscribe(n,t,_):this.get(e)?.__unsubscribe(n,t,_);this.setState=e=>{this.__node.state.setState(e)};this.init(e)}};function p(s,e){for(let n in e)e[n]?.constructor.name==="Object"&&!Array.isArray(e[n])?s[n]?.constructor.name==="Object"&&!Array.isArray(s[n])?p(s[n],e[n]):s[n]=p({},e[n]):s[n]=e[n];return s}var b=(s,e,n)=>{s.__node.backward&&e instanceof h&&n.setListeners({[e.__node.tag]:{[s.__node.tag]:e}})},G=(s,e,n)=>{if(s.__operator&&!s.__node.looperSet){if(s.__node.looperSet=!0,typeof s.__node.delay=="number"){let t=s.__operator;s.__operator=(..._)=>new Promise((i,r)=>{setTimeout(async()=>{i(await t(..._))},s.__node.delay)})}else if(s.__node.frame===!0){let t=s.__operator;s.__operator=(..._)=>new Promise((i,r)=>{requestAnimationFrame(async()=>{i(await t(..._))})})}if(typeof s.__node.repeat=="number"||typeof s.__node.recursive=="number"){let t=s.__operator;s.__operator=async(..._)=>{let i=s.__node.repeat?s.__node.repeat:s.__node.recursive,r,o=async(a,...f)=>{for(;a>0;){if(s.__node.delay||s.__node.frame){t(...f).then(async d=>{s.__node.recursive?await o(a,d):await o(a,...f)});break}else r=await t(..._);a--}};return await o(i,..._),r}}if(s.__node.loop&&typeof s.__node.loop=="number"){let t=s.__operator;s.__operator=(...i)=>{"looping"in s.__node||(s.__node.looping=!0),s.__node.looping&&(t(...i),setTimeout(()=>{s.__operator(...i)},s.__node.loop))},s.__node.looping&&s.__operator();let _=i=>{i.__node.looping&&(i.__node.looping=!1)};s.__addDisconnected(_)}}},m=(s,e,n)=>{if(s.__node.animate===!0||s.__node.animation){typeof s.__node.animate=="function"&&(s.__node.animate=s.__node.animate.bind(s)),requestAnimationFrame(i=>{let r=i.__operator;i.__operator=(...o)=>{"animating"in i.__node||(i.__node.animating=!0),i.__node.animating&&(typeof i.__node.animate=="function"?i.__node.animate(...o):r(...o),requestAnimationFrame(()=>{i.__operator(...o)}))},i.__node.animating&&i.__node.animation()});let _=i=>{i.__node.animating&&(i.__node.animating=!1)};s.__addDisconnected(_)}},O=(s,e,n)=>{if(typeof s.__node.branch=="object"&&s.__operator&&!s.__node.branchApplied){let t=s.__operator;s.__node.branchApplied=!0,s.__operator=(..._)=>{let i=t(..._);for(let r in s.__node.branch){let o=()=>{typeof s.__node.branch[r].then=="function"?s.__node.branch[r].then(i):s.__node.branch[r].then instanceof h&&s.__node.branch[r].then.__operator?s.__node.branch[r].then.__operator(i):i=s.__node.branch[r].then};typeof s.__node.branch[r].if=="function"?s.__node.branch[r].if(i)&&o():s.__node.branch[r].if===i&&o()}return i}}if(s.__listeners){for(let t in s.__listeners)if(typeof s.__listeners[t]=="object"&&s.__listeners[t].branch&&!s.__listeners[t].branchApplied){let _=s.__listeners[t].callback;s.__listeners[t].branchApplied=!0,s.__listeners.callback=i=>{let r=()=>{typeof s.__listeners[t].branch.then=="function"?i=s.__listeners[t].branch.then(i):s.__listeners[t].branch.then instanceof h&&s.__listeners[t].branch.then.__operator?i=s.__listeners[t].branch.then.__operator(i):i=s.__listeners[t].branch.then};return typeof s.__listeners[t].branch.if=="function"?s.__listeners[t].branch.if(i)&&r():s.__listeners[t].branch.if===i&&r(),_(i)}}}},N=(s,e,n)=>{if(s.__listeners)for(let t in s.__listeners)typeof s.__listeners[t]=="object"&&s.__listeners[t].oncreate&&s.__listeners[t].callback(s.__listeners[t].oncreate)},j=(s,e,n)=>{if(s.__listeners)for(let t in s.__listeners)typeof s.__listeners[t]=="object"&&typeof s.__listeners[t].binding=="object"&&(s.__listeners.callback=s.__listeners.callback.bind(s.__listeners[t].binding))},q=(s,e,n)=>{if(s.__listeners){for(let t in s.__listeners)if(typeof s.__listeners[t]=="object"&&typeof s.__listeners[t].transform=="function"&&!s.__listeners[t].transformApplied){let _=s.__listeners[t].callback;s.__listeners[t].transformApplied=!0,s.__listeners.callback=i=>(i=s.__listeners[t].transform(i),_(i))}}},v=(s,e,n)=>{s.post&&!s.__operator?s.__setOperator(s.post):!s.__operator&&typeof s.get=="function"&&s.__setOperator(s.get),!s.get&&s.__operator&&(s.get=s.__operator),s.aliases&&s.aliases.forEach(t=>{n.set(t,s);let _=i=>{n.__node.nodes.delete(t)};s.__addDisconnected(_)}),typeof n.__node.tree[s.__node.tag]=="object"&&s.get&&(n.__node.tree[s.__node.tag].get=s.get)},V={backprop:b,loop:G,animate:m,branching:O,triggerListenerOncreate:N,bindListener:j,transformListenerResult:q,substitute__operator:v};})();
