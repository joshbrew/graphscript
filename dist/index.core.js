(()=>{function O(d=""){let s=n=>n.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=(n=>{let a=n.indexOf("=>")+1;return a<=0&&(a=n.indexOf("){")),a<=0&&(a=n.indexOf(") {")),n.slice(0,n.indexOf("{",a)+1)})(d),i=s(d),r;if(t.includes("function")){let n=t.split("(")[1].split(")")[0];r=new Function(n,i)}else if(t.substring(0,6)===i.substring(0,6)){let n=t.split("(")[1].split(")")[0];r=new Function(n,i.substring(i.indexOf("{")+1,i.length-1))}else try{r=(0,eval)(t+i+"}")}catch{}return r}var S={pushToState:{},data:{},triggers:{},setState(d){Object.assign(S.data,d);for(let s of Object.getOwnPropertyNames(d))S.triggers[s]&&S.triggers[s].forEach(e=>e.onchange(S.data[s]));return S.data},subscribeTrigger(d,s){if(d){S.triggers[d]||(S.triggers[d]=[]);let e=S.triggers[d].length;return S.triggers[d].push({idx:e,onchange:s}),S.triggers[d].length-1}else return},unsubscribeTrigger(d,s){let e,t=S.triggers[d];if(t)if(!s)delete S.triggers[d];else return t.find(r=>{if(r.idx===s)return!0})&&t.splice(e,1),!0},subscribeTriggerOnce(d,s){let e,t=i=>{s(i),S.unsubscribeTrigger(d,e)};e=S.subscribeTrigger(d,t)}},g=class{constructor(s={},e,t){this.nodes=new Map;this._initial={};this.state=S;this.isLooping=!1;this.isAnimating=!1;this.looper=void 0;this.animation=void 0;this.forward=!0;this.backward=!1;this.runSync=!1;this.firstRun=!0;this.DEBUGNODE=!1;this.operator=(...s)=>s;this.runOp=(...s)=>{this.DEBUGNODE&&console.time(this.tag);let e=this.operator(...s);return e instanceof Promise?e.then(t=>(t!==void 0&&this.setState({[this.tag]:t}),this.DEBUGNODE&&(console.timeEnd(this.tag),e!==void 0&&console.log(`${this.tag} result:`,e)),t)):(e!==void 0&&this.setState({[this.tag]:e}),this.DEBUGNODE&&(console.timeEnd(this.tag),e!==void 0&&console.log(`${this.tag} result:`,e))),e};this.setOperator=s=>(typeof s!="function"||(this.operator=s.bind(this)),s);this.runAsync=(...s)=>new Promise((e,t)=>{e(this.run(...s))});this.transformArgs=(s=[])=>s;this.run=(...s)=>{if(typeof this.transformArgs=="function"&&(s=this.transformArgs(s,this)),!(this.firstRun&&(this.firstRun=!1,this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||this.branch||(this.runSync=!0),this.animate&&!this.isAnimating&&this.runAnimation(this.animation,s),this.loop&&typeof this.loop=="number"&&!this.isLooping&&this.runLoop(this.looper,s),this.loop||this.animate)))return this.runSync?this.runOp(...s):new Promise(async e=>{if(this){let t=(r,n=0,...a)=>new Promise(async o=>{n++;let f=await r.runOp(...a);if(r.repeat){for(;n<r.repeat;){if(r.delay){setTimeout(async()=>{o(await t(r,n,...a))},r.delay);break}else if(r.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{o(await t(r,n,...a))});break}else f=await r.runOp(...a);n++}if(n===r.repeat){o(f);return}}else if(r.recursive){for(;n<r.recursive;){if(r.delay){setTimeout(async()=>{o(await t(r,n,...f))},r.delay);break}else if(r.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{o(await t(r,n,...f))});break}else f=await r.runOp(...f);n++}if(n===r.recursive){o(f);return}}else{o(f);return}}),i=async()=>{let r=await t(this,void 0,...s);return r!==void 0&&(this.backward&&this.parent instanceof g&&(Array.isArray(r)?await this.runParent(this,...r):await this.runParent(this,r)),this.children&&this.forward&&(Array.isArray(r)?await this.runChildren(this,...r):await this.runChildren(this,r)),this.branch&&this.runBranch(this,r)),r};this.delay?setTimeout(async()=>{e(await i())},this.delay):this.frame&&window?.requestAnimationFrame?requestAnimationFrame(async()=>{e(await i())}):e(await i())}else e(void 0)})};this.runParent=async(s,...e)=>{s.backward&&s.parent&&(typeof s.parent=="string"&&(s.graph&&s.graph?.get(s.parent)?(s.parent=s.graph,s.parent&&this.nodes.set(s.parent.tag,s.parent)):s.parent=this.nodes.get(s.parent)),s.parent instanceof g&&await s.parent.run(...e))};this.runChildren=async(s,...e)=>{if(typeof s.children=="object")for(let t in s.children)typeof s.children[t]=="string"?(s.graph&&s.graph?.get(s.children[t])&&(s.children[t]=s.graph.get(s.children[t]),s.nodes.get(s.children[t].tag)||s.nodes.set(s.children[t].tag,s.children[t])),!s.children[t]&&s.nodes.get(s.children[t])&&(s.children[t]=s.nodes.get(s.children[t]))):(typeof s.children[t]>"u"||s.children[t]===!0)&&(s.graph&&s.graph?.get(t)&&(s.children[t]=s.graph.get(t),s.nodes.get(s.children[t].tag)||s.nodes.set(s.children[t].tag,s.children[t])),!s.children[t]&&s.nodes.get(t)&&(s.children[t]=s.nodes.get(t))),s.children[t]?.runOp&&await s.children[t].run(...e)};this.runBranch=async(s,e)=>{if(s.branch){let t=Object.keys(s.branch);await Promise.all(t.map(async i=>{typeof s.branch[i].if=="object"&&(s.branch[i].if=v(s.branch[i].if));let r=!1;return typeof s.branch[i].if=="function"?r=s.branch[i].if(e):typeof e=="object"?v(e)===s.branch[i].if&&(r=!0):e===s.branch[i].if&&(r=!0),r&&(s.branch[i].then instanceof g?Array.isArray(e)?await s.branch[i].then.run(...e):await s.branch[i].then.run(...e):typeof s.branch[i].then=="function"?Array.isArray(e)?await s.branch[i].then(...e):await s.branch[i].then(e):typeof s.branch[i].then=="string"&&(s.graph?s.branch[i].then=s.graph.nodes.get(s.branch[i].then):s.branch[i].then=s.nodes.get(s.branch[i].then),s.branch[i].then instanceof g&&(Array.isArray(e)?await s.branch[i].then.run(...e):await s.branch[i].then.run(...e)))),r}))}};this.runAnimation=(s=this.animation,e=[])=>{if(this.animation=s,s||(this.animation=this.operator),this.animate&&!this.isAnimating&&"requestAnimationFrame"in window){this.isAnimating=!0;let t=async()=>{if(this.isAnimating){this.DEBUGNODE&&console.time(this.tag);let i=this.animation(...e);i instanceof Promise&&(i=await i),this.DEBUGNODE&&(console.timeEnd(this.tag),i!==void 0&&console.log(`${this.tag} result:`,i)),i!==void 0&&(this.tag&&this.setState({[this.tag]:i}),this.backward&&this.parent?.run&&(Array.isArray(i)?await this.runParent(this,...i):await this.runParent(this,i)),this.children&&this.forward&&(Array.isArray(i)?await this.runChildren(this,...i):await this.runChildren(this,i)),this.branch&&this.runBranch(this,i),this.setState({[this.tag]:i})),requestAnimationFrame(t)}};requestAnimationFrame(t)}};this.runLoop=(s=this.looper,e=[],t=this.loop)=>{if(this.looper=s,s||(this.looper=this.operator),typeof t=="number"&&!this.isLooping){this.isLooping=!0;let i=async()=>{if(this.isLooping){this.DEBUGNODE&&console.time(this.tag);let r=this.looper(...e);r instanceof Promise&&(r=await r),this.DEBUGNODE&&(console.timeEnd(this.tag),r!==void 0&&console.log(`${this.tag} result:`,r)),r!==void 0&&(this.tag&&this.setState({[this.tag]:r}),this.backward&&this.parent?.run&&(Array.isArray(r)?await this.runParent(this,...r):await this.runParent(this,r)),this.children&&this.forward&&(Array.isArray(r)?await this.runChildren(this,...r):await this.runChildren(this,r)),this.branch&&this.runBranch(this,r),this.setState({[this.tag]:r})),setTimeout(async()=>{await i()},t)}};i()}};this.setParent=s=>{this.parent=s,this.backward&&(this.runSync=!1)};this.setChildren=s=>{this.children=s,this.forward&&(this.runSync=!1)};this.add=(s={})=>(typeof s=="function"&&(s={operator:s}),s instanceof g||(s=new g(s,this,this.graph)),this.nodes.set(s.tag,s),this.graph&&(this.graph.nodes.set(s.tag,s),this.graph.nNodes=this.graph.nodes.size),s);this.remove=s=>{typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&(this.nodes.delete(s.tag),this.children[s.tag]&&delete this.children[s.tag],this.graph&&(this.graph.nodes.delete(s.tag),this.graph.nNodes=this.graph.nodes.size),this.nodes.forEach(e=>{e.nodes.get(e.tag)&&(e.nodes.delete(e.tag),e.children[e.tag]&&delete e.children[e.tag],e.parent?.tag===e.tag&&delete e.parent)}),s.ondelete&&s.ondelete(s))};this.append=(s,e=this)=>{typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&(e.addChildren(s),s.forward&&(s.runSync=!1))};this.subscribe=(s,e=this.tag)=>s instanceof g?this.subscribeNode(s):this.state.subscribeTrigger(e,s);this.unsubscribe=(s,e=this.tag)=>{this.state.unsubscribeTrigger(e,s)};this.addChildren=s=>{this.children||(this.children={}),typeof s=="object"&&Object.assign(this.children,s),this.convertChildrenToNodes(),this.forward&&(this.runSync=!1)};this.callParent=(...s)=>{if(typeof this.parent=="string"&&(this.graph&&this.graph?.get(this.parent)?(this.parent=this.graph,this.parent&&this.nodes.set(this.parent.tag,this.parent)):this.parent=this.nodes.get(this.parent)),typeof this.parent?.operator=="function")return this.parent.runOp(...s)};this.callChildren=(...s)=>{let e;if(typeof this.children=="object")for(let t in this.children)this.children[t]?.runOp&&this.children[t].runOp(...s);return e};this.getProps=(s=this)=>({tag:s.tag,operator:s.operator,graph:s.graph,children:s.children,parent:s.parent,forward:s.forward,backward:s.bacward,loop:s.loop,animate:s.animate,frame:s.frame,delay:s.delay,recursive:s.recursive,repeat:s.repeat,branch:s.branch,oncreate:s.oncreate,DEBUGNODE:s.DEBUGNODE,...this._initial});this.setProps=(s={})=>{let e=Object.assign({},s);e.children&&(this.addChildren(s.children),delete e.children),e.operator&&(this.setOperator(s.operator),delete e.operator),Object.assign(e,s),this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||(this.runSync=!0)};this.removeTree=s=>{if(s&&typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g){let e={},t=i=>{if(typeof i.children=="object"&&!e[i.tag]){e[i.tag]=!0;for(let r in i.children)i.children[r].stopNode&&i.children[r].stopNode(),i.children[r].tag&&(this.nodes.get(i.children[r].tag)&&this.nodes.delete(i.children[r].tag),this.nodes.forEach(n=>{n.nodes.get(i.children[r].tag)&&n.nodes.delete(i.children[r].tag),n.children[r]instanceof g&&delete n.children[r]}),t(i.children[r]))}};s.stopNode&&s.stopNode(),s.tag&&(this.nodes.delete(s.tag),this.children[s.tag]&&delete this.children[s.tag],this.parent?.tag===s.tag&&delete this.parent,this[s.tag]instanceof g&&delete this[s.tag],this.nodes.forEach(i=>{i?.tag&&(i.nodes.get(i.tag)&&i.nodes.delete(i.tag),i.children[i.tag]instanceof g&&delete i.children[i.tag])}),t(s),this.graph?this.graph.removeTree(s,e):s.ondelete&&s.ondelete(s))}};this.checkNodesHaveChildMapped=(s,e,t={})=>{let i=s.tag;i||(i=s.name),t[i]||(t[i]=!0,s.children&&e.tag in s.children&&s.children[e.tag]instanceof g&&(s.nodes.get(e.tag)||s.nodes.set(e.tag,e),s.children[e.tag]=e,s.firstRun||(s.firstRun=!0)),s.parent instanceof g&&(s.nodes.get(e.tag)&&!s.parent.nodes.get(e.tag)&&s.parent.nodes.set(e.tag,e),s.parent.children?this.checkNodesHaveChildMapped(s.parent,e,t):s.nodes&&s.nodes.forEach(r=>{t[r.tag]||this.checkNodesHaveChildMapped(r,e,t)})),s.graph&&s.parent&&s.parent.name!==s.graph.name&&s.graph.nodes.forEach(r=>{t[r.tag]||this.checkNodesHaveChildMapped(r,e,t)}))};this.convertChildrenToNodes=(s=this)=>{if(s?.children){for(let e in s.children)if(!(s.children[e]instanceof g))if(typeof s.children[e]=="object")s.children[e].tag||(s.children[e].tag=e),s.nodes.get(s.children[e].tag)||(s.children[e]=new g(s.children[e],s,s.graph),this.checkNodesHaveChildMapped(s,s.children[e]));else{if(typeof s.children[e]>"u"||s.children[e]==!0)s.children[e]=s.graph.get(e),s.children[e]||(s.children[e]=s.nodes.get(e));else if(typeof s.children[e]=="string"){let t=s.children[e];s.children[e]=s.graph.get(t),s.children[e]||(s.children[e]=s.nodes.get(e))}if(s.children[e]instanceof g){if(s.graph){let t=s.children[e].getProps();delete t.parent,delete t.graph,s.source instanceof m?s.children[e]=new g(t,s,s.source):s.children[e]=new g(t,s,s.graph)}s.nodes.set(s.children[e].tag,s.children[e]),this.checkNodesHaveChildMapped(s,s.children[e]),s.children[e].tag in s||(s[s.children[e].tag]=s.children[e])}}}return s.children};this.stopLooping=(s=this)=>{s.isLooping=!1};this.stopAnimating=(s=this)=>{s.isAnimating=!1};this.stopNode=(s=this)=>{s.stopAnimating(s),s.stopLooping(s)};this.subscribeNode=s=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s.tag&&this.nodes.set(s.tag,s),s)return this.state.subscribeTrigger(this.tag,e=>{Array.isArray(e)?s.run(...e):s.run(e)})};this.print=(s=this,e=!0,t=[])=>{let i=new g;if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g){t.push(s.tag);let r={tag:s.tag,operator:s.operator.toString()};if(s.parent&&(r.parent=s.parent.tag),typeof s.children=="object")for(let n in s.children)return typeof s.children[n]=="string"?s.children[n]:t.includes(s.children[n].tag)?s.children[n].tag:e?s.children[n].print(s.children[n],e,t):s.children[n].tag;for(let n in s)n==="parent"||n==="children"||typeof i[n]>"u"&&(typeof s[n]=="function"?r[n]=s[n].toString():typeof s[n]=="object"?r[n]=JSON.stringifyWithCircularRefs(s[n]):r[n]=s[n]);return JSON.stringify(r)}};this.reconstruct=s=>{let e=A(s);if(e)return this.add(e)};this.setState=this.state.setState;this.DEBUGNODES=(s=!0)=>{this.DEBUGNODE=s,this.nodes.forEach(e=>{s?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};if(typeof s=="function"&&(s={operator:s}),typeof s=="object"){if(s instanceof g&&s._initial&&Object.assign(s,s._initial),s instanceof m){let r=s;s={source:r,operator:n=>{if(typeof n=="object"){let a={};for(let o in n)typeof r[o]=="function"?Array.isArray(n[o])?a[o]=r[o](...n[o]):a[o]=r[o](n[o]):(r[o]=n[o],a[o]=r[o]);return a}return r}},r.operator&&(s.operator=r.operator),r.children&&(s.children=r.children),r.forward&&(s.forward=r.forward),r.backward&&(s.backward=r.backward),r.repeat&&(s.repeat=r.repeat),r.recursive&&(s.recursive=r.recursive),r.loop&&(s.loop=r.loop),r.animate&&(s.animate=r.animate),r.looper&&(s.looper=r.looper),r.animation&&(s.animation=r.animation),r.delay&&(s.delay=r.delay),r.tag&&(s.tag=r.tag),r.oncreate&&(s.oncreate=r.oncreate),r.node&&r.node._initial&&Object.assign(s,r.node._initial),r._initial&&Object.assign(s,r._initial),this.nodes=r.nodes,r.node=this,t&&r.nodes.forEach(n=>{t.nodes.get(n.tag)||(t.nodes.set(n.tag,n),t.nNodes++)})}if(s.tag&&(t||e)){let r;if(t?.nodes&&(r=t.nodes.get(s.tag)),!r&&e?.nodes&&(r=e.nodes.get(s.tag)),r){Object.assign(this,r),this.source||(this.source=r);let n=r.getProps();delete n.graph,delete n.parent,Object.assign(s,n)}}s?.operator&&(s.operator=this.setOperator(s.operator)),!s.tag&&t?s.tag=`node${t.nNodes}`:s.tag||(s.tag=`node${Math.floor(Math.random()*1e10)}`);let i=Object.getOwnPropertyNames(this);for(let r in s)i.includes(r)||(this._initial[r]=s[r]);if(s.children&&(this._initial.children=Object.assign({},s.children)),Object.assign(this,s),this.tag||(t?this.tag=`node${t.nNodes}`:this.tag=`node${Math.floor(Math.random()*1e10)}`),t&&(this.graph=t,t.nodes.get(this.tag)&&(this.tag=`${this.tag}${t.nNodes+1}`),t.nodes.set(this.tag,this),t.nNodes++),e&&(this.parent=e,(e instanceof g||e instanceof m)&&e.nodes.set(this.tag,this)),typeof s.tree=="object")for(let r in s.tree){typeof s.tree[r]=="object"&&(!s.tree[r]).tag&&(s.tree[r].tag=r);let n=new g(s.tree[r],this,t);this.nodes.set(n.tag,n)}this.children&&this.convertChildrenToNodes(this),(this.parent instanceof g||this.parent instanceof m)&&this.checkNodesHaveChildMapped(this.parent,this),typeof this.oncreate=="function"&&this.oncreate(this),this.firstRun||(this.firstRun=!0)}else return s}},m=class{constructor(s,e,t){this.nNodes=0;this.nodes=new Map;this.state=S;this.tree={};this.add=(s={})=>{let e=s;return s instanceof g?(this.nNodes=this.nodes.size,s.tag&&(this.tree[s.tag]=e,this.nodes.set(s.tag,s))):s=new g(e,this,this),s};this.setTree=(s=this.tree)=>{if(!!s){for(let e in s)if(this.nodes.get(e)){let t=this.nodes.get(e);if(typeof s[e]=="function")t.setOperator(s[e]);else if(typeof s[e]=="object")if(s[e]instanceof g)this.add(s[e]);else if(s[e]instanceof m){let i=s[e],r={};i.operator&&(r.operator=i.operator),i.children&&(r.children=i.children),i.forward&&(r.forward=i.forward),i.backward&&(r.backward=i.backward),i.repeat&&(r.repeat=i.repeat),i.recursive&&(r.recursive=i.recursive),i.loop&&(r.loop=i.loop),i.animate&&(r.animate=i.animate),i.looper&&(r.looper=i.looper),i.animation&&(r.animation=i.animation),i.delay&&(r.delay=i.delay),i.tag&&(r.tag=i.tag),i.oncreate&&(r.oncreate=i.oncreate),i.node?._initial&&Object.assign(r,i.node._initial),r.nodes=i.nodes,r.source=i,t.setProps(r)}else t.setProps(s[e])}else if(typeof s[e]=="function")this.add({tag:e,operator:s[e]});else if(typeof s[e]=="object"&&!Array.isArray(s[e])){s[e].tag||(s[e].tag=e);let t=this.add(s[e]);s[e].aliases&&s[e].aliases.forEach(i=>{this.nodes.set(i,t)})}else this.add({tag:e,operator:(...t)=>s[e]});this.nodes.forEach(e=>{if(typeof e.children=="object")for(let t in e.children)typeof e.children[t]=="string"?this.nodes.get(e.children[t])&&(e.children[t]=this.nodes.get(e.children[t])):(e.children[t]===!0||typeof e.children[t]>"u")&&this.nodes.get(t)&&(e.children[t]=this.nodes.get(t)),e.children[t]instanceof g&&e.checkNodesHaveChildMapped(e,e.children[t]);typeof e.parent=="string"&&this.nodes.get(e.parent)&&(e.parent=this.nodes.get(e.parent),e.nodes.set(e.parent.tag,e.parent))})}};this.get=s=>this.nodes.get(s);this.set=s=>this.nodes.set(s.tag,s);this.run=(s,...e)=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g)return s.run(...e)};this.runAsync=(s,...e)=>(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g?new Promise((t,i)=>{t(s.run(...e))}):new Promise((t,i)=>{t(void 0)}));this.removeTree=(s,e)=>{if(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g){e||(e={});let t=i=>{i.children&&!e[i.tag]&&(e[i.tag]=!0,Array.isArray(i.children)?i.children.forEach(r=>{r.stopNode&&r.stopNode(),r.tag&&this.nodes.get(r.tag)&&this.nodes.delete(r.tag),this.nodes.forEach(n=>{n.nodes.get(r.tag)&&n.nodes.delete(r.tag)}),t(r)}):typeof i.children=="object"&&(i.stopNode&&i.stopNode(),i.tag&&this.nodes.get(i.tag)&&this.nodes.delete(i.tag),this.nodes.forEach(r=>{r.nodes.get(i.tag)&&r.nodes.delete(i.tag)}),t(i)))};s.stopNode&&s.stopNode(),s.tag&&(this.nodes.delete(s.tag),this.nodes.forEach(i=>{i.nodes.get(i.tag)&&i.nodes.delete(i.tag)}),this.nNodes=this.nodes.size,t(s)),s.ondelete&&s.ondelete(s)}return s};this.remove=s=>(typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&(s.stopNode(),s?.tag&&this.nodes.get(s.tag)&&(this.nodes.delete(s.tag),this.nodes.forEach(e=>{e.nodes.get(e.tag)&&e.nodes.delete(e.tag)})),s.ondelete&&s.ondelete(s)),s);this.append=(s,e)=>{e.addChildren(s)};this.callParent=async(s,...e)=>{if(s?.parent)return await s.callParent(...e)};this.callChildren=async(s,...e)=>{if(s?.children)return await s.callChildren(...e)};this.subscribe=(s,e)=>{if(!!e){if(s instanceof g&&typeof e=="function")return s.subscribe(e);if(e instanceof g||typeof e=="string")return this.subscribeNode(s,e);if(typeof s=="string")return this.state.subscribeTrigger(s,e)}};this.unsubscribe=(s,e)=>{this.state.unsubscribeTrigger(s,e)};this.subscribeNode=(s,e)=>{let t;if(s?.tag?t=s.tag:typeof s=="string"&&(t=s),typeof e=="string"&&(e=this.nodes.get(e)),s&&e)return this.state.subscribeTrigger(t,r=>{Array.isArray(r)?e.run(...r):e.run(r)})};this.stopNode=s=>{typeof s=="string"&&(s=this.nodes.get(s)),s instanceof g&&s.stopNode()};this.print=(s=void 0,e=!0)=>{if(s instanceof g)return s.print(s,e);{let t="{";return this.nodes.forEach(i=>{t+=`
"${i.tag}:${i.print(i,e)}"`}),t}};this.reconstruct=s=>{let e=A(s);if(e)return this.add(e)};this.create=(s,e,t)=>N(s,e,t,this);this.setState=this.state.setState;this.DEBUGNODES=(s=!0)=>{this.nodes.forEach(e=>{s?e.DEBUGNODE=!0:e.DEBUGNODE=!1})};this.tag=e||`graph${Math.floor(Math.random()*1e11)}`,t&&(Object.assign(this,t),this._initial=t),(s||Object.keys(this.tree).length>0)&&this.setTree(s)}};function E(d,s,e){let t=A(d);if(t)return new g(t,s,e)}function A(d="{}"){try{let s=typeof d=="string"?JSON.parse(d):d,e=t=>{for(let i in t)if(typeof t[i]=="string"){let r=O(t[i]);typeof r=="function"&&(t[i]=r)}else typeof t[i]=="object"&&e(t[i]);return t};return e(s)}catch(s){console.error(s);return}}var j=function(){let d=new Map,s=[],e=["this"];function t(){d.clear(),s.length=0,e.length=1}function i(n,a){var o=s.length-1,f=s[o];if(typeof f=="object")if(f[n]===a||o===0)e.push(n),s.push(a.pushed);else for(;o-->=0;){if(f=s[o],typeof f=="object"&&f[n]===a){o+=2,s.length=o,e.length=o,--o,s[o]=a,e[o]=n;break}o--}}function r(n,a){if(a!=null&&typeof a=="object"){n&&i(n,a);let o=d.get(a);if(o)return"[Circular Reference]"+o;d.set(a,e.join("."))}return a}return function(a,o){try{return s.push(a),JSON.stringify(a,r,o)}finally{t()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=j);var v=function(){let d=new Map,s=[],e=["this"];function t(){d.clear(),s.length=0,e.length=1}function i(n,a){var o=s.length-1;if(s[o]){var f=s[o];if(typeof f=="object")if(f[n]===a||o===0)e.push(n),s.push(a.pushed);else for(;o-->=0;){if(f=s[o],typeof f=="object"&&f[n]===a){o+=2,s.length=o,e.length=o,--o,s[o]=a,e[o]=n;break}o++}}}function r(n,a){let o;if(a!=null)if(typeof a=="object"){let f=a.constructor.name;n&&f==="Object"&&i(n,a);let h=d.get(a);if(h)return"[Circular Reference]"+h;if(d.set(a,e.join(".")),f==="Array")a.length>20?o=a.slice(a.length-20):o=a;else if(f.includes("Set"))o=Array.from(a);else if(f!=="Object"&&f!=="Number"&&f!=="String"&&f!=="Boolean")o="instanceof_"+f;else if(f==="Object"){let c={};for(let l in a)if(a[l]==null)c[l]=a[l];else if(Array.isArray(a[l]))a[l].length>20?c[l]=a[l].slice(a[l].length-20):c[l]=a[l];else if(a[l].constructor.name==="Object"){c[l]={};for(let y in a[l])if(Array.isArray(a[l][y]))a[l][y].length>20?c[l][y]=a[l][y].slice(a[l][y].length-20):c[l][y]=a[l][y];else if(a[l][y]!=null){let u=a[l][y].constructor.name;u.includes("Set")?c[l][y]=Array.from(a[l][y]):u!=="Number"&&u!=="String"&&u!=="Boolean"?c[l][y]="instanceof_"+u:c[l][y]=a[l][y]}else c[l][y]=a[l][y]}else{let y=a[l].constructor.name;y.includes("Set")?c[l]=Array.from(a[l]):y!=="Number"&&y!=="String"&&y!=="Boolean"?c[l]="instanceof_"+y:c[l]=a[l]}o=c}else o=a}else o=a;return o}return function(a,o){s.push(a);let f=JSON.stringify(a,r,o);return t(),f}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=v);function N(d,s,e,t){return typeof e=="object"?(e.operator=d,new g(e,s,t)):new g({operator:d},s,t)}var k=class extends m{constructor(e={}){super(void 0,e.name?e.name:`service${Math.floor(Math.random()*1e14)}`,e.props);this.routes={};this.loadDefaultRoutes=!1;this.keepState=!0;this.firstLoad=!0;this.init=e=>{e?e=Object.assign({},e):e={},e.customRoutes?Object.assign(e.customRoutes,this.customRoutes):e.customRoutes=this.customRoutes,e.customChildren?Object.assign(e.customChildren,this.customChildren):e.customChildren=this.customChildren,Array.isArray(e.routes)?e.routes.forEach(t=>{this.load(t,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren)}):(e.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)&&this.load(e.routes,e.includeClassName,e.routeFormat,e.customRoutes,e.customChildren)};this.load=(e,t=!0,i=".",r,n)=>{if(!e&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;this.firstLoad&&(this.firstLoad=!1),r?r=Object.assign(this.customRoutes,r):r=this.customRoutes,n&&(n=Object.assign(this.customChildren,n));let a,o={};if(e){if(!(e instanceof m)&&e?.name)if(e.module){let h=e;e={},Object.getOwnPropertyNames(e.module).forEach(c=>{t?e[h.name+i+c]=e.module[c]:e[c]=e.module[c]})}else typeof e=="function"&&(a=new e({loadDefaultRoutes:this.loadDefaultRoutes}),a.load(),e=a.routes);else if(e instanceof m||e.source instanceof m){a=e,e={};let h;t&&(h=a.name,h||(h=a.tag,a.name=h),h||(h=`graph${Math.floor(Math.random()*1e15)}`,a.name=h,a.tag=h)),a.customRoutes&&!this.customRoutes?this.customRoutes=a.customRoutes:a.customRoutes&&this.customRoutes&&Object.assign(this.customRoutes,a.customRoutes),a.customChildren&&!this.customChildren?this.customChildren=a.customChildren:a.customChildren&&this.customChildren&&Object.assign(this.customChildren,a.customChildren),a.nodes.forEach(c=>{e[c.tag]=c;let l={},y=(u,p)=>{if((!l[u.tag]||p&&t&&!l[p?.tag+i+u.tag])&&(p?l[p.tag+i+u.tag]=!0:l[u.tag]=!0,u instanceof m||u.source instanceof m)){if(t){let b=u.name;b||(b=u.tag,u.name=b),b||(b=`graph${Math.floor(Math.random()*1e15)}`,u.name=b,u.tag=b)}u.nodes.forEach(b=>{t&&!e[u.tag+i+b.tag]?e[u.tag+i+b.tag]=b:e[b.tag]||(e[b.tag]=b),y(b,u)})}};y(c)})}else if(typeof e=="object"){let h=e.constructor.name;if(h==="Object"&&(h=Object.prototype.toString.call(e),h&&(h=h.split(" ")[1]),h&&(h=h.split("]")[0])),h&&h!=="Object"){let c=e;e={},Object.getOwnPropertyNames(c).forEach(l=>{t?e[h+i+l]=c[l]:e[l]=c[l]})}}if(a instanceof m&&a.name&&t){e=Object.assign({},e);for(let h in e){let c=e[h];delete e[h],e[a.name+i+h]=c}}}if(this.loadDefaultRoutes){let h=Object.assign({},this.defaultRoutes);e?(Object.assign(h,this.routes),e=Object.assign(h,e)):e=Object.assign(h,this.routes),this.loadDefaultRoutes=!1}e||(e=this.routes);let f=0;for(let h in e){f++;let c=(l,y)=>{if(typeof l=="object"&&(l.tag||(l.tag=y),typeof l?.children=="object")){e:for(let u in l.children)if(f++,typeof l.children[u]=="object"){let p=l.children[u];if(p.tag&&o[p.tag])continue;if(n){for(let w in n)if(p=n[w](p,u,l,e,o),!p)continue e}p.id&&!p.tag&&(p.tag=p.id);let b;if(p.tag)if(o[p.tag]){let w=`${p.tag}${f}`;o[w]=p,p.tag=w,c(o[w],u),b=w}else o[p.tag]=p,c(o[p.tag],u),b=p.tag;else if(o[u]){let w=`${u}${f}`;o[w]=p,p.tag=w,c(o[w],u),b=w}else o[u]=p,c(o[u],u),b=u;a?.name&&t?(o[a.name+i+b]=p,delete o[b]):o[b]=p}}};o[h]=e[h],c(e[h],h)}e:for(let h in o)if(typeof o[h]=="object"){let c=o[h];if(typeof c=="object"){if(r){for(let l in r)if(c=r[l](c,h,o),!c)continue e}c.get&&c.get,c.post,c.delete,c.put,c.head,c.patch,c.options,c.connect,c.trace,c.post&&!c.operator?o[h].operator=c.post:!c.operator&&typeof c.get=="function"&&(o[h].operator=c.get)}}for(let h in e)typeof e[h]=="object"?this.routes[h]?typeof this.routes[h]=="object"?Object.assign(this.routes[h],e[h]):this.routes[h]=e[h]:this.routes[h]=e[h]:this.routes[h]?typeof this.routes[h]=="object"?Object.assign(this.routes[h],e[h]):this.routes[h]=e[h]:this.routes[h]=e[h];if(a)for(let h in this.routes)this.routes[h]instanceof g&&(this.nodes.set(h,this.routes[h]),this.nNodes=this.nodes.size);else this.setTree(this.routes);for(let h in this.routes)this.routes[h]?.aliases&&this.routes[h].aliases.forEach(l=>{a?.name&&t?e[a.name+i+l]=this.routes[h]:e[l]=this.routes[h]});return this.routes};this.unload=(e=this.routes)=>{if(!e)return;let t;!(e instanceof k)&&typeof e=="function"?(t=new k,e=t.routes):e instanceof k&&(e=e.routes);for(let i in e)delete this.routes[i],this.nodes.get(i)&&this.remove(i);return this.routes};this.handleMethod=(e,t,i)=>{let r=t.toLowerCase();return r==="get"&&this.routes[e]?.get?.transform instanceof Function?Array.isArray(i)?this.routes[e].get.transform(...i):this.routes[e].get.transform(i):this.routes[e]?.[r]?this.routes[e][r]instanceof Function?this.routes[e][r](i):(i&&(this.routes[e][r]=i),this.routes[e][r]):this.handleServiceMessage({route:e,args:i,method:t})};this.transmit=(...e)=>typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e;this.receive=(...e)=>{if(e[0]&&typeof e[0]=="string"){let t=e[0].substring(0,8);(t.includes("{")||t.includes("["))&&(t.includes("\\")&&(e[0]=e[0].replace(/\\/g,"")),e[0][0]==='"'&&(e[0]=e[0].substring(1,e[0].length-1)),e[0]=JSON.parse(e[0]))}return typeof e[0]=="object"?e[0].method?this.handleMethod(e[0].route,e[0].method,e[0].args):e[0].route?this.handleServiceMessage(e[0]):e[0].node?this.handleGraphNodeCall(e[0].node,e[0].args):(this.keepState&&(e[0].route&&this.setState({[e[0].route]:e[0].args}),e[0].node&&this.setState({[e[0].node]:e[0].args})),e):e};this.pipe=(e,t,i,r,n)=>{if(e instanceof g)return n?e.subscribe(a=>{let o=n(a);o!==void 0?this.transmit({route:t,args:o,method:r}):this.transmit({route:t,args:a,method:r},i)}):this.subscribe(e,a=>{this.transmit({route:t,args:a,method:r},i)});if(typeof e=="string")return this.subscribe(e,a=>{this.transmit({route:t,args:a,method:r},i)})};this.pipeOnce=(e,t,i,r,n)=>{if(e instanceof g)return n?e.state.subscribeTriggerOnce(e.tag,a=>{let o=n(a);o!==void 0?this.transmit({route:t,args:o,method:r}):this.transmit({route:t,args:a,method:r},i)}):this.state.subscribeTriggerOnce(e.tag,a=>{this.transmit({route:t,args:a,method:r},i)});if(typeof e=="string")return this.state.subscribeTriggerOnce(e,a=>{this.transmit({route:t,args:a,method:r},i)})};this.terminate=(...e)=>{this.nodes.forEach(t=>{t.stopNode()})};this.recursivelyAssign=(e,t)=>{for(let i in t)typeof t[i]=="object"?typeof e[i]=="object"?this.recursivelyAssign(e[i],t[i]):e[i]=this.recursivelyAssign({},t[i]):e[i]=t[i];return e};this.defaultRoutes={"/":{get:()=>this.print(),aliases:[""]},ping:()=>(console.log("ping"),"pong"),echo:(...e)=>(this.transmit(...e),e),assign:e=>typeof e=="object"?(Object.assign(this,e),!0):!1,recursivelyAssign:e=>typeof e=="object"?(this.recursivelyAssign(this,e),!0):!1,log:{post:(...e)=>{console.log("Log: ",...e)},aliases:["info"]},error:e=>{let t=new Error(e);return console.error(e),t},state:e=>e?this.state.data[e]:this.state.data,printState:e=>e?j(this.state.data[e]):j(this.state.data),spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,_run:this._run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};e.name?this.name=e.name:e.name=this.tag,"loadDefaultRoutes"in e&&(this.loadDefaultRoutes=e.loadDefaultRoutes,this.routes=Object.assign(this.defaultRoutes,this.routes)),(e||Object.keys(this.routes).length>0)&&this.init(e)}handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}isTypedArray(e){return ArrayBuffer.isView(e)&&Object.prototype.toString.call(e)!=="[object DataView]"}spliceTypedArray(e,t,i){let r=e.subarray(0,t),n;i&&(n=e.subarray(i+1));let a;return(r.length>0||n?.length>0)&&(a=new e.constructor(r.length+n.length)),r.length>0&&a.set(r),n&&n.length>0&&a.set(n,r.length),a}};var _=class{constructor(s,e){this.id=`router${Math.floor(Math.random()*1e15)}`;this.service=new k;this.nodes=this.service.nodes;this.run=this.service.run;this._run=this.service._run;this.add=this.service.add;this.remove=this.service.remove;this.stopNode=this.service.stopNode;this.subscribe=this.service.subscribe;this.unsubscribe=this.service.unsubscribe;this.get=this.service.get;this.reconstruct=this.service.reconstruct;this.setState=this.service.setState;this.recursivelyAssign=this.service.recursivelyAssign;this.state=this.service.state;this.routes=this.service.routes;this.services={};this.loadDefaultRoutes=!1;this.load=(s,e=!0,t=!0,i=".",r,n)=>{if(!(s instanceof m)&&typeof s=="function")s=new s({loadDefaultRoutes:this.loadDefaultRoutes,name:s.name}),s.load();else if(!s)return;if(s instanceof m&&s.name)this.services[s.name]=s;else if(s.constructor.name==="Object"){let o=Object.prototype.toString.call(s);o&&(o=o.split(" ")[1]),o&&(o=o.split("]")[0]),o&&o!=="Object"&&o!=="Function"&&(this.services[o]=s)}else this.services[s.constructor.name]=s;let a=this.service.load(s,t,i,r,n);return e&&this.syncServices(),a};this.syncServices=()=>{for(let s in this.services)this.service.nodes.forEach(e=>{this.services[s]?.nodes&&(this.services[s].nodes.get(e.tag)||this.services[s].nodes.set(e.tag,e))})};this.pipe=(s,e,t,i,r)=>{if(!t&&s&&e)return r?this.subscribe(s,n=>{let a=r(n);a&&(n=a),this.run(e,n)}):this.subscribe(s,n=>{this.run(e,n)});if(t){t==="sockets"&&(t="wss");let n=this.services[t];if(n)return r?this.subscribe(s,a=>{let o=r(a);o&&(a=o),n.transmit({route:e,args:a,method:i})}):this.subscribe(s,a=>{n.transmit({route:e,args:a,method:i})});{let a=this.getEndpointInfo(t);if(a)return this.services[a.service].pipe(s,e,t,i,r)}}return!1};this.pipeOnce=(s,e,t,i,r)=>{if(s instanceof g&&(s=s.tag),!t&&typeof s=="string"&&e)return r?this.state.subscribeTriggerOnce(s,n=>{let a=r(n);a&&(n=a),this.run(e,n)}):this.state.subscribeTriggerOnce(s,n=>{this.run(e,n)});if(t){t==="sockets"&&(t="wss");let n=this.services[t];if(n)return r?this.state.subscribeTriggerOnce(s,a=>{let o=r(a);o&&(a=o),n.transmit({route:e,args:a,method:i})}):this.state.subscribeTriggerOnce(s,a=>{n.transmit({route:e,args:a,method:i})});{let a=this.getEndpointInfo(t);if(a)return this.services[a.service].pipeOnce(s,e,t,i,r)}}return!1};this.sendAll=(s,e,t)=>{let i=!1;if(typeof e=="object")for(let r in e)for(let n in e[r]){let a=e[r][n];if(a.socket)a.socket.readyState===1?(a.socket.send(s),i=!0):delete e[r][n];else if(a.wss)a.wss.clients.forEach(o=>{o.send(s)}),i=!0;else if(a.sessions)if(t)a.channel.broadcast(s,t),i=!0;else for(let o in a.sessions)a.sessions[o].isConnected&&(a.sessions[o].push(s),i=!0);else if(a.session)t?(a.served.channel.broadcast(s,t),i=!0):a.session.isConnected?(a.session.push(s),i=!0):delete e[r][n];else if(a.rtc)if(t&&a.channels[t])a.channels[t].send(s),i=!0;else if(a.channels.data)a.channels.data.send(s),i=!0;else{let o=Object.keys(a.channels)[0];a.channels[o].send(s),i=!0}else a.server&&this.services.http&&(this.services.http.transmit(s,t),i=!0)}return i};this.getEndpointInfo=(s,e)=>{if(!s)return;let t=(i,r)=>{if(this.services[r]){if(this.services[r].rtc?.[i])return this.services[r].rtc[i];if(this.services[r].servers?.[i])return this.services[r].servers[i];if(this.services[r].sockets?.[i])return this.services[r].sockets[i];if(this.services[r].eventsources?.[i])return this.services[r].eventsources[i];if(this.services[r].workers?.[i])return this.services[r].workers[i]}};if(e){let i=t(s,e);if(i)return{endpoint:i,service:e}}for(let i in this.services){let r=t(s,i);if(r)return{endpoint:r,service:i}}};this.pipeFastest=(s,e,t,i,r=this.services)=>{for(let n in r){if(r[n].rtc)return this.pipe(s,e,"webrtc",t,i);if(r[n].eventsources){let a=Object.keys(r[n].eventsources);if(a[0]&&this.services[n].eventsources[a[0]].sessions)return this.pipe(s,e,"sse",t,i)}if(r[n].sockets)return this.pipe(s,e,"wss",t,i);if(r[n].servers)return this.pipe(s,e,"http",t,i);if(r[n].workers)return this.pipe(s,e,"worker",t,i)}return!1};this.getFirstRemoteEndpoint=(s=this.services)=>{let e;for(let i in s){if(s[i].rtc&&(e=s[i].rtc),s[i].eventsources&&!e){let r=Object.keys(s[i].eventsources);r[0]&&this.services[i].eventsources[r[0]]?.sessions&&(e=s[i].eventsources)}s[i].sockets&&!e&&(e=s[i].sockets),s[i].servers&&!e&&(e=s[i].servers),s[i].workers&&!e&&(e=s[i].workers)}let t=Object.keys(e);return t[0]?e[t[0]]:!1};this.STREAMLATEST=0;this.STREAMALLLATEST=1;this.streamSettings={};this.streamFunctions={allLatestValues:(s,e)=>{let t;if(Array.isArray(s))s.length!==e.lastRead&&(t=s.slice(e.lastRead),e.lastRead=s.length);else if(typeof s=="object"){t={};for(let i in s)Array.isArray(s[i])?(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),s[i].length!==e[i].lastRead&&(t[i]=s[i].slice(e[i].lastRead),e[i].lastRead=s[i].length)):(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),e[i].lastRead!==s[i]&&(t[i]=s[i],e[i].lastRead=s[i]));Object.keys(t).length===0&&(t=void 0)}else e.lastRead!==s&&(t=s,e.lastRead=s);return t},latestValue:(s,e)=>{let t;if(Array.isArray(s))s.length!==e.lastRead&&(t=s[s.length-1],e.lastRead=s.length);else if(typeof s=="object"){t={};for(let i in s)Array.isArray(s[i])?(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),s[i].length!==e[i].lastRead&&(t[i]=s[i][s[i].length-1],e[i].lastRead=s[i].length)):(typeof e=="number"?e={[i]:{lastRead:void 0}}:e[i]||(e[i]={lastRead:void 0}),e[i].lastRead!==s[i]&&(t[i]=s[i],e[i].lastRead=s[i]))}else e.lastRead!==s&&(t=s,e.lastRead=s);return t}};this.setStreamFunc=(s,e,t=this.streamFunctions.allLatestValues)=>(this.streamSettings[s].settings[e]||(this.streamSettings[s].settings[e]={lastRead:0}),t===this.STREAMLATEST?this.streamSettings[s].settings[e].callback=this.streamFunctions.latestValue:t===this.STREAMALLLATEST?this.streamSettings[s].settings[e].callback=this.streamFunctions.allLatestValues:typeof t=="string"?this.streamSettings[s].settings[e].callback=this.streamFunctions[t]:typeof t=="function"&&(this.streamSettings[s].settings[e].callback=t),this.streamSettings[s].settings[e].callback||(this.streamSettings[s].settings[e].callback=this.streamFunctions.allLatestValues),!0);this.addStreamFunc=(s,e=t=>{})=>{this.streamFunctions[s]=e};this.setStream=(s={},e={},t=`stream${Math.floor(Math.random()*1e10)}`)=>{if(e.keys){if(e.keys.length===0){let i=Object.keys(s);i.length>0&&(e.keys=Array.from(i))}}else e.keys=Array.from(Object.keys(s));return this.streamSettings[t]={object:s,settings:e},e.keys.forEach(i=>{e[i]?.callback?this.setStreamFunc(t,i,e[i].callback):this.setStreamFunc(t,i,e.callback)}),this.streamSettings[t]};this.removeStream=(s,e)=>{if(s&&!e)delete this.streamSettings[s];else if(e&&this.streamSettings[s]?.settings?.keys){let t=this.streamSettings[s].settings.keys.indexOf(e);return t>-1&&this.streamSettings[s].settings.keys.splice(t,1),this.streamSettings[s].settings[e]&&delete this.streamSettings[s].settings[e],!0}return!1};this.updateStreamData=(s,e={})=>this.streamSettings[s]?(Object.assign(this.streamSettings[s].object,e),this.streamSettings[s].object):!1;this.streamLoop=(s,e)=>{let t={};for(let i in this.streamSettings)this.streamSettings[i].settings.keys.forEach(r=>{if(this.streamSettings[i].settings[r]){let n=this.streamSettings[i].settings[r].callback(this.streamSettings[i].object[r],this.streamSettings[i].settings[r]);n!==void 0&&(t[r]=n)}});return s&&this.sendAll(t,s,e),t};this.receive=(s,e,...t)=>{if(e){for(let i in this.services)if(i===e||this.services[i].name===e)return this.services[i].receive(s,...t)}return this.service.receive(s,...t)};this.transmit=(s,e,...t)=>{if(e){for(let i in this.services)if(i===e||this.services[i].name===e)return this.services[i].transmit(s,...t)}return this.service.transmit(s,...t)};this.defaultRoutes={getEndpointInfo:this.getEndpointInfo,pipeOnce:this.pipeOnce,pipeFastest:this.pipeFastest,setStream:this.setStream,removeStream:this.removeStream,updateStreamData:this.updateStreamData,addStreamFunc:this.addStreamFunc,setStreamFunc:this.setStreamFunc,sendAll:this.sendAll,streamLoop:{operator:this.streamLoop,loop:10}};e&&"loadDefaultRoutes"in e&&(this.loadDefaultRoutes=e.loadDefaultRoutes),this.loadDefaultRoutes&&this.load(this.defaultRoutes,e?.linkServices,e?.includeClassName,e?.routeFormat,e?.customRoutes,e?.customChildren),Array.isArray(s)?s.forEach(t=>this.load(t,e?.linkServices,e?.includeClassName,e?.routeFormat,e?.customRoutes,e?.customChildren)):typeof s=="object"&&Object.keys(s).forEach(t=>this.load(s[t],e?.linkServices,e?.includeClassName,e?.routeFormat,e?.customRoutes,e?.customChildren))}};var G=class extends _{constructor(e,t){super(e,t);this.users={};this.sessions={private:{},shared:{}};this.runAs=(e,t,...i)=>(typeof t=="object"&&(t=t._id),this.run(e,t,...i));this._initConnections=e=>{if(e.sockets&&this.services.wss)for(let t in e.sockets){if(e.sockets[t]._id){if(this.services.wss.servers){for(let i in this.services.wss.servers)for(let r in this.services.wss.servers[i].clients)if(r===e.sockets[t]._id){e.sockets[t]={socket:this.services.wss.servers[i].clients[r],_id:r,address:t};break}}if(!e.sockets[t].socket){for(let i in this.services.wss.sockets)if(this.services.wss.sockets[i]._id===e.sockets[t]._id){e.sockets[t]=this.services.wss.sockets[t];break}}}e.sockets[t].socket||(e.sockets[t]=this.run("wss/openWS",e.sockets[t])),e.onmessage&&e.sockets[t].socket.addEventListener("message",e.onmessage),e.onclose&&e.sockets[t].socket.addEventListener("close",e.onclose)}if(e.wss&&this.services.wss)for(let t in e.wss){if(e.wss[t]._id){for(let i in this.services.wss.servers)if(this.services.wss.servers[i]._id===e.server[t]._id){e.wss[t]=this.services.wss.server[t];break}}e.wss[t].wss||(e.wss[t]=this.run("wss/openWSS",e.wss[t])),e.onmessage&&e.wss[t].wss.addEventListener("message",e.onmessage),e.onclose&&e.wss[t].wss.addEventListener("close",e.onclose)}if(e.eventsources&&this.services.sse)for(let t in e.eventsources){if(e.eventsources[t]._id){for(let i in this.services.sse.eventsources)if(this.services.sse.eventsources[i]._id===e.eventsources[t]._id){e.eventsources[t]=this.services.sse.eventsources[i];break}else if(this.services.sse.eventsources[i].sessions?.[e.eventsources[t]._id]){e.eventsources[t]={session:this.services.sse.eventsources[i].sessions[e.eventsources[t]._id],_id:t};break}else if(this.services.sse.eventsources[i].session?.[e.eventsources[t]._id]){e.eventsources[t]=this.services.sse.eventsources[i];break}}!e.eventsources[t].source&&!e.eventsources[t].sessions&&!e.eventsources[t].session&&(e.eventsources[t]=this.run("sse/openSSE",e.eventsources[t])),e.eventsources[t].source&&(e.onmessage&&e.eventsources[t].source.addEventListener("message",e.onmessage),e.onclose&&e.eventsources[t].source.addEventListener("close",e.onclose))}if(e.servers&&this.services.http)for(let t in e.servers)e.servers[t].server||(e.servers[t]=this.run("http/setupServer",e.servers[t])),e.onmessage&&this.subscribe(t,e.onmessage);if(e.webrtc&&this.services.webrtc){for(let t in e.webrtc)if(e.webrtc[t].rtc){let i=e.webrtc[t].channels.data;i||(i=e.webrtc[t].channels[Object.keys(e.webrtc[t].channels)[0]]),i&&i.addEventListener("message",e.onmessage)}}if(e.sessions&&e._id)for(let t in e.sessions)typeof e.sessions[t]=="string"?e.sessions[t]=this.joinSession(e.sessions[t],e._id):typeof e.sessions[t]=="object"&&(e.sessions[t]=this.joinSession(t,e._id,e.sessions[t]))};this.addUser=async(e,t=5e3)=>{if(e||(e={}),e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`),e.tag=e._id,typeof e=="object"&&(e.onmessage||(e.onmessage=i=>{this.setState({[e.tag]:i})}),e.onclose||(e.onclose=()=>{this.removeUser(e._id)}),e.operator=e.onmessage,e.send||(e.send=(i,r)=>{if(!!this.users[e._id])if(typeof this.users[e._id].sendAll=="object"){typeof i=="object"&&(i=JSON.stringify(i));for(let n in this.users[e._id].sendAll)for(let a in this.users[e._id].sendAll[n]){let o=this.users[e._id].sendAll[n][a];if(o.socket)o.socket.readyState===1?o.socket.send(i):delete this.users[e._id].sendAll[n][a];else if(o.rtc)if(r&&o.channels[r])o.channels[r].send(i);else if(o.channels.data)o.channels.data.send(i);else{let f=Object.keys(o.channels)[0];o.channels[f].send(i)}else if(o.wss)o.wss.clients.forEach(f=>{f.send(i)});else if(o.sessions)if(r)o.channel.broadcast(i,r);else for(let f in o.sessions)o.sessions[f].isConnected&&o.sessions[f].push(i);else o.session?r?o.served.channel.broadcast(i,r):o.session.isConnected?o.session.push(i):delete this.users[e._id].sendAll[n][a]:o.server&&this.services.http&&this.services.http.transmit(i,r)}}else{let n;if(this.users[e._id].sendAll&&typeof this.users[e._id].sendAll=="string"&&(n=this.user[this.users[e._id].sendAll],this.users[e._id].sendAll={}),!n){if(this.users[e._id].sendAll={},this.users[e._id].webrtc){let a=Object.keys(this.users[e._id].webrtc)[0];a&&(this.users[e._id].sendAll.webrtc={[a]:this.users[e._id].webrtc[a]})}else if(this.users[e._id].eventsources&&this.users[e._id].eventsources[Object.keys(this.users[e._id].eventsources)[0]].session){let a=Object.keys(this.users[e._id].eventsources)[0];a&&(this.users[e._id].sendAll.eventsources={[a]:this.users[e._id].eventsources[a]})}else if(this.users[e._id].eventsources&&this.users[e._id].eventsources[Object.keys(this.users[e._id].eventsources)[0]].sessions){let a=Object.keys(this.users[e._id].eventsources)[0];a&&(this.users[e._id].sendAll.eventsources={[a]:this.users[e._id].eventsources[a]})}else if(this.users[e._id].sockets){let a=Object.keys(this.users[e._id].sockets)[0];a&&(this.users[e._id].sendAll.sockets={[a]:this.users[e._id].sockets[a]})}else if(this.users[e._id].wss){let a=Object.keys(this.users[e._id].wss)[0];a&&(this.users[e._id].sendAll.wss={[a]:this.users[e._id].wss[a]})}else if(this.users[e._id].servers){let a=Object.keys(this.users[e._id].servers)[0];a&&(this.users[e._id].sendAll.servers={[a]:this.users[e._id].servers[a]})}}this.users[e._id].sendAll&&Object.keys(this.users[e._id].sendAll).length>0&&this.users[e._id].send(i,r)}}),e.request||(e.request=(i,r,n,a)=>{if(!r){if(this.users[e._id].sockets){for(let h in this.users[e._id].sockets)if(this.users[e._id].sockets[h].socket){if(n=this.users[e._id].sockets[h]._id,!n)continue;r=this.users[e._id].sockets[h].socket;break}}if(!r&&this.users[e._id].webrtc){for(let h in this.users[e._id].webrtc)if(this.users[e._id].webrtc[h].channels.data){if(n=this.users[e._id].webrtc[h]._id,!n)return;r=this.users[e._id].webrtc[h].channels.data;break}else if(Object.keys(this.users[e._id].webrtc[h].channels).length>0){if(n=this.users[e._id].webrtc[h]._id,!n)return;r=this.users[e._id].webrtc[h].channels[Object.keys(this.users[e._id].webrtc[h].channels)[0]];break}}if(!r)return}let o=`${Math.random()}`,f={route:"runRequest",args:[i,n,o]};return a&&(f.method=a),new Promise((h,c)=>{let l=y=>{let u=y.data;typeof u=="string"&&u.includes("callbackId")&&(u=JSON.parse(u)),typeof u=="object"&&u.callbackId===o&&(r.removeEventListener("message",l),h(u.args))};r.addEventListener("message",l),r.send(JSON.stringify(f))})}),this._initConnections(e),e instanceof g||(this.users[e._id]=new g(e,void 0,this.service)),this.users[e._id].sockets||this.users[e._id].eventsources||this.users[e._id].webrtc)){let i=[];for(let r in this.users[e._id].sockets)this.users[e._id].sockets[r]._id||i.push(this.users[e._id].sockets[r]);for(let r in this.users[e._id].eventsources)!this.users[e._id].eventsources[r]._id&&this.users[e._id].eventsources[r].source&&i.push(this.users[e._id].eventsources[r]);for(let r in this.users[e._id].webrtc)this.users[e._id].webrtc[r]._id||i.push(this.users[e._id].webrtc[r]);if(i.length>0)return await new Promise((r,n)=>{let a=performance.now(),o=()=>{let f=i.filter(h=>{if(!h._id)return!0});if(f.length>0){if(performance.now()-a>t)return n(f),this.users[e._id];setTimeout(()=>{o()},100)}else return r(this.users[e._id]),this.users[e._id]};o()}).catch(r=>{console.error("Connections timed out:",r)})}return await this.users[e._id]};this.removeUser=e=>{if(typeof e=="string"&&(e=this.users[e]),!e)return!1;if(e.sockets)for(let t in e.sockets)e.sockets[t].socket&&this.run("wss/terminate",t);if(e.wss)for(let t in e.wss)e.wss[t].wss&&this.run("wss/terminate",t);if(e.eventsources)for(let t in e.eventsources)(e.eventsources[t].source||e.eventsources[t].sessions)&&this.run("sse/terminate",t);if(e.servers)for(let t in e.servers)e.servers[t].server&&this.run("http/terminate",t);if(e.webrtc)for(let t in e.webrtc)e.webrtc[t].rtc&&this.run("webrtc/terminate",t);return e.sessions,delete this.users[e._id],!0};this.updateUser=(e,t)=>(typeof e=="string"&&(e=this.users[e]),e?(this._initConnections(t),t._id!==e._id&&(delete this.users[e._id],e._id=t._id,this.users[e._id]=e),this.recursivelyAssign(this.users[e._id],t),e):!1);this.setUser=(e,t)=>e&&typeof e=="string"&&(e=this.users[e],!e)?!1:(t&&typeof t=="string"&&(t=JSON.parse(t)),this.recursivelyAssign(e,t),!0);this.getConnectionInfo=e=>{let t={_id:e._id};if(e.sockets){t.sockets={};for(let i in e.sockets)e.sockets[i]._id&&(t.sockets[i]={_id:e.sockets[i]._id,host:e.sockets[i].host,port:e.sockets[i].port,path:e.sockets[i].path,address:e.sockets[i].address})}if(e.eventsources){t.eventsources={};for(let i in e.eventsources)e.eventsources[i]._id&&(t.eventsources[i]={_id:e.eventsources[i]._id,url:e.eventsources[i].url})}if(e.webrtc){t.webrtc={};for(let i in e.webrtc)e.webrtc[i]._id&&(t.webrtc[i]={_id:e.webrtc[i]._id,icecandidate:e.webrtc[i].icecandidate})}if(e.servers){t.servers={};for(let i in e.servers)e.servers[i].server&&(t.servers[i]={host:e.servers[i].host,port:e.servers[i].port,protocol:e.servers[i].protocol,address:e.servers[i].address})}if(e.wss){t.wss={};for(let i in e.wss)e.wss[i]._id&&(t.wss[i]={host:e.wss[i].host,port:e.wss[i].port,path:e.wss[i].path,address:e.wss[i].address})}if(e.sessions){t.sessions={};for(let i in e.sessions)e.sessions[i]._id&&(t.sessions[i]={_id:e.sessions[i]._id,type:e.sessions[i].type,users:e.sessions[i].users})}return t};this.getSessionInfo=(e,t)=>{if(typeof t=="object"&&(t=t._id),e)if(this.sessions.private[e]){let i=this.sessions.private[e];if(i.settings&&(i.settings.source===t||i.settings.listener===t||i.settings.ownerId===t||i.settings.admins?.[t]||i.settings.moderators?.[t]))return{private:{[e]:i}}}else{if(this.sessions.shared[e])return{shared:{[e]:this.sessions.shared[e]}};{let i={};for(let r in this.sessions.shared)this.sessions.shared[r].settings?.name&&(i[r]=this.sessions.shared.settings);if(Object.keys(i).length>0)return i}}else return this.sessions.shared};this.openPrivateSession=(e={},t)=>{if(typeof t=="object"&&(t=t._id),e._id||(e._id=`private${Math.floor(Math.random()*1e15)}`,this.sessions.private[e._id]&&(delete e._id,this.openPrivateSession(e,t))),e._id){if(t&&(e.settings||(e.settings={listener:t,source:t,propnames:{latency:!0},admins:{[t]:!0},ownerId:t}),e.settings.listener||(e.settings.listener=t),e.settings.source||(e.settings.source=t),this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e._id]=e),e.data||(e.data={}),this.sessions.private[e._id])return this.updateSession(e,t);e.settings?.listener&&e.settings.source&&(this.sessions.private[e._id]=e)}return e};this.openSharedSession=(e,t)=>{if(typeof t=="object"&&(t=t._id),e._id||(e._id=`shared${Math.floor(Math.random()*1e15)}`,this.sessions.shared[e._id]&&(delete e._id,this.openSharedSession(e,t))),e._id){if(typeof t=="string"?(e.settings||(e.settings={name:"shared",propnames:{latency:!0},users:{[t]:!0},admins:{[t]:!0},ownerId:t}),e.settings.users||(e.settings.users={[t]:!0}),e.settings.admins||(e.settings.admins={[t]:!0}),e.settings.ownerId||(e.settings.ownerId=t),this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e._id]=e):e.settings||(e.settings={name:"shared",propnames:{latency:!0},users:{}}),e.data||(e.data={private:{},shared:{}}),e.settings.name||(e.name=e.id),this.sessions.shared[e._id])return this.updateSession(e,t);this.sessions.shared[e._id]=e}return e};this.updateSession=(e,t)=>{typeof t=="object"&&(t=t._id);let i;if(e._id&&typeof t=="string")if(i=this.sessions.private[e._id],i||(i=this.sessions.shared[e._id]),this.sesh.private[e._id]){let r=this.sessions.shared[e._id];if(r.settings&&(r?.settings.source===t||r.settings.admins?.[t]||r.settings.moderators?.[t]||r.settings.ownerId===t))return Object.assign(this.session.shared[e._id],e)}else return e.settings?.source?this.openPrivateSession(e,t):this.openSharedSession(e,t);return!1};this.joinSession=(e,t,i)=>{if(typeof t=="object"&&(t=t._id),!t)return!1;let r=this.sessions.shared[e];return r?.settings?r.settings?.banned&&r.settings.banned[t]||r.settings?.password&&(!i?.settings?.password||i.settings.password!==r.settings.password)?!1:(r.settings.users[t]=!0,this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e]=r,i?this.updateSession(i,t):r):i?.source||i?.listener?this.openPrivateSession(i,t):i?this.openSharedSession(i,t):!1};this.leaveSession=(e,t,i=!0)=>{typeof t=="object"&&(t=t._id);let r=this.sessions.private[e];return r||(r=this.sessions.shared[e]),r?(this.sessions.private[e]?(t===r.settings.source||t===r.settings.listener||r.settings.admins?.[t]||r.settings.moderators?.[t])&&(delete this.sessions.private[e],delete this.users[t].sessions[e],i&&(r.settings.admins?.[t]&&delete(this.sessions.shared[e].settings?.admins)[t],r.settings.moderators?.[t]&&delete(this.sessions.shared[e].settings?.moderators)[t])):this.sessions.shared[e]&&(delete this.sessions.shared.settings.users[t],delete this.users[t].sessions[e],i&&(r.settings.admins?.[t]&&delete(this.sessions.shared[e].settings?.admins)[t],r.settings.moderators?.[t]&&delete(this.sessions.shared[e].settings?.moderators)[t],r.data.shared[t]&&delete this.sessions.shared[e].data?.shared[t],r.settings.host===t&&(delete r.settings.host,delete r.data.shared,r.data.shared={},this.swapHost(r)))),!0):!1};this.swapHost=(e,t)=>{if(typeof e=="string"&&(this.sessions.private[e]?e=this.sessions.private[e]:this.sessions.shared[e]&&(e=this.sessions.shared[e])),typeof e=="object"&&e.settings){if(delete e.settings.host,t&&e.settings.users[t]&&(e.settings.host=t),e.settings.ownerId&&!e.settings.host&&e.settings.users[e.settings.ownerId]&&(e.settings.host=e.settings.ownerId),e.settings.admins&&!e.settings.host){let i=this.getFirstMatch(e.settings.users,e.settings.admins);i&&(e.settings.host=i)}if(e.settings.moderators&&!e.settings.host){let i=this.getFirstMatch(e.settings.users,e.settings.moderators);i&&(e.settings.host=i)}return e.settings.host||(e.settings.host=Object.keys(e.settings.users)[0]),!0}return!1};this.deleteSession=(e,t)=>{typeof t=="object"&&(t=t._id);let i=this.sessions.private[e];if(i||(i=this.sessions.shared[e]),i&&(i.source===t||i.listener===t||i.admins?.[t]||i.ownerId===t)){for(let r in i.settings.users)delete this.users.sessions[e];this.sessions.private[e]?delete this.sessions.private[e]:this.sessions.shared[e]&&delete this.sessions.private[e]}return!0};this.subscribeToSession=(e,t,i,r,n)=>{if(typeof t=="object"&&(t=t._id),typeof e=="string"){let a=this.sessions.private[e];if(a||(a=this.sessions.shared[e]),!a)return;e=a}if(typeof e.onopen=="function"){let a=this.subscribe("joinSession",o=>{o._id===e._id&&e.onopen(e,t),this.unsubscribe("joinSession",a)})}return typeof e=="object"&&(i&&(e.onmessage=i),r&&(e.onclose=r),n&&(e.onclose=n)),e};this.sessionLoop=(e=!0)=>{let t={private:{},shared:{}};for(let i in this.sessions.private){let r=this.sessions.private[i],n={_id:r._id,settings:{listener:r.listener,source:r.source},data:{}};if(!this.users[r.source]){delete this.sessions.private[i];break}if(r.settings&&r.data)for(let a in r.settings.propnames)this.users[r.source][a]?this.sessions.private[i].data?typeof r.data[a]=="object"?this.users[r.source][a]&&(v(r.data[a])!==v(this.users[r.source][a])||!(a in r.data))&&(n.data[a]=this.users[r.source][a]):this.users[r.source][a]&&(r.data[a]!==this.users[r.source][a]||!(a in r.data))&&(n.data[a]=this.users[r.source][a]):n.data[a]=this.users[r.source][a]:this.sessions.private[i]?.data?.[a]&&delete this.sessions.private[i].data[a];Object.keys(n.data).length>0&&(this.recursivelyAssign(this.sessions.private[i].data,n.data),t.private[r._id]=n)}for(let i in this.sessions.shared){let r=this.sessions.shared[i],n={_id:r._id,settings:{name:r.name},data:{}};if(r.settings?.host){let a={},o={};for(let f in r.settings.users){if(!this.users[f]){delete r.settings.users[f],r.data?.shared[f]&&delete r.data.shared[f],r.data?.private?.[f]&&delete r.data.shared[f],r.settings.host===f&&this.swapHost(r),n.settings.users=r.settings.users,n.settings.host=r.settings.host;continue}if(f!==r.settings.host){a[f]={};for(let h in r.settings.propnames)this.users[f][h]?r.data?.private&&!(f in r.data.private)?typeof this.users[f][h]=="object"?a[f][h]=this.recursivelyAssign({},this.users[f][h]):a[f][h]=this.users[f][h]:typeof a[f][h]=="object"&&r.data?this.users[f][h]&&(v(r.data?.shared[f][h])!==v(this.users[f][h])||!(h in r.data))&&(a[f][h]=this.users[f][h]):this.users[f][h]&&r.data?.private?.[h]!==this.users[f][h]&&(a[f][h]=this.users[f][h]):r.data?.private?.[f]?.[h]&&delete r.data.private[f][h];Object.keys(a[f]).length===0&&delete a[f]}else{o[f]={};for(let h in r.settings.hostprops)this.users[f][h]?r.data&&!(f in r.data.shared)?typeof this.users[f][h]=="object"?o[f][h]=this.recursivelyAssign({},this.users[f][h]):o[f][h]=this.users[f][h]:typeof o[f][h]=="object"&&r.data?this.users[f][h]&&(v(r.data?.shared[f][h])!==v(this.users[f][h])||!(h in r.data.shared[f]))&&(o[f][h]=this.users[f][h]):this.users[f][h]&&r.data?.shared[f][h]!==this.users[f][h]&&(o[f][h]=this.users[f][h]):r.data?.shared[f]?.[h]&&delete r.data.shared[f][h]}}Object.keys(a).length>0&&(n.data.private=a),Object.keys(o).length>0&&(n.data.shared=o)}else{let a={};if(r.settings?.users){for(let o in r.settings.users){if(!this.users[o]){delete r.settings.users[o],r.data?.shared[o]&&delete r.data.shared[o],r.data?.private?.[o]&&delete r.data.shared[o],r.settings.host===o&&this.swapHost(r),n.settings.users=r.settings.users,n.settings.host=r.settings.host;continue}a[o]={};for(let f in r.settings.propnames)this.users[o][f]?r.data&&!(o in r.data.shared)?typeof this.users[o][f]=="object"?a[o][f]=this.recursivelyAssign({},this.users[o][f]):a[o][f]=this.users[o][f]:typeof r.data?.shared[o][f]=="object"?(v(r.data.shared[o][f])!==v(this.users[o][f])||!(f in r.data.shared[o]))&&(a[o][f]=this.users[o][f]):r.data?.shared[o][f]!==this.users[o][f]&&(a[o][f]=this.users[o][f]):r.data?.shared[o]?.[f]&&delete r.data.shared[o][f];Object.keys(a[o]).length===0&&delete a[o]}Object.keys(a).length>0&&(n.data.shared=a)}}(n.data.shared||n.data.private)&&(t.shared[r._id]=n),n.data.shared&&this.recursivelyAssign(this.sessions.shared[i].data?.shared,n.data.shared),n.data.private&&this.recursivelyAssign(this.sessions.shared[i].data?.private,n.data.private)}if(Object.keys(t.private).length===0&&delete t.private,Object.keys(t.shared).length===0&&delete t.shared,Object.keys(t).length!==0)return e&&this.transmitSessionUpdates(t),t};this.transmitSessionUpdates=e=>{let t={};if(e.private)for(let r in e.private){let n=this.sessions.private[r];if(n?.settings){let a=n.settings.listener;t[a]?t[a].private||(t[a].private={}):t[a]={private:{}},t[a].private[r]=e.private[r]}}if(e.shared)for(let r in e.shared){let n=this.sessions.shared[r];if(n?.settings){let a;n.settings.host&&(a=Object.assign({},e.shared[r]),delete a.data.private);for(let o in n.settings.users)t[o]?t[o].shared||(t[o].shared={}):t[o]={shared:{}},n.settings.host&&o!==n.settings.host?t[o].shared[r]=a:t[o].shared[r]=e.shared[r]}}let i={route:"receiveSessionUpdates",args:null};for(let r in t)i.args=[r,t[r]],this.users[r].send&&this.users[r].send(JSON.stringify(i));return t};this.receiveSessionUpdates=(e,t)=>{if(t&&typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object"){let i=this.users[e];if(!i)return;if(i.sessions||(i.sessions={}),t.private)for(let r in t.private)!i.sessions[r]||(this.recursivelyAssign(i.sessions[r].data,t.private[r].data),i.sessions[r].onmessage&&i.sessions[r].onmessage(i.sessions[r],i._id));if(t.shared)for(let r in t.shared)!i.sessions[r]||(t.shared[r].settings.users&&(i.sessions[r].settings.users=t.shared[r].settings.users),t.shared[r].settings.host&&(i.sessions[r].settings.host=t.shared[r].settings.host),t.shared[r].data.private&&this.recursivelyAssign(i.sessions[r].data.private,t.shared[r].data.private),t.shared[r].data.shared&&this.recursivelyAssign(i.sessions[r].data.shared,t.shared[r].data.shared),i.sessions[r].onmessage&&i.sessions[r].onmessage(i.sessions[r],i._id));return i}};this.getUpdatedUserData=e=>{let t={};for(let i in e.sessions){let r=e.sessions[i];if((r.settings.users[e._id]||r.settings.source===e._id)&&!r.settings.spectators?.[e._id])if(r.settings.host===e._id)for(let n in r.settings.hostprops)!t[n]&&n in e&&(r.data.shared?.[e._id]&&n in r.data.shared?.[e._id]?typeof e[n]=="object"?v(r.data.shared[e._id][n])!==v(e[n])&&(t[n]=e[n]):r.data.shared[e._id][n]!==e[n]&&(t[n]=e[n]):t[n]=e[n]);else for(let n in r.settings.propnames)!t[n]&&e[n]!==void 0&&(r.settings.source?typeof e[n]=="object"&&n in r.data?v(r.data[n])!==v(e[n])&&(t[n]=e[n]):r.data[n]!==e[n]&&(t[n]=e[n]):r.data.shared?.[e._id]&&n in r.data.shared?.[e._id]?typeof e[n]=="object"?v(r.data.shared[e._id][n])!==v(e[n])&&(t[n]=e[n]):r.data.shared[e._id][n]!==e[n]&&(t[n]=e[n]):t[n]=e[n])}return t};this.userUpdateCheck=e=>{if(e.sessions){let t=this.getUpdatedUserData(e);if(Object.keys(t).length>0)return e.send&&e.send({route:"setUser",args:[e._id,t]}),t}};this.routes={runAs:this.runAs,pipeAs:this.pipeAs,addUser:this.addUser,setUser:(e,t)=>this.setUser(e,t),removeUser:this.removeUser,updateUser:this.updateUser,getConnectionInfo:this.getConnectionInfo,getSessionInfo:this.getSessionInfo,openPrivateSession:this.openPrivateSession,openSharedSession:this.openSharedSession,joinSession:this.joinSession,leaveSession:this.leaveSession,subscribeToSession:this.subscribeToSession,transmitSessionUpdates:this.transmitSessionUpdates,receiveSessionUpdates:this.receiveSessionUpdates,swapHost:this.swapHost,getupdateUserData:this.getUpdatedUserData,userUpdateCheck:this.userUpdateCheck,userUpdateLoop:{operator:this.userUpdateCheck,loop:10},sessionLoop:{operator:this.sessionLoop,loop:10}};this.load(this.routes,t?.linkServices,t?.includeClassName,t?.routeFormat,t?.customRoutes,t?.customChildren)}getFirstMatch(e,t){for(let i in e)for(let r in t)if(i===r)return i;return!1}};var Y={setRoute:function(d,s){return typeof d=="string"&&(d=O(d)),typeof d=="function"?(s||(s=d.name),this.graph.get(s)?this.graph.get(s).setOperator(d):this.graph.load({[s]:{operator:d}}),!0):!1},setNode:function(d,s){return typeof d=="string"&&(d=O(d)),typeof d=="function"?(s||(s=d.name),this.graph.get(s)?this.graph.get(s).setOperator(d):this.graph.add({tag:s,operator:d}),!0):!1},setMethod:function(d,s,e){return typeof s=="string"&&(s=O(s)),typeof s=="function"?(e||(e=s.name),this.graph.get(d)?this.graph.get(d)[e]=s:this.graph.add({tag:e,[e]:s}),!0):!1},assignRoute:function(d,s){this.graph.get(d)&&typeof s=="object"&&Object.assign(this.graph.get(d),s)},transferClass:(d,s)=>{if(typeof d=="object"){let e=d.toString();return{route:"receiveClass",args:[e,s]}}return!1},receiveClass:function(d,s){if(typeof d=="string"&&d.indexOf("class")===0){let e=(0,eval)("("+d+")"),t=s;return t||(t=e.name),this.graph[t]=e,!0}return!1},setGlobal:(d,s)=>(globalThis[d]=s,!0),assignGlobalObject:(d,s)=>globalThis[d]?(typeof s=="object"&&Object.assign(globalThis[d],s),!0):!1,setValue:function(d,s){return this.graph[d]=s,!0},assignObject:function(d,s){return this.graph[d]?(typeof s=="object"&&Object.assign(this.graph[d],s),!0):!1},setGlobalFunction:(d,s)=>(typeof d=="string"&&(d=O(d)),typeof d=="function"?(s||(s=d.name),globalThis[s]=d,!0):!1),assignFunctionToGlobalObject:function(d,s,e){return globalThis[d]?(typeof s=="string"&&(s=O(s)),typeof s=="function"?(e||(e=s.name),this.graph[d][e]=s,!0):!1):!1},setFunction:function(d,s){return typeof d=="string"&&(d=O(d)),typeof d=="function"?(s||(s=d.name),this.graph[s]=d,!0):!1},assignFunctionToObject:function(d,s,e){return this.graph[d]?(typeof s=="string"&&(s=O(s)),typeof s=="function"?(e||(e=s.name),this.graph[d][e]=s,!0):!1):!1}};var P=class extends k{constructor(e){super(e);this.entities={};this.systems={};this.map=new Map;this.order=[];this.animating=!0;this.updateEntities=(e=this.order,t,i=!1)=>{e.forEach(r=>{this.systems[r]&&(t?(i&&(i=performance.now()),this.systems[r].run(this.map.get(r)),i&&console.log("system",r,"took",performance.now()-i,"ms for",Object.keys(this.map.get(r)).length,"entities")):(i&&(i=performance.now()),this.systems[r].run(this.entities),i&&console.log("system",r,"took",performance.now()-i,"ms for",Object.keys(this.entities).length,"entities")))})};this.animate=(e=!0,t)=>{requestAnimationFrame(()=>{this.animating&&(this.updateEntities(t,e),this.animate(e,t))})};this.stop=()=>{this.animating=!1};this.start=e=>{this.animating=!0,this.animate(e)};this.addEntities=(e,t={},i=1)=>{let r=0,n={};for(;r<i;){let a=this.addEntity(e,t);n[a.tag]=a,r++}return Object.keys(n)};this.addEntity=(e={},t={})=>{if(!e)return;let i=this.recursivelyAssign({},e);if(i.components=t,Object.keys(t).length===0&&Object.keys(this.systems).forEach(r=>{t[r]=!0}),i.tag&&this.entities[i.tag]){let r=i.tag,n=2;for(;this.entities[i.tag];)i.tag=`${r}${n}`,n++}else i.tag||(i.tag=`entity${Math.floor(Math.random()*1e15)}`);return this.load({[i.tag]:i}),this.entities[i.tag]=this.nodes.get(i.tag),this.setupEntity(this.entities[i.tag]),this.entities[i.tag]};this.addSystems=(e={},t)=>{for(let i in e)e[i].tag=i,this.addSystem(e[i],void 0,void 0,t);return this.systems};this.addSystem=(e,t,i,r)=>{if(!e)return;let n=this.recursivelyAssign({},e);if(t&&(n.setupEntities=t),i&&(n.operator=i),n.tag&&this.systems[n.tag]){let a=n.tag,o=2;for(;this.systems[n.tag];)n.tag=`${a}${o}`,o++}else n.tag||(n.tag=`system${Math.floor(Math.random()*1e15)}`);if(this.load({[n.tag]:n}),this.systems[n.tag]=this.nodes.get(n.tag),this.map.get(n.tag)||this.map.set(n.tag,{}),this.systems[n.tag]?.setupEntities){let a=this.filterObject(this.entities,(o,f)=>{if(f.components[n.tag])return!0});this.systems[n.tag].setupEntities(n,a),Object.assign(this.map.get(n.tag),a)}return r?this.order=r:this.order.push(n.tag),this.systems[n.tag]};this.setupEntity=e=>{if(e?.components)for(let t in e.components)this.systems[t]&&(this.systems[t].setupEntity(this.systems[t],e),this.map.get(t)[e.tag]=e)};this.removeEntity=e=>{let t=this.entities[e];for(let i in t.components)this.map.get(i)&&delete this.map.get(i)[t.tag];return delete this.entities[e],this.remove(e)};this.removeSystem=e=>(delete this.systems[e],this.map.delete(e),this.order.splice(this.order.indexOf(e),1),this.remove(e));this.bufferValues=(e,t,i,r)=>{if(!Array.isArray(i)&&typeof i=="object"&&(i=Object.keys(i)),!r){let a=Object.keys(e);i?r=new Float32Array(a.length*i.length):typeof e[a[0]][t]=="object"?(i=Object.keys(e[a[0]][t]),r=new Float32Array(a.length*i.length)):r=new Float32Array(a.length)}let n=0;for(let a in e)if(e[a][t])if(i)for(let o=0;o<i.length;o++)r[n]=e[a][t][i[o]],n++;else r[n]=e[a][t],n++;return r};this.routes={animateEntities:this.animate,startEntityAnimation:this.start,stopEntityAnimation:this.stop,addEntity:this.addEntity,addSystem:this.addSystem,addSystems:this.addSystems,removeEntity:this.removeEntity,removeSystem:this.removeSystem,setupEntity:this.setupEntity,addEntities:this.addEntities,filterObject:this.filterObject,bufferValues:this.bufferValues};if(this.routes&&this.load(this.routes),e.systems)for(let t in e.systems)this.addSystem(e.systems[t],void 0,void 0,e.order);if(e.entities)for(let t in e.entities)this.addEntity(e.entities[t],e.entities[t].components)}filterObject(e,t){return Object.fromEntries(Object.entries(e).filter(([i,r])=>{t(i,r)}))}};})();
