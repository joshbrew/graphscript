(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __commonJS=(cb,mod)=>function __require(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from==="object"||typeof from==="function"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:true}):target,mod));var require_browser=__commonJS({"node_modules/web-worker/cjs/browser.js"(exports,module){module.exports=Worker}});var ARGUMENT_NAMES=/([^,]*)/g;function getFnParamInfo(fn){var fstr=fn.toString();const openPar=fstr.indexOf("(");const closePar=fstr.indexOf(")");const getFirstBracket=(str,offset=0)=>{const fb=offset+str.indexOf("{");if(fb<closePar&&fb>openPar){return getFirstBracket(str.slice(fb),offset+fb)}else return fb};const firstBracket=getFirstBracket(fstr);let innerMatch;if(firstBracket===-1||closePar<firstBracket)innerMatch=fstr.slice(fstr.indexOf("(")+1,fstr.indexOf(")"));else innerMatch=fstr.match(/([a-zA-Z]\w*|\([a-zA-Z]\w*(,\s*[a-zA-Z]\w*)*\)) =>/)?.[1];if(!innerMatch)return void 0;const matches=innerMatch.match(ARGUMENT_NAMES).filter(e=>!!e);const info=new Map;matches.forEach(v=>{let[name,value]=v.split("=");name=name.trim();name=name.replace(/\d+$/,"");const spread=name.includes("...");name=name.replace("...","");try{if(name)info.set(name,{state:(0,eval)(`(${value})`),spread})}catch(e){info.set(name,{})}});return info}function parseFunctionFromText(method=""){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf("=>")+1;if(startindex<=0){startindex=methodString.indexOf("){")}if(startindex<=0){startindex=methodString.indexOf(") {")}return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch{}}}return newFunc}var state={pushToState:{},data:{},triggers:{},setState(updateObj){Object.assign(state.data,updateObj);for(const prop of Object.getOwnPropertyNames(updateObj)){if(state.triggers[prop])state.triggers[prop].forEach(obj=>obj.onchange(state.data[prop]))}return state.data},subscribeTrigger(key,onchange){if(key){if(!state.triggers[key]){state.triggers[key]=[]}let l=state.triggers[key].length;state.triggers[key].push({idx:l,onchange});return state.triggers[key].length-1}else return void 0},unsubscribeTrigger(key,sub){let idx=void 0;let triggers=state.triggers[key];if(triggers){if(!sub)delete state.triggers[key];else{let obj=triggers.find(o=>{if(o.idx===sub){return true}});if(obj)triggers.splice(idx,1);return true}}},subscribeTriggerOnce(key,onchange){let sub;let changed=value=>{onchange(value);state.unsubscribeTrigger(key,sub)};sub=state.subscribeTrigger(key,changed)}};var GraphNode=class{constructor(properties={},parentNode,graph){this.nodes=new Map;this._initial={};this.state=state;this.isLooping=false;this.isAnimating=false;this.looper=void 0;this.animation=void 0;this.forward=true;this.backward=false;this.runSync=false;this.firstRun=true;this.DEBUGNODE=false;this.operator=(self2=this,origin,...args)=>{return args};this.runOp=(node=this,origin=this,...args)=>{if(node.DEBUGNODE)console.time(node.tag);let result=node.operator(node,origin,...args);if(result instanceof Promise){result.then(res=>{if(res!==void 0)this.setState({[node.tag]:res});if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};return res})}else{if(result!==void 0)this.setState({[node.tag]:result});if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};}return result};this.setOperator=operator=>{if(typeof operator!=="function")return operator;let params=getFnParamInfo(operator);let pass=false;if(params){const keys=params.keys();const paramOne=keys.next().value;const paramTwo=keys.next().value;const restrictedOne=["self","node"];const restrictedTwo=["origin","parent","graph","router"];if(paramOne)restrictedOne.forEach(a=>{if(paramOne.includes(a))pass=true});if(paramTwo)restrictedTwo.forEach(a=>{if(paramTwo.includes(a))pass=true})}if(!pass){let fn=operator;operator=(self2,origin,...args)=>{return fn(...args)}}this.operator=operator;return operator};this.run=(...args)=>{return this._run(this,void 0,...args)};this.runAsync=(...args)=>{return new Promise((res,rej)=>{res(this._run(this,void 0,...args))})};this.transformArgs=(args=[])=>args;this._run=(node=this,origin,...args)=>{if(typeof this.transformArgs==="function")args=this.transformArgs(args,node);if(!(typeof node==="object")){if(typeof node==="string"){let fnd=void 0;if(this.graph)fnd=this.graph.nodes.get(node);if(!fnd)fnd=this.nodes.get(node);node=fnd}if(!node)return void 0}if(node.firstRun){node.firstRun=false;if(!(node.children&&node.forward||node.parent&&node.backward||node.repeat||node.delay||node.frame||node.recursive||node.branch))node.runSync=true;if(node.animate&&!node.isAnimating){node.runAnimation(node.animation,args,node,origin)}if(node.loop&&typeof node.loop==="number"&&!node.isLooping){node.runLoop(node.looper,args,node,origin)}if(node.loop||node.animate)return}if(node.runSync){let res=node.runOp(node,origin,...args);return res}return new Promise(async resolve=>{if(node){let run=(node2,tick=0,...input)=>{return new Promise(async r=>{tick++;let res=await node2.runOp(node2,origin,...input);if(node2.repeat){while(tick<node2.repeat){if(node2.delay){setTimeout(async()=>{r(await run(node2,tick,...input))},node2.delay);break}else if(node2.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node2,tick,...input))});break}else res=await node2.runOp(node2,origin,...input);tick++}if(tick===node2.repeat){r(res);return}}else if(node2.recursive){while(tick<node2.recursive){if(node2.delay){setTimeout(async()=>{r(await run(node2,tick,...res))},node2.delay);break}else if(node2.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node2,tick,...res))});break}else res=await node2.runOp(node2,origin,...res);tick++}if(tick===node2.recursive){r(res);return}}else{r(res);return}})};let runnode=async()=>{let res=await run(node,void 0,...args);if(res!==void 0){if(node.backward&&node.parent instanceof GraphNode){if(Array.isArray(res))await this.runParent(node,...res);else await this.runParent(node,res)}if(node.children&&node.forward){if(Array.isArray(res))await this.runChildren(node,...res);else await this.runChildren(node,res)}if(node.branch){this.runBranch(node,res)}}return res};if(node.delay){setTimeout(async()=>{resolve(await runnode())},node.delay)}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{resolve(await runnode())})}else{resolve(await runnode())}}else resolve(void 0)})};this.runParent=async(node,...args)=>{if(node.backward&&node.parent){if(typeof node.parent==="string"){if(node.graph&&node.graph?.get(node.parent)){node.parent=node.graph;if(node.parent)this.nodes.set(node.parent.tag,node.parent)}else node.parent=this.nodes.get(node.parent)}if(node.parent instanceof GraphNode)await node.parent._run(node.parent,this,...args)}};this.runChildren=async(node,...args)=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(node.graph&&node.graph?.get(node.children[key])){node.children[key]=node.graph.get(node.children[key]);if(!node.nodes.get(node.children[key].tag))node.nodes.set(node.children[key].tag,node.children[key])}if(!node.children[key]&&node.nodes.get(node.children[key]))node.children[key]=node.nodes.get(node.children[key])}else if(typeof node.children[key]==="undefined"||node.children[key]===true){if(node.graph&&node.graph?.get(key)){node.children[key]=node.graph.get(key);if(!node.nodes.get(node.children[key].tag))node.nodes.set(node.children[key].tag,node.children[key])}if(!node.children[key]&&node.nodes.get(key))node.children[key]=node.nodes.get(key)}if(node.children[key]?.runOp)await node.children[key]._run(node.children[key],node,...args)}}};this.runBranch=async(node,output)=>{if(node.branch){let keys=Object.keys(node.branch);await Promise.all(keys.map(async k=>{if(typeof node.branch[k].if==="object")node.branch[k].if=stringifyFast(node.branch[k].if);let pass=false;if(typeof node.branch[k].if==="function"){pass=node.branch[k].if(output)}else{if(typeof output==="object"){if(stringifyFast(output)===node.branch[k].if)pass=true}else if(output===node.branch[k].if)pass=true}if(pass){if(node.branch[k].then instanceof GraphNode){if(Array.isArray(output))await node.branch[k].then._run(node.branch[k].then,node,...output);else await node.branch[k].then._run(node.branch[k].then,node,...output)}else if(typeof node.branch[k].then==="function"){if(Array.isArray(output))await node.branch[k].then(...output);else await node.branch[k].then(output)}else if(typeof node.branch[k].then==="string"){if(node.graph)node.branch[k].then=node.graph.nodes.get(node.branch[k].then);else node.branch[k].then=node.nodes.get(node.branch[k].then);if(node.branch[k].then instanceof GraphNode){if(Array.isArray(output))await node.branch[k].then._run(node.branch[k].then,node,...output);else await node.branch[k].then._run(node.branch[k].then,node,...output)}}}return pass}))}};this.runAnimation=(animation=this.animation,args=[],node=this,origin)=>{this.animation=animation;if(!animation)this.animation=this.operator;if(node.animate&&!node.isAnimating&&"requestAnimationFrame"in window){node.isAnimating=true;let anim=async()=>{if(node.isAnimating){if(node.DEBUGNODE)console.time(node.tag);let result=this.animation(node,origin,...args);if(result instanceof Promise){result=await result}if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(node.backward&&node.parent?._run){if(Array.isArray(result))await this.runParent(node,...result);else await this.runParent(node,result)}if(node.children&&node.forward){if(Array.isArray(result))await this.runChildren(node,...result);else await this.runChildren(node,result)}if(node.branch){this.runBranch(node,result)}this.setState({[node.tag]:result})}requestAnimationFrame(anim)}};requestAnimationFrame(anim)}};this.runLoop=(loop=this.looper,args=[],node=this,origin,timeout=node.loop)=>{node.looper=loop;if(!loop)node.looper=node.operator;if(typeof timeout==="number"&&!node.isLooping){node.isLooping=true;let looping=async()=>{if(node.isLooping){if(node.DEBUGNODE)console.time(node.tag);let result=node.looper(node,origin,...args);if(result instanceof Promise){result=await result}if(node.DEBUGNODE){console.timeEnd(node.tag);if(result!==void 0)console.log(`${node.tag} result:`,result)};if(result!==void 0){if(node.tag)node.setState({[node.tag]:result});if(node.backward&&node.parent?._run){if(Array.isArray(result))await this.runParent(node,...result);else await this.runParent(node,result)}if(node.children&&node.forward){if(Array.isArray(result))await this.runChildren(node,...result);else await this.runChildren(node,result)}if(node.branch){this.runBranch(node,result)}node.setState({[node.tag]:result})}setTimeout(async()=>{await looping()},timeout)}};looping()}};this.setParent=parent=>{this.parent=parent;if(this.backward)this.runSync=false};this.setChildren=children=>{this.children=children;if(this.forward)this.runSync=false};this.add=(node={})=>{if(typeof node==="function")node={operator:node};if(!(node instanceof GraphNode))node=new GraphNode(node,this,this.graph);this.nodes.set(node.tag,node);if(this.graph){this.graph.nodes.set(node.tag,node);this.graph.nNodes=this.graph.nodes.size}return node};this.remove=node=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){this.nodes.delete(node.tag);if(this.children[node.tag])delete this.children[node.tag];if(this.graph){this.graph.nodes.delete(node.tag);this.graph.nNodes=this.graph.nodes.size}this.nodes.forEach(n=>{if(n.nodes.get(node.tag)){n.nodes.delete(node.tag);if(n.children[node.tag])delete n.children[node.tag];if(n.parent?.tag===node.tag)delete n.parent}});if(node.ondelete)node.ondelete(node)}};this.append=(node,parentNode=this)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){parentNode.addChildren(node);if(node.forward)node.runSync=false}};this.subscribe=(callback,tag=this.tag)=>{if(callback instanceof GraphNode){return this.subscribeNode(callback)}else return this.state.subscribeTrigger(tag,callback)};this.unsubscribe=(sub,tag=this.tag)=>{this.state.unsubscribeTrigger(tag,sub)};this.addChildren=children=>{if(!this.children)this.children={};if(typeof children==="object"){Object.assign(this.children,children)}this.convertChildrenToNodes();if(this.forward)this.runSync=false};this.callParent=(...args)=>{const origin=this;if(typeof this.parent==="string"){if(this.graph&&this.graph?.get(this.parent)){this.parent=this.graph;if(this.parent)this.nodes.set(this.parent.tag,this.parent)}else this.parent=this.nodes.get(this.parent)}if(typeof this.parent?.operator==="function")return this.parent.runOp(this.parent,origin,...args)};this.callChildren=(idx,...args)=>{const origin=this;let result;if(typeof this.children==="object"){for(const key in this.children){if(this.children[key]?.runOp)this.children[key].runOp(this.children[key],origin,...args)}}return result};this.getProps=(node=this)=>{return{tag:node.tag,operator:node.operator,graph:node.graph,children:node.children,parent:node.parent,forward:node.forward,backward:node.bacward,loop:node.loop,animate:node.animate,frame:node.frame,delay:node.delay,recursive:node.recursive,repeat:node.repeat,branch:node.branch,oncreate:node.oncreate,DEBUGNODE:node.DEBUGNODE,...this._initial}};this.setProps=(props={})=>{let tmp=Object.assign({},props);if(tmp.children){this.addChildren(props.children);delete tmp.children}if(tmp.operator){this.setOperator(props.operator);delete tmp.operator}Object.assign(tmp,props);if(!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive))this.runSync=true};this.removeTree=node=>{if(node){if(typeof node==="string")node=this.nodes.get(node)}if(node instanceof GraphNode){let checked={};const recursivelyRemove=node2=>{if(typeof node2.children==="object"&&!checked[node2.tag]){checked[node2.tag]=true;for(const key in node2.children){if(node2.children[key].stopNode)node2.children[key].stopNode();if(node2.children[key].tag){if(this.nodes.get(node2.children[key].tag))this.nodes.delete(node2.children[key].tag);this.nodes.forEach(n=>{if(n.nodes.get(node2.children[key].tag))n.nodes.delete(node2.children[key].tag);if(n.children[key]instanceof GraphNode)delete n.children[key]});recursivelyRemove(node2.children[key])}}}};if(node.stopNode)node.stopNode();if(node.tag){this.nodes.delete(node.tag);if(this.children[node.tag])delete this.children[node.tag];if(this.parent?.tag===node.tag)delete this.parent;if(this[node.tag]instanceof GraphNode)delete this[node.tag];this.nodes.forEach(n=>{if(node?.tag){if(n.nodes.get(node.tag))n.nodes.delete(node.tag);if(n.children[node.tag]instanceof GraphNode)delete n.children[node.tag]}});recursivelyRemove(node);if(this.graph)this.graph.removeTree(node,checked);else if(node.ondelete)node.ondelete(node)}}};this.checkNodesHaveChildMapped=(node,child,checked={})=>{let tag=node.tag;if(!tag)tag=node.name;if(!checked[tag]){checked[tag]=true;if(node.children){if(child.tag in node.children){if(node.children[child.tag]instanceof GraphNode){if(!node.nodes.get(child.tag))node.nodes.set(child.tag,child);node.children[child.tag]=child;if(!node.firstRun)node.firstRun=true}}}if(node.parent instanceof GraphNode){if(node.nodes.get(child.tag)&&!node.parent.nodes.get(child.tag))node.parent.nodes.set(child.tag,child);if(node.parent.children){this.checkNodesHaveChildMapped(node.parent,child,checked)}else if(node.nodes){node.nodes.forEach(n=>{if(!checked[n.tag]){this.checkNodesHaveChildMapped(n,child,checked)}})}}if(node.graph){if(node.parent&&node.parent.name!==node.graph.name){node.graph.nodes.forEach(n=>{if(!checked[n.tag]){this.checkNodesHaveChildMapped(n,child,checked)}})}}}};this.convertChildrenToNodes=(n=this)=>{if(n?.children){for(const key in n.children){if(!(n.children[key]instanceof GraphNode)){if(typeof n.children[key]==="object"){if(!n.children[key].tag)n.children[key].tag=key;if(!n.nodes.get(n.children[key].tag)){n.children[key]=new GraphNode(n.children[key],n,n.graph);this.checkNodesHaveChildMapped(n,n.children[key])}}else{if(typeof n.children[key]==="undefined"||n.children[key]==true){n.children[key]=n.graph.get(key);if(!n.children[key])n.children[key]=n.nodes.get(key)}else if(typeof n.children[key]==="string"){let k=n.children[key];n.children[key]=n.graph.get(k);if(!n.children[key])n.children[key]=n.nodes.get(key)}if(n.children[key]instanceof GraphNode){if(n.graph){let props=n.children[key].getProps();delete props.parent;delete props.graph;if(n.source instanceof Graph){n.children[key]=new GraphNode(props,n,n.source)}else{n.children[key]=new GraphNode(props,n,n.graph)}}n.nodes.set(n.children[key].tag,n.children[key]);this.checkNodesHaveChildMapped(n,n.children[key]);if(!(n.children[key].tag in n))n[n.children[key].tag]=n.children[key]}}}}}return n.children};this.stopLooping=(node=this)=>{node.isLooping=false};this.stopAnimating=(node=this)=>{node.isAnimating=false};this.stopNode=(node=this)=>{node.stopAnimating(node);node.stopLooping(node)};this.subscribeNode=node=>{if(node.tag)this.nodes.set(node.tag,node);return this.state.subscribeTrigger(this.tag,res=>{node._run(node,this,res)})};this.print=(node=this,printChildren=true,nodesPrinted=[])=>{let dummyNode=new GraphNode;if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){nodesPrinted.push(node.tag);let jsonToPrint={tag:node.tag,operator:node.operator.toString()};if(node.parent)jsonToPrint.parent=node.parent.tag;if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string")return node.children[key];if(nodesPrinted.includes(node.children[key].tag))return node.children[key].tag;else if(!printChildren){return node.children[key].tag}else return node.children[key].print(node.children[key],printChildren,nodesPrinted)}}for(const prop in node){if(prop==="parent"||prop==="children")continue;if(typeof dummyNode[prop]==="undefined"){if(typeof node[prop]==="function"){jsonToPrint[prop]=node[prop].toString()}else if(typeof node[prop]==="object"){jsonToPrint[prop]=JSON.stringifyWithCircularRefs(node[prop])}else{jsonToPrint[prop]=node[prop]}}}return JSON.stringify(jsonToPrint)}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.DEBUGNODE=debugging;this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};if(typeof properties==="function"){properties={operator:properties}}if(typeof properties==="object"){if(properties instanceof GraphNode&&properties._initial)Object.assign(properties,properties._initial);if(properties instanceof Graph){let source=properties;properties={source,operator:input=>{if(typeof input==="object"){let result={};for(const key in input){if(typeof source[key]==="function"){if(Array.isArray(input[key]))result[key]=source[key](...input[key]);else result[key]=source[key](input[key])}else{source[key]=input[key];result[key]=source[key]}}return result}return source}};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node){if(source.node._initial)Object.assign(properties,source.node._initial)}if(source._initial)Object.assign(properties,source._initial);this.nodes=source.nodes;source.node=this;if(graph){source.nodes.forEach(n=>{if(!graph.nodes.get(n.tag)){graph.nodes.set(n.tag,n);graph.nNodes++}})}}if(properties.tag&&(graph||parentNode)){let hasnode;if(graph?.nodes){hasnode=graph.nodes.get(properties.tag)}if(!hasnode&&parentNode?.nodes){hasnode=parentNode.nodes.get(properties.tag)}if(hasnode){Object.assign(this,hasnode);if(!this.source)this.source=hasnode;let props=hasnode.getProps();delete props.graph;delete props.parent;Object.assign(properties,props)}}if(properties?.operator){properties.operator=this.setOperator(properties.operator)}if(!properties.tag&&graph){properties.tag=`node${graph.nNodes}`}else if(!properties.tag){properties.tag=`node${Math.floor(Math.random()*1e10)}`}let keys=Object.getOwnPropertyNames(this);for(const key in properties){if(!keys.includes(key))this._initial[key]=properties[key]}if(properties.children)this._initial.children=Object.assign({},properties.children);Object.assign(this,properties);if(!this.tag){if(graph){this.tag=`node${graph.nNodes}`}else{this.tag=`node${Math.floor(Math.random()*1e10)}`}}if(graph){this.graph=graph;if(graph.nodes.get(this.tag)){this.tag=`${this.tag}${graph.nNodes+1}`}graph.nodes.set(this.tag,this);graph.nNodes++}if(parentNode){this.parent=parentNode;if(parentNode instanceof GraphNode||parentNode instanceof Graph)parentNode.nodes.set(this.tag,this)}if(typeof properties.tree==="object"){for(const key in properties.tree){if(typeof properties.tree[key]==="object"){if((!properties.tree[key]).tag){properties.tree[key].tag=key}}let node=new GraphNode(properties.tree[key],this,graph);this.nodes.set(node.tag,node)}}if(this.children)this.convertChildrenToNodes(this);if(this.parent instanceof GraphNode||this.parent instanceof Graph)this.checkNodesHaveChildMapped(this.parent,this);if(typeof this.oncreate==="function")this.oncreate(this);if(!this.firstRun)this.firstRun=true}else return properties}};var Graph=class{constructor(tree,tag,props){this.nNodes=0;this.nodes=new Map;this.state=state;this.tree={};this.add=(node={})=>{let props=node;if(!(node instanceof GraphNode))node=new GraphNode(props,this,this);else{this.nNodes=this.nodes.size;if(node.tag){this.tree[node.tag]=props;this.nodes.set(node.tag,node)}}return node};this.setTree=(tree=this.tree)=>{if(!tree)return;for(const node in tree){if(!this.nodes.get(node)){if(typeof tree[node]==="function"){this.add({tag:node,operator:tree[node]})}else if(typeof tree[node]==="object"&&!Array.isArray(tree[node])){if(!tree[node].tag)tree[node].tag=node;let newNode=this.add(tree[node]);if(tree[node].aliases){tree[node].aliases.forEach(a=>{this.nodes.set(a,newNode)})}}else{this.add({tag:node,operator:(self2,origin,...args)=>{return tree[node]}})}}else{let n=this.nodes.get(node);if(typeof tree[node]==="function"){n.setOperator(tree[node])}else if(typeof tree[node]==="object"){if(tree[node]instanceof GraphNode){this.add(tree[node])}else if(tree[node]instanceof Graph){let source=tree[node];let properties={};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node?._initial)Object.assign(properties,source.node._initial);properties.nodes=source.nodes;properties.source=source;n.setProps(properties)}else{n.setProps(tree[node])}}}}this.nodes.forEach(node=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(this.nodes.get(node.children[key])){node.children[key]=this.nodes.get(node.children[key])}}else if(node.children[key]===true||typeof node.children[key]==="undefined"){if(this.nodes.get(key)){node.children[key]=this.nodes.get(key)}}if(node.children[key]instanceof GraphNode){node.checkNodesHaveChildMapped(node,node.children[key])}}}if(typeof node.parent==="string"){if(this.nodes.get(node.parent)){node.parent=this.nodes.get(node.parent);node.nodes.set(node.parent.tag,node.parent)}}})};this.get=tag=>{return this.nodes.get(tag)};this.set=node=>{return this.nodes.set(node.tag,node)};this.run=(node,...args)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode)return node._run(node,this,...args);else return void 0};this.runAsync=(node,...args)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode)return new Promise((res,rej)=>{res(node._run(node,this,...args))});else return new Promise((res,rej)=>{res(void 0)})};this._run=(node,origin=this,...args)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode)return node._run(node,origin,...args);else return void 0};this.removeTree=(node,checked)=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){if(!checked)checked={};const recursivelyRemove=node2=>{if(node2.children&&!checked[node2.tag]){checked[node2.tag]=true;if(Array.isArray(node2.children)){node2.children.forEach(c=>{if(c.stopNode)c.stopNode();if(c.tag){if(this.nodes.get(c.tag))this.nodes.delete(c.tag)}this.nodes.forEach(n=>{if(n.nodes.get(c.tag))n.nodes.delete(c.tag)});recursivelyRemove(c)})}else if(typeof node2.children==="object"){if(node2.stopNode)node2.stopNode();if(node2.tag){if(this.nodes.get(node2.tag))this.nodes.delete(node2.tag)}this.nodes.forEach(n=>{if(n.nodes.get(node2.tag))n.nodes.delete(node2.tag)});recursivelyRemove(node2)}}};if(node.stopNode)node.stopNode();if(node.tag){this.nodes.delete(node.tag);this.nodes.forEach(n=>{if(n.nodes.get(node.tag))n.nodes.delete(node.tag)});this.nNodes=this.nodes.size;recursivelyRemove(node)}if(node.ondelete)node.ondelete(node)}return node};this.remove=node=>{if(typeof node==="string")node=this.nodes.get(node);if(node instanceof GraphNode){node.stopNode();if(node?.tag){if(this.nodes.get(node.tag)){this.nodes.delete(node.tag);this.nodes.forEach(n=>{if(n.nodes.get(node.tag))n.nodes.delete(node.tag)})}}if(node.ondelete)node.ondelete(node)}return node};this.append=(node,parentNode)=>{parentNode.addChildren(node)};this.callParent=async(node,origin=node,...args)=>{if(node?.parent){return await node.callParent(node,origin,...args)}};this.callChildren=async(node,idx,...args)=>{if(node?.children){return await node.callChildren(idx,...args)}};this.subscribe=(node,callback)=>{if(!callback)return;if(node instanceof GraphNode){return node.subscribe(callback)}else if(typeof node=="string")return this.state.subscribeTrigger(node,callback)};this.unsubscribe=(tag,sub)=>{this.state.unsubscribeTrigger(tag,sub)};this.subscribeNode=(inputNode,outputNode)=>{let tag;if(inputNode?.tag)tag=inputNode.tag;else if(typeof inputNode==="string")tag=inputNode;return this.state.subscribeTrigger(tag,res=>{this.run(outputNode,inputNode,...res)})};this.stopNode=node=>{if(typeof node==="string"){node=this.nodes.get(node)}if(node instanceof GraphNode){node.stopNode()}};this.print=(node=void 0,printChildren=true)=>{if(node instanceof GraphNode)return node.print(node,printChildren);else{let printed=`{`;this.nodes.forEach(n=>{printed+=`
"${n.tag}:${n.print(n,printChildren)}"`});return printed}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.create=(operator,parentNode,props)=>{return createNode(operator,parentNode,props,this)};this.setState=this.state.setState;this.DEBUGNODES=(debugging=true)=>{this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};this.tag=tag?tag:`graph${Math.floor(Math.random()*1e11)}`;if(props){Object.assign(this,props);this._initial=props}if(tree||Object.keys(this.tree).length>0)this.setTree(tree)}};function reconstructObject(json="{}"){try{let parsed=typeof json==="string"?JSON.parse(json):json;const parseObj=obj=>{for(const prop in obj){if(typeof obj[prop]==="string"){let funcParsed=parseFunctionFromText(obj[prop]);if(typeof funcParsed==="function"){obj[prop]=funcParsed}}else if(typeof obj[prop]==="object"){parseObj(obj[prop])}}return obj};return parseObj(parsed)}catch(err){console.error(err);return void 0}}var stringifyWithCircularRefs=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx--}}}}function checkCircular(key,value){if(value!=null){if(typeof value==="object"){if(key){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}}}return value}return function stringifyWithCircularRefs2(obj,space){try{parents.push(obj);return JSON.stringify(obj,checkCircular,space)}finally{clear()}}}();if(JSON.stringifyWithCircularRefs===void 0){JSON.stringifyWithCircularRefs=stringifyWithCircularRefs}var stringifyFast=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;if(parents[idx]){var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx++}}}}}function checkValues(key,value){let val;if(value!=null){if(typeof value==="object"){let c=value.constructor.name;if(key&&c==="Object"){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}if(c==="Array"){if(value.length>20){val=value.slice(value.length-20)}else val=value}else if(c.includes("Set")){val=Array.from(value)}else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean"){val="instanceof_"+c}else if(c==="Object"){let obj={};for(const prop in value){if(value[prop]==null){obj[prop]=value[prop]}else if(Array.isArray(value[prop])){if(value[prop].length>20)obj[prop]=value[prop].slice(value[prop].length-20);else obj[prop]=value[prop]}else if(value[prop].constructor.name==="Object"){obj[prop]={};for(const p in value[prop]){if(Array.isArray(value[prop][p])){if(value[prop][p].length>20)obj[prop][p]=value[prop][p].slice(value[prop][p].length-20);else obj[prop][p]=value[prop][p]}else{if(value[prop][p]!=null){let con=value[prop][p].constructor.name;if(con.includes("Set")){obj[prop][p]=Array.from(value[prop][p])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop][p]="instanceof_"+con}else{obj[prop][p]=value[prop][p]}}else{obj[prop][p]=value[prop][p]}}}}else{let con=value[prop].constructor.name;if(con.includes("Set")){obj[prop]=Array.from(value[prop])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop]="instanceof_"+con}else{obj[prop]=value[prop]}}}val=obj}else{val=value}}else{val=value}}return val}return function stringifyFast2(obj,space){parents.push(obj);let res=JSON.stringify(obj,checkValues,space);clear();return res}}();if(JSON.stringifyFast===void 0){JSON.stringifyFast=stringifyFast}function createNode(operator,parentNode,props,graph){if(typeof props==="object"){props.operator=operator;return new GraphNode(props,parentNode,graph)}return new GraphNode({operator},parentNode,graph)}var Service=class extends Graph{constructor(options={}){super(void 0,options.name?options.name:`service${Math.floor(Math.random()*1e14)}`,options.props);this.routes={};this.loadDefaultRoutes=false;this.keepState=true;this.firstLoad=true;this.init=options=>{if(options)options=Object.assign({},options);else options={};if(options.customRoutes)Object.assign(options.customRoutes,this.customRoutes);else options.customRoutes=this.customRoutes;if(options.customChildren)Object.assign(options.customChildren,this.customChildren);else options.customChildren=this.customChildren;if(Array.isArray(options.routes)){options.routes.forEach(r=>{this.load(r,options.includeClassName,options.routeFormat,options.customRoutes,options.customChildren)})}else if(options.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)this.load(options.routes,options.includeClassName,options.routeFormat,options.customRoutes,options.customChildren)};this.load=(routes,includeClassName=true,routeFormat=".",customRoutes,customChildren)=>{if(!routes&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;if(this.firstLoad)this.firstLoad=false;if(customRoutes)customRoutes=Object.assign(this.customRoutes,customRoutes);else customRoutes=this.customRoutes;if(customChildren)customChildren=Object.assign(this.customChildren,customChildren);let service;let allRoutes={};if(routes){if(!(routes instanceof Graph)&&routes?.name){if(routes.module){let mod=routes;routes={};Object.getOwnPropertyNames(routes.module).forEach(prop=>{if(includeClassName)routes[mod.name+routeFormat+prop]=routes.module[prop];else routes[prop]=routes.module[prop]})}else if(typeof routes==="function"){service=new routes({loadDefaultRoutes:this.loadDefaultRoutes});service.load();routes=service.routes}}else if(routes instanceof Graph||routes.source instanceof Graph){service=routes;routes={};let name;if(includeClassName){name=service.name;if(!name){name=service.tag;service.name=name}if(!name){name=`graph${Math.floor(Math.random()*1e15)}`;service.name=name;service.tag=name}}if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren);service.nodes.forEach(node=>{routes[node.tag]=node;let checked={};let checkChildGraphNodes=(nd,par)=>{if(!checked[nd.tag]||par&&includeClassName&&!checked[par?.tag+routeFormat+nd.tag]){if(!par)checked[nd.tag]=true;else checked[par.tag+routeFormat+nd.tag]=true;if(nd instanceof Graph||nd.source instanceof Graph){if(includeClassName){let nm=nd.name;if(!nm){nm=nd.tag;nd.name=nm}if(!nm){nm=`graph${Math.floor(Math.random()*1e15)}`;nd.name=nm;nd.tag=nm}}nd.nodes.forEach(n=>{if(includeClassName&&!routes[nd.tag+routeFormat+n.tag])routes[nd.tag+routeFormat+n.tag]=n;else if(!routes[n.tag])routes[n.tag]=n;checkChildGraphNodes(n,nd)})}}};checkChildGraphNodes(node)})}else if(typeof routes==="object"){let name=routes.constructor.name;if(name==="Object"){name=Object.prototype.toString.call(routes);if(name)name=name.split(" ")[1];if(name)name=name.split("]")[0]}if(name&&name!=="Object"){let module=routes;routes={};Object.getOwnPropertyNames(module).forEach(route=>{if(includeClassName)routes[name+routeFormat+route]=module[route];else routes[route]=module[route]})}}if(service instanceof Graph&&service.name&&includeClassName){routes=Object.assign({},routes);for(const prop in routes){let route=routes[prop];delete routes[prop];routes[service.name+routeFormat+prop]=route}}}if(this.loadDefaultRoutes){let rts=Object.assign({},this.defaultRoutes);if(routes){Object.assign(rts,this.routes);routes=Object.assign(rts,routes)}else routes=Object.assign(rts,this.routes);this.loadDefaultRoutes=false}if(!routes)routes=this.routes;let incr=0;for(const tag in routes){incr++;let childrenIter=(route,routeKey)=>{if(typeof route==="object"){if(!route.tag)route.tag=routeKey;if(typeof route?.children==="object"){nested:for(const key in route.children){incr++;if(typeof route.children[key]==="object"){let rt=route.children[key];if(rt.tag&&allRoutes[rt.tag])continue;if(customChildren){for(const k2 in customChildren){rt=customChildren[k2](rt,key,route,routes,allRoutes);if(!rt)continue nested}}if(rt.id&&!rt.tag){rt.tag=rt.id}let k;if(rt.tag){if(allRoutes[rt.tag]){let randkey=`${rt.tag}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[rt.tag]=rt;childrenIter(allRoutes[rt.tag],key);k=rt.tag}}else{if(allRoutes[key]){let randkey=`${key}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[key]=rt;childrenIter(allRoutes[key],key);k=key}}if(service?.name&&includeClassName){allRoutes[service.name+routeFormat+k]=rt;delete allRoutes[k]}else allRoutes[k]=rt}}}}};allRoutes[tag]=routes[tag];childrenIter(routes[tag],tag)}top:for(const route in allRoutes){if(typeof allRoutes[route]==="object"){let r=allRoutes[route];if(typeof r==="object"){if(customRoutes){for(const key in customRoutes){r=customRoutes[key](r,route,allRoutes);if(!r)continue top}}if(r.get){if(typeof r.get=="object"){}}if(r.post){}if(r.delete){}if(r.put){}if(r.head){}if(r.patch){}if(r.options){}if(r.connect){}if(r.trace){}if(r.post&&!r.operator){allRoutes[route].operator=r.post}else if(!r.operator&&typeof r.get=="function"){allRoutes[route].operator=r.get}}}}for(const route in routes){if(typeof routes[route]==="object"){if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}else if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}if(service){for(const key in this.routes){if(this.routes[key]instanceof GraphNode){this.nodes.set(key,this.routes[key]);this.nNodes=this.nodes.size}}}else this.setTree(this.routes);for(const prop in this.routes){if(this.routes[prop]?.aliases){let aliases=this.routes[prop].aliases;aliases.forEach(a=>{if(service?.name&&includeClassName)routes[service.name+routeFormat+a]=this.routes[prop];else routes[a]=this.routes[prop]})}}return this.routes};this.unload=(routes=this.routes)=>{if(!routes)return;let service;if(!(routes instanceof Service)&&typeof routes==="function"){service=new Service;routes=service.routes}else if(routes instanceof Service){routes=routes.routes}for(const r in routes){delete this.routes[r];if(this.nodes.get(r))this.remove(r)}return this.routes};this.handleMethod=(route,method,args,origin)=>{let m=method.toLowerCase();if(m==="get"&&this.routes[route]?.get?.transform instanceof Function){if(Array.isArray(args))return this.routes[route].get.transform(...args);else return this.routes[route].get.transform(args)}if(this.routes[route]?.[m]){if(!(this.routes[route][m]instanceof Function)){if(args)this.routes[route][m]=args;return this.routes[route][m]}else return this.routes[route][m](args)}else return this.handleServiceMessage({route,args,method,origin})};this.transmit=(...args)=>{if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args,args[0].origin)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.receive=(...args)=>{if(args[0]){if(typeof args[0]==="string"){let substr=args[0].substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))args[0]=args[0].replace(/\\/g,"");if(args[0][0]==='"'){args[0]=args[0].substring(1,args[0].length-1)};args[0]=JSON.parse(args[0])}}}if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args,args[0].origin)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.pipe=(source,destination,endpoint,origin,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.subscribe(res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,origin,method});else this.transmit({route:destination,args:res,origin,method},endpoint)});else return this.subscribe(source,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})}else if(typeof source==="string")return this.subscribe(source,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})};this.pipeOnce=(source,destination,endpoint,origin,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.state.subscribeTriggerOnce(source.tag,res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,origin,method});else this.transmit({route:destination,args:res,origin,method},endpoint)});else return this.state.subscribeTriggerOnce(source.tag,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})}else if(typeof source==="string")return this.state.subscribeTriggerOnce(source,res=>{this.transmit({route:destination,args:res,origin,method},endpoint)})};this.terminate=(...args)=>{this.nodes.forEach(n=>{n.stopNode()})};this.recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"){if(typeof target[key]==="object")this.recursivelyAssign(target[key],obj[key]);else target[key]=this.recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};this.defaultRoutes={"/":{get:()=>{return this.print()},aliases:[""]},ping:()=>{console.log("ping");return"pong"},echo:(...args)=>{this.transmit(...args);return args},assign:source=>{if(typeof source==="object"){Object.assign(this,source);return true}return false},recursivelyAssign:source=>{if(typeof source==="object"){this.recursivelyAssign(this,source);return true}return false},log:{post:(...args)=>{console.log("Log: ",...args)},aliases:["info"]},error:message=>{let er=new Error(message);console.error(message);return er},state:key=>{if(key){return this.state.data[key]}else return this.state.data},printState:key=>{if(key){return stringifyWithCircularRefs(this.state.data[key])}else return stringifyWithCircularRefs(this.state.data)},transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,_run:this._run,subscribe:this.subscribe,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};if(options.name)this.name=options.name;else options.name=this.tag;if("loadDefaultRoutes"in options){this.loadDefaultRoutes=options.loadDefaultRoutes;this.routes=Object.assign(this.defaultRoutes,this.routes)}if(options||Object.keys(this.routes).length>0)this.init(options)}handleServiceMessage(message){let call;if(typeof message==="object"){if(message.route)call=message.route;else if(message.node)call=message.node}if(call){if(message.origin){if(Array.isArray(message.args))return this._run(call,message.origin,...message.args);else return this._run(call,message.origin,message.args)}else{if(Array.isArray(message.args))return this.run(call,...message.args);else return this.run(call,message.args)}}else return message}handleGraphNodeCall(route,args,origin){if(!route)return args;if(args?.args){this.handleServiceMessage(args)}else if(origin){if(Array.isArray(args))return this._run(route,origin,...args);else return this._run(route,origin,args)}else if(Array.isArray(args))return this.run(route,...args);else return this.run(route,args)}isTypedArray(x){return ArrayBuffer.isView(x)&&Object.prototype.toString.call(x)!=="[object DataView]"}};var import_web_worker=__toESM(require_browser());var WorkerService=class extends Service{constructor(options){super(options);this.name="worker";this.workers={};this.threadRot=0;this.customRoutes={"worker":(route,routeKey,routes)=>{let rt=route;if(rt?.worker||rt?.workerId){if(rt.workerUrl)rt.url=rt.workerUrl;if(rt.workerId)rt.tag=rt.workerId;if(!rt.tag)rt.tag=routeKey;rt._id=rt.tag;let worker;if(this.workers[rt._id])worker=this.workers[rt._id];if(!worker)worker=this.addWorker(rt);rt.worker=worker;if(rt.transferFunctions){for(const prop in rt.transferFunctions){this.transferFunction(worker,rt.transferFunctions[prop],prop)}}if(rt.transferClasses){for(const prop in rt.transferClasses){this.transferClass(worker,rt.transferClasses[prop],prop)}}if(worker){if(!rt.operator){rt.operator=(...args)=>{if(rt.callback){if(!this.nodes.get(rt.tag)?.children)worker.post(rt.callback,args);else return worker.run(rt.callback,args)}else{if(!this.nodes.get(rt.tag)?.children)worker.send(args);else return worker.request(args)}}}}}return rt}};this.customChildren={"worker":(child,childRouteKey,parent,routes,checked)=>{let worker;if(child?.worker||child?.workerId){if(child.workerUrl)child.url=child.workerUrl;if(child.workerId)child.tag=child.workerId;if(!child.tag)child.tag=childRouteKey;child._id=child.tag;if(this.workers[child._id])worker=this.workers[child._id];if(!worker)worker=this.addWorker(child);child.worker=worker;if(child.transferFunctions){for(const prop in child.transferFunctions){this.transferFunction(worker,child.transferFunctions[prop],prop)}}if(child.transferClasses){for(const prop in child.transferClasses){this.transferClass(worker,child.transferClasses[prop],prop)}}if(worker){if(!child.operator){child.operator=(...args)=>{if(child.callback){if(!this.nodes.get(child.tag)?.children)worker.post(child.callback,args);else return worker.run(child.callback,args)}else{if(!this.nodes.get(child.tag)?.children)worker.send(args);else return worker.request(args)}}}}}if(child.parentRoute&&(parent?.worker||parent?.workerId)){if(worker){let portId=this.establishMessageChannel(worker,parent.worker.worker);worker.post("subscribeToWorker",child.parentRoute,portId,child.callback)}else{parent.worker.subscribe(child.parentRoute,result=>{this.nodes.get(child.tag?child.tag:childRouteKey).run(result)})}}}};this.addWorker=options=>{let worker;if(!options._id)options._id=`worker${Math.floor(Math.random()*1e15)}`;if(options.url)worker=new import_web_worker.default(options.url);else if(options.port){worker=options.port}else if(this.workers[options._id]){if(this.workers[options._id].port)worker=this.workers[options._id].port;else worker=this.workers[options._id].worker}if(!worker)return;let send=(message,transfer)=>{return this.transmit(message,worker,transfer)};let post=(route,args,transfer,origin,method)=>{let message={route,args};if(origin)message.origin=origin;if(method)message.method=method;return this.transmit(message,worker,transfer)};let run=(route,args,transfer,origin,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options._id,callbackId]};if(origin)req.args[0].origin=origin;if(method)req.args[0].method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let request=(message,transfer,origin,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options._id,callbackId]};if(origin)req.origin=origin;if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let subscribe=(route,callback)=>{return this.subscribeToWorker(route,options._id,callback)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};if(!options.onmessage)options.onmessage=ev=>{this.receive(ev.data);this.setState({[options._id]:ev.data})};if(!options.onerror){options.onerror=ev=>{console.error(ev.data)}}worker.onmessage=options.onmessage;worker.onerror=options.onerror;this.workers[options._id]={worker,send,post,run,request,subscribe,unsubscribe,...options};return this.workers[options._id]};this.toObjectURL=scriptTemplate=>{let blob=new Blob([scriptTemplate],{type:"text/javascript"});return URL.createObjectURL(blob)};this.transmit=(message,worker,transfer)=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort){worker.postMessage(message,transfer)}else if(typeof worker==="string"){if(this.workers[worker]){if(this.workers[worker].port)this.workers[worker].port.postMessage(message,transfer);else if(this.workers[worker].worker)this.workers[worker].worker.postMessage(message,transfer)}}else{let keys=Object.keys(this.workers);this.workers[keys[this.threadRot]].worker.postMessage(message,transfer);this.threadRot++;if(this.threadRot===keys.length)this.threadRot=0}return message};this.terminate=worker=>{if(typeof worker==="string"){let obj=this.workers[worker];if(obj)delete this.workers[worker];worker=obj.worker}if(worker instanceof import_web_worker.default){worker.terminate();return true}if(worker instanceof MessagePort){worker.close();return true}return false};this.establishMessageChannel=(worker,worker2)=>{let workerId;if(typeof worker==="string"){workerId=worker;if(this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker2=this.workers[worker].worker}}if(typeof worker2==="string"){if(this.workers[worker2]){if(this.workers[worker2].port)worker2=this.workers[worker2].port;else worker2=this.workers[worker2].worker}}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){let channel=new MessageChannel;let portId=`port${Math.floor(Math.random()*1e15)}`;worker.postMessage({route:"addWorker",args:{port:channel.port1,_id:portId}},[channel.port1]);if(worker2 instanceof import_web_worker.default||worker2 instanceof MessagePort){worker2.postMessage({route:"addWorker",args:{port:channel.port2,_id:portId}},[channel.port2])}else if(workerId&&this.workers[workerId])this.workers[workerId].port=channel.port2;return portId}return false};this.request=(message,workerId,transfer,origin,method)=>{let worker=this.workers[workerId].worker;return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,callbackId]};if(origin)req.origin=origin;if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};this.runRequest=(message,worker,callbackId)=>{let res=this.receive(message);if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}if(res instanceof Promise){res.then(r=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:r,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:r,callbackId})})}else{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:res,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:res,callbackId})}return res};this.subscribeWorker=(route,worker)=>{if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}return this.subscribe(route,res=>{if(res instanceof Promise){res.then(r=>{if(worker?.postMessage)worker.postMessage({args:r,route});else if(globalThis.postMessage)globalThis.postMessage({args:r,callbackId:route})})}else{if(worker?.postMessage)worker.postMessage({args:res,route});else if(globalThis.postMessage)globalThis.postMessage({args:res,callbackId:route})}})};this.subscribeToWorker=(route,workerId,callback)=>{if(typeof workerId==="string"&&this.workers[workerId]){this.subscribe(workerId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[workerId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return this.workers[workerId].run("subscribeWorker",[route,workerId])}};this.routes={addWorker:this.addWorker,toObjectURL:this.toObjectURL,request:this.request,runRequest:this.runRequest,establishMessageChannel:this.establishMessageChannel,subscribeWorker:this.subscribeWorker,subscribeToWorker:this.subscribeToWorker,unsubscribe:this.unsubscribe};this.load(this.routes);if(typeof WorkerGlobalScope!=="undefined"&&globalThis instanceof WorkerGlobalScope){globalThis.onmessage=ev=>{let result=this.receive(ev.data);if(this.keepState)this.setState({[ev.data.origin?ev.data.origin:"worker"]:result})}}}transferFunction(worker,fn,fnName){if(!fnName)fnName=fn.name;return worker.request({route:"setRoute",args:[fn.toString(),fnName]})}transferClass(worker,cls,className){if(!className)className=cls.name;return worker.request({route:"receiveClass",args:[cls.toString(),className]})}};var mouseEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","button","pointerType","clientX","clientY","pageX","pageY"]);var wheelEventHandlerImpl=makeSendPropertiesHandler(["deltaX","deltaY"]);var keydownEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","keyCode"]);function wheelEventHandler(event,sendFn){event.preventDefault();wheelEventHandlerImpl(event,sendFn)}function preventDefaultHandler(event){event.preventDefault()}function copyProperties(src,properties,dst){for(const name of properties){dst[name]=src[name]}}function makeSendPropertiesHandler(properties){return function sendProperties(event,sendFn){const data={type:event.type};copyProperties(event,properties,data);sendFn(data)}}function touchEventHandler(event,sendFn){const touches=[];const data={type:event.type,touches};for(let i=0;i<event.touches.length;++i){const touch=event.touches[i];touches.push({pageX:touch.pageX,pageY:touch.pageY})}sendFn(data)}var orbitKeys={"37":true,"38":true,"39":true,"40":true};function filteredKeydownEventHandler(event,sendFn){const{keyCode}=event;if(orbitKeys[keyCode]){event.preventDefault();keydownEventHandler(event,sendFn)}}var eventHandlers={contextmenu:preventDefaultHandler,mousedown:mouseEventHandler,mousemove:mouseEventHandler,mouseup:mouseEventHandler,pointerdown:mouseEventHandler,pointermove:mouseEventHandler,pointerup:mouseEventHandler,touchstart:touchEventHandler,touchmove:touchEventHandler,touchend:touchEventHandler,wheel:wheelEventHandler,keydown:filteredKeydownEventHandler};function initProxyElement(element,worker,id){if(!id)id="proxy"+Math.floor(Math.random()*1e15);const sendEvent=data=>{worker.postMessage({route:"handleProxyEvent",args:[data,id]})};let entries=Object.entries(eventHandlers);for(const[eventName,handler]of entries){element.addEventListener(eventName,function(event){handler(event,sendEvent)})}const sendSize=()=>{const rect=element.getBoundingClientRect();sendEvent({type:"resize",left:rect.left,top:rect.top,width:element.clientWidth,height:element.clientHeight})};sendSize();globalThis.addEventListener("resize",sendSize);return id}var EventDispatcher=class{addEventListener(type,listener){if(this._listeners===void 0)this._listeners={};const listeners=this._listeners;if(listeners[type]===void 0){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}}hasEventListener(type,listener){if(this._listeners===void 0)return false;const listeners=this._listeners;return listeners[type]!==void 0&&listeners[type].indexOf(listener)!==-1}removeEventListener(type,listener){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[type];if(listenerArray!==void 0){const index=listenerArray.indexOf(listener);if(index!==-1){listenerArray.splice(index,1)}}}dispatchEvent(event,target){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[event.type];if(listenerArray!==void 0){if(!target)event.target=this;else event.target=target;const array=listenerArray.slice(0);for(let i=0,l=array.length;i<l;i++){array[i].call(this,event)}event.target=null}}};function noop(){}var ElementProxyReceiver=class extends EventDispatcher{constructor(){super();this._listeners={};this.style={};this.setPointerCapture=()=>{};this.releasePointerCapture=()=>{};this.getBoundingClientRect=()=>{return{left:this.left,top:this.top,width:this.width,height:this.height,right:this.left+this.width,bottom:this.top+this.height}};this.handleEvent=data=>{if(data.type==="resize"){this.left=data.left;this.top=data.top;this.width=data.width;this.height=data.height;if(typeof this.proxied==="object"){this.proxied.width=this.width;this.proxied.height=this.height;this.proxied.clientWidth=this.width;this.proxied.clientHeight=this.height}}data.preventDefault=noop;data.stopPropagation=noop;this.dispatchEvent(data,this.proxied)};this.style={}}get clientWidth(){return this.width}get clientHeight(){return this.height}focus(){}};var ProxyManager=class{constructor(){this.targets={};this.makeProxy=(id,addTo=void 0)=>{if(!id)id=`proxyReceiver${Math.floor(Math.random()*1e15)}`;let proxy;if(this.targets[id])proxy=this.targets[id];else{proxy=new ElementProxyReceiver;this.targets[id]=proxy}if(typeof addTo==="object"){addTo.proxy=proxy;proxy.proxied=addTo;console.log(proxy,addTo);addTo.style=proxy.style;if(proxy.width){addTo.width=proxy.width;addTo.clientWidth=proxy.width}if(proxy.height){addTo.height=proxy.height;addTo.clientHeight=proxy.height}addTo.setPointerCapture=proxy.setPointerCapture.bind(proxy);addTo.releasePointerCapture=proxy.releasePointerCapture.bind(proxy);addTo.getBoundingClientRect=proxy.getBoundingClientRect.bind(proxy);addTo.addEventListener=proxy.addEventListener.bind(proxy);addTo.removeEventListener=proxy.removeEventListener.bind(proxy);addTo.handleEvent=proxy.handleEvent.bind(proxy);addTo.dispatchEvent=proxy.dispatchEvent.bind(proxy);addTo.focus=proxy.focus.bind(proxy)}};this.getProxy=id=>{return this.targets[id]};this.handleEvent=(data,id)=>{if(!this.targets[id])this.makeProxy(id);if(this.targets[id]){this.targets[id].handleEvent(data);return true}return void 0};if(!globalThis.document)globalThis.document={}}};var proxyElementWorkerRoutes={initProxyElement,makeProxy:(self2,origin,id,elm)=>{if(!self2.graph.ProxyManager)self2.graph.ProxyManager=new ProxyManager;self2.graph.ProxyManager.makeProxy(id,elm);return id},handleProxyEvent:(self2,origin,data,id)=>{if(!self2.graph.ProxyManager)self2.graph.ProxyManager=new ProxyManager;if(self2.graph.ProxyManager.handleEvent(data,id))return data}};var workerCanvasRoutes={...proxyElementWorkerRoutes,transferCanvas:(self2,origin,worker,options,route)=>{if(!options)return void 0;if(!options._id)options._id=`canvas${Math.floor(Math.random()*1e15)}`;let offscreen=options.canvas.transferControlToOffscreen();let message={route:route?route:"receiveCanvas",args:{canvas:offscreen,context:options.context,_id:options._id}};self2.graph.run("initProxyElement",options.canvas,worker,options._id);if(options.draw){if(typeof options.draw==="function")message.args.draw=options.draw.toString();else message.args.draw=options.draw}if(options.update){if(typeof options.update==="function")message.args.update=options.update.toString();else message.args.update=options.update}if(options.init){if(typeof options.init==="function")message.args.init=options.init.toString();else message.args.init=options.init}if(options.clear){if(typeof options.clear==="function")message.args.clear=options.clear.toString();else message.args.clear=options.clear}worker.postMessage(message,[offscreen]);const workercontrols={_id:options._id,draw:props=>{worker.postMessage({route:"drawFrame",args:[options._id,props]})},update:props=>{worker.postMessage({route:"updateCanvas",args:[options._id,props]})},clear:()=>{worker.postMessage({route:"clearCanvas",args:options._id})},init:()=>{worker.postMessage({route:"initCanvas",args:options._id})},stop:()=>{worker.postMessage({route:"stopAnim",args:options._id})},start:()=>{worker.postMessage({route:"startAnim",args:options._id})},set:newDrawProps=>{worker.postMessage({route:"setDraw",args:[newDrawProps,options._id]})}};return workercontrols},receiveCanvas:(self2,origin,options)=>{if(!self2.graph.CANVASES)self2.graph.CANVASES={};let canvasOptions=options;options._id?canvasOptions._id=options._id:canvasOptions._id=`canvas${Math.floor(Math.random()*1e15)}`;typeof options.context==="string"?canvasOptions.context=options.canvas.getContext(options.context):canvasOptions.context=options.context;"animating"in options?canvasOptions.animating=options.animating:canvasOptions.animating=true;if(self2.graph.CANVASES[canvasOptions._id]){self2.graph.run("setDraw",canvasOptions)}else{self2.graph.CANVASES[canvasOptions._id]=canvasOptions;self2.graph.run("makeProxy",canvasOptions._id,canvasOptions.canvas);if(options.width)canvasOptions.canvas.width=options.width;if(options.height)canvasOptions.canvas.height=options.height;if(typeof canvasOptions.draw==="string"){canvasOptions.draw=parseFunctionFromText(canvasOptions.draw)}if(typeof canvasOptions.update==="string"){canvasOptions.update=parseFunctionFromText(canvasOptions.update)}if(typeof canvasOptions.init==="string"){canvasOptions.init=parseFunctionFromText(canvasOptions.init)}if(typeof canvasOptions.clear==="string"){canvasOptions.clear=parseFunctionFromText(canvasOptions.clear)}if(typeof canvasOptions.init==="function")canvasOptions.init(canvasOptions,canvasOptions.canvas,canvasOptions.context);if(typeof canvasOptions.draw==="function"&&canvasOptions.animating){let draw=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw(s,canvas,context)})}};draw(canvasOptions,canvasOptions.canvas,canvasOptions.context)}}return canvasOptions._id},setDraw:(self2,origin,settings,_id)=>{let canvasopts;if(_id)canvasopts=self2.graph.CANVASES?.[settings._id];else if(settings._id)canvasopts=self2.graph.CANVASES?.[settings._id];else canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];if(canvasopts){if(settings.canvas){canvasopts.canvas=settings.canvas;self2.graph.run("makeProxy",canvasopts._id,canvasopts.canvas)}if(typeof settings.context==="string")canvasopts.context=canvasopts.canvas.getContext(settings.context);else if(settings.context)canvasopts.context=settings.context;if(settings.width)canvasopts.canvas.width=settings.width;if(settings.height)canvasopts.canvas.height=settings.height;if(typeof settings.draw==="string")settings.draw=parseFunctionFromText(settings.draw);if(typeof settings.draw==="function"){canvasopts.draw=settings.draw}if(typeof settings.update==="string")settings.update=parseFunctionFromText(settings.update);if(typeof settings.update==="function"){canvasopts.update=settings.update}if(typeof settings.init==="string")settings.init=parseFunctionFromText(settings.init);if(typeof settings.init==="function"){canvasopts.init=settings.init}if(typeof settings.clear==="string")settings.clear=parseFunctionFromText(settings.clear);if(typeof settings.clear==="function"){canvasopts.clear=settings.clear}return settings._id}return void 0},drawFrame:(self2,origin,_id,props)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts){if(props)Object.assign(canvasopts,props);if(canvasopts.draw){canvasopts.draw(canvasopts,canvasopts.canvas,canvasopts.context);return _id}}return void 0},clearCanvas:(self2,origin,_id)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts?.clear){canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},initCanvas:(self2,origin,_id)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts?.init){canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},updateCanvas:(self2,origin,_id,input)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts?.update){canvasopts.update(canvasopts,canvasopts.canvas,canvasopts.context,input);return _id}return void 0},setProps:(self2,origin,_id,props)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts){Object.assign(canvasopts,props);if(props.width)canvasopts.canvas.width=props.width;if(props.height)canvasopts.canvas.height=props.height;return _id}return void 0},startAnim:(self2,origin,_id,draw)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];canvasopts.animating=true;if(canvasopts&&draw){if(typeof draw==="string")draw=parseFunctionFromText(draw);if(typeof draw==="function"){canvasopts.draw=draw}return _id}if(typeof canvasopts?.draw==="function"){let draw2=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw2(s,canvas,context)})}};if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);if(typeof canvasopts.init==="function")canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);draw2(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0},stopAnim:(self2,origin,_id)=>{let canvasopts;if(!_id)canvasopts=self2.graph.CANVASES?.[Object.keys(self2.graph.CANVASES)[0]];else canvasopts=self2.graph.CANVASES?.[_id];if(canvasopts){canvasopts.animating=false;if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}};var unsafeRoutes={setRoute:(self2,origin,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(self2.graph.get(fnName)){self2.graph.get(fnName).setOperator(fn)}else self2.graph.load({[fnName]:{operator:fn}});return true}return false},setNode:(self2,origin,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(self2.graph.get(fnName)){self2.graph.get(fnName).setOperator(fn)}else self2.graph.add({tag:fnName,operator:fn});return true}return false},setMethod:(self2,origin,route,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(self2.graph.get(route)){self2.graph.get(route)[fnName]=fn}else self2.graph.add({tag:fnName,[fnName]:fn});return true}return false},assignRoute:(self2,origin,route,source)=>{if(self2.graph.get(route)&&typeof source==="object"){Object.assign(self2.graph.get(route),source)}},transferClass:(classObj,className)=>{if(typeof classObj==="object"){let str=classObj.toString();let message={route:"receiveClass",args:[str,className]};return message}return false},receiveClass:(self2,origin,stringified,className)=>{if(typeof stringified==="string"){if(stringified.indexOf("class")===0){let cls=(0,eval)("("+stringified+")");let name=className;if(!name)name=cls.name;self2.graph[name]=cls;return true}}return false},setValue:(self2,origin,key,value)=>{globalThis[key]=value;return true},assignObject:(self2,origin,target,source)=>{if(!globalThis[target])return false;if(typeof source==="object")Object.assign(globalThis[target],source);return true},setFunction:(self2,origin,fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[fnName]=fn;return true}return false},assignFunctionToObject:(self2,origin,globalObjectName,fn,fnName)=>{if(!globalThis[globalObjectName])return false;if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[globalObjectName][fnName]=fn;return true}return false}};var ECSService=class extends Service{constructor(options){super(options);this.entities={};this.systems={};this.order=[];this.animating=true;this.updateEntities=(order,filter)=>{if(!order)order=this.order;order.forEach(k=>{if(this.systems[k]){if(filter){this.systems[k]._run(this.systems[k],this,this.filterObject(this.entities,(key,entity)=>{if(entity.components[k])return true}))}else this.systems[k]._run(this.systems[k],this,this.entities)}})};this.animate=(filter,order)=>{requestAnimationFrame(()=>{if(this.animating){this.update(filter,order);this.animate(filter,order)}})};this.stop=()=>{this.animating=false};this.start=filter=>{this.animating=true;this.animate(filter)};this.routes={update:this.update,animate:this.animate,start:this.start,stop:this.stop,addEntity:this.addEntity,addSystem:this.addSystem,removeEntity:this.removeEntity,removeSystem:this.removeSystem};if(this.routes)this.load(this.routes);if(options.entities)for(const key in options.entities){if(typeof options.entities[key]!=="object"){options.entities[key]=this.nodes.get(key);if(!options.entities[key]){delete options.entities[key];continue}}if(typeof options.entities[key]==="object"){if(!options.entities[key].components){options.entities[key].components={}}}}if(options.systems)for(const key in options.systems){if(typeof options.systems[key]!=="object"){options.systems[key]=this.nodes.get(key);if(!options.systems[key]){delete options.systems[key];continue}}if(typeof options.systems[key]==="object"){}}if(!options.order)options.order=Object.keys(options.systems);this.order=options.order;this.load(this.entities);for(const key in options.entities){options.entities=this.nodes.get(options.entities[key].tag)}this.entities=options.entities;this.load(this.systems);this.order.forEach(key=>{options.systems[key]=this.nodes.get(options.systems[key].tag);if(options.systems[key]?.setupEntities){options.systems[key].setupEntities(options.systems[key],this.entities)}});this.systems=options.systems}filterObject(o,filter){return Object.fromEntries(Object.entries(o).filter(([key,value])=>{filter(key,value)}))}addEntity(prototype={},components={}){const entity=this.recursivelyAssign({},prototype);entity.components=components;if(Object.keys(components).length===0){Object.keys(this.systems).forEach(k=>{components[k]=true})}if(entity.tag&&this.entities[entity.tag]){entity.tag=`entity${Math.floor(Math.random()*1e15)}`}this.load({[entity.tag]:entity});this.entities[entity.tag]=this.nodes.get(entity.tag);this.setupEntities({[entity.tag]:this.entities[entity.tag]});return this.entities[entity.tag]}addSystem(prototype={},setup,update){const system=this.recursivelyAssign({},prototype);system.setupEntities=setup;system.operator=update;if(system.tag&&this.systems[system.tag]){system.tag=`system${Math.floor(Math.random()*1e15)}`}this.load({[system.tag]:system});this.systems[system.tag]=this.nodes.get(system.tag);if(system?.setupEntities){system.setupEntities(system,this.filterObject(this.entities,(key,v)=>{if(v.components[system.tag])return true}))}return this.systems[system.tag]}setupEntities(entities,system){if(system){if(!system?.setupEntities)return;if(entities)system.setupEntities(system,this.filterObject(entities,(k,v)=>{if(v.components[system.tag])return true}));else system.setupEntities(system,this.filterObject(this.entities,(k,v)=>{if(v.components[system.tag])return true}))}else{for(const key in this.systems){if(!this.systems[key]?.setupEntities)continue;if(entities)this.systems[key].setupEntities(this.systems[key],this.filterObject(entities,(k,v)=>{if(v.components[key])return true}));else this.systems[key].setupEntities(this.systems[key],this.filterObject(this.entities,(k,v)=>{if(v.components[key])return true}))}}}removeEntity(tag){delete this.entities[tag];return this.remove(tag)}removeSystem(tag){delete this.systems[tag];return this.remove(tag)}};if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.SERVICE=new WorkerService({routes:[self.SERVICE,workerCanvasRoutes,ECSService,unsafeRoutes],includeClassName:false})}var Worker_default=self;})();
