(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:true,configurable:true,writable:true,value}):obj[key]=value;var __require=(x=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b)=>(typeof require!=="undefined"?require:a)[b]}):x)(function(x){if(typeof require!=="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+x+'" is not supported')});var __commonJS=(cb,mod)=>function __require2(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from==="object"||typeof from==="function"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:true}):target,mod));var __publicField=(obj,key,value)=>{__defNormalProp(obj,typeof key!=="symbol"?key+"":key,value);return value};var require_sjcl=__commonJS({"services/e2ee/sjcl.js"(exports,module){"use strict";var sjcl2={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message};this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message};this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message};this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message};this.message=a}}};sjcl2.cipher.aes=function(a){this.s[0][0][0]||this.O();var b,c,d,e,f=this.s[0][4],g=this.s[1];b=a.length;var h=1;if(4!==b&&6!==b&&8!==b)throw new sjcl2.exception.invalid("invalid aes key size");this.b=[d=a.slice(0),e=[]];for(a=b;a<4*b+28;a++){c=d[a-1];if(0===a%b||8===b&&4===a%b)c=f[c>>>24]<<24^f[c>>16&255]<<16^f[c>>8&255]<<8^f[c&255],0===a%b&&(c=c<<8^c>>>24^h<<24,h=h<<1^283*(h>>7));d[a]=d[a-b]^c}for(b=0;a;b++,a--)c=d[b&3?a:a-4],e[b]=4>=a||4>b?c:g[0][f[c>>>24]]^g[1][f[c>>16&255]]^g[2][f[c>>8&255]]^g[3][f[c&255]]};sjcl2.cipher.aes.prototype={encrypt:function(a){return t(this,a,0)},decrypt:function(a){return t(this,a,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var a=this.s[0],b=this.s[1],c=a[4],d=b[4],e,f,g,h=[],k=[],l,n,m,p;for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(f=g=0;!c[f];f^=l||1,g=k[g]||1)for(m=g^g<<1^g<<2^g<<3^g<<4,m=m>>8^m&255^99,c[f]=m,d[m]=f,n=h[e=h[l=h[f]]],p=16843009*n^65537*e^257*l^16843008*f,n=257*h[m]^16843008*m,e=0;4>e;e++)a[e][f]=n=n<<24^n>>>8,b[e][m]=p=p<<24^p>>>8;for(e=0;5>e;e++)a[e]=a[e].slice(0),b[e]=b[e].slice(0)}};function t(a,b,c){if(4!==b.length)throw new sjcl2.exception.invalid("invalid aes block size");var d=a.b[c],e=b[0]^d[0],f=b[c?3:1]^d[1],g=b[2]^d[2];b=b[c?1:3]^d[3];var h,k,l,n=d.length/4-2,m,p=4,r=[0,0,0,0];h=a.s[c];a=h[0];var q=h[1],v=h[2],w=h[3],x=h[4];for(m=0;m<n;m++)h=a[e>>>24]^q[f>>16&255]^v[g>>8&255]^w[b&255]^d[p],k=a[f>>>24]^q[g>>16&255]^v[b>>8&255]^w[e&255]^d[p+1],l=a[g>>>24]^q[b>>16&255]^v[e>>8&255]^w[f&255]^d[p+2],b=a[b>>>24]^q[e>>16&255]^v[f>>8&255]^w[g&255]^d[p+3],p+=4,e=h,f=k,g=l;for(m=0;4>m;m++)r[c?3&-m:m]=x[e>>>24]<<24^x[f>>16&255]<<16^x[g>>8&255]<<8^x[b&255]^d[p++],h=e,e=f,f=g,g=b,b=h;return r}sjcl2.bitArray={bitSlice:function(a,b,c){a=sjcl2.bitArray.$(a.slice(b/32),32-(b&31)).slice(1);return void 0===c?a:sjcl2.bitArray.clamp(a,c-b)},extract:function(a,b,c){var d=Math.floor(-b-c&31);return((b+c-1^b)&-32?a[b/32|0]<<32-d^a[b/32+1|0]>>>d:a[b/32|0]>>>d)&(1<<c)-1},concat:function(a,b){if(0===a.length||0===b.length)return a.concat(b);var c=a[a.length-1],d=sjcl2.bitArray.getPartial(c);return 32===d?a.concat(b):sjcl2.bitArray.$(b,d,c|0,a.slice(0,a.length-1))},bitLength:function(a){var b=a.length;return 0===b?0:32*(b-1)+sjcl2.bitArray.getPartial(a[b-1])},clamp:function(a,b){if(32*a.length<b)return a;a=a.slice(0,Math.ceil(b/32));var c=a.length;b=b&31;0<c&&b&&(a[c-1]=sjcl2.bitArray.partial(b,a[c-1]&2147483648>>b-1,1));return a},partial:function(a,b,c){return 32===a?b:(c?b|0:b<<32-a)+1099511627776*a},getPartial:function(a){return Math.round(a/1099511627776)||32},equal:function(a,b){if(sjcl2.bitArray.bitLength(a)!==sjcl2.bitArray.bitLength(b))return false;var c=0,d;for(d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c},$:function(a,b,c,d){var e;e=0;for(void 0===d&&(d=[]);32<=b;b-=32)d.push(c),c=0;if(0===b)return d.concat(a);for(e=0;e<a.length;e++)d.push(c|a[e]>>>b),c=a[e]<<32-b;e=a.length?a[a.length-1]:0;a=sjcl2.bitArray.getPartial(e);d.push(sjcl2.bitArray.partial(b+a&31,32<b+a?c:d.pop(),1));return d},i:function(a,b){return[a[0]^b[0],a[1]^b[1],a[2]^b[2],a[3]^b[3]]},byteswapM:function(a){var b,c;for(b=0;b<a.length;++b)c=a[b],a[b]=c>>>24|c>>>8&65280|(c&65280)<<8|c<<24;return a}};sjcl2.codec.utf8String={fromBits:function(a){var b="",c=sjcl2.bitArray.bitLength(a),d,e;for(d=0;d<c/8;d++)0===(d&3)&&(e=a[d/4]),b+=String.fromCharCode(e>>>8>>>8>>>8),e<<=8;return decodeURIComponent(escape(b))},toBits:function(a){a=unescape(encodeURIComponent(a));var b=[],c,d=0;for(c=0;c<a.length;c++)d=d<<8|a.charCodeAt(c),3===(c&3)&&(b.push(d),d=0);c&3&&b.push(sjcl2.bitArray.partial(8*(c&3),d));return b}};sjcl2.codec.hex={fromBits:function(a){var b="",c;for(c=0;c<a.length;c++)b+=((a[c]|0)+0xf00000000000).toString(16).substr(4);return b.substr(0,sjcl2.bitArray.bitLength(a)/4)},toBits:function(a){var b,c=[],d;a=a.replace(/\s|0x/g,"");d=a.length;a=a+"00000000";for(b=0;b<a.length;b+=8)c.push(parseInt(a.substr(b,8),16)^0);return sjcl2.bitArray.clamp(c,4*d)}};sjcl2.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(a,b,c){var d=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f="",g=0,h=sjcl2.codec.base32.B,k=0,l=sjcl2.bitArray.bitLength(a);c&&(h=sjcl2.codec.base32.X);for(c=0;f.length*d<l;)f+=h.charAt((k^a[c]>>>g)>>>e),g<d?(k=a[c]<<d-g,g+=e,c++):(k<<=d,g-=d);for(;f.length&7&&!b;)f+="=";return f},toBits:function(a,b){a=a.replace(/\s|=/g,"").toUpperCase();var c=sjcl2.codec.base32.BITS,d=sjcl2.codec.base32.BASE,e=sjcl2.codec.base32.REMAINING,f=[],g,h=0,k=sjcl2.codec.base32.B,l=0,n,m="base32";b&&(k=sjcl2.codec.base32.X,m="base32hex");for(g=0;g<a.length;g++){n=k.indexOf(a.charAt(g));if(0>n){if(!b)try{return sjcl2.codec.base32hex.toBits(a)}catch(p){}throw new sjcl2.exception.invalid("this isn't "+m+"!")}h>e?(h-=e,f.push(l^n>>>h),l=n<<c-h):(h+=d,l^=n<<c-h)}h&56&&f.push(sjcl2.bitArray.partial(h&56,l,1));return f}};sjcl2.codec.base32hex={fromBits:function(a,b){return sjcl2.codec.base32.fromBits(a,b,1)},toBits:function(a){return sjcl2.codec.base32.toBits(a,1)}};sjcl2.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(a,b,c){var d="",e=0,f=sjcl2.codec.base64.B,g=0,h=sjcl2.bitArray.bitLength(a);c&&(f=f.substr(0,62)+"-_");for(c=0;6*d.length<h;)d+=f.charAt((g^a[c]>>>e)>>>26),6>e?(g=a[c]<<6-e,e+=26,c++):(g<<=6,e-=6);for(;d.length&3&&!b;)d+="=";return d},toBits:function(a,b){a=a.replace(/\s|=/g,"");var c=[],d,e=0,f=sjcl2.codec.base64.B,g=0,h;b&&(f=f.substr(0,62)+"-_");for(d=0;d<a.length;d++){h=f.indexOf(a.charAt(d));if(0>h)throw new sjcl2.exception.invalid("this isn't base64!");26<e?(e-=26,c.push(g^h>>>e),g=h<<32-e):(e+=6,g^=h<<32-e)}e&56&&c.push(sjcl2.bitArray.partial(e&56,g,1));return c}};sjcl2.codec.base64url={fromBits:function(a){return sjcl2.codec.base64.fromBits(a,1,1)},toBits:function(a){return sjcl2.codec.base64.toBits(a,1)}};sjcl2.hash.sha256=function(a){this.b[0]||this.O();a?(this.F=a.F.slice(0),this.A=a.A.slice(0),this.l=a.l):this.reset()};sjcl2.hash.sha256.hash=function(a){return new sjcl2.hash.sha256().update(a).finalize()};sjcl2.hash.sha256.prototype={blockSize:512,reset:function(){this.F=this.Y.slice(0);this.A=[];this.l=0;return this},update:function(a){"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));var b,c=this.A=sjcl2.bitArray.concat(this.A,a);b=this.l;a=this.l=b+sjcl2.bitArray.bitLength(a);if(9007199254740991<a)throw new sjcl2.exception.invalid("Cannot hash more than 2^53 - 1 bits");if("undefined"!==typeof Uint32Array){var d=new Uint32Array(c),e=0;for(b=512+b-(512+b&511);b<=a;b+=512)u(this,d.subarray(16*e,16*(e+1))),e+=1;c.splice(0,16*e)}else for(b=512+b-(512+b&511);b<=a;b+=512)u(this,c.splice(0,16));return this},finalize:function(){var a,b=this.A,c=this.F,b=sjcl2.bitArray.concat(b,[sjcl2.bitArray.partial(1,1)]);for(a=b.length+2;a&15;a++)b.push(0);b.push(Math.floor(this.l/4294967296));for(b.push(this.l|0);b.length;)u(this,b.splice(0,16));this.reset();return c},Y:[],b:[],O:function(){function a(a2){return 4294967296*(a2-Math.floor(a2))|0}for(var b=0,c=2,d,e;64>b;c++){e=true;for(d=2;d*d<=c;d++)if(0===c%d){e=false;break}e&&(8>b&&(this.Y[b]=a(Math.pow(c,.5))),this.b[b]=a(Math.pow(c,1/3)),b++)}}};function u(a,b){var c,d,e,f=a.F,g=a.b,h=f[0],k=f[1],l=f[2],n=f[3],m=f[4],p=f[5],r=f[6],q=f[7];for(c=0;64>c;c++)16>c?d=b[c]:(d=b[c+1&15],e=b[c+14&15],d=b[c&15]=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+b[c&15]+b[c+9&15]|0),d=d+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(r^m&(p^r))+g[c],q=r,r=p,p=m,m=n+d|0,n=l,l=k,k=h,h=d+(k&l^n&(k^l))+(k>>>2^k>>>13^k>>>22^k<<30^k<<19^k<<10)|0;f[0]=f[0]+h|0;f[1]=f[1]+k|0;f[2]=f[2]+l|0;f[3]=f[3]+n|0;f[4]=f[4]+m|0;f[5]=f[5]+p|0;f[6]=f[6]+r|0;f[7]=f[7]+q|0}sjcl2.mode.ccm={name:"ccm",G:[],listenProgress:function(a){sjcl2.mode.ccm.G.push(a)},unListenProgress:function(a){a=sjcl2.mode.ccm.G.indexOf(a);-1<a&&sjcl2.mode.ccm.G.splice(a,1)},fa:function(a){var b=sjcl2.mode.ccm.G.slice(),c;for(c=0;c<b.length;c+=1)b[c](a)},encrypt:function(a,b,c,d,e){var f,g=b.slice(0),h=sjcl2.bitArray,k=h.bitLength(c)/8,l=h.bitLength(g)/8;e=e||64;d=d||[];if(7>k)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(f=2;4>f&&l>>>8*f;f++);f<15-k&&(f=15-k);c=h.clamp(c,8*(15-f));b=sjcl2.mode.ccm.V(a,b,c,d,e,f);g=sjcl2.mode.ccm.C(a,g,c,b,e,f);return h.concat(g.data,g.tag)},decrypt:function(a,b,c,d,e){e=e||64;d=d||[];var f=sjcl2.bitArray,g=f.bitLength(c)/8,h=f.bitLength(b),k=f.clamp(b,h-e),l=f.bitSlice(b,h-e),h=(h-e)/8;if(7>g)throw new sjcl2.exception.invalid("ccm: iv must be at least 7 bytes");for(b=2;4>b&&h>>>8*b;b++);b<15-g&&(b=15-g);c=f.clamp(c,8*(15-b));k=sjcl2.mode.ccm.C(a,k,c,l,e,b);a=sjcl2.mode.ccm.V(a,k.data,c,d,e,b);if(!f.equal(k.tag,a))throw new sjcl2.exception.corrupt("ccm: tag doesn't match");return k.data},na:function(a,b,c,d,e,f){var g=[],h=sjcl2.bitArray,k=h.i;d=[h.partial(8,(b.length?64:0)|d-2<<2|f-1)];d=h.concat(d,c);d[3]|=e;d=a.encrypt(d);if(b.length)for(c=h.bitLength(b)/8,65279>=c?g=[h.partial(16,c)]:4294967295>=c&&(g=h.concat([h.partial(16,65534)],[c])),g=h.concat(g,b),b=0;b<g.length;b+=4)d=a.encrypt(k(d,g.slice(b,b+4).concat([0,0,0])));return d},V:function(a,b,c,d,e,f){var g=sjcl2.bitArray,h=g.i;e/=8;if(e%2||4>e||16<e)throw new sjcl2.exception.invalid("ccm: invalid tag length");if(4294967295<d.length||4294967295<b.length)throw new sjcl2.exception.bug("ccm: can't deal with 4GiB or more data");c=sjcl2.mode.ccm.na(a,d,c,e,g.bitLength(b)/8,f);for(d=0;d<b.length;d+=4)c=a.encrypt(h(c,b.slice(d,d+4).concat([0,0,0])));return g.clamp(c,8*e)},C:function(a,b,c,d,e,f){var g,h=sjcl2.bitArray;g=h.i;var k=b.length,l=h.bitLength(b),n=k/50,m=n;c=h.concat([h.partial(8,f-1)],c).concat([0,0,0]).slice(0,4);d=h.bitSlice(g(d,a.encrypt(c)),0,e);if(!k)return{tag:d,data:[]};for(g=0;g<k;g+=4)g>n&&(sjcl2.mode.ccm.fa(g/k),n+=m),c[3]++,e=a.encrypt(c),b[g]^=e[0],b[g+1]^=e[1],b[g+2]^=e[2],b[g+3]^=e[3];return{tag:d,data:h.clamp(b,l)}}};sjcl2.mode.ocb2={name:"ocb2",encrypt:function(a,b,c,d,e,f){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");var g,h=sjcl2.mode.ocb2.S,k=sjcl2.bitArray,l=k.i,n=[0,0,0,0];c=h(a.encrypt(c));var m,p=[];d=d||[];e=e||64;for(g=0;g+4<b.length;g+=4)m=b.slice(g,g+4),n=l(n,m),p=p.concat(l(c,a.encrypt(l(c,m)))),c=h(c);m=b.slice(g);b=k.bitLength(m);g=a.encrypt(l(c,[0,0,0,b]));m=k.clamp(l(m.concat([0,0,0]),g),b);n=l(n,l(m.concat([0,0,0]),g));n=a.encrypt(l(n,l(c,h(c))));d.length&&(n=l(n,f?d:sjcl2.mode.ocb2.pmac(a,d)));return p.concat(k.concat(m,k.clamp(n,e)))},decrypt:function(a,b,c,d,e,f){if(128!==sjcl2.bitArray.bitLength(c))throw new sjcl2.exception.invalid("ocb iv must be 128 bits");e=e||64;var g=sjcl2.mode.ocb2.S,h=sjcl2.bitArray,k=h.i,l=[0,0,0,0],n=g(a.encrypt(c)),m,p,r=sjcl2.bitArray.bitLength(b)-e,q=[];d=d||[];for(c=0;c+4<r/32;c+=4)m=k(n,a.decrypt(k(n,b.slice(c,c+4)))),l=k(l,m),q=q.concat(m),n=g(n);p=r-32*c;m=a.encrypt(k(n,[0,0,0,p]));m=k(m,h.clamp(b.slice(c),p).concat([0,0,0]));l=k(l,m);l=a.encrypt(k(l,k(n,g(n))));d.length&&(l=k(l,f?d:sjcl2.mode.ocb2.pmac(a,d)));if(!h.equal(h.clamp(l,e),h.bitSlice(b,r)))throw new sjcl2.exception.corrupt("ocb: tag doesn't match");return q.concat(h.clamp(m,p))},pmac:function(a,b){var c,d=sjcl2.mode.ocb2.S,e=sjcl2.bitArray,f=e.i,g=[0,0,0,0],h=a.encrypt([0,0,0,0]),h=f(h,d(d(h)));for(c=0;c+4<b.length;c+=4)h=d(h),g=f(g,a.encrypt(f(h,b.slice(c,c+4))));c=b.slice(c);128>e.bitLength(c)&&(h=f(h,d(h)),c=e.concat(c,[-2147483648,0,0,0]));g=f(g,c);return a.encrypt(f(d(f(h,d(h))),g))},S:function(a){return[a[0]<<1^a[1]>>>31,a[1]<<1^a[2]>>>31,a[2]<<1^a[3]>>>31,a[3]<<1^135*(a[0]>>>31)]}};sjcl2.mode.gcm={name:"gcm",encrypt:function(a,b,c,d,e){var f=b.slice(0);b=sjcl2.bitArray;d=d||[];a=sjcl2.mode.gcm.C(true,a,f,d,c,e||128);return b.concat(a.data,a.tag)},decrypt:function(a,b,c,d,e){var f=b.slice(0),g=sjcl2.bitArray,h=g.bitLength(f);e=e||128;d=d||[];e<=h?(b=g.bitSlice(f,h-e),f=g.bitSlice(f,0,h-e)):(b=f,f=[]);a=sjcl2.mode.gcm.C(false,a,f,d,c,e);if(!g.equal(a.tag,b))throw new sjcl2.exception.corrupt("gcm: tag doesn't match");return a.data},ka:function(a,b){var c,d,e,f,g,h=sjcl2.bitArray.i;e=[0,0,0,0];f=b.slice(0);for(c=0;128>c;c++){(d=0!==(a[Math.floor(c/32)]&1<<31-c%32))&&(e=h(e,f));g=0!==(f[3]&1);for(d=3;0<d;d--)f[d]=f[d]>>>1|(f[d-1]&1)<<31;f[0]>>>=1;g&&(f[0]^=-520093696)}return e},j:function(a,b,c){var d,e=c.length;b=b.slice(0);for(d=0;d<e;d+=4)b[0]^=4294967295&c[d],b[1]^=4294967295&c[d+1],b[2]^=4294967295&c[d+2],b[3]^=4294967295&c[d+3],b=sjcl2.mode.gcm.ka(b,a);return b},C:function(a,b,c,d,e,f){var g,h,k,l,n,m,p,r,q=sjcl2.bitArray;m=c.length;p=q.bitLength(c);r=q.bitLength(d);h=q.bitLength(e);g=b.encrypt([0,0,0,0]);96===h?(e=e.slice(0),e=q.concat(e,[1])):(e=sjcl2.mode.gcm.j(g,[0,0,0,0],e),e=sjcl2.mode.gcm.j(g,e,[0,0,Math.floor(h/4294967296),h&4294967295]));h=sjcl2.mode.gcm.j(g,[0,0,0,0],d);n=e.slice(0);d=h.slice(0);a||(d=sjcl2.mode.gcm.j(g,h,c));for(l=0;l<m;l+=4)n[3]++,k=b.encrypt(n),c[l]^=k[0],c[l+1]^=k[1],c[l+2]^=k[2],c[l+3]^=k[3];c=q.clamp(c,p);a&&(d=sjcl2.mode.gcm.j(g,h,c));a=[Math.floor(r/4294967296),r&4294967295,Math.floor(p/4294967296),p&4294967295];d=sjcl2.mode.gcm.j(g,d,a);k=b.encrypt(e);d[0]^=k[0];d[1]^=k[1];d[2]^=k[2];d[3]^=k[3];return{tag:q.bitSlice(d,0,f),data:c}}};sjcl2.misc.hmac=function(a,b){this.W=b=b||sjcl2.hash.sha256;var c=[[],[]],d,e=b.prototype.blockSize/32;this.w=[new b,new b];a.length>e&&(a=b.hash(a));for(d=0;d<e;d++)c[0][d]=a[d]^909522486,c[1][d]=a[d]^1549556828;this.w[0].update(c[0]);this.w[1].update(c[1]);this.R=new b(this.w[0])};sjcl2.misc.hmac.prototype.encrypt=sjcl2.misc.hmac.prototype.mac=function(a){if(this.aa)throw new sjcl2.exception.invalid("encrypt on already updated hmac called!");this.update(a);return this.digest(a)};sjcl2.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]);this.aa=false};sjcl2.misc.hmac.prototype.update=function(a){this.aa=true;this.R.update(a)};sjcl2.misc.hmac.prototype.digest=function(){var a=this.R.finalize(),a=new this.W(this.w[1]).update(a).finalize();this.reset();return a};sjcl2.misc.pbkdf2=function(a,b,c,d,e){c=c||1e4;if(0>d||0>c)throw new sjcl2.exception.invalid("invalid params to pbkdf2");"string"===typeof a&&(a=sjcl2.codec.utf8String.toBits(a));"string"===typeof b&&(b=sjcl2.codec.utf8String.toBits(b));e=e||sjcl2.misc.hmac;a=new e(a);var f,g,h,k,l=[],n=sjcl2.bitArray;for(k=1;32*l.length<(d||1);k++){e=f=a.encrypt(n.concat(b,[k]));for(g=1;g<c;g++)for(f=a.encrypt(f),h=0;h<f.length;h++)e[h]^=f[h];l=l.concat(e)}d&&(l=n.clamp(l,d));return l};sjcl2.prng=function(a){this.c=[new sjcl2.hash.sha256];this.m=[0];this.P=0;this.H={};this.N=0;this.U={};this.Z=this.f=this.o=this.ha=0;this.b=[0,0,0,0,0,0,0,0];this.h=[0,0,0,0];this.L=void 0;this.M=a;this.D=false;this.K={progress:{},seeded:{}};this.u=this.ga=0;this.I=1;this.J=2;this.ca=65536;this.T=[0,48,64,96,128,192,256,384,512,768,1024];this.da=3e4;this.ba=80};sjcl2.prng.prototype={randomWords:function(a,b){var c=[],d;d=this.isReady(b);var e;if(d===this.u)throw new sjcl2.exception.notReady("generator isn't seeded");if(d&this.J){d=!(d&this.I);e=[];var f=0,g;this.Z=e[0]=new Date().valueOf()+this.da;for(g=0;16>g;g++)e.push(4294967296*Math.random()|0);for(g=0;g<this.c.length&&(e=e.concat(this.c[g].finalize()),f+=this.m[g],this.m[g]=0,d||!(this.P&1<<g));g++);this.P>=1<<this.c.length&&(this.c.push(new sjcl2.hash.sha256),this.m.push(0));this.f-=f;f>this.o&&(this.o=f);this.P++;this.b=sjcl2.hash.sha256.hash(this.b.concat(e));this.L=new sjcl2.cipher.aes(this.b);for(d=0;4>d&&(this.h[d]=this.h[d]+1|0,!this.h[d]);d++);}for(d=0;d<a;d+=4)0===(d+1)%this.ca&&y(this),e=z(this),c.push(e[0],e[1],e[2],e[3]);y(this);return c.slice(0,a)},setDefaultParanoia:function(a,b){if(0===a&&"Setting paranoia=0 will ruin your security; use it only for testing"!==b)throw new sjcl2.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=a},addEntropy:function(a,b,c){c=c||"user";var d,e,f=new Date().valueOf(),g=this.H[c],h=this.isReady(),k=0;d=this.U[c];void 0===d&&(d=this.U[c]=this.ha++);void 0===g&&(g=this.H[c]=0);this.H[c]=(this.H[c]+1)%this.c.length;switch(typeof a){case"number":void 0===b&&(b=1);this.c[g].update([d,this.N++,1,b,f,1,a|0]);break;case"object":c=Object.prototype.toString.call(a);if("[object Uint32Array]"===c){e=[];for(c=0;c<a.length;c++)e.push(a[c]);a=e}else for("[object Array]"!==c&&(k=1),c=0;c<a.length&&!k;c++)"number"!==typeof a[c]&&(k=1);if(!k){if(void 0===b)for(c=b=0;c<a.length;c++)for(e=a[c];0<e;)b++,e=e>>>1;this.c[g].update([d,this.N++,2,b,f,a.length].concat(a))}break;case"string":void 0===b&&(b=a.length);this.c[g].update([d,this.N++,3,b,f,a.length]);this.c[g].update(a);break;default:k=1}if(k)throw new sjcl2.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[g]+=b;this.f+=b;h===this.u&&(this.isReady()!==this.u&&A("seeded",Math.max(this.o,this.f)),A("progress",this.getProgress()))},isReady:function(a){a=this.T[void 0!==a?a:this.M];return this.o&&this.o>=a?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=a?this.J|this.u:this.u},getProgress:function(a){a=this.T[a?a:this.M];return this.o>=a?1:this.f>a?1:this.f/a},startCollectors:function(){if(!this.D){this.a={loadTimeCollector:B(this,this.ma),mouseCollector:B(this,this.oa),keyboardCollector:B(this,this.la),accelerometerCollector:B(this,this.ea),touchCollector:B(this,this.qa)};if(window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,false),window.addEventListener("mousemove",this.a.mouseCollector,false),window.addEventListener("keypress",this.a.keyboardCollector,false),window.addEventListener("devicemotion",this.a.accelerometerCollector,false),window.addEventListener("touchmove",this.a.touchCollector,false);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new sjcl2.exception.bug("can't attach event");this.D=true}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,false),window.removeEventListener("mousemove",this.a.mouseCollector,false),window.removeEventListener("keypress",this.a.keyboardCollector,false),window.removeEventListener("devicemotion",this.a.accelerometerCollector,false),window.removeEventListener("touchmove",this.a.touchCollector,false)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=false)},addEventListener:function(a,b){this.K[a][this.ga++]=b},removeEventListener:function(a,b){var c,d,e=this.K[a],f=[];for(d in e)e.hasOwnProperty(d)&&e[d]===b&&f.push(d);for(c=0;c<f.length;c++)d=f[c],delete e[d]},la:function(){C(this,1)},oa:function(a){var b,c;try{b=a.x||a.clientX||a.offsetX||0,c=a.y||a.clientY||a.offsetY||0}catch(d){c=b=0}0!=b&&0!=c&&this.addEntropy([b,c],2,"mouse");C(this,0)},qa:function(a){a=a.touches[0]||a.changedTouches[0];this.addEntropy([a.pageX||a.clientX,a.pageY||a.clientY],1,"touch");C(this,0)},ma:function(){C(this,2)},ea:function(a){a=a.accelerationIncludingGravity.x||a.accelerationIncludingGravity.y||a.accelerationIncludingGravity.z;if(window.orientation){var b=window.orientation;"number"===typeof b&&this.addEntropy(b,1,"accelerometer")}a&&this.addEntropy(a,2,"accelerometer");C(this,0)}};function A(a,b){var c,d=sjcl2.random.K[a],e=[];for(c in d)d.hasOwnProperty(c)&&e.push(d[c]);for(c=0;c<e.length;c++)e[c](b)}function C(a,b){"undefined"!==typeof window&&window.performance&&"function"===typeof window.performance.now?a.addEntropy(window.performance.now(),b,"loadtime"):a.addEntropy(new Date().valueOf(),b,"loadtime")}function y(a){a.b=z(a).concat(z(a));a.L=new sjcl2.cipher.aes(a.b)}function z(a){for(var b=0;4>b&&(a.h[b]=a.h[b]+1|0,!a.h[b]);b++);return a.L.encrypt(a.h)}function B(a,b){return function(){b.apply(a,arguments)}}sjcl2.random=new sjcl2.prng(6);a:try{if(G="undefined"!==typeof module&&module.exports){try{H=__require("crypto")}catch(a){H=null}G=E=H}if(G&&E.randomBytes)D=E.randomBytes(128),D=new Uint32Array(new Uint8Array(D).buffer),sjcl2.random.addEntropy(D,1024,"crypto['randomBytes']");else if("undefined"!==typeof window&&"undefined"!==typeof Uint32Array){F=new Uint32Array(32);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(F);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(F);else break a;sjcl2.random.addEntropy(F,1024,"crypto['getRandomValues']")}}catch(a){"undefined"!==typeof window&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(a))}var D;var E;var F;var G;var H;sjcl2.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(a,b,c,d){c=c||{};d=d||{};var e=sjcl2.json,f=e.g({iv:sjcl2.random.randomWords(4,0)},e.defaults),g;e.g(f,c);c=f.adata;"string"===typeof f.salt&&(f.salt=sjcl2.codec.base64.toBits(f.salt));"string"===typeof f.iv&&(f.iv=sjcl2.codec.base64.toBits(f.iv));if(!sjcl2.mode[f.mode]||!sjcl2.cipher[f.cipher]||"string"===typeof a&&100>=f.iter||64!==f.ts&&96!==f.ts&&128!==f.ts||128!==f.ks&&192!==f.ks&&256!==f.ks||2>f.iv.length||4<f.iv.length)throw new sjcl2.exception.invalid("json encrypt: invalid parameters");"string"===typeof a?(g=sjcl2.misc.cachedPbkdf2(a,f),a=g.key.slice(0,f.ks/32),f.salt=g.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.publicKey&&(g=a.kem(),f.kemtag=g.tag,a=g.key.slice(0,f.ks/32));"string"===typeof b&&(b=sjcl2.codec.utf8String.toBits(b));"string"===typeof c&&(f.adata=c=sjcl2.codec.utf8String.toBits(c));g=new sjcl2.cipher[f.cipher](a);e.g(d,f);d.key=a;f.ct="ccm"===f.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.encrypt(g,b,f.iv,c,f.ts):sjcl2.mode[f.mode].encrypt(g,b,f.iv,c,f.ts);return f},encrypt:function(a,b,c,d){var e=sjcl2.json,f=e.ja.apply(e,arguments);return e.encode(f)},ia:function(a,b,c,d){c=c||{};d=d||{};var e=sjcl2.json;b=e.g(e.g(e.g({},e.defaults),b),c,true);var f,g;f=b.adata;"string"===typeof b.salt&&(b.salt=sjcl2.codec.base64.toBits(b.salt));"string"===typeof b.iv&&(b.iv=sjcl2.codec.base64.toBits(b.iv));if(!sjcl2.mode[b.mode]||!sjcl2.cipher[b.cipher]||"string"===typeof a&&100>=b.iter||64!==b.ts&&96!==b.ts&&128!==b.ts||128!==b.ks&&192!==b.ks&&256!==b.ks||!b.iv||2>b.iv.length||4<b.iv.length)throw new sjcl2.exception.invalid("json decrypt: invalid parameters");"string"===typeof a?(g=sjcl2.misc.cachedPbkdf2(a,b),a=g.key.slice(0,b.ks/32),b.salt=g.salt):sjcl2.ecc&&a instanceof sjcl2.ecc.elGamal.secretKey&&(a=a.unkem(sjcl2.codec.base64.toBits(b.kemtag)).slice(0,b.ks/32));"string"===typeof f&&(f=sjcl2.codec.utf8String.toBits(f));g=new sjcl2.cipher[b.cipher](a);f="ccm"===b.mode&&sjcl2.arrayBuffer&&sjcl2.arrayBuffer.ccm&&b.ct instanceof ArrayBuffer?sjcl2.arrayBuffer.ccm.decrypt(g,b.ct,b.iv,b.tag,f,b.ts):sjcl2.mode[b.mode].decrypt(g,b.ct,b.iv,f,b.ts);e.g(d,b);d.key=a;return 1===c.raw?f:sjcl2.codec.utf8String.fromBits(f)},decrypt:function(a,b,c,d){var e=sjcl2.json;return e.ia(a,e.decode(b),c,d)},encode:function(a){var b,c="{",d="";for(b in a)if(a.hasOwnProperty(b)){if(!b.match(/^[a-z0-9]+$/i))throw new sjcl2.exception.invalid("json encode: invalid property name");c+=d+'"'+b+'":';d=",";switch(typeof a[b]){case"number":case"boolean":c+=a[b];break;case"string":c+='"'+escape(a[b])+'"';break;case"object":c+='"'+sjcl2.codec.base64.fromBits(a[b],0)+'"';break;default:throw new sjcl2.exception.bug("json encode: unsupported type")}}return c+"}"},decode:function(a){a=a.replace(/\s/g,"");if(!a.match(/^\{.*\}$/))throw new sjcl2.exception.invalid("json decode: this isn't json!");a=a.replace(/^\{|\}$/g,"").split(/,/);var b={},c,d;for(c=0;c<a.length;c++){if(!(d=a[c].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new sjcl2.exception.invalid("json decode: this isn't json!");null!=d[3]?b[d[2]]=parseInt(d[3],10):null!=d[4]?b[d[2]]=d[2].match(/^(ct|adata|salt|iv)$/)?sjcl2.codec.base64.toBits(d[4]):unescape(d[4]):null!=d[5]&&(b[d[2]]="true"===d[5])}return b},g:function(a,b,c){void 0===a&&(a={});if(void 0===b)return a;for(var d in b)if(b.hasOwnProperty(d)){if(c&&void 0!==a[d]&&a[d]!==b[d])throw new sjcl2.exception.invalid("required parameter overridden");a[d]=b[d]}return a},sa:function(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&a[d]!==b[d]&&(c[d]=a[d]);return c},ra:function(a,b){var c={},d;for(d=0;d<b.length;d++)void 0!==a[b[d]]&&(c[b[d]]=a[b[d]]);return c}};sjcl2.encrypt=sjcl2.json.encrypt;sjcl2.decrypt=sjcl2.json.decrypt;sjcl2.misc.pa={};sjcl2.misc.cachedPbkdf2=function(a,b){var c=sjcl2.misc.pa,d;b=b||{};d=b.iter||1e3;c=c[a]=c[a]||{};d=c[d]=c[d]||{firstSalt:b.salt&&b.salt.length?b.salt.slice(0):sjcl2.random.randomWords(2,0)};c=void 0===b.salt?d.firstSalt:b.salt;d[c]=d[c]||sjcl2.misc.pbkdf2(a,c,b.iter);return{key:d[c].slice(0),salt:c.slice(0)}};"undefined"!==typeof module&&module.exports&&(module.exports=sjcl2);"function"===typeof define&&define([],function(){return sjcl2})}});var require_browser=__commonJS({"node_modules/web-worker/cjs/browser.js"(exports,module){module.exports=Worker}});function parseFunctionFromText(method=""){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf("=>")+1;if(startindex<=0){startindex=methodString.indexOf("){")}if(startindex<=0){startindex=methodString.indexOf(") {")}return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch{}}}return newFunc}var EventHandler=class{constructor(){this.pushToState={};this.data={};this.triggers={};this.setState=updateObj=>{Object.assign(this.data,updateObj);for(const prop of Object.getOwnPropertyNames(updateObj)){if(this.triggers[prop])this.triggers[prop].forEach(obj=>obj.onchange(this.data[prop]))}return this.data};this.subscribeTrigger=(key,onchange)=>{if(key){if(!this.triggers[key]){this.triggers[key]=[]}let l=this.triggers[key].length;this.triggers[key].push({idx:l,onchange});return this.triggers[key].length-1}else return void 0};this.unsubscribeTrigger=(key,sub)=>{let triggers=this.triggers[key];if(triggers){if(!sub)delete this.triggers[key];else{let idx=void 0;let obj=triggers.find((o,i)=>{if(o.idx===sub){idx=i;return true}});if(obj)triggers.splice(idx,1);return true}}};this.subscribeTriggerOnce=(key,onchange)=>{let sub;let changed=value=>{onchange(value);this.unsubscribeTrigger(key,sub)};sub=this.subscribeTrigger(key,changed)}}};var state=new EventHandler;function addLocalState(props){if(!this._state)this._state={};for(let k in props){if(k==="_state"||k==="graph")continue;else{this._state[k]=props[k];if(k in this)this[k]=props[k];else Object.defineProperty(this,k,{get:()=>{this._state[k]},set:v=>{this._state[k]=v;if(this.state.triggers[this._unique])this.setState({[this._unique]:this._state})},enumerable:true,configurable:true})}}}var GraphNode=class{constructor(properties={},parent,graph){this.nodes=new Map;this._initial={};this._unique=`${Math.random()}`;this.state=state;this.isLooping=false;this.isAnimating=false;this.looper=void 0;this.animation=void 0;this.forward=true;this.backward=false;this.reactive=false;this.runSync=false;this.firstRun=true;this.DEBUGNODE=false;this.addLocalState=addLocalState;this.operator=(...args)=>{return args};this.runOp=(...args)=>{if(this.DEBUGNODE)console.time(this.tag);let result=this.operator(...args);if(result instanceof Promise){result.then(res=>{if(res!==void 0)this.setState({[this.tag]:res});if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};return res})}else{if(result!==void 0)this.setState({[this.tag]:result});if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};}return result};this.setOperator=operator=>{if(typeof operator!=="function")return operator;this.operator=operator.bind(this);return operator};this.runAsync=(...args)=>{return new Promise((res,rej)=>{res(this.run(...args))})};this.transformArgs=(args=[])=>args;this.isRunSync=()=>{return!(this.children&&this.forward||this.parent&&this.backward||this.repeat||this.delay||this.frame||this.recursive||this.branch)};this.run=(...args)=>{if(typeof this.transformArgs==="function")args=this.transformArgs(args,this);if(this.firstRun){this.firstRun=false;this.runSync=this.isRunSync();if(this.animate&&!this.isAnimating){this.runAnimation(this.animation,args)}if(this.loop&&typeof this.loop==="number"&&!this.isLooping){this.runLoop(this.looper,args)}if(this.loop||this.animate)return}if(this.runSync){let res=this.runOp(...args);return res}return new Promise(async resolve=>{if(this){let run=(node,tick=0,...input)=>{return new Promise(async r=>{tick++;let res=await node.runOp(...input);if(node.repeat){while(tick<node.repeat){if(node.delay){setTimeout(async()=>{r(await run(node,tick,...input))},node.delay);break}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node,tick,...input))});break}else res=await node.runOp(...input);tick++}if(tick===node.repeat){r(res);return}}else if(node.recursive){while(tick<node.recursive){if(node.delay){setTimeout(async()=>{r(await run(node,tick,...res))},node.delay);break}else if(node.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{r(await run(node,tick,...res))});break}else res=await node.runOp(...res);tick++}if(tick===node.recursive){r(res);return}}else{r(res);return}})};let runnode=async()=>{let res=await run(this,void 0,...args);if(res!==void 0){if(this.backward&&this.parent instanceof GraphNode){if(Array.isArray(res))await this.runParent(this,...res);else await this.runParent(this,res)}if(this.children&&this.forward){if(Array.isArray(res))await this.runChildren(this,...res);else await this.runChildren(this,res)}if(this.branch){this.runBranch(this,res)}}return res};if(this.delay){setTimeout(async()=>{resolve(await runnode())},this.delay)}else if(this.frame&&window?.requestAnimationFrame){requestAnimationFrame(async()=>{resolve(await runnode())})}else{resolve(await runnode())}}else resolve(void 0)})};this.runParent=async(n,...args)=>{if(n.backward&&n.parent){if(typeof n.parent==="string"){if(n.graph&&n.graph?.get(n.parent)){n.parent=n.graph;if(n.parent)this.nodes.set(n.parent.tag,n.parent)}else n.parent=this.nodes.get(n.parent)}if(n.parent instanceof GraphNode)await n.parent.run(...args)}};this.runChildren=async(n,...args)=>{if(typeof n.children==="object"){for(const key in n.children){if(typeof n.children[key]==="string"){if(n.graph&&n.graph?.get(n.children[key])){n.children[key]=n.graph.get(n.children[key]);if(!n.nodes.get(n.children[key].tag))n.nodes.set(n.children[key].tag,n.children[key])}if(!n.children[key]&&n.nodes.get(n.children[key]))n.children[key]=n.nodes.get(n.children[key])}else if(typeof n.children[key]==="undefined"||n.children[key]===true){if(n.graph&&n.graph?.get(key)){n.children[key]=n.graph.get(key);if(!n.nodes.get(n.children[key].tag))n.nodes.set(n.children[key].tag,n.children[key])}if(!n.children[key]&&n.nodes.get(key))n.children[key]=n.nodes.get(key)}if(n.children[key]?.runOp)await n.children[key].run(...args)}}};this.runBranch=async(n,output)=>{if(n.branch){let keys=Object.keys(n.branch);await Promise.all(keys.map(async k=>{if(typeof n.branch[k].if==="object")n.branch[k].if=stringifyFast(n.branch[k].if);let pass=false;if(typeof n.branch[k].if==="function"){pass=n.branch[k].if(output)}else{if(typeof output==="object"){if(stringifyFast(output)===n.branch[k].if)pass=true}else if(output===n.branch[k].if)pass=true}if(pass){if(n.branch[k].then.run){if(Array.isArray(output))await n.branch[k].then.run(...output);else await n.branch[k].then.run(...output)}else if(typeof n.branch[k].then==="function"){if(Array.isArray(output))await n.branch[k].then(...output);else await n.branch[k].then(output)}else if(typeof n.branch[k].then==="string"){if(n.graph)n.branch[k].then=n.graph.nodes.get(n.branch[k].then);else n.branch[k].then=n.nodes.get(n.branch[k].then);if(n.branch[k].then.run){if(Array.isArray(output))await n.branch[k].then.run(...output);else await n.branch[k].then.run(...output)}}}return pass}))}};this.runAnimation=(animation=this.animation,args=[])=>{this.animation=animation;if(!animation)this.animation=this.operator;if(this.animate&&!this.isAnimating&&"requestAnimationFrame"in window){this.isAnimating=true;let anim=async()=>{if(this.isAnimating){if(this.DEBUGNODE)console.time(this.tag);let result=this.animation.call(this,...args);if(result instanceof Promise){result=await result}if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(this.backward&&this.parent?.run){if(Array.isArray(result))await this.runParent(this,...result);else await this.runParent(this,result)}if(this.children&&this.forward){if(Array.isArray(result))await this.runChildren(this,...result);else await this.runChildren(this,result)}if(this.branch){this.runBranch(this,result)}this.setState({[this.tag]:result})}requestAnimationFrame(anim)}};requestAnimationFrame(anim)}};this.runLoop=(loop=this.looper,args=[],timeout=this.loop)=>{this.looper=loop;if(!loop)this.looper=this.operator;if(typeof timeout==="number"&&!this.isLooping){this.isLooping=true;let looping=async()=>{if(this.isLooping){if(this.DEBUGNODE)console.time(this.tag);let result=this.looper.call(this,...args);if(result instanceof Promise){result=await result}if(this.DEBUGNODE){console.timeEnd(this.tag);if(result!==void 0)console.log(`${this.tag} result:`,result)};if(result!==void 0){if(this.tag)this.setState({[this.tag]:result});if(this.backward&&this.parent?.run){if(Array.isArray(result))await this.runParent(this,...result);else await this.runParent(this,result)}if(this.children&&this.forward){if(Array.isArray(result))await this.runChildren(this,...result);else await this.runChildren(this,result)}if(this.branch){this.runBranch(this,result)}this.setState({[this.tag]:result})}setTimeout(async()=>{await looping()},timeout)}};looping()}};this.setParent=parent=>{this.parent=parent;if(this.backward)this.runSync=false};this.setChildren=children=>{this.children=children;if(this.forward)this.runSync=false};this.add=(n={})=>{if(typeof n==="function")n={operator:n};if(n?.node instanceof GraphNode)n=n.node;if(!(n instanceof GraphNode))n=new GraphNode(n.node??n,this,this.graph);this.nodes.set(n.tag,n);if(this.graph){this.graph.nodes.set(n.tag,n);this.graph.nNodes=this.graph.nodes.size}return n};this.remove=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.tag){this.nodes.delete(n.tag);if(this.children[n.tag])delete this.children[n.tag];if(this.graph){this.graph.nodes.delete(n.tag);this.graph.nNodes=this.graph.nodes.size}this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag)){n2.nodes.delete(n2.tag);if(n2.children[n2.tag])delete n2.children[n2.tag];if(n2.parent?.tag===n2.tag)delete n2.parent}});if(n.ondelete)n.ondelete(n)}if(typeof this._state==="object"){this.state.unsubscribeTrigger(this._unique)}};this.append=(n,parentNode=this)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){parentNode.addChildren(n);if(n.forward)n.runSync=false}};this.subscribe=(callback,tag=this.tag)=>{if(typeof callback==="string"){if(this.graph)callback=this.graph.get(callback);else callback=this.nodes.get(callback)}if(typeof callback==="function"){return this.state.subscribeTrigger(tag,callback)}else if(callback)return this.state.subscribeTrigger(tag,res=>{callback.run(res)})};this.unsubscribe=(sub,tag=this.tag)=>{return this.state.unsubscribeTrigger(tag,sub)};this.subscribeState=callback=>{if(!this.reactive){return void 0}else{if(typeof callback==="string"){if(this.graph)callback=this.graph.get(callback);else callback=this.nodes.get(callback)}if(typeof callback==="function"){return this.state.subscribeTrigger(this._unique,callback)}else if(callback)return this.state.subscribeTrigger(this._unique,_state=>{callback.run(_state)})}};this.addChildren=children=>{if(!this.children)this.children={};if(typeof children==="object"){Object.assign(this.children,children)}this.convertChildrenToNodes();if(this.forward)this.runSync=false};this.callParent=(...args)=>{if(typeof this.parent==="string"){if(this.graph&&this.graph?.get(this.parent)){this.parent=this.graph;if(this.parent)this.nodes.set(this.parent.tag,this.parent)}else this.parent=this.nodes.get(this.parent)}if(typeof this.parent?.operator==="function")return this.parent.runOp(...args)};this.callChildren=(...args)=>{let result;if(typeof this.children==="object"){for(const key in this.children){if(this.children[key]?.runOp)this.children[key].runOp(...args)}}return result};this.getProps=(n=this,getInitial=true)=>{let baseprops={tag:n.tag,operator:n.operator,graph:n.graph,children:n.children,parent:n.parent,forward:n.forward,backward:n.bacward,loop:n.loop,animate:n.animate,frame:n.frame,delay:n.delay,recursive:n.recursive,repeat:n.repeat,branch:n.branch,oncreate:n.oncreate,reactive:n.reactive,DEBUGNODE:n.DEBUGNODE};if(!getInitial){let uniqueprops={};for(const key in this._initial){uniqueprops[key]=this[key]}return Object.assign(baseprops,uniqueprops)}else return{tag:n.tag,operator:n.operator,graph:n.graph,children:n.children,parent:n.parent,forward:n.forward,backward:n.bacward,loop:n.loop,animate:n.animate,frame:n.frame,delay:n.delay,recursive:n.recursive,repeat:n.repeat,branch:n.branch,oncreate:n.oncreate,reactive:n.reactive,DEBUGNODE:n.DEBUGNODE,...this._initial}};this.setProps=(props={})=>{let tmp=Object.assign({},props);if(tmp.children){this.addChildren(props.children);delete tmp.children}if(tmp.operator){this.setOperator(props.operator);delete tmp.operator}Object.assign(tmp,props);this.runSync=this.isRunSync()};this.removeTree=n=>{if(n){if(typeof n==="string")n=this.nodes.get(n)}if(n?.nodes){let checked={};const recursivelyRemove=node=>{if(typeof node.children==="object"&&!checked[node.tag]){checked[node.tag]=true;for(const key in node.children){if(node.children[key].stopNode)node.children[key].stopNode();if(node.children[key].tag){if(this.nodes.get(node.children[key].tag))this.nodes.delete(node.children[key].tag);this.nodes.forEach(n2=>{if(n2.nodes.get(node.children[key].tag))n2.nodes.delete(node.children[key].tag);if(n2.children?.[key]instanceof GraphNode)delete n2.children[key]});if(node.children[key].ondelete&&!this.graph)node.children[key].ondelete(node.children[key]);recursivelyRemove(node.children[key])}}}};if(n.stopNode)n.stopNode();if(n.tag){this.nodes.delete(n.tag);if(this.children?.[n.tag])delete this.children[n.tag];if(this.parent?.tag===n.tag)delete this.parent;if(this[n.tag]instanceof GraphNode)delete this[n.tag];this.nodes.forEach(n2=>{if(n2?.tag){if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag);if(n2.children?.[n2.tag]instanceof GraphNode)delete n2.children[n2.tag]}});recursivelyRemove(n);if(this.graph)this.graph.removeTree(n,checked);else if(n.ondelete)n.ondelete(n)}}};this.checkNodesHaveChildMapped=(n,child,checked={})=>{let tag=n.tag;if(!tag)tag=n.name;if(!checked[tag]){checked[tag]=true;if(n.children){if(child.tag in n.children){if(n.children[child.tag]instanceof GraphNode){if(!n.nodes.get(child.tag))n.nodes.set(child.tag,child);n.children[child.tag]=child;if(!n.firstRun)n.firstRun=true}}}if(n.parent instanceof GraphNode){if(n.nodes.get(child.tag))n.parent.nodes.set(child.tag,child);if(n.parent.children){this.checkNodesHaveChildMapped(n.parent,child,checked)}else if(n.nodes){n.nodes.forEach(n2=>{if(!checked[n2.tag]){this.checkNodesHaveChildMapped(n2,child,checked)}})}}if(n.graph){if(n.parent&&n.parent.name!==n.graph.name){n.graph.nodes.forEach(n2=>{if(!checked[n2.tag]){this.checkNodesHaveChildMapped(n2,child,checked)}})}}}};this.convertChildrenToNodes=(n=this)=>{if(n?.children){for(const key in n.children){if(!(n.children[key]instanceof GraphNode)){if(typeof n.children[key]==="object"){if(!n.children[key].tag)n.children[key].tag=key;if(!n.nodes.get(n.children[key].tag)){n.children[key]=new GraphNode(n.children[key],n,n.graph);this.checkNodesHaveChildMapped(n,n.children[key])}}else{if(typeof n.children[key]==="undefined"||n.children[key]==true){n.children[key]=n.graph.get(key);if(!n.children[key])n.children[key]=n.nodes.get(key)}else if(typeof n.children[key]==="string"){let k=n.children[key];n.children[key]=n.graph.get(k);if(!n.children[key])n.children[key]=n.nodes.get(key)}if(n.children[key]instanceof GraphNode){n.nodes.set(n.children[key].tag,n.children[key]);this.checkNodesHaveChildMapped(n,n.children[key]);if(!(n.children[key].tag in n))n[n.children[key].tag]=n.children[key]}}}}}return n.children};this.stopLooping=(n=this)=>{n.isLooping=false};this.stopAnimating=(n=this)=>{n.isAnimating=false};this.stopNode=(n=this)=>{n.stopAnimating(n);n.stopLooping(n)};this.subscribeNode=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n.tag)this.nodes.set(n.tag,n);if(n)return this.state.subscribeTrigger(this.tag,res=>{if(Array.isArray(res))n.run(...res);else n.run(res)})};this.print=(n=this,printChildren=true,nodesPrinted=[])=>{let dummyNode=new GraphNode;if(typeof n==="string")n=this.nodes.get(n);if(n instanceof GraphNode){nodesPrinted.push(n.tag);let jsonToPrint={tag:n.tag,operator:n.operator.toString()};if(n.parent)jsonToPrint.parent=n.parent.tag;if(typeof n.children==="object"){for(const key in n.children){if(typeof n.children[key]==="string")return n.children[key];if(nodesPrinted.includes(n.children[key].tag))return n.children[key].tag;else if(!printChildren){return n.children[key].tag}else return n.children[key].print(n.children[key],printChildren,nodesPrinted)}}for(const prop in n){if(prop==="parent"||prop==="children")continue;if(typeof dummyNode[prop]==="undefined"){if(typeof n[prop]==="function"){jsonToPrint[prop]=n[prop].toString()}else if(typeof n[prop]==="object"){jsonToPrint[prop]=JSON.stringifyWithCircularRefs(n[prop])}else{jsonToPrint[prop]=n[prop]}}}return JSON.stringify(jsonToPrint)}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.setState=data=>{this.state.setState(data)};this.DEBUGNODES=(debugging=true)=>{this.DEBUGNODE=debugging;this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};if(typeof properties==="function"){properties={operator:properties}}if(typeof properties==="object"){if(properties instanceof GraphNode&&properties._initial)Object.assign(properties,properties._initial);if(properties instanceof Graph){let source=properties;properties={source,operator:input=>{if(typeof input==="object"){let result={};for(const key in input){if(typeof source[key]==="function"){if(Array.isArray(input[key]))result[key]=source[key](...input[key]);else result[key]=source[key](input[key])}else{source[key]=input[key];result[key]=source[key]}}return result}return source}};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node){if(source.node._initial)Object.assign(properties,source.node._initial)}if(source._initial)Object.assign(properties,source._initial);if(source.tag)properties.tag=source.tag;this.nodes=source.nodes;source.node=this;if(graph){source.nodes.forEach(n=>{if(!graph.nodes.get(n.tag)){graph.nodes.set(n.tag,n);graph.nNodes++}})}}if(typeof parent==="string"){if(graph)parent=graph.nodes.get(parent);else parent=void 0}if(properties.tag&&(graph||parent)){let hasnode;if(graph?.nodes){hasnode=graph.nodes.get(properties.tag)}if(!hasnode&&parent?.nodes){hasnode=parent.nodes.get(properties.tag)}if(hasnode){if(this.reactive){this.addLocalState(hasnode)}if(!this.source)this.source=hasnode;let props=hasnode.getProps();delete props.graph;delete props.parent;for(let k in props){const desc=Object.getOwnPropertyDescriptor(properties,k);if(desc&&desc.get&&!desc.set)properties=Object.assign({},properties);else properties[k]=props[k]}}}if(properties?.operator){properties.operator=this.setOperator(properties.operator)}if(!properties.tag&&graph){properties.tag=`node${graph.nNodes}`}else if(!properties.tag){properties.tag=`node${Math.floor(Math.random()*1e10)}`}let keys=Object.getOwnPropertyNames(this);for(const key in properties){if(!keys.includes(key))this._initial[key]=properties[key]}if(properties.children)this._initial.children=Object.assign({},properties.children);Object.assign(this,properties);if(!this.tag){if(graph){this.tag=`node${graph.nNodes}`}else{this.tag=`node${Math.floor(Math.random()*1e10)}`}}if(graph){this.graph=graph;if(graph.nodes.get(this.tag)){this.tag=`${this.tag}${graph.nNodes+1}`}graph.nodes.set(this.tag,this);graph.nNodes++;this.state=graph.state}if(this.reactive){addLocalState(properties);if(typeof this.reactive==="function"){this.state.subscribeTrigger(this._unique,this.reactive)}}if(typeof parent==="object"){this.parent=parent;if(parent instanceof GraphNode||parent instanceof Graph)parent.nodes.set(this.tag,this)}if(typeof properties.tree==="object"){for(const key in properties.tree){if(typeof properties.tree[key]==="object"){if((!properties.tree[key]).tag){properties.tree[key].tag=key}}let node=new GraphNode(properties.tree[key],this,graph);this.nodes.set(node.tag,node)}}if(this.children)this.convertChildrenToNodes(this);if(this.parent instanceof GraphNode||this.parent instanceof Graph)this.checkNodesHaveChildMapped(this.parent,this);if(typeof this.oncreate==="function")this.oncreate(this);if(!this.firstRun)this.firstRun=true;if(this.animation&&!this.animate)this.animate=true}else return properties}};var Graph=class{constructor(tree,tag,props){this.nNodes=0;this.nodes=new Map;this.state=new EventHandler;this._unique=`${Math.random()}`;this.tree={};this.addLocalState=addLocalState;this.add=(n={})=>{if(n?.node instanceof GraphNode)n=n.node;let props=n;if(!(n instanceof GraphNode))n=new GraphNode(props?.node??props,this,this);else{this.nNodes=this.nodes.size;if(n.tag){this.tree[n.tag]=props;this.nodes.set(n.tag,n)}}return n};this.setTree=(tree=this.tree)=>{if(!tree)return;for(const node in tree){const n=this.nodes.get(node);if(!n){if(typeof tree[node]==="function"){this.add({tag:node,operator:tree[node]})}else if(typeof tree[node]==="object"&&!Array.isArray(tree[node])){if(!tree[node].tag)tree[node].tag=node;let newNode=this.add(tree[node]);if(tree[node].aliases){tree[node].aliases.forEach(a=>{this.nodes.set(a,newNode)})}}else{this.add({tag:node,operator:(...args)=>{return tree[node]}})}}else{if(typeof tree[node]==="function"){n.setOperator(tree[node])}else if(typeof tree[node]==="object"){if(tree[node]instanceof GraphNode){this.add(tree[node])}else if(tree[node]instanceof Graph){let source=tree[node];let properties={};if(source.operator)properties.operator=source.operator;if(source.children)properties.children=source.children;if(source.forward)properties.forward=source.forward;if(source.backward)properties.backward=source.backward;if(source.repeat)properties.repeat=source.repeat;if(source.recursive)properties.recursive=source.recursive;if(source.loop)properties.loop=source.loop;if(source.animate)properties.animate=source.animate;if(source.looper)properties.looper=source.looper;if(source.animation)properties.animation=source.animation;if(source.delay)properties.delay=source.delay;if(source.tag)properties.tag=source.tag;if(source.oncreate)properties.oncreate=source.oncreate;if(source.node?._initial)Object.assign(properties,source.node._initial);properties.nodes=source.nodes;properties.source=source;n.setProps(properties)}else{n.setProps(tree[node])}}}}this.nodes.forEach(node=>{if(typeof node.children==="object"){for(const key in node.children){if(typeof node.children[key]==="string"){if(this.nodes.get(node.children[key])){node.children[key]=this.nodes.get(node.children[key])}}else if(node.children[key]===true||typeof node.children[key]==="undefined"){if(this.nodes.get(key)){node.children[key]=this.nodes.get(key)}}if(node.children[key]instanceof GraphNode){node.checkNodesHaveChildMapped(node,node.children[key])}}}if(typeof node.parent==="string"){if(this.nodes.get(node.parent)){node.parent=this.nodes.get(node.parent);node.nodes.set(node.parent.tag,node.parent)}}})};this.get=tag=>{return this.nodes.get(tag)};this.set=n=>{return this.nodes.set(n.tag,n)};this.run=(n,...args)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.run)return n.run(...args);else return void 0};this.runAsync=(n,...args)=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.run)return new Promise((res,rej)=>{res(n.run(...args))});else return new Promise((res,rej)=>{res(void 0)})};this.removeTree=(n,checked)=>{if(n){if(typeof n==="string")n=this.nodes.get(n)}if(n?.nodes){let checked2={};const recursivelyRemove=node=>{if(typeof node.children==="object"&&!checked2[node.tag]){checked2[node.tag]=true;for(const key in node.children){if(node.children[key]?.stopNode)node.children[key].stopNode();if(node.children[key]?.tag){if(this.nodes.get(node.children[key].tag))this.nodes.delete(node.children[key].tag);this.nodes.forEach(n2=>{if(n2.nodes.get(node.children[key].tag))n2.nodes.delete(node.children[key].tag);if(n2.children?.[key]instanceof GraphNode)delete n2.children[key]});if(node.children[key].ondelete)node.children[key].ondelete(node.children[key]);recursivelyRemove(node.children[key])}}}};if(n.stopNode)n.stopNode();if(n.tag){this.nodes.delete(n.tag);if(this.parent?.tag===n.tag)delete this.parent;if(this[n.tag]instanceof GraphNode)delete this[n.tag];this.nodes.forEach(n2=>{if(n2?.tag){if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag);if(n2.children?.[n2.tag]instanceof GraphNode)delete n2.children[n2.tag]}});recursivelyRemove(n);if(n.ondelete)n.ondelete(n)}}};this.remove=n=>{if(typeof n==="string")n=this.nodes.get(n);if(n?.nodes){if(n.stopNode)n.stopNode();if(n?.tag){if(this.nodes.get(n.tag)){this.nodes.delete(n.tag);this.nodes.forEach(n2=>{if(n2.nodes.get(n2.tag))n2.nodes.delete(n2.tag)})}}if(n.ondelete)n.ondelete(n)}return n};this.append=(n,parentNode)=>{parentNode.addChildren(n)};this.callParent=async(n,...args)=>{if(n?.parent){return await n.callParent(...args)}};this.callChildren=async(n,...args)=>{if(n?.children){return await n.callChildren(...args)}};this.subscribe=(n,callback)=>{if(!callback)return;if(n?.subscribe&&typeof callback==="function"){return n.subscribe(callback)}else if(callback instanceof GraphNode||typeof callback==="string")return this.subscribeNode(n,callback);else if(typeof n=="string"){return this.state.subscribeTrigger(n,callback)}};this.unsubscribe=(tag,sub)=>{return this.state.unsubscribeTrigger(tag,sub)};this.subscribeState=callback=>{if(!this.reactive){return void 0}else{if(typeof callback==="string"){if(this.graph)callback=this.graph.get(callback);else callback=this.nodes.get(callback)}if(typeof callback==="function"){return this.state.subscribeTrigger(this._unique,callback)}else if(callback)return this.state.subscribeTrigger(this._unique,_state=>{callback.run(_state)})}};this.subscribeNode=(inputNode,outputNode)=>{let tag;if(inputNode?.tag)tag=inputNode.tag;else if(typeof inputNode==="string")tag=inputNode;if(typeof outputNode==="string")outputNode=this.nodes.get(outputNode);if(inputNode&&outputNode){let sub=this.state.subscribeTrigger(tag,res=>{if(Array.isArray(res))outputNode.run(...res);else outputNode.run(res)});return sub}};this.stopNode=n=>{if(typeof n==="string"){n=this.nodes.get(n)}if(n?.stopNode){n.stopNode()}};this.print=(n,printChildren=true)=>{if(n?.print)return n.print(n,printChildren);else{let printed=`{`;this.nodes.forEach(n2=>{printed+=`
"${n2.tag}:${n2.print(n2,printChildren)}"`});return printed}};this.reconstruct=json=>{let parsed=reconstructObject(json);if(parsed)return this.add(parsed)};this.create=(operator,parentNode,props)=>{return createNode(operator,parentNode,props,this)};this.setState=data=>{this.state.setState(data)};this.DEBUGNODES=(debugging=true)=>{this.nodes.forEach(n=>{if(debugging)n.DEBUGNODE=true;else n.DEBUGNODE=false})};this.tag=tag?tag:`graph${Math.floor(Math.random()*1e11)}`;if(props){console.log(props,props.constructor.name);if(props.reactive){this.addLocalState(props)}else Object.assign(this,props);this._initial=props}if(tree||Object.keys(this.tree).length>0)this.setTree(tree)}};function reconstructNode(json,parentNode,graph){let reconstructed=reconstructObject(json);if(reconstructed)return new GraphNode(reconstructed,parentNode,graph);else return void 0}function reconstructObject(json="{}"){try{let parsed=typeof json==="string"?JSON.parse(json):json;const parseObj=obj=>{for(const prop in obj){if(typeof obj[prop]==="string"){let funcParsed=parseFunctionFromText(obj[prop]);if(typeof funcParsed==="function"){obj[prop]=funcParsed}}else if(typeof obj[prop]==="object"){parseObj(obj[prop])}}return obj};return parseObj(parsed)}catch(err){console.error(err);return void 0}}var stringifyWithCircularRefs=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx--}}}}function checkCircular(key,value){if(value!=null){if(typeof value==="object"){if(key){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}}}return value}return function stringifyWithCircularRefs2(obj,space){try{parents.push(obj);return JSON.stringify(obj,checkCircular,space)}finally{clear()}}}();if(JSON.stringifyWithCircularRefs===void 0){JSON.stringifyWithCircularRefs=stringifyWithCircularRefs}var stringifyFast=function(){const refs=new Map;const parents=[];const path=["this"];function clear(){refs.clear();parents.length=0;path.length=1}function updateParents(key,value){var idx=parents.length-1;if(parents[idx]){var prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value||idx===0){path.push(key);parents.push(value.pushed)}else{while(idx-->=0){prev=parents[idx];if(typeof prev==="object"){if(prev[key]===value){idx+=2;parents.length=idx;path.length=idx;--idx;parents[idx]=value;path[idx]=key;break}}idx++}}}}}function checkValues(key,value){let val;if(value!=null){if(typeof value==="object"){let c=value.constructor.name;if(key&&c==="Object"){updateParents(key,value)}let other=refs.get(value);if(other){return"[Circular Reference]"+other}else{refs.set(value,path.join("."))}if(c==="Array"){if(value.length>20){val=value.slice(value.length-20)}else val=value}else if(c.includes("Set")){val=Array.from(value)}else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean"){val="instanceof_"+c}else if(c==="Object"){let obj={};for(const prop in value){if(value[prop]==null){obj[prop]=value[prop]}else if(Array.isArray(value[prop])){if(value[prop].length>20)obj[prop]=value[prop].slice(value[prop].length-20);else obj[prop]=value[prop]}else if(value[prop].constructor.name==="Object"){obj[prop]={};for(const p in value[prop]){if(Array.isArray(value[prop][p])){if(value[prop][p].length>20)obj[prop][p]=value[prop][p].slice(value[prop][p].length-20);else obj[prop][p]=value[prop][p]}else{if(value[prop][p]!=null){let con=value[prop][p].constructor.name;if(con.includes("Set")){obj[prop][p]=Array.from(value[prop][p])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop][p]="instanceof_"+con}else{obj[prop][p]=value[prop][p]}}else{obj[prop][p]=value[prop][p]}}}}else{let con=value[prop].constructor.name;if(con.includes("Set")){obj[prop]=Array.from(value[prop])}else if(con!=="Number"&&con!=="String"&&con!=="Boolean"){obj[prop]="instanceof_"+con}else{obj[prop]=value[prop]}}}val=obj}else{val=value}}else{val=value}}return val}return function stringifyFast2(obj,space){parents.push(obj);let res=JSON.stringify(obj,checkValues,space);clear();return res}}();if(JSON.stringifyFast===void 0){JSON.stringifyFast=stringifyFast}function createNode(operator,parentNode,props,graph){if(typeof props==="object"){props.operator=operator;return new GraphNode(props,parentNode,graph)}return new GraphNode({operator},parentNode,graph)}var Service=class extends Graph{constructor(options={}){super(void 0,options.name?options.name:`service${Math.floor(Math.random()*1e14)}`,options.props);this.routes={};this.loadDefaultRoutes=false;this.keepState=true;this.firstLoad=true;this.customRoutes={};this.customChildren={};this.init=options=>{if(options)options=Object.assign({},options);else options={};if(options.customRoutes)Object.assign(options.customRoutes,this.customRoutes);else options.customRoutes=this.customRoutes;if(options.customChildren)Object.assign(options.customChildren,this.customChildren);else options.customChildren=this.customChildren;if(Array.isArray(options.routes)){options.routes.forEach(r=>{this.load(r,options.includeClassName,options.routeFormat,options.customRoutes,options.customChildren,options.sharedState)})}else if(options.routes||(Object.keys(this.routes).length>0||this.loadDefaultRoutes)&&this.firstLoad)this.load(options.routes,options.includeClassName,options.routeFormat,options.customRoutes,options.customChildren,options.sharedState)};this.load=(routes,includeClassName=true,routeFormat=".",customRoutes=this.customRoutes,customChildren=this.customChildren,sharedState=true)=>{if(!routes&&!this.loadDefaultRoutes&&(Object.keys(this.routes).length>0||this.firstLoad))return;if(this.firstLoad)this.firstLoad=false;if(customRoutes)customRoutes=Object.assign(this.customRoutes,customRoutes);else customRoutes=this.customRoutes;let service;let allRoutes={};if(routes){if(!(routes instanceof Graph)&&routes?.name&&!routes.setTree){if(routes.module){let mod=routes;routes={};Object.getOwnPropertyNames(routes.module).forEach(prop=>{if(includeClassName)routes[mod.name+routeFormat+prop]=routes.module[prop];else routes[prop]=routes.module[prop]})}else if(typeof routes==="function"){service=new routes({loadDefaultRoutes:this.loadDefaultRoutes});service.load();if(sharedState)service.state=this.state;routes=service.routes;if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren)}}else if(routes instanceof Graph||routes.source instanceof Graph||routes.setTree){service=routes;routes={};if(sharedState)service.state=this.state;if(includeClassName){let name=service.name;if(!name){name=service.tag;service.name=name}if(!name){name=`graph${Math.floor(Math.random()*1e15)}`;service.name=name;service.tag=name}}if(service.customRoutes&&!this.customRoutes)this.customRoutes=service.customRoutes;else if(service.customRoutes&&this.customRoutes)Object.assign(this.customRoutes,service.customRoutes);if(service.customChildren&&!this.customChildren)this.customChildren=service.customChildren;else if(service.customChildren&&this.customChildren)Object.assign(this.customChildren,service.customChildren);service.nodes.forEach(node=>{routes[node.tag]=node;let checked={};let checkChildGraphNodes=(nd,par)=>{if(!checked[nd.tag]||par&&includeClassName&&!checked[par?.tag+routeFormat+nd.tag]){if(!par)checked[nd.tag]=true;else checked[par.tag+routeFormat+nd.tag]=true;if(nd instanceof Graph||nd.source instanceof Graph||nd.setTree){if(sharedState)nd.state=this.state;if(includeClassName){let nm=nd.name;if(!nm){nm=nd.tag;nd.name=nm}if(!nm){nm=`graph${Math.floor(Math.random()*1e15)}`;nd.name=nm;nd.tag=nm}}nd.nodes.forEach(n=>{if(includeClassName&&!routes[nd.tag+routeFormat+n.tag])routes[nd.tag+routeFormat+n.tag]=n;else if(!routes[n.tag])routes[n.tag]=n;checkChildGraphNodes(n,nd)})}}};checkChildGraphNodes(node)})}else if(typeof routes==="object"){let name=routes.constructor.name;if(name==="Object"){name=Object.prototype.toString.call(routes);if(name)name=name.split(" ")[1];if(name)name=name.split("]")[0]}if(name&&name!=="Object"){let module=routes;routes={};Object.getOwnPropertyNames(module).forEach(route=>{if(includeClassName)routes[name+routeFormat+route]=module[route];else routes[route]=module[route]})}}if((service instanceof Graph||service?.setTree)&&service.name&&includeClassName){routes=Object.assign({},routes);for(const prop in routes){let route=routes[prop];delete routes[prop];routes[service.name+routeFormat+prop]=route}}}if(this.loadDefaultRoutes){let rts=Object.assign({},this.defaultRoutes);if(routes){Object.assign(rts,this.routes);routes=Object.assign(rts,routes)}else routes=Object.assign(rts,this.routes);this.loadDefaultRoutes=false}if(!routes)routes=this.routes;let incr=0;for(const tag in routes){incr++;let childrenIter=(route,routeKey)=>{if(typeof route==="object"){if(!route.tag)route.tag=routeKey;if(typeof route?.children==="object"){nested:for(const key in route.children){incr++;if(typeof route.children[key]==="object"){let rt=route.children[key];if(rt.tag&&allRoutes[rt.tag])continue;if(customChildren){for(const k2 in customChildren){rt=customChildren[k2](rt,key,route,routes,allRoutes);if(!rt)continue nested}}if(rt.id&&!rt.tag){rt.tag=rt.id}let k;if(rt.tag){if(allRoutes[rt.tag]){let randkey=`${rt.tag}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[rt.tag]=rt;childrenIter(allRoutes[rt.tag],key);k=rt.tag}}else{if(allRoutes[key]){let randkey=`${key}${incr}`;allRoutes[randkey]=rt;rt.tag=randkey;childrenIter(allRoutes[randkey],key);k=randkey}else{allRoutes[key]=rt;childrenIter(allRoutes[key],key);k=key}}if(service?.name&&includeClassName){allRoutes[service.name+routeFormat+k]=rt;delete allRoutes[k]}else allRoutes[k]=rt}}}}};allRoutes[tag]=routes[tag];childrenIter(routes[tag],tag)}top:for(const route in allRoutes){if(typeof allRoutes[route]==="object"){let r=allRoutes[route];if(typeof r==="object"){if(customRoutes){for(const key in customRoutes){r=customRoutes[key](r,route,allRoutes);if(!r)continue top}}if(r.get){if(typeof r.get=="object"){}}if(r.post){}if(r.delete){}if(r.put){}if(r.head){}if(r.patch){}if(r.options){}if(r.connect){}if(r.trace){}if(r.post&&!r.operator){allRoutes[route].operator=r.post}else if(!r.operator&&typeof r.get=="function"){allRoutes[route].operator=r.get}}}}for(const route in routes){if(typeof routes[route]==="object"){if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}else if(this.routes[route]){if(typeof this.routes[route]==="object")Object.assign(this.routes[route],routes[route]);else this.routes[route]=routes[route]}else this.routes[route]=routes[route]}if(service){for(const key in this.routes){if(this.routes[key]instanceof GraphNode||this.routes[key].constructor.name.includes("GraphNode")){this.nodes.set(key,this.routes[key]);this.nNodes=this.nodes.size}}}else this.setTree(this.routes);for(const prop in routes){if(routes[prop]?.aliases){let aliases=routes[prop].aliases;aliases.forEach(a=>{if(service?.name&&includeClassName)this.routes[service.name+routeFormat+a]=routes[prop];else this.routes[a]=routes[prop]})}}return this.routes};this.unload=(routes=this.routes)=>{if(!routes)return;let service;if(!(routes instanceof Service)&&typeof routes==="function"){service=new Service;routes=service.routes}else if(routes instanceof Service){routes=routes.routes}for(const r in routes){delete this.routes[r];if(this.nodes.get(r))this.remove(r)}return this.routes};this.handleMethod=(route,method,args)=>{let m=method.toLowerCase();let src=this.nodes.get(route);if(!src){src=this.routes[route];if(!src)src=this.tree[route]}if(src?.[m]){if(!(src[m]instanceof Function)){if(args)src[m]=args;return src[m]}else return src[m](args)}else return this.handleServiceMessage({route,args,method})};this.transmit=(...args)=>{if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.receive=(...args)=>{if(args[0]){if(typeof args[0]==="string"){let substr=args[0].substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))args[0]=args[0].replace(/\\/g,"");if(args[0][0]==='"'){args[0]=args[0].substring(1,args[0].length-1)};args[0]=JSON.parse(args[0])}}}if(typeof args[0]==="object"){if(args[0].method){return this.handleMethod(args[0].route,args[0].method,args[0].args)}else if(args[0].route){return this.handleServiceMessage(args[0])}else if(args[0].node){return this.handleGraphNodeCall(args[0].node,args[0].args)}else if(this.keepState){if(args[0].route)this.setState({[args[0].route]:args[0].args});if(args[0].node)this.setState({[args[0].node]:args[0].args})}return args}else return args};this.pipe=(source,destination,endpoint,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.subscribe(res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,method});else this.transmit({route:destination,args:res,method},endpoint)});else return this.subscribe(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})}else if(typeof source==="string")return this.subscribe(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})};this.pipeOnce=(source,destination,endpoint,method,callback)=>{if(source instanceof GraphNode){if(callback)return source.state.subscribeTriggerOnce(source.tag,res=>{let mod=callback(res);if(mod!==void 0)this.transmit({route:destination,args:mod,method});else this.transmit({route:destination,args:res,method},endpoint)});else return this.state.subscribeTriggerOnce(source.tag,res=>{this.transmit({route:destination,args:res,method},endpoint)})}else if(typeof source==="string")return this.state.subscribeTriggerOnce(source,res=>{this.transmit({route:destination,args:res,method},endpoint)})};this.terminate=(...args)=>{this.nodes.forEach(n=>{n.stopNode()})};this.recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"&&!Array.isArray(obj[key])){if(typeof target[key]==="object"&&!Array.isArray(target[key]))this.recursivelyAssign(target[key],obj[key]);else target[key]=this.recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};this.defaultRoutes={"/":{get:()=>{return this.print()},aliases:[""]},ping:()=>{console.log("ping");return"pong"},echo:(...args)=>{this.transmit(...args);return args},assign:source=>{if(typeof source==="object"){Object.assign(this,source);return true}return false},recursivelyAssign:source=>{if(typeof source==="object"){this.recursivelyAssign(this,source);return true}return false},log:{post:(...args)=>{console.log("Log: ",...args)},aliases:["info"]},error:message=>{let er=new Error(message);console.error(message);return er},state:key=>{if(key){return this.state.data[key]}else return this.state.data},printState:key=>{if(key){return stringifyWithCircularRefs(this.state.data[key])}else return stringifyWithCircularRefs(this.state.data)},spliceTypedArray:this.spliceTypedArray,transmit:this.transmit,receive:this.receive,load:this.load,unload:this.unload,pipe:this.pipe,terminate:this.terminate,run:this.run,subscribe:this.subscribe,subscribeNode:this.subscribeNode,unsubscribe:this.unsubscribe,stopNode:this.stopNode,get:this.get,add:this.add,remove:this.remove,setTree:this.setTree,setState:this.setState,print:this.print,reconstruct:this.reconstruct,handleMethod:this.handleMethod,handleServiceMessage:this.handleServiceMessage,handleGraphNodeCall:this.handleGraphNodeCall};if(options.name)this.name=options.name;else options.name=this.tag;if("loadDefaultRoutes"in options){this.loadDefaultRoutes=options.loadDefaultRoutes;this.routes=Object.assign(this.defaultRoutes,this.routes)}if(options||Object.keys(this.routes).length>0)this.init(options)}handleServiceMessage(message){let call;if(typeof message==="object"){if(message.route)call=message.route;else if(message.node)call=message.node}if(call){if(Array.isArray(message.args))return this.run(call,...message.args);else return this.run(call,message.args)}else return message}handleGraphNodeCall(route,args){if(!route)return args;if(args?.args){this.handleServiceMessage(args)}else if(Array.isArray(args))return this.run(route,...args);else return this.run(route,args)}isTypedArray(x){return ArrayBuffer.isView(x)&&Object.prototype.toString.call(x)!=="[object DataView]"}spliceTypedArray(arr,start,end){let s=arr.subarray(0,start);let e;if(end){e=arr.subarray(end+1)}let n;if(s.length>0||e?.length>0)n=new arr.constructor(s.length+e.length);if(s.length>0)n.set(s);if(e&&e.length>0)n.set(e,s.length);return n}};var unsafeRoutes={setRoute:function(fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(this.graph.get(fnName)){this.graph.get(fnName).setOperator(fn.bind(this.graph.get(fnName)))}else{let node=this.graph.add({tag:fnName,operator:fn});if(this.graph instanceof Service)this.graph.load({[fnName]:node})}return true}return false},setNode:function(fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(this.graph.get(fnName)){this.graph.get(fnName).setOperator(fn)}else this.graph.add({tag:fnName,operator:fn});return true}return false},setMethod:function(route,fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;if(this.graph.get(route)){this.graph.get(route)[fnName]=fn}else this.graph.add({tag:fnName,[fnName]:fn});return true}return false},assignRoute:function(route,source){if(this.graph.get(route)&&typeof source==="object"){Object.assign(this.graph.get(route),source)}},transferClass:(classObj,className)=>{if(typeof classObj==="object"){let str=classObj.toString();let message={route:"receiveClass",args:[str,className]};return message}return false},receiveClass:function(stringified,className){if(typeof stringified==="string"){if(stringified.indexOf("class")===0){let cls=(0,eval)("("+stringified+")");let name=className;if(!name)name=cls.name;this.graph[name]=cls;return true}}return false},setGlobal:(key,value)=>{globalThis[key]=value;return true},assignGlobalObject:(target,source)=>{if(!globalThis[target])return false;if(typeof source==="object")Object.assign(globalThis[target],source);return true},setValue:function(key,value){this.graph[key]=value;return true},assignObject:function(target,source){if(!this.graph[target])return false;if(typeof source==="object")Object.assign(this.graph[target],source);return true},setGlobalFunction:(fn,fnName)=>{if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[fnName]=fn;return true}return false},assignFunctionToGlobalObject:function(globalObjectName,fn,fnName){if(!globalThis[globalObjectName])return false;if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.graph[globalObjectName][fnName]=fn;return true}return false},setFunction:function(fn,fnName){if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.graph[fnName]=fn;return true}return false},assignFunctionToObject:function(objectName,fn,fnName){if(!this.graph[objectName])return false;if(typeof fn==="string")fn=parseFunctionFromText(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.graph[objectName][fnName]=fn;return true}return false}};var ECSService=class extends Service{constructor(options){super(options);this.entities={};this.systems={};this.entityMap=new Map;this.entityKeyMap=new Map;this.order=[];this.animating=false;this.entityCt=0;this.systemCt=0;this.updateEntities=(order=this.order,filter,debug=false)=>{order.forEach(k=>{if(this.systems[k]){if(filter){if(debug)debug=performance.now();if(this.entityKeyMap.get(k).length>0)this.systems[k].run(this.entityMap.get(k));if(debug)console.log("system",k,"took",performance.now()-debug,"ms for",Object.keys(this.entityMap.get(k)).length,"entities")}else{if(debug)debug=performance.now();if(this.entityKeyMap.get(k).length>0)this.systems[k].run(this.entities);if(debug)console.log("system",k,"took",performance.now()-debug,"ms for",Object.keys(this.entities).length,"entities")}}})};this.animate=(filter=true,order)=>{if(this.animating===false){this.animating=true;if(typeof requestAnimationFrame!=="undefined"){let anim=()=>{requestAnimationFrame(()=>{if(this.animating){this.updateEntities(order,filter);anim()}})};anim()}else{let looper=()=>{setTimeout(async()=>{if(this.animating){this.updateEntities(order,filter);looper()}},10)};looper()}}};this.stop=()=>{this.animating=false};this.start=filter=>{this.animate(filter)};this.addEntities=(prototype,components={},count=1)=>{let i=0;let newEntities={};while(i<count){let entity=this.addEntity(prototype,components);newEntities[entity.tag]=entity;i++}return Object.keys(newEntities)};this.addEntity=(prototype={},components={})=>{if(!prototype)return;const entity=this.recursivelyAssign({},prototype);entity.components=components;if(Object.keys(components).length===0){Object.keys(this.systems).forEach(k=>{components[k]=true})}if(entity.tag&&this.entities[entity.tag]){this.entityCt++;let tag=entity.tag+this.entityCt;while(this.entities[entity.tag]){this.entityCt++;entity.tag=`${tag}${this.entityCt}`}}else if(!entity.tag)entity.tag=`entity${Math.floor(Math.random()*1e15)}`;this.add(entity);this.entities[entity.tag]=this.nodes.get(entity.tag);this.setupEntity(this.entities[entity.tag]);return this.entities[entity.tag]};this.addSystems=(systems={},order)=>{for(const key in systems){systems[key].tag=key;this.addSystem(systems[key],void 0,void 0,void 0,void 0,order)}return this.systems};this.addSystem=(prototype,setupEntities,setupEntity,operator,remove,order)=>{if(!prototype)return;const system=this.recursivelyAssign({},prototype);if(setupEntities)system.setupEntities=setupEntities;if(setupEntity)system.setupEntity=setupEntity;if(operator)system.operator=operator;if(remove)system.remove=remove;if(system.tag&&this.systems[system.tag]){this.systemCt++;let tag=system.tag+this.systemCt;while(this.systems[system.tag]){this.systemCt++;system.tag=`${tag}${this.systemCt}`}}else if(!system.tag)system.tag=`system${Math.floor(Math.random()*1e15)}`;this.add(system);this.systems[system.tag]=this.nodes.get(system.tag);if(!this.entityMap.get(system.tag))this.entityMap.set(system.tag,{});if(!this.entityKeyMap.get(system.tag))this.entityKeyMap.set(system.tag,[]);this.systems[system.tag].entities=this.entityMap.get(system.tag);this.systems[system.tag].entityKeys=this.entityKeyMap.get(system.tag);if(this.systems[system.tag]?.setupEntities){let filtered=this.filterObject(this.entities,(key,v)=>{if(v.components[system.tag])return true});this.systems[system.tag].setupEntities(filtered);Object.assign(this.entityMap.get(system.tag),filtered)}if(!order)this.order.push(system.tag);else this.order=order;return this.systems[system.tag]};this.setupEntity=entity=>{if(entity?.components){for(const key in entity.components){if(this.systems[key]){this.systems[key].setupEntity(entity);this.entityMap.get(key)[entity.tag]=entity;this.entityKeyMap.get(key).push(entity.tag)}}}};this.removeEntity=tag=>{const entity=this.entities[tag];for(const key in entity.components){if(this.entityMap.get(key)){delete this.entityMap.get(key)[entity.tag];this.entityKeyMap.get(key).splice(this.entityKeyMap.get(key).indexOf(entity.tag),1)}if(this.systems[key]?.remove){this.systems[key].remove(entity,this.entityMap.get(key))}}delete this.entities[tag];return this.remove(tag)};this.removeSystem=tag=>{if(this.systems[tag]?.remove){for(const e in this.entityKeyMap.get(tag)){this.systems[tag].remove(this.entityMap.get(tag)[e],this.entityMap.get(tag))}}delete this.systems[tag];this.entityMap.delete(tag);this.entityKeyMap.delete(tag);this.order.splice(this.order.indexOf(tag),1);return this.remove(tag)};this.setEntities=(entities,props)=>{if(Array.isArray(entities)){entities.forEach(k=>{if(this.entities[k])this.recursivelyAssign(this.entities[k],props)})}else{for(const key in this.entities){this.setEntity(this.entities[key],props)}}return true};this.setEntity=(entity,props)=>{return this.recursivelyAssign(entity,props)};this.bufferValues=(entities,property,keys,buffer)=>{if(!Array.isArray(keys)&&typeof keys==="object")keys=Object.keys(keys);if(!buffer){let entkeys=Object.keys(entities);if(keys)buffer=new Float32Array(entkeys.length*keys.length);else{if(typeof entities[entkeys[0]][property]==="object"){keys=Object.keys(entities[entkeys[0]][property]);buffer=new Float32Array(entkeys.length*keys.length)}else buffer=new Float32Array(entkeys.length)}}let i=0;for(const key in entities){if(entities[key][property]){if(keys){for(let j=0;j<keys.length;j++){buffer[i]=entities[key][property][keys[j]];i++}}else{buffer[i]=entities[key][property];i++}}}return buffer};this.routes={animateEntities:this.animate,startEntityAnimation:this.start,stopEntityAnimation:this.stop,addEntity:this.addEntity,addSystem:this.addSystem,addSystems:this.addSystems,removeEntity:this.removeEntity,removeEntities:this.removeEntities,removeSystem:this.removeSystem,setupEntity:this.setupEntity,addEntities:this.addEntities,filterObject:this.filterObject,bufferValues:this.bufferValues,setEntity:this.setEntity,setEntities:this.setEntities};if(this.routes)this.load(this.routes);if(options.systems)for(const key in options.systems){this.addSystem(options.systems[key],void 0,void 0,void 0,void 0,options.order)}if(options.entities){for(const key in options.entities){this.addEntity(options.entities[key],options.entities[key].components)}}}removeEntities(entities){if(!Array.isArray(entities))entities=Object.keys(entities);entities.forEach(t=>{this.removeEntity(t)})}filterObject(o,filter){return Object.fromEntries(Object.entries(o).filter(([key,value])=>{filter(key,value)}))}};var DOMElement=class extends HTMLElement{constructor(){super();__publicField(this,"template",function(self2=this,props){return`<div> Custom Fragment Props: ${JSON.stringify(props)} </div>`});__publicField(this,"props",{});__publicField(this,"useShadow",false);__publicField(this,"styles");__publicField(this,"oncreate");__publicField(this,"onresize");__publicField(this,"ondelete");__publicField(this,"onchanged");__publicField(this,"renderonchanged",false);__publicField(this,"FRAGMENT");__publicField(this,"STYLE");__publicField(this,"attachedShadow",false);__publicField(this,"obsAttributes",["props","options","onchanged","onresize","ondelete","oncreate","template"]);__publicField(this,"attributeChangedCallback",(name,old,val)=>{if(name==="onchanged"){let onchanged=val;if(typeof onchanged==="string")onchanged=parseFunctionFromText2(onchanged);if(typeof onchanged==="function"){this.onchanged=onchanged;this.state.data.props=this.props;this.state.unsubscribeTrigger("props");this.state.subscribeTrigger("props",this.onchanged);let changed=new CustomEvent("changed",{detail:{props:this.props,self:this}});this.state.subscribeTrigger("props",()=>{this.dispatchEvent(changed)})}}else if(name==="onresize"){let onresize=val;if(typeof onresize==="string")onresize=parseFunctionFromText2(onresize);if(typeof onresize==="function"){if(this.ONRESIZE){try{window.removeEventListener("resize",this.ONRESIZE)}catch(err){}}this.ONRESIZE=ev=>{this.onresize(this.props,this)};this.onresize=onresize;window.addEventListener("resize",this.ONRESIZE)}}else if(name==="ondelete"){let ondelete=val;if(typeof ondelete==="string")ondelete=parseFunctionFromText2(ondelete);if(typeof ondelete==="function"){this.ondelete=()=>{if(this.ONRESIZE)window.removeEventListener("resize",this.ONRESIZE);this.state.unsubscribeTrigger("props");if(ondelete)ondelete(this.props,this)}}}else if(name==="oncreate"){let oncreate=val;if(typeof oncreate==="string")oncreate=parseFunctionFromText2(oncreate);if(typeof oncreate==="function"){this.oncreate=oncreate}}else if(name==="renderonchanged"){let rpc=val;if(typeof this.renderonchanged==="number")this.unsubscribeTrigger(this.renderonchanged);if(typeof rpc==="string")rpc=parseFunctionFromText2(rpc);if(typeof rpc==="function"){this.renderonchanged=this.state.subscribeTrigger("props",p=>{this.render(p);rpc(this,p)})}else if(rpc!=false)this.renderonchanged=this.state.subscribeTrigger("props",this.render)}else if(name==="props"){let newProps=val;if(typeof newProps==="string")newProps=JSON.parse(newProps);Object.assign(this.props,newProps);this.state.setState({props:this.props})}else if(name==="template"){let template=val;this.template=template;this.render(this.props);let created=new CustomEvent("created",{detail:{props:this.props}});this.dispatchEvent(created)}else{let parsed=val;if(name.includes("eval_")){name=name.split("_");name.shift();name=name.join();parsed=parseFunctionFromText2(val)}else if(typeof val==="string"){try{parsed=JSON.parse(val)}catch(err){parsed=val}}this[name]=parsed;if(name!=="props"&&this.props)this.props[name]=parsed}});__publicField(this,"delete",()=>{this.remove();if(typeof this.ondelete==="function")this.ondelete(this.props)});__publicField(this,"render",(props=this.props)=>{if(typeof this.template==="function")this.templateResult=this.template(this,props);else this.templateResult=this.template;if(this.styles)this.templateResult=`<style>${this.styles}</style>${this.templateResult}`;const t=document.createElement("template");if(typeof this.templateResult==="string")t.innerHTML=this.templateResult;else if(this.templateResult instanceof HTMLElement){if(this.templateResult.parentNode){this.templateResult.parentNode.removeChild(this.templateResult)}t.appendChild(this.templateResult)}const fragment=t.content;if(this.FRAGMENT){if(this.useShadow){if(this.STYLE)this.shadowRoot.removeChild(this.STYLE);this.shadowRoot.removeChild(this.FRAGMENT)}else this.removeChild(this.FRAGMENT)}if(this.useShadow){if(!this.attachedShadow){this.attachShadow({mode:"open"}).innerHTML="<slot></slot>";this.attachedShadow=true}if(this.styles){let style=document.createElement("style");style.textContent=this.styles;this.shadowRoot.prepend(style);this.STYLE=style}this.shadowRoot.prepend(fragment);this.FRAGMENT=this.shadowRoot.childNodes[0]}else{this.prepend(fragment);this.FRAGMENT=this.childNodes[0]}let rendered=new CustomEvent("rendered",{detail:{props:this.props,self:this}});this.dispatchEvent(rendered);if(this.oncreate)this.oncreate(this,props)});__publicField(this,"state",{pushToState:{},data:{},triggers:{},setState(updateObj){Object.assign(this.pushToState,updateObj);if(Object.keys(this.triggers).length>0){for(const prop of Object.getOwnPropertyNames(this.triggers)){if(this.pushToState[prop]){this.data[prop]=this.pushToState[prop];delete this.pushToState[prop];this.triggers[prop].forEach(obj=>{obj.onchanged(this.data[prop])})}}}return this.pushToState},subscribeTrigger(key,onchanged=res=>{}){if(key){if(!this.triggers[key]){this.triggers[key]=[]}let l=this.triggers[key].length;this.triggers[key].push({idx:l,onchanged});return this.triggers[key].length-1}else return void 0},unsubscribeTrigger(key,sub){let triggers=this.triggers[key];if(triggers){if(!sub)delete this.triggers[key];else{let idx=void 0;let obj=triggers.find((o,i)=>{if(o.idx===sub){idx=i;return true}});if(obj)triggers.splice(idx,1);return true}}},subscribeTriggerOnce(key=void 0,onchanged=value=>{}){let sub;let changed=value=>{onchanged(value);this.unsubscribeTrigger(key,sub)};sub=this.subscribeTrigger(key,changed)}})}get observedAttributes(){return this.obsAttributes}get obsAttributes(){return this.obsAttributes}set obsAttributes(att){if(typeof att==="string"){this.obsAttributes.push(att)}else if(Array.isArray(att))this.obsAttributes=att}static get tag(){return this.name.toLowerCase()+"-"}static addElement(tag=this.tag,cls=this,extend=void 0){addCustomElement(cls,tag,extend)}connectedCallback(){if(!this.props)this.props={};let newProps=this.getAttribute("props");if(typeof newProps==="string")newProps=JSON.parse(newProps);Object.assign(this.props,newProps);this.state.setState({props:this.props});Array.from(this.attributes).forEach(att=>{let name=att.name;let parsed=att.value;if(name.includes("eval_")||name.includes("()")){if(name.includes("eval_"))name=name.split("_");else if(name.includes("()"))name=name.substring(0,name.indexOf("("));name.shift();name=name.join();parsed=parseFunctionFromText2(att.value)}else if(typeof att.value==="string"){try{parsed=JSON.parse(att.value)}catch(err){parsed=att.value}}if(!this[name]){Object.defineProperties(this,att,{value:parsed,writable:true,get(){return this[name]},set(val){this.setAttribute(name,val)}})}this[name]=parsed;if(name!=="props")this.props[name]=parsed;this.obsAttributes.push(name)});let resizeevent=new CustomEvent("resized",{detail:{props:this.props,self:this}});let changed=new CustomEvent("changed",{detail:{props:this.props,self:this}});let deleted=new CustomEvent("deleted",{detail:{props:this.props,self:this}});let created=new CustomEvent("created",{detail:{props:this.props,self:this}});this.render(this.props);this.dispatchEvent(created);this.state.subscribeTrigger("props",()=>{this.dispatchEvent(changed)});if(typeof this.onresize==="function"){if(this.ONRESIZE){try{window.removeEventListener("resize",this.ONRESIZE)}catch(err){}}this.ONRESIZE=ev=>{this.onresize(this,this.props);this.dispatchEvent(resizeevent)};window.addEventListener("resize",this.ONRESIZE)}if(typeof this.ondelete==="function"){let ondelete=this.ondelete;this.ondelete=(props=this.props)=>{if(this.ONRESIZE)window.removeEventListener("resize",this.ONRESIZE);this.state.unsubscribeTrigger("props");this.dispatchEvent(deleted);ondelete(this,props)}}if(typeof this.onchanged==="function"){this.state.data.props=this.props;this.state.subscribeTrigger("props",this.onchanged)}if(this.renderonchanged){let rpc=this.renderonchanged;if(typeof this.renderonchanged==="number")this.unsubscribeTrigger(this.renderonchanged);if(typeof rpc==="string")rpc=parseFunctionFromText2(rpc);if(typeof rpc==="function"){this.renderonchanged=this.state.subscribeTrigger("props",p=>{this.render(p);rpc(this,p)})}else if(rpc!==false)this.renderonchanged=this.state.subscribeTrigger("props",this.render)}}get props(){return this.props}set props(newProps={}){this.setAttribute("props",newProps)}get template(){return this.template}set template(template){this.setAttribute("template",template)}get render(){return this.render}get delete(){return this.delete}get state(){return this.state}get onchanged(){return this.onchanged}set onchanged(onchanged){this.setAttribute("onchanged",onchanged)}get styles(){return this.styles}set styles(templateStr){this.styles=templateStr;if(this.querySelector("style")){this.querySelector("style").innerHTML=templateStr}else{this.render()}}get renderonchanged(){return this.renderonchanged}set renderonchanged(onchanged){this.setAttribute("renderonchanged",onchanged)}get onresize(){return this.props}set onresize(onresize){this.setAttribute("onresize",onresize)}get ondelete(){return this.props}set ondelete(ondelete){this.setAttribute("ondelete",ondelete)}get oncreate(){return this.oncreate}set oncreate(oncreate){this.setAttribute("oncreated",oncreate)}};function addCustomElement(cls,tag,extend=null){try{if(extend){if(tag)window.customElements.define(tag,cls,{extends:extend});else window.customElements.define(cls.name.toLowerCase()+"-",cls,{extends:extend})}else{if(tag)window.customElements.define(tag,cls);else window.customElements.define(cls.name.toLowerCase()+"-",cls)}}catch(err){}}function parseFunctionFromText2(method){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf(")");return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;try{if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch(err){newFunc=(0,eval)(method)}}}}catch(err){}return newFunc}var DOMService=class extends Service{constructor(options,parentNode,interpreters){super({props:options?.props,name:options?.name?options.name:`dom${Math.floor(Math.random()*1e15)}`});this.loadDefaultRoutes=false;this.keepState=true;this.parentNode=document.body;this.interpreters={md:(template,options)=>{if(typeof markdownit==="undefined"){document.head.insertAdjacentHTML("beforeend",`
                    <script src='https://unpkg.com/markdown-it@latest/dist/markdown-it.min.js'><\/script>`)}let md=globalThis.markdownit();let html=md.render(template);options.template=html},jsx:(template,options)=>{if(!options.parentNode)options.parentNode=this.parentNode;if(typeof options.parentNode==="string")options.parentNode=document.getElementById(options.parentNode);if(typeof ReactDOM==="undefined"){document.head.insertAdjacentHTML("beforeend",`
                    <script src='https://unpkg.com/react@latest/umd/react.production.min.js'><\/script>
                    <script src='https://unpkg.com/react-dom@latest/umd/react-dom.production.min.js'><\/script>`)}options.template="";let onrender=options.onrender;options.onrender=(self2,info)=>{const modal=ReactDOM.createPortal(template,options.id);onrender(self2,info)}}};this.customRoutes={"dom":(r,route,routes)=>{if(!(r instanceof GraphNode)){if(r.element?.parentNode?.id&&r.graph?.parentNode?.id){if(r.graph.parentNode.id===r.element.id){r.parentNode=this.parentNode}}else{if(r.template){if(!r.tag)r.tag=route;this.addComponent(r,r.generateChildElementNodes)}else if(r.context){if(!r.tag)r.tag=route;this.addCanvasComponent(r)}else if(r.tagName||r.element){if(!r.tag)r.tag=route;this.addElement(r,r.generateChildElementNodes)}}}return r}};this.customChildren={"dom":(rt,routeKey,parent,routes,checked)=>{if((parent.tag||parent.id)&&(parent.template||parent.context||parent.tagName||parent.element)&&(rt.template||rt.context||rt.tagName||rt.element)&&!rt.parentNode){if(parent.tag)rt.parentNode=parent.tag;if(parent.id)rt.parentNode=parent.id}return rt}};this.elements={};this.components={};this.templates={};this.addElement=(options,generateChildElementNodes=false)=>{let elm=this.createElement(options);if(!options.element)options.element=elm;if(!options.operator)options.operator=function(props){if(typeof props==="object")for(const key in props){if(this.element){if(typeof this.element[key]==="function"&&typeof props[key]!=="function"){if(Array.isArray(props[key]))this.element[key](...props[key]);else this.element[key](props[key])}else if(key==="style"){Object.assign(this.element[key],props[key])}else this.element[key]=props[key]}}return props};let node=this.resolveGraphNode(elm,options);let divs=Array.from(elm.querySelectorAll("*"));if(generateChildElementNodes){divs=divs.map((d,i)=>this.addElement({element:d}))}this.elements[options.id]={element:elm,node,parentNode:options.parentNode,divs};if(!node.ondelete)node.ondelete=node2=>{elm.remove();if(options.onremove)options.onremove.call(this.elements[options.id].node,elm,this.elements[options.id])};if(options.onresize){let onresize=options.onresize;options.onresize=ev=>{onresize.call(this.elements[options.id].node,ev,elm,this.elements[options.id])};window.addEventListener("resize",options.onresize)}return this.elements[options.id]};this.createElement=options=>{let elm;if(options.element){if(typeof options.element==="string"){elm=document.querySelector(options.element);if(!elm)elm=document.getElementById(options.element)}else elm=options.element}else if(options.tagName)elm=document.createElement(options.tagName);else if(options.id&&document.getElementById(options.id))elm=document.getElementById(options.id);if(!elm)return void 0;this.updateOptions(options,elm);return elm};this.updateOptions=(options,element)=>{if(!options.id&&options.tag)options.id=options.tag;if(!options.tag&&options.id)options.tag=options.id;if(!options.id)options.id=`${options.tagName??"element"}${Math.floor(Math.random()*1e15)}`;let p=options.parentNode;delete options.parentNode;Object.defineProperty(options,"parentNode",{get:function(){return element.parentNode},set:v=>{if(element.parentNode){element.parentNode.removeChild(element)}this.resolveParentNode(element,v?v:this.parentNode,options,options.onrender)},enumerable:true,configurable:true});options.parentNode=p?p:this.parentNode;element.id=options.id;if(options.style)Object.assign(element.style,options.style);if(options.attributes){for(let key in options.attributes){if(typeof options.attributes[key]==="function")element[key]=(...args)=>options.attributes[key](...args);else element[key]=options.attributes[key]}}if(!options.attributes?.innerHTML&&options.innerHTML){element.innerHTML=options.innerHTML}else if(!options.attributes?.innerText&&options.innerText){element.innerText=options.innerText}return options};this.resolveParentNode=(elm,parentNode,options,oncreate)=>{if(!elm.parentNode){setTimeout(()=>{if(typeof parentNode==="string")parentNode=document.getElementById(parentNode);if(parentNode&&typeof parentNode==="object"){parentNode.appendChild(elm)}if(oncreate)oncreate.call(elm.node,elm,this.elements[options.id]);if(elm.node.animation||elm.node.animate){elm.node.runAnimation()}if(elm.node.looper||typeof elm.node.loop==="number"&&elm.node.loop){elm.node.runLoop()}},.01)}};this.resolveGraphNode=(element,options)=>{let node;if(this.nodes.get(options.id)?.element?.parentNode?.id===options.parentNode||this.nodes.get(options.id)?.parentNode===options.parentNode){node=this.nodes.get(options.id)}else{let parentId=options.parentNode instanceof HTMLElement?options.parentNode?.id:typeof options.parentNode==="string"?options.parentNode:void 0;let parent;if(parentId)parent=this.nodes.get(parentId);node=new GraphNode(options instanceof Graph?options:Object.assign({},options),parent,this)}delete node.parentNode;Object.defineProperty(node,"parentNode",{get:function(){return element.parentNode},set:v=>{if(element.parentNode){element.parentNode.removeChild(element)}this.resolveParentNode(element,v?v:this.parentNode,options,options.onrender)},enumerable:true,configurable:true});if(!node["element"])Object.defineProperty(node,"element",{get:()=>element,set:v=>{element=v;node.nodes.forEach(n=>{if(node.source?._unique===n.graph?._unique)n.parentNode=element})}});node.element=element;element.node=node;let initialOptions=options._initial??options;for(let key in initialOptions){if(typeof initialOptions[key]==="function"){const desc=Object.getOwnPropertyDescriptor(initialOptions,key);if(desc&&desc.get&&!desc.set)initialOptions=Object.assign({},initialOptions);initialOptions[key]=initialOptions[key].bind(node)}else if(key==="attributes"){for(let key2 in initialOptions.attributes){if(typeof initialOptions.attributes[key2]==="function"){initialOptions.attributes[key2]=initialOptions.attributes[key2].bind(node)}}}}return node};this.addComponent=(options,generateChildElementNodes=true)=>{if(options.onrender){let oncreate=options.onrender;options.onrender=element=>{oncreate.call(element.node,element,options)}}if(options.onresize){let onresize=options.onresize;options.onresize=element=>{onresize.call(element.node,element,options)}}if(options.onremove){let ondelete=options.onremove;options.onremove=element=>{ondelete.call(element.node,self,options)}}if(typeof options.renderonchanged==="function"){let renderonchanged=options.renderonchanged;options.renderonchanged=element=>{renderonchanged.call(element.node,element,options)}}if(options.interpreter&&options.interpreter!=="wc"){this.interpreters[options.interpreter](options.template,options)}class CustomElement extends DOMElement{constructor(){super(...arguments);this.props=options.props;this.styles=options.styles;this.useShadow=options.useShadow;this.template=options.template;this.oncreate=options.onrender;this.onresize=options.onresize;this.ondelete=options.onremove;this.renderonchanged=options.renderonchanged}}if(!options.tagName)options.tagName=`custom-element${Math.random()*1e15}`;CustomElement.addElement(options.tagName);let elm=document.createElement(options.tagName);let completeOptions=this.updateOptions(options,elm);this.templates[completeOptions.id]=completeOptions;let divs=Array.from(elm.querySelectorAll("*"));if(generateChildElementNodes){divs=divs.map(d=>this.addElement({element:d}))}if(!options.element)options.element=elm;if(!options.operator)options.operator=function op(props){if(typeof props==="object")for(const key in props){if(this.element){if(typeof this.element[key]==="function"&&typeof props[key]!=="function"){if(Array.isArray(props[key]))this.element[key](...props[key]);else this.element[key](props[key])}else if(key==="style"){Object.assign(this.element[key],props[key])}else this.element[key]=props[key]}}return props};let node=this.resolveGraphNode(elm,options);if(!node.ondelete)node.ondelete=node2=>{elm.delete()};this.components[completeOptions.id]={element:elm,class:CustomElement,node,divs,...completeOptions};return this.components[completeOptions.id]};this.addCanvasComponent=options=>{if(!options.canvas){options.template=`<canvas `;if(options.width)options.template+=`width="${options.width}"`;if(options.height)options.template+=`height="${options.height}"`;options.template+=` ></canvas>`}else options.template=options.canvas;if(options.onrender){let oncreate=options.onrender;options.onrender=element=>{oncreate.call(element.node,element,options)}}if(options.onresize){let onresize=options.onresize;options.onresize=element=>{onresize.call(element.node,element,options)}}if(options.ondelete){let ondelete=options.onremove;options.onremove=element=>{ondelete.call(element.node,element,options)}}if(typeof options.renderonchanged==="function"){let renderonchanged=options.renderonchanged;options.renderonchanged=element=>{renderonchanged.call(element.node,element,options)}}class CustomElement extends DOMElement{constructor(){super(...arguments);this.props=options.props;this.styles=options.styles;this.template=options.template;this.oncreate=options.onrender;this.onresize=options.onresize;this.ondelete=options.onremove;this.renderonchanged=options.renderonchanged}}if(!options.tagName)options.tagName=`custom-element${Math.random()*1e15}`;CustomElement.addElement(options.tagName);let elm=document.createElement(options.tagName);const completeOptions=this.updateOptions(options,elm);let animation=()=>{if(this.components[completeOptions.id]?.animating){this.components[completeOptions.id].draw(this.components[completeOptions.id].element,this.components[completeOptions.id]);requestAnimationFrame(animation)}};this.templates[completeOptions.id]=completeOptions;if(!options.element)options.element=elm;if(!options.operator)options.operator=function op(props){if(typeof props==="object")for(const key in props){if(this.element){if(typeof this.element[key]==="function"&&typeof props[key]!=="function"){if(Array.isArray(props[key]))this.element[key](...props[key]);else this.element[key](props[key])}else if(key==="style"){Object.assign(this.element[key],props[key])}else this.element[key]=props[key]}}return props};let node=this.resolveGraphNode(elm,options);if(!node.ondelete)node.ondelete=node2=>{elm.delete()};let canvas=elm.querySelector("canvas");if(completeOptions.style)Object.assign(canvas.style,completeOptions.style);let context;if(typeof completeOptions.context==="object")context=options.context;else if(typeof completeOptions.context==="string")context=canvas.getContext(completeOptions.context);this.components[completeOptions.id]={element:elm,class:CustomElement,template:completeOptions.template,canvas,node,...completeOptions};this.components[completeOptions.id].context=context;elm.canvas=canvas;elm.context=context;node.canvas=canvas;node.context=context;return this.components[completeOptions.id]};this.terminate=element=>{if(typeof element==="object"){if(element.animating)element.animating=false;if(element.element)element=element.element}else if(typeof element==="string"&&this.components[element]){if(this.components[element].node.isAnimating)this.components[element].node.stopNode();if(this.components[element].divs)this.components[element].divs.forEach(d=>this.terminate(d));let temp=this.components[element].element;delete this.components[element];element=temp}else if(typeof element==="string"&&this.elements[element]){if(this.elements[element].divs)this.elements[element].divs.forEach(d=>this.terminate(d));let temp=this.elements[element].element;if(this.elements[element].onresize)window.removeEventListener("resize",this.elements[element].onresize);if(this.elements[element].ondelete)this.elements[element].ondelete(temp,this.elements[element]);delete this.elements[element];element=temp}if(element){if(this.nodes.get(element.id)){this.removeTree(element.id)}if(element instanceof DOMElement)element.delete();else if(element?.parentNode){element.parentNode.removeChild(element)}return true}return false};this.defaultRoutes={addElement:this.addElement,addComponent:this.addComponent,addCanvasComponent:this.addCanvasComponent,terminate:this.terminate};if(options?.parentNode)parentNode=options.parentNode;if(typeof parentNode==="string")parentNode=document.getElementById(parentNode);if(parentNode instanceof HTMLElement)this.parentNode=parentNode;if(interpreters){Object.assign(this.interpreters,interpreters)}this.init(options)}};var import_sjcl=__toESM(require_sjcl());var E2EEService=class extends Service{constructor(options,keys,secureKeys,secret){super(options);this.name="e2ee";this.securedKeys=false;this.addKey=(key,_id)=>{if(!_id)_id=`key${Math.floor(Math.random()*1e15)}`;if(this.securedKeys&&this.secret&&this.encryptedkeys){let decrypted=JSON.parse(import_sjcl.default.decrypt(this.secret,this.encryptedkeys));decrypted[_id]={key,_id};this.encryptedkeys=import_sjcl.default.encrypt(this.secret,decrypted).cipher;return this.encryptedkeys}else this.keys[_id]={key,_id};return this.keys[_id]};this.encryptRoute=(message,keyId)=>{if(typeof message==="object")message=JSON.stringify(message);let key;if(this.securedKeys&&this.secret&&this.encryptedkeys){let decrypted=JSON.parse(import_sjcl.default.decrypt(this.secret,this.encryptedkeys));if(decrypted[keyId]?.key){message=import_sjcl.default.encrypt(this.secret,decrypted[keyId].key).cipher}}else{if(this.keys[keyId]){if(!key)key=keyId;message=this.encrypt(message,key)}}message={route:"decryptRoute",args:[message,keyId]};return message};this.decryptRoute=(message,keyId)=>{let decryptedMessage=message;if(typeof message==="object"){if(!keyId){if(typeof message.keyId==="string")keyId=message.keyId}if(keyId){let key;if(this.securedKeys&&this.secret&&this.encryptedkeys){let decrypted=JSON.parse(import_sjcl.default.decrypt(this.secret,this.encryptedkeys));if(decrypted[keyId]?.key){decryptedMessage=import_sjcl.default.decrypt(this.secret,decrypted[keyId].key);return decryptedMessage}}else{if(this.keys[keyId])key=this.keys[keyId].key;if(key)decryptedMessage=this.decrypt(message.args,key)}}}else{let key;if(this.securedKeys&&this.secret&&this.encryptedkeys){let decrypted=JSON.parse(import_sjcl.default.decrypt(this.secret,this.encryptedkeys));if(decrypted[keyId]?.key){decryptedMessage=import_sjcl.default.decrypt(this.secret,decrypted[keyId].key);return decryptedMessage}}else{if(this.keys[keyId])key=this.keys[keyId].key;if(key)decryptedMessage=this.decrypt(message,key)}}return decryptedMessage};this.transmit=(message,keyId)=>{if(!keyId){keyId=Object.keys(this.keys)[0]}message=this.encryptRoute(message,keyId);return this.handleServiceMessage(message)};this.receive=(message,keyId)=>{if(!keyId){keyId=Object.keys(this.keys)[0]}message=this.decryptRoute(message,keyId);if(typeof message==="string"){let substr=message.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))message=message.replace(/\\/g,"");if(message[0]==='"'){message=message.substring(1,message.length-1)};message=JSON.parse(message)}}if(typeof message==="object"){if(typeof message.method==="string"){return this.handleMethod(message.route,message.method,message.args)}else if(typeof message.route==="string"){return this.handleServiceMessage(message)}else if(typeof message.node==="string"||message.node instanceof GraphNode){return this.handleGraphNodeCall(message.node,message.args)}else if(this.keepState){if(message.route)this.setState({[message.route]:message.args});if(message.node)this.setState({[message.node]:message.args})}}else return message};this.routes={encryptRoute:this.encryptRoute,decryptRoute:this.decryptRoute,encrypt:this.encrypt,decrypt:this.decrypt,generateSecret:E2EEService.generateSecret,addKey:this.addKey};if(keys){if(secureKeys&&secret){this.securedKeys=true;this.encryptedkeys=import_sjcl.default.encrypt(secret,JSON.stringify(keys)).cipher;this.secret=secret}else Object.assign(this.keys,keys)}}static generateSecret(){return import_sjcl.default.codec.base64.fromBits(import_sjcl.default.random.randomWords(8,10))}encrypt(message,key){message=import_sjcl.default.encrypt(key,message).cipher;return message}decrypt(message,key){message=import_sjcl.default.decrypt(key,message);return message}};var _HTTPfrontend=class extends Service{constructor(options,path,fetched){super(options);this.name="http";this.fetchProxied=false;this.listening={};this.GET=(url="http://localhost:8080/ping",type="",mimeType)=>{if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"GET",url,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.POST=(message,url="http://localhost:8080/echo",type="",mimeType)=>{if(typeof message==="object"&&(type==="json"||type==="text"||!type)){message=JSON.stringify(message)}if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"POST",url,data:message,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.transmit=(message,url)=>{let obj=message;if(typeof obj==="object"){message=JSON.stringify(obj)}if(obj?.method?.toLowerCase()=="get"||message?.toLowerCase()==="get")return this.GET(url);return this.post(message,url)};this.transponder=(url,message,type="",mimeType)=>{if(typeof message==="object")message=JSON.stringify(message);let method="GET";if(message){method="POST"}if(type==="json")mimeType="application/json";else return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method,url,data:message,responseType:type,onload:ev=>{let body=xhr.response;if(typeof body==="string"){let substr=body.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))body=body.replace(/\\/g,"");if(body[0]==='"'){body=body.substring(1,body.length-1)};body=JSON.parse(body)}}if(typeof body?.method==="string"){return resolve(this.handleMethod(body.route,body.method,body.args))}else if(typeof body?.route==="string"){return resolve(this.handleServiceMessage(body))}else if(typeof body?.node==="string"||body.node instanceof GraphNode){return resolve(this.handleGraphNodeCall(body.node,body.args))}else return resolve(body)},onabort:er=>{reject(er)}})}).catch(console.error)};this.listen=(path="0",fetched=async(clone,args,response)=>{const result=await clone.text();const returned=this.receive(result);this.setState({[response.url]:returned})})=>{this.listening[path]={};let listenerId=`${path}${Math.floor(Math.random()*1e15)}`;this.listening[path][listenerId]=fetched;if(!this.fetchProxied){globalThis.fetch=new Proxy(globalThis.fetch,{apply(fetch,that,args){const result=fetch.apply(that,args);result.then(response=>{if(!response.ok)return;if(this.listening["0"]){for(const key in this.listeners){const clone=response.clone();this.listening["0"][key](clone,args,response)}}else{for(const key in this.listening){if(response.url.includes(key)){for(const key2 in this.listening[path]){const clone=response.clone();this.listening[path][key2](clone,args,response)}break}}}}).catch(er=>{console.error(er)});return result}});this.fetchProxied=true}return listenerId};this.stopListening=(path,listener)=>{if(!path&&path!==0){for(const key in this.listening)delete this.listening[key]}else{if(!listener)delete this.listening[path];else delete this.listeners[listener]}};this.routes={request:this.request,GET:this.GET,POST:this.POST,transponder:this.transponder,listen:this.listen,stopListening:this.stopListening};this.load(this.routes);this.listen(path,fetched)}};var HTTPfrontend=_HTTPfrontend;HTTPfrontend.request=options=>{const xhr=new XMLHttpRequest;if(options.responseType)xhr.responseType=options.responseType;else options.responseType="json";if(options.mimeType){xhr.overrideMimeType(options.mimeType)}if(options.onload)xhr.addEventListener("load",options.onload,false);if(options.onprogress)xhr.addEventListener("progress",options.onprogress,false);if(options.onabort)xhr.addEventListener("abort",options.onabort,false);if(options.onloadend)xhr.addEventListener("loadend",options.onloadend,false);if(options.onerror)xhr.addEventListener("error",options.onerror,false);xhr.open(options.method,options.url,true,options.user,options.pass);if(!options.onerror)xhr.onerror=function(){xhr.abort()};xhr.send(options.data);return xhr};var SSEfrontend=class extends Service{constructor(options){super(options);this.name="sse";this.eventsources={};this.connections={eventsources:this.eventsources};this.openSSE=options=>{let source=new EventSource(options.url);let sse={source,type:"eventsource",...options};if(!("keepState"in options))options.keepState=true;if(!options.events)options.events={};if(options.events.close){let close=options.events.close;options.events.close=ev=>{if(sse.onclose)sse.onclose(ev,sse);close(ev,sse)}}if(options.events.open){let open=options.events.open;options.events.open=ev=>{if(sse.onopen)sse.onopen(ev,sse);open(ev,sse)}}if(options.events.error){let error=options.events.error;options.events.error=ev=>{if(sse.onerror)sse.onerror(ev,sse);error(ev,sse)}}if(options.events.message){let message=options.events.message;options.events.message=ev=>{if(sse.onmessage)sse.onmessage(ev,sse);message(ev,sse)}}if(!options.events.message){options.events.message=(ev,sse2)=>{let data=ev.data;if(data){if(typeof data==="string"){let substr=data.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))data=data.replace(/\\/g,"");if(data[0]==='"'){data=data.substring(1,data.length-1)};data=JSON.parse(data);if(data.route==="setId"&&sse2){sse2._id=data.args;options.events.message=(e,sse3)=>{const result2=this.receive(e.data,sse3);if(options.keepState)this.setState({[options.url]:e.data})}}}}}const result=this.receive(ev.data,sse2);if(options.keepState)this.setState({[options.url]:data})}}if(!options.events.error)options.events.error=(ev,sse2)=>{this.terminate(sse2);delete this.eventsources[options.url]};if(options.events){if(!options.evoptions)options.evoptions=false;for(const key in options.events){if(typeof options.events[key]!=="function"){options.events[key]=ev=>{const result=this.receive(ev.data,sse);if(options.keepState)this.setState({[options.url]:result})}}else{let l=options.events[key];options.events[key]=ev=>{l(ev,sse)}}source.addEventListener(key,options.events[key],options.evoptions)}}let send=message=>{return this.transmit(message,options.url)};let request=(message,method,sessionId)=>{return this.request(message,options.url,sessionId,method)};let post=(route,args,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,options.url)};let run=(route,args,method,sessionId)=>{return this.request({route,args},options.url,method,sessionId)};let subscribe=(route,callback)=>{return this.subscribeToSSE(route,options.url,callback,sse._id)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options.url)};sse.send=send;sse.request=request;sse.post=post;sse.run=run;sse.subscribe=subscribe;sse.unsubscribe=unsubscribe;sse.terminate=terminate;sse.graph=this;this.eventsources[options.url]=sse;return sse};this.POST=(message,url="http://localhost:8080/echo",type="",mimeType)=>{if(typeof message==="object"&&(type==="json"||type==="text"||!type)){message=JSON.stringify(message)}if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=HTTPfrontend.request({method:"POST",url,data:message,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};this.transmit=(message,url)=>{return this.POST(message,url,"json")};this.request=(message,url,method,sessionId)=>{return new Promise((res,rej)=>{let callbackId=`${Math.random()}`;let req={route:"runRequest",args:[message,url,callbackId,sessionId]};if(method)req.method=method;let evs=this.eventsources[url].source;let onmessage=ev=>{let data=ev.data;if(typeof data==="string"){if(data.includes("callbackId"))data=JSON.parse(data)}if(typeof data==="object"){if(data.callbackId===callbackId){evs.removeEventListener("message",onmessage);res(data.args)}}};evs.addEventListener("message",onmessage);this.POST(message,url,"json")})};this.runRequest=(message,url,callbackId,sessionId)=>{let res=this.receive(message);if(url){if(res instanceof Promise){res.then(r=>{let message2={args:r,callbackId,sessionId};this.POST(message2,url,"json")})}else{let message2={args:res,callbackId,sessionId};this.POST(message2,url,"json")}}return res};this.subscribeSSE=(route,url)=>{return this.subscribe(route,res=>{this.POST(res,url,"json")})};this.subscribeToSSE=(route,url,callback,sessionId)=>{if(url){this.subscribe(url,res=>{let msg=JSON.parse(res);if(msg?.callbackId===route){if(!callback)this.setState({[url]:msg.args});else if(typeof callback==="string"){this.run(callback,msg.args)}else callback(msg.args)}});return this.eventsources[url].run("subscribeSSE",[route,url,sessionId])}};this.terminate=sse=>{if(typeof sse==="string"){let str=sse;sse=this.eventsources[sse];delete this.eventsources[str]}if(!sse)return;if(typeof sse==="object"){if(sse.source){sse=sse.source}if(sse instanceof EventSource){if(sse.readyState!==2)sse.close()}}};this.routes={openSSE:{operator:this.openSSE,aliases:["open"]},request:this.request,runRequest:this.runRequest,transmit:this.transmit,POST:this.POST,terminate:this.terminate,subscribeToSSE:this.subscribeToSSE,subscribeSSE:this.subscribeSSE};this.load(this.routes)}};var WSSfrontend=class extends Service{constructor(options){super(options);this.name="wss";this.sockets={};this.connections={sockets:this.sockets};this.openWS=(options={host:"localhost",port:7e3,path:void 0,protocol:"ws",onclose:(ev,socket,wsinfo)=>{if(ev.target.url)delete this.sockets[ev.target.url]}})=>{let protocol=options.protocol;if(!protocol)protocol="ws";let address=`${protocol}://${options.host}`;if(!("keepState"in options))options.keepState=true;if(options.port)address+=":"+options.port;if(options.path&&!options.path?.startsWith("/"))address+="/";if(options.path)address+=options.path;if(this.sockets[address]?.socket){if(this.sockets[address].socket.readyState===this.sockets[address].socket.OPEN)this.sockets[address].socket.close()}const socket=new WebSocket(address);if(!options.onmessage){if(!options._id){options.onmessage=(data,ws,wsinfo)=>{if(data){if(typeof data==="string"){let substr=data.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))data=data.replace(/\\/g,"");if(data[0]==='"'){data=data.substring(1,data.length-1)};data=JSON.parse(data);if(data.route==="setId"){this.sockets[address]._id=data.args;options.onmessage=(data2,ws2,wsinfo2)=>{this.receive(data2);if(options.keepState){this.setState({[address]:data2})}}}}}}let res=this.receive(data);if(options.keepState)this.setState({[address]:data})}}else{options.onmessage=(data,ws,wsinfo)=>{this.receive(data,socket,this.sockets[address]);if(options.keepState){this.setState({[address]:data})}}}}if(options.onmessage){socket.addEventListener("message",ev=>{this.sockets[address].onmessage(ev.data,socket,this.sockets[address])})}socket.addEventListener("open",ev=>{if(this.sockets[address].onopen)this.sockets[address].onopen(ev,socket,this.sockets[address])});socket.addEventListener("close",ev=>{if(this.sockets[address].onclose)this.sockets[address].onclose(ev,socket,this.sockets[address])});socket.addEventListener("error",ev=>{if(this.sockets[address].onerror)this.sockets[address].onerror(ev,socket,this.sockets[address])});let send=message=>{return this.transmit(message,socket)};let post=(route,args,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,socket)};let run=(route,args,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options._id,callbackId]};if(method)req.args[0].method=method;let onmessage=ev=>{if(typeof ev.data==="string"&&ev.data.indexOf("{")>-1)ev.data=JSON.parse(ev.data);if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){socket.removeEventListener("message",onmessage);res(ev.data.args)}}};socket.addEventListener("message",onmessage);this.transmit(req,socket)})};let request=(message,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options._id,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="string"&&ev.data.indexOf("{")>-1)ev.data=JSON.parse(ev.data);if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){socket.removeEventListener("message",onmessage);res(ev.data.args)}}};socket.addEventListener("message",onmessage);this.transmit(req,socket)})};let subscribe=(route,callback)=>{return this.subscribeToSocket(route,options._id,callback)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options._id)};this.sockets[address]={type:"socket",socket,address,send,post,run,request,subscribe,unsubscribe,terminate,graph:this,...options};return this.sockets[address]};this.transmit=(data,ws)=>{if(typeof data==="object")data=JSON.stringify(data);if(!ws){let s=this.sockets[Object.keys(this.sockets)[0]];if(s)ws=s.socket}if(ws instanceof WebSocket&&ws?.readyState===1)ws.send(data);return true};this.terminate=ws=>{if(!ws){let key=Object.keys(this.sockets)[0];if(key)ws=this.sockets[key].socket}else if(typeof ws==="string"){for(const k in this.sockets){if(k.includes(ws)){ws=this.sockets[k].socket;break}}}if(ws instanceof WebSocket){if(ws.readyState===ws.OPEN)ws.close()}return true};this.request=(message,ws,_id,method)=>{let callbackId=`${Math.random()}`;let req={route:"runRequest",args:[message,_id,callbackId]};if(method)req.method=method;return new Promise((res,rej)=>{let onmessage=ev=>{let data=ev.data;if(typeof data==="string"){if(data.includes("callbackId"))data=JSON.parse(data)}if(typeof data==="object"){if(data.callbackId===callbackId){ws.removeEventListener("message",onmessage);res(data.args)}}};ws.addEventListener("message",onmessage);ws.send(JSON.stringify(req))})};this.runRequest=(message,ws,callbackId)=>{let res=this.receive(message);if(typeof ws==="string"){for(const s in this.sockets){if(s===ws){ws=this.sockets[s].socket;break}}}if(ws){if(res instanceof Promise){res.then(v=>{res={args:v,callbackId};if(ws instanceof WebSocket)ws.send(JSON.stringify(res))})}else{res={args:res,callbackId};if(ws instanceof WebSocket)ws.send(JSON.stringify(res))}}return res};this.subscribeSocket=(route,socket)=>{if(typeof socket==="string"&&this.sockets[socket]){socket=this.sockets[socket].socket}if(typeof socket==="object")return this.subscribe(route,res=>{if(socket.readyState===socket.OPEN){if(res instanceof Promise){res.then(r=>{socket.send(JSON.stringify({args:r,callbackId:route}))})}else{socket.send(JSON.stringify({args:res,callbackId:route}))}}})};this.subscribeToSocket=(route,socketId,callback)=>{if(typeof socketId==="string"&&this.sockets[socketId]){this.subscribe(socketId,res=>{let msg=JSON.parse(res);if(msg?.callbackId===route){if(!callback)this.setState({[socketId]:msg.args});else if(typeof callback==="string"){this.run(callback,msg.args)}else callback(msg.args)}});return this.sockets[socketId].request({route:"subscribeSocket",args:[route,socketId]})}};this.routes={openWS:{operator:this.openWS,aliases:["open"]},request:this.request,runRequest:this.runRequest,terminate:this.terminate,subscribeSocket:this.subscribeSocket,subscribeToSocket:this.subscribeToSocket,unsubscribe:this.unsubscribe};this.load(this.routes)}};var WebRTCfrontend=class extends Service{constructor(options,iceServers){super(options);this.name="webrtc";this.rtc={};this.iceServers=[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]},{urls:["stun:stun2.l.google.com:19302"]},{urls:["stun:stun3.l.google.com:19302"]},{urls:["stun:stun4.l.google.com:19302"]}];this.connections={rtc:this.rtc};this.createStream=options=>{let stream=new MediaStream;for(const key in options){let track=options[key].track;if(!(track instanceof MediaStreamTrack)&&typeof track==="object"){track=new MediaStreamTrack;track.applyConstraints(options[key].track);stream.addTrack(track)}if(track instanceof MediaStreamTrack){stream.addTrack(track);track.onmute=options[key].onmute;track.onunmute=options[key].onunmute;track.onended=options[key].onended}}return stream};this.openRTC=async options=>{if(!options)options={};if(!options._id)options._id=`rtc${Math.floor(Math.random()*1e15)}`;if(!options.config)options.config={iceServers:this.iceServers};let rtc=new RTCPeerConnection(options.config);if(!this.rtc[options._id]){if(!options.channels)options.channels={"data":true};let firstChannel;for(const key in options.channels){firstChannel=key;break}let send=message=>{return this.transmit(message,options._id,options.channels[firstChannel])};let post=(route,args,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,options._id,options.channels[firstChannel])};let run=(route,args,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options._id,callbackId]};if(method)req.args[0].method=method;let sub;let ondata=data=>{if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(data);if(typeof data==="object"){if(data.callbackId===callbackId){this.unsubscribe(options._id,sub);res(data.args)}}};sub=this.subscribe(options._id,ondata);this.transmit(req,options._id,options.channels[firstChannel])})};let request=(message,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options._id,callbackId]};if(method)req.method=method;let sub;let ondata=data=>{if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(data);if(typeof data==="object"){if(data.callbackId===callbackId){this.unsubscribe(options._id,sub);res(data.args)}}};sub=this.subscribe(options._id,ondata);this.transmit(req,options._id,options.channels[firstChannel])})};let subscribe=(route,callback)=>{return this.subscribeToRTC(route,options._id,firstChannel,callback)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options._id)};this.rtc[options._id]={rtc,_id:options._id,request,run,post,send,subscribe,unsubscribe,terminate,graph:this,...options};if(!options.ondatachannel)options.ondatachannel=ev=>{this.rtc[options._id].channels[ev.channel.label]=ev.channel;if(!options.ondata){ev.channel.addEventListener("message",mev=>{this.receive(mev.data,ev.channel,this.rtc[options._id]);this.setState({[options._id]:mev.data})})}else ev.channel.addEventListener("message",mev=>{options.ondata(mev.data,ev.channel,this.rtc[options._id])})};if(options.channels){for(const channel in options.channels){if(options.channels[channel]instanceof RTCDataChannel){}else if(typeof options.channels[channel]==="object"){options.channels[channel]=this.addDataChannel(rtc,channel,options.channels[channel])}else{options.channels[channel]=this.addDataChannel(rtc,channel)}options.channels[channel].addEventListener("message",mev=>{this.receive(mev.data,channel,this.rtc[options._id]);this.setState({[options._id]:mev.data})})}}rtc.ontrack=options.ontrack;rtc.onicecandidate=options.onicecandidate;rtc.onicecandidateerror=options.onicecandidateerror;rtc.ondatachannel=options.ondatachannel;rtc.onnegotiationneeded=options.onnegotiationneeded;rtc.oniceconnectionstatechange=options.oniceconnectionstatechange;rtc.onconnectionstatechange=options.onconnectionstatechange;rtc.addEventListener("connectionstatechange",ev=>{if(rtc.connectionState==="closed"||rtc.connectionState==="failed"){if(this.rtc[options._id].onclose){this.rtc[options._id].onclose(this.rtc[options._id])}}})}else{Object.assign(this.rtc[options._id],options)}if(options.hostdescription&&!options.peerdescription){if(!options.onicecandidate)options.onicecandidate=ev=>{if(ev.candidate){let icecandidate=ev.candidate;if(!this.rtc[options._id].peercandidates)this.rtc[options._id].peercandidates={};this.rtc[options._id].peercandidates[`peercandidate${Math.floor(Math.random()*1e15)}`]=icecandidate}};return await new Promise((res,rej)=>{if(typeof options.hostdescription==="string"){options.hostdescription=JSON.parse(decodeURIComponent(options.hostdescription))}const description=new RTCSessionDescription(options.hostdescription);options.hostdescription=description;rtc.setRemoteDescription(description).then(()=>{if(options.hostcandidates){for(const prop in options.hostcandidates){const candidate=new RTCIceCandidate(options.hostcandidates[prop]);rtc.addIceCandidate(candidate).catch(console.error)}}rtc.createAnswer(options.answer).then(answer=>rtc.setLocalDescription(answer)).then(()=>{this.rtc[options._id].peerdescription=encodeURIComponent(JSON.stringify(rtc.localDescription));res(this.rtc[options._id])})}).catch(rej)})}if(options.peerdescription){this.answerPeer(rtc,options)}if(!options.onicecandidate&&!this.rtc[options._id]?.onicecandidate)options.onicecandidate=ev=>{if(ev.candidate){let icecandidate=ev.candidate;if(!this.rtc[options._id].hostcandidates)this.rtc[options._id].hostcandidates={};this.rtc[options._id].hostcandidates[`hostcandidate${Math.floor(Math.random()*1e15)}`]=icecandidate}};return await new Promise((res,rej)=>{rtc.createOffer(options.offer).then(offer=>rtc.setLocalDescription(offer)).then(()=>{this.rtc[options._id].hostdescription=encodeURIComponent(JSON.stringify(rtc.localDescription));res(this.rtc[options._id])})})};this.addUserMedia=(rtc,options={audio:false,video:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560}]}})=>{let senders=[];navigator.mediaDevices.getUserMedia(options).then(stream=>{let tracks=stream.getTracks();tracks.forEach(track=>{senders.push(rtc.addTrack(track,stream))})});return senders};this.addTrack=(rtc,track,stream)=>{rtc.addTrack(track,stream);return true};this.removeTrack=(rtc,sender)=>{rtc.removeTrack(sender);return true};this.addDataChannel=(rtc,name,options)=>{return rtc.createDataChannel(name,options)};this.transmit=(data,id,channel)=>{if(typeof data==="object"||typeof data==="number")data=JSON.stringify(data);if(!channel&&id){let keys=Object.keys(this.rtc[id].channels);if(keys[0])channel=this.rtc[id].channels[keys[0]]}if(typeof channel==="string"){if(id){channel=this.rtc[id].channels[channel]}else{for(const id2 in this.rtc){if(this.rtc[id2].channels[channel]instanceof RTCDataChannel)this.rtc[id2].channels[channel].send(data)}}}if(channel instanceof RTCDataChannel)channel.send(data);return true};this.terminate=rtc=>{let tx;if(typeof rtc==="string"){let room=this.rtc[rtc];delete this.rtc[rtc];if(room){tx=room.rtc}}else if(typeof rtc==="object"){tx=rtc.rtc}if(rtc instanceof RTCPeerConnection){rtc.close()}else if(tx){if(tx)tx.close()}return true};this.request=(message,channel,_id,method)=>{let callbackId=`${Math.random()}`;let req={route:"runRequest",args:[message,_id,callbackId]};if(method)req.method=method;return new Promise((res,rej)=>{let onmessage=ev=>{let data=ev.data;if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(ev.data);if(typeof data==="object"){if(data.callbackId===callbackId){channel.removeEventListener("message",onmessage);res(data.args)}}};channel.addEventListener("message",onmessage);channel.send(JSON.stringify(req))})};this.runRequest=(message,channel,callbackId)=>{let res=this.receive(message);if(channel){if(typeof channel==="string"){for(const key in this.rtc){if(key===channel){channel=this.rtc[key].channels.data;break}}}if(res instanceof Promise)res.then(v=>{res={args:v,callbackId};if(channel instanceof RTCDataChannel)channel.send(JSON.stringify(res));return res});else{res={args:res,callbackId};if(channel instanceof RTCDataChannel)channel.send(JSON.stringify(res))}}return res};this.subscribeRTC=(route,rtcId,channel)=>{if(typeof channel==="string"&&this.rtc[rtcId]){channel=this.rtc[rtcId].channels[channel]}return this.subscribe(route,res=>{if(res instanceof Promise){res.then(r=>{channel.send(JSON.stringify({args:r,callbackId:route}))})}else{channel.send(JSON.stringify({args:res,callbackId:route}))}})};this.subscribeToRTC=(route,rtcId,channelId,callback)=>{if(typeof channelId==="string"&&this.rtc[rtcId]){let c=this.rtc[rtcId];let channel=c.channels[channelId];if(channel){this.subscribe(rtcId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[rtcId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return c.request({route:"subscribeRTC",args:[route,channelId]})}}};this.routes={openRTC:{operator:this.openRTC,aliases:["open"]},request:this.request,runRequest:this.runRequest,createStream:this.createStream,addUserMedia:this.addUserMedia,addTrack:this.addTrack,removeTrack:this.removeTrack,addDataChannel:this.addDataChannel,subscribeRTC:this.subscribeRTC,subscribeToRTC:this.subscribeToRTC,unsubscribe:this.unsubscribe,terminate:this.terminate};this.load(this.routes);if(iceServers)this.iceServers=iceServers}addIceCandidate(rtc,candidate){return rtc.addIceCandidate(candidate)}answerPeer(rtc,options){return new Promise((res,rej)=>{if(typeof options.peerdescription==="string"){options.peerdescription=JSON.parse(decodeURIComponent(options.peerdescription))}const description=new RTCSessionDescription(options.peerdescription);options.peerdescription=description;if(this.rtc[options._id])this.rtc[options._id].peerdescription=description;rtc.setRemoteDescription(description).then(()=>{if(options.peercandidates){for(const prop in options.peercandidates){const candidate=new RTCIceCandidate(options.peercandidates[prop]);if(this.rtc[options._id])this.rtc[options._id].peercandidates[prop]=options.peercandidates[prop];rtc.addIceCandidate(candidate).catch(console.error)}}res(this.rtc[options._id]?this.rtc[options._id]:rtc)}).catch(rej)})}};var import_web_worker=__toESM(require_browser());var WorkerService=class extends Service{constructor(options){super(options);this.name="worker";this.workers={};this.threadRot=0;this.connections={workers:this.workers};this.customRoutes={"worker":(route,routeKey,routes)=>{let rt=route;if(rt?.worker||rt?.workerId||rt?.workerUrl){let worker=this.loadWorkerRoute(rt,routeKey);if(worker){if(!rt.parentRoute&&rt.parent?.callback)rt.parentRoute=rt.parent.callback;if(rt.parent&&!rt.portId){if(typeof rt.parent==="string"){if(rt.tag!==rt.parent&&worker._id!==rt.parent)rt.portId=this.establishMessageChannel(worker,rt.parent)}else if(rt.tag!==rt.parent.tag&&worker._id!==rt.parent.tag){rt.portId=this.establishMessageChannel(worker,rt.parent.worker)}};if(rt.parentRoute){if(!rt.stopped){if(typeof rt.parent==="string"&&rt.parent===worker._id){worker.run("subscribe",[rt.parentRoute,rt.callback])}else if(rt.tag===rt.parent?.tag||worker._id===rt.parent?.tag){worker.run("subscribe",[rt.parentRoute,rt.callback])}else worker.run("subscribeToWorker",[rt.parentRoute,rt.portId,rt.callback,rt.blocking]).then(sub=>{worker.workerSubs[rt.parentRoute+rt.portId].sub=sub})}if(!(typeof rt.parent==="string"&&rt.parent===worker._id)&&!(rt.tag===rt.parent?.tag||worker._id===rt.parent?.tag))worker.workerSubs[rt.parentRoute+rt.portId]={sub:null,route:rt.parentRoute,portId:rt.portId,callback:rt.callback,blocking:rt.blocking}}else if(rt.parent){if(typeof rt.parent==="string"){if(!rt.stopped){if(rt.parent===worker._id){worker.run("subscribe",[rt.parent,rt.callback])}else worker.run("subscribeToWorker",[rt.parent,rt.portId,rt.callback,rt.blocking]).then(sub=>{worker.workerSubs[rt.parentRoute+rt.portId].sub=sub})}if(!(typeof rt.parent==="string"&&rt.parent===worker._id))worker.workerSubs[rt.parentRoute+rt.portId]={sub:null,route:rt.parentRoute,portId:rt.portId,callback:rt.callback,blocking:rt.blocking}}else if(rt.parent?.tag){if(!rt.stopped){if(rt.tag===rt.parent?.tag||worker._id===rt.parent?.tag){worker.run("subscribe",[rt.parent.tag,rt.callback])}else worker.run("subscribeToWorker",[rt.parent.tag,rt.portId,rt.callback,rt.blocking]).then(sub=>{worker.workerSubs[rt.parentRoute+rt.portId].sub=sub})}if(!(rt.tag===rt.parent?.tag||worker._id===rt.parent?.tag))worker.workerSubs[rt.parentRoute+rt.portId]={sub:null,route:rt.parentRoute,portId:rt.portId,callback:rt.callback,blocking:rt.blocking}}}}}else if(rt.parent&&rt.parentRoute){if(typeof rt.parent==="string"&&routes[rt.parent]?.worker){routes[rt.parent].worker.subscribe(rt.parentRoute,rt.tag,rt.blocking)}else if(rt.parent?.worker){rt.parent.worker.subscribe(rt.parentRoute,rt.tag,rt.blocking)}}return rt}};this.customChildren={"worker":(child,childRouteKey,parent,routes,checked)=>{if(!child.parentRoute&&parent?.callback)child.parentRoute=parent.callback;if(!child.parent&&parent.tag)child.parent=parent.tag;return child}};this.postMessage=(message,target,transfer)=>{if(this.workers[target]){this.workers[target].send(message,transfer)}else{globalThis.postMessage(message,target,transfer)}};this.addWorker=options=>{let worker;if(!options._id)options._id=`worker${Math.floor(Math.random()*1e15)}`;if(options.url)worker=new import_web_worker.default(options.url);else if(options.port){worker=options.port}else if(this.workers[options._id]){if(this.workers[options._id].port)worker=this.workers[options._id].port;else worker=this.workers[options._id].worker}if(!worker)return;let send=(message,transfer)=>{return this.transmit(message,worker,transfer)};let post=(route,args,transfer,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,worker,transfer)};let run=(route,args,transfer,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options._id,callbackId]};if(method)req.args[0].method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let request=(message,transfer,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options._id,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let workerSubs={};let subscribe=(route,callback,blocking)=>{return this.subscribeToWorker(route,options._id,callback,blocking)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let start=async(route,portId,callback,blocking)=>{if(route)await run("subscribeToWorker",[route,portId,callback,blocking]).then(sub=>{if(sub)workerSubs[route+portId]={sub,route,portId,callback,blocking}});else for(const key in workerSubs){if(typeof workerSubs[key].sub!=="number")await run("subscribeToWorker",[workerSubs[key].route,workerSubs[key].portId,workerSubs[key].callback,workerSubs[key].blocking]).then(sub=>{workerSubs[key].sub=sub})}return true};let stop=async(route,portId)=>{if(route&&portId&&workerSubs[route+portId]){await run("unsubscribe",[route,workerSubs[route+portId].sub]);workerSubs[route+portId].sub=false}else{for(const key in workerSubs){if(typeof workerSubs[key].sub==="number"){await run("unpipeWorkers",[workerSubs[key].route,workerSubs[key].portId,workerSubs[key].sub])}workerSubs[key].sub=false}}return true};let terminate=()=>{for(const key in workerSubs){if(typeof workerSubs[key].sub==="number"){run("unpipeWorkers",[workerSubs[key].route,workerSubs[key].portId,workerSubs[key].sub])}workerSubs[key].sub=false}return this.terminate(options._id)};if(!options.onmessage)options.onmessage=ev=>{this.receive(ev.data);this.setState({[options._id]:ev.data})};if(!options.onerror){options.onerror=ev=>{console.error(ev.data)}}worker.onmessage=options.onmessage;worker.onerror=options.onerror;this.workers[options._id]={worker,send,post,run,request,subscribe,unsubscribe,terminate,start,stop,postMessage:worker.postMessage,workerSubs,graph:this,...options};return this.workers[options._id]};this.toObjectURL=scriptTemplate=>{let blob=new Blob([scriptTemplate],{type:"text/javascript"});return URL.createObjectURL(blob)};this.transmit=(message,worker,transfer)=>{if(!transfer){transfer=this.getTransferable(message)}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){worker.postMessage(message,transfer)}else if(typeof worker==="string"){if(this.workers[worker]){if(this.workers[worker].port)this.workers[worker].port.postMessage(message,transfer);else if(this.workers[worker].worker)this.workers[worker].worker.postMessage(message,transfer)}}else{let keys=Object.keys(this.workers);this.workers[keys[this.threadRot]].worker.postMessage(message,transfer);this.threadRot++;if(this.threadRot===keys.length)this.threadRot=0}return message};this.terminate=worker=>{let onclose;if(typeof worker==="string"){let obj=this.workers[worker];if(obj)delete this.workers[worker];worker=obj.worker;if(obj.onclose)onclose=obj.onclose}if(worker instanceof import_web_worker.default){worker.terminate();if(onclose)onclose(worker);return true}if(worker instanceof MessagePort){worker.close();if(onclose)onclose(worker);return true}return false};this.establishMessageChannel=(worker,worker2)=>{let workerId;if(typeof worker==="string"){workerId=worker;if(this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker2=this.workers[worker].worker}}else if(worker?.worker){worker=worker.worker}if(typeof worker2==="string"){if(this.workers[worker2]){if(this.workers[worker2].port)worker2=this.workers[worker2].port;else worker2=this.workers[worker2].worker}}else if(worker2?.worker){worker2=worker2.worker}if(worker instanceof import_web_worker.default||worker instanceof MessagePort){let channel=new MessageChannel;let portId=`port${Math.floor(Math.random()*1e15)}`;worker.postMessage({route:"addWorker",args:{port:channel.port1,_id:portId}},[channel.port1]);if(worker2 instanceof import_web_worker.default||worker2 instanceof MessagePort){worker2.postMessage({route:"addWorker",args:{port:channel.port2,_id:portId}},[channel.port2])}else if(workerId&&this.workers[workerId]){channel.port2.onmessage=this.workers[workerId].onmessage;this.workers[workerId].port=channel.port2}return portId}return false};this.request=(message,workerId,transfer,method)=>{let worker=this.workers[workerId].worker;return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};this.runRequest=(message,worker,callbackId)=>{let res=this.receive(message);if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}if(res instanceof Promise){res.then(r=>{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:r,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:r,callbackId})})}else{if(worker instanceof import_web_worker.default||worker instanceof MessagePort)worker.postMessage({args:res,callbackId});else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:res,callbackId})}return res};this.subscribeWorker=(route,worker,blocking)=>{let callback;if(blocking){let blocked=false;callback=res=>{if(!blocked){blocked=true;if(res instanceof Promise){res.then(r=>{if(worker?.run)worker.run("triggerSubscription",[route,worker._id,r]).then(ret=>{blocked=false})})}else{if(worker?.run)worker.run("triggerSubscription",[route,worker._id,res]).then(ret=>{blocked=false})}}}}else{callback=res=>{if(res instanceof Promise){res.then(r=>{if(worker?.postMessage)worker.postMessage({args:r,callbackId:route});else if(globalThis.postMessage)globalThis.postMessage({args:r,callbackId:route})})}else{if(worker?.postMessage)worker.postMessage({args:res,callbackId:route});else if(globalThis.postMessage)globalThis.postMessage({args:res,callbackId:route})}}}if(!blocking&&worker?.port){worker=worker.port}else if(!blocking&&worker?.worker){worker=worker.worker}else if(typeof worker==="string"&&this.workers[worker]){if(blocking)worker=this.workers[worker];else if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}return this.subscribe(route,callback)};this.subscribeToWorker=(route,workerId,callback,blocking)=>{if(typeof workerId==="string"&&this.workers[workerId]){this.subscribe(workerId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[workerId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return this.workers[workerId].run("subscribeWorker",[route,workerId,blocking])}};this.triggerSubscription=async(route,workerId,result)=>{if(this.state.triggers[workerId])for(let i=0;i<this.state.triggers[workerId].length;i++){await this.state.triggers[workerId][i].onchange({args:result,callbackId:route})}return true};this.pipeWorkers=(sourceWorker,listenerWorker,sourceRoute,listenerRoute,portId,blocking)=>{if(typeof sourceWorker==="string")sourceWorker=this.workers[sourceWorker];if(typeof listenerWorker==="string")listenerWorker=this.workers[listenerWorker];if(!portId){portId=this.establishMessageChannel(sourceWorker.worker,listenerWorker.worker)}return listenerWorker.run("subscribeToWorker",[sourceRoute,portId,listenerRoute,blocking])};this.unpipeWorkers=(sourceRoute,sourceWorker,sub)=>{if(typeof sourceWorker==="string")sourceWorker=this.workers[sourceWorker];if(sourceWorker)return sourceWorker.run("unsubscribe",[sourceRoute,sub])};this.routes={addWorker:{operator:this.addWorker,aliases:["open"]},toObjectURL:this.toObjectURL,request:this.request,runRequest:this.runRequest,establishMessageChannel:this.establishMessageChannel,subscribeWorker:this.subscribeWorker,subscribeToWorker:this.subscribeToWorker,triggerSubscription:this.triggerSubscription,subscribe:this.subscribe,pipeWorkers:this.pipeWorkers,unpipeWorkers:this.unpipeWorkers,unsubscribe:(route,sub)=>{this.unsubscribe(route,sub)},terminate:this.terminate};this.load(this.routes);if(typeof WorkerGlobalScope!=="undefined"&&globalThis instanceof WorkerGlobalScope){this.addDefaultMessageListener()}}loadWorkerRoute(rt,routeKey){if(rt.workerUrl)rt.url=rt.workerUrl;if(rt.workerId)rt.tag=rt.workerId;if(!rt.tag)rt.tag=routeKey;rt._id=rt.tag;let worker;if(this.workers[rt._id])worker=this.workers[rt._id];else if(rt.worker)worker=rt.worker;if(!worker){worker=this.addWorker(rt);let ondelete=rt2=>{rt2.worker?.terminate()};let oldondelete;if(rt.ondelete)oldondelete=rt.ondelete;rt.ondelete=n=>{if(oldondelete)oldondelete(n);ondelete(n)}}rt.worker=worker;if(rt.transferFunctions){for(const prop in rt.transferFunctions){this.transferFunction(worker,rt.transferFunctions[prop],prop)}}if(rt.transferClasses){for(const prop in rt.transferClasses){this.transferClass(worker,rt.transferClasses[prop],prop)}}if(worker){if(!rt.operator){rt.operator=(...args)=>{if(rt.callback){if(!this.nodes.get(rt.tag)?.children)worker.post(rt.callback,args);else return worker.run(rt.callback,args)}else{if(!this.nodes.get(rt.tag)?.children)worker.send(args);else return worker.request(args)}}}if(rt.init){worker.run(rt.init,rt.initArgs,rt.initTransfer)}return worker}}addDefaultMessageListener(){globalThis.onmessage=ev=>{let result=this.receive(ev.data);if(this.keepState)this.setState({[this.name]:result})}}getTransferable(message){let transfer;if(typeof message==="object"){if(message.args){if(message.args.constructor?.name==="Object"){for(const key in message.args){if(ArrayBuffer.isView(message.args[key])){if(!transfer)transfer=[message.args[key].buffer];else transfer.push(message.args[key].buffer)}else if(message.args[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message.args[key]];else transfer.push(message.args[key])}}}else if(Array.isArray(message.args)&&message.args.length<11){message.args.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message.args)){transfer=[message.args.buffer]}else if(message.args.constructor?.name==="ArrayBuffer"){transfer=[message]}}else if(message.constructor?.name==="Object"){for(const key in message){if(ArrayBuffer.isView(message[key])){if(!transfer)transfer=[message[key].buffer];else transfer.push(message[key].buffer)}else if(message[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message[key]];else transfer.push(message[key])}}}else if(Array.isArray(message)&&message.length<11){message.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message)){transfer=[message.buffer]}else if(message.constructor?.name==="ArrayBuffer"){transfer=[message]}}return transfer}transferFunction(worker,fn,fnName){if(!fnName)fnName=fn.name;return worker.request({route:"setRoute",args:[fn.toString(),fnName]})}transferClass(worker,cls,className){if(!className)className=cls.name;return worker.request({route:"receiveClass",args:[cls.toString(),className]})}};var mouseEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","button","pointerType","clientX","clientY","pageX","pageY"]);var wheelEventHandlerImpl=makeSendPropertiesHandler(["deltaX","deltaY"]);var keydownEventHandler=makeSendPropertiesHandler(["ctrlKey","metaKey","shiftKey","keyCode"]);function wheelEventHandler(event,sendFn){event.preventDefault();wheelEventHandlerImpl(event,sendFn)}function preventDefaultHandler(event){event.preventDefault()}function copyProperties(src,properties,dst){for(const name of properties){dst[name]=src[name]}}function makeSendPropertiesHandler(properties){return function sendProperties(event,sendFn){const data={type:event.type};copyProperties(event,properties,data);sendFn(data)}}function touchEventHandler(event,sendFn){const touches=[];const data={type:event.type,touches};for(let i=0;i<event.touches.length;++i){const touch=event.touches[i];touches.push({pageX:touch.pageX,pageY:touch.pageY})}sendFn(data)}var orbitKeys={"37":true,"38":true,"39":true,"40":true};function filteredKeydownEventHandler(event,sendFn){const{keyCode}=event;if(orbitKeys[keyCode]){event.preventDefault();keydownEventHandler(event,sendFn)}}var eventHandlers={contextmenu:preventDefaultHandler,mousedown:mouseEventHandler,mousemove:mouseEventHandler,mouseup:mouseEventHandler,pointerdown:mouseEventHandler,pointermove:mouseEventHandler,pointerup:mouseEventHandler,touchstart:touchEventHandler,touchmove:touchEventHandler,touchend:touchEventHandler,wheel:wheelEventHandler,keydown:filteredKeydownEventHandler};function initProxyElement(element,worker,id){if(!id)id="proxy"+Math.floor(Math.random()*1e15);const sendEvent=data=>{worker.postMessage({route:"handleProxyEvent",args:[data,id]})};let entries=Object.entries(eventHandlers);for(const[eventName,handler]of entries){element.addEventListener(eventName,function(event){handler(event,sendEvent)})}const sendSize=()=>{const rect=element.getBoundingClientRect();sendEvent({type:"resize",left:rect.left,top:rect.top,width:element.clientWidth,height:element.clientHeight})};sendSize();globalThis.addEventListener("resize",sendSize);return id}var EventDispatcher=class{addEventListener(type,listener){if(this._listeners===void 0)this._listeners={};const listeners=this._listeners;if(listeners[type]===void 0){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}}hasEventListener(type,listener){if(this._listeners===void 0)return false;const listeners=this._listeners;return listeners[type]!==void 0&&listeners[type].indexOf(listener)!==-1}removeEventListener(type,listener){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[type];if(listenerArray!==void 0){const index=listenerArray.indexOf(listener);if(index!==-1){listenerArray.splice(index,1)}}}dispatchEvent(event,target){if(this._listeners===void 0)return;const listeners=this._listeners;const listenerArray=listeners[event.type];if(listenerArray!==void 0){if(!target)event.target=this;else event.target=target;const array=listenerArray.slice(0);for(let i=0,l=array.length;i<l;i++){array[i].call(this,event)}event.target=null}}};function noop(){}var ElementProxyReceiver=class extends EventDispatcher{constructor(){super();this._listeners={};this.style={};this.setPointerCapture=()=>{};this.releasePointerCapture=()=>{};this.getBoundingClientRect=()=>{return{left:this.left,top:this.top,width:this.width,height:this.height,right:this.left+this.width,bottom:this.top+this.height}};this.handleEvent=data=>{if(data.type==="resize"){this.left=data.left;this.top=data.top;this.width=data.width;this.height=data.height;if(typeof this.proxied==="object"){this.proxied.width=this.width;this.proxied.height=this.height;this.proxied.clientWidth=this.width;this.proxied.clientHeight=this.height}}data.preventDefault=noop;data.stopPropagation=noop;this.dispatchEvent(data,this.proxied)};this.style={}}get clientWidth(){return this.width}get clientHeight(){return this.height}focus(){}};var ProxyManager=class{constructor(){this.targets={};this.makeProxy=(id,addTo=void 0)=>{if(!id)id=`proxyReceiver${Math.floor(Math.random()*1e15)}`;let proxy;if(this.targets[id])proxy=this.targets[id];else{proxy=new ElementProxyReceiver;this.targets[id]=proxy}if(typeof addTo==="object"){addTo.proxy=proxy;proxy.proxied=addTo;addTo.style=proxy.style;if(proxy.width){addTo.width=proxy.width;addTo.clientWidth=proxy.width}if(proxy.height){addTo.height=proxy.height;addTo.clientHeight=proxy.height}addTo.setPointerCapture=proxy.setPointerCapture.bind(proxy);addTo.releasePointerCapture=proxy.releasePointerCapture.bind(proxy);addTo.getBoundingClientRect=proxy.getBoundingClientRect.bind(proxy);addTo.addEventListener=proxy.addEventListener.bind(proxy);addTo.removeEventListener=proxy.removeEventListener.bind(proxy);addTo.handleEvent=proxy.handleEvent.bind(proxy);addTo.dispatchEvent=proxy.dispatchEvent.bind(proxy);addTo.focus=proxy.focus.bind(proxy)}};this.getProxy=id=>{return this.targets[id]};this.handleEvent=(data,id)=>{if(!this.targets[id])this.makeProxy(id);if(this.targets[id]){this.targets[id].handleEvent(data);return true}return void 0};if(!globalThis.document)globalThis.document={}}};function makeProxy(id,elm){if(this.graph){if(!this.graph.ProxyManager)this.graph.ProxyManager=new ProxyManager;this.graph.ProxyManager.makeProxy(id,elm)}else{if(!globalThis.ProxyManager)globalThis.ProxyManager=new ProxyManager;globalThis.ProxyManager.makeProxy(id,elm)}return id}function handleProxyEvent(data,id){if(this.graph){if(!this.graph.ProxyManager)this.graph.ProxyManager=new ProxyManager;if(this.graph.ProxyManager.handleEvent(data,id))return data}else{if(!globalThis.ProxyManager)globalThis.ProxyManager=new ProxyManager;if(globalThis.ProxyManager.handleEvent(data,id))return data}}var proxyElementWorkerRoutes={initProxyElement,makeProxy,handleProxyEvent};function transferCanvas(worker,options,route){if(!options)return void 0;if(!options._id)options._id=`canvas${Math.floor(Math.random()*1e15)}`;let offscreen=options.canvas.transferControlToOffscreen();let message={route:route?route:"setupCanvas",args:{...options,canvas:offscreen}};if(this.graph)this.graph.run("initProxyElement",options.canvas,worker,options._id);else initProxyElement(options.canvas,worker,options._id);if(options.draw){if(typeof options.draw==="function")message.args.draw=options.draw.toString();else message.args.draw=options.draw}if(options.update){if(typeof options.update==="function")message.args.update=options.update.toString();else message.args.update=options.update}if(options.init){if(typeof options.init==="function")message.args.init=options.init.toString();else message.args.init=options.init}if(options.clear){if(typeof options.clear==="function")message.args.clear=options.clear.toString();else message.args.clear=options.clear}let transfer=[offscreen];if(options.transfer){transfer.push(...options.transfer);delete options.transfer}worker.postMessage(message,transfer);const canvascontrols={_id:options._id,width:options.width,height:options.height,worker,draw:props=>{worker.postMessage({route:"drawFrame",args:[props,options._id]})},update:props=>{worker.postMessage({route:"updateCanvas",args:[props,options._id]})},clear:()=>{worker.postMessage({route:"clearCanvas",args:options._id})},init:()=>{worker.postMessage({route:"initCanvas",args:options._id})},stop:()=>{worker.postMessage({route:"stopAnim",args:options._id})},start:()=>{worker.postMessage({route:"startAnim",args:options._id})},set:newDrawProps=>{worker.postMessage({route:"setDraw",args:[newDrawProps,options._id]})},terminate:()=>{worker.terminate()}};return canvascontrols}function setDraw(settings,_id){let canvasopts;if(this.graph){if(_id)canvasopts=this.graph.CANVASES?.[settings._id];else if(settings._id)canvasopts=this.graph.CANVASES?.[settings._id];else canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]]}else{if(_id)canvasopts=globalThis.CANVASES?.[settings._id];else if(settings._id)canvasopts=globalThis.CANVASES?.[settings._id];else canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]]}if(canvasopts){if(settings.canvas){canvasopts.canvas=settings.canvas;if(this.graph)this.graph.run("makeProxy",canvasopts._id,canvasopts.canvas);else proxyElementWorkerRoutes.makeProxy(canvasopts._id,canvasopts.canvas)}if(typeof settings.context==="string")canvasopts.context=canvasopts.canvas.getContext(settings.context);else if(settings.context)canvasopts.context=settings.context;if(settings.width)canvasopts.canvas.width=settings.width;if(settings.height)canvasopts.canvas.height=settings.height;if(typeof settings.draw==="string")settings.draw=parseFunctionFromText3(settings.draw);if(typeof settings.draw==="function"){canvasopts.draw=settings.draw}if(typeof settings.update==="string")settings.update=parseFunctionFromText3(settings.update);if(typeof settings.update==="function"){canvasopts.update=settings.update}if(typeof settings.init==="string")settings.init=parseFunctionFromText3(settings.init);if(typeof settings.init==="function"){canvasopts.init=settings.init}if(typeof settings.clear==="string")settings.clear=parseFunctionFromText3(settings.clear);if(typeof settings.clear==="function"){canvasopts.clear=settings.clear}return settings._id}return void 0}function Renderer(options){if(options.worker){let worker=options.worker;let route=options.route;if(worker instanceof Blob||typeof worker==="string"){worker=new Worker(worker)}delete options.worker;delete options.route;return transferCanvas(worker,options,route)}else return setupCanvas(options)}function setupCanvas(options){if(this.graph){if(!this.graph.CANVASES)this.graph.CANVASES={}}else if(!globalThis.CANVASES)globalThis.CANVASES={};let canvasOptions=options;options._id?canvasOptions._id=options._id:canvasOptions._id=`canvas${Math.floor(Math.random()*1e15)}`;typeof options.context==="string"?canvasOptions.context=options.canvas.getContext(options.context):canvasOptions.context=options.context;"animating"in options?canvasOptions.animating=options.animating:canvasOptions.animating=true;if(this.graph?.CANVASES[canvasOptions._id]){this.graph.run("setDraw",canvasOptions)}else if(globalThis.CANVASES[canvasOptions._id]){setDraw(canvasOptions)}else{canvasOptions.graph=this.graph;if(this.graph)this.graph.CANVASES[canvasOptions._id]=canvasOptions;else globalThis.CANVASES[canvasOptions._id]=canvasOptions;if(this.graph)this.graph.run("makeProxy",canvasOptions._id,canvasOptions.canvas);else proxyElementWorkerRoutes.makeProxy(canvasOptions._id,canvasOptions.canvas);if(options.width)canvasOptions.canvas.width=options.width;if(options.height)canvasOptions.canvas.height=options.height;if(typeof canvasOptions.draw==="string"){canvasOptions.draw=parseFunctionFromText3(canvasOptions.draw)}else if(typeof canvasOptions.draw==="function"){canvasOptions.draw=canvasOptions.draw}if(typeof canvasOptions.update==="string"){canvasOptions.update=parseFunctionFromText3(canvasOptions.update)}else if(typeof canvasOptions.update==="function"){canvasOptions.update=canvasOptions.update}if(typeof canvasOptions.init==="string"){canvasOptions.init=parseFunctionFromText3(canvasOptions.init)}else if(typeof canvasOptions.init==="function"){canvasOptions.init=canvasOptions.init}if(typeof canvasOptions.clear==="string"){canvasOptions.clear=parseFunctionFromText3(canvasOptions.clear)}else if(typeof canvasOptions.clear==="function"){canvasOptions.clear=canvasOptions.clear}if(typeof canvasOptions.init==="function")canvasOptions.init(canvasOptions,canvasOptions.canvas,canvasOptions.context);canvasOptions.stop=()=>{stopAnim(canvasOptions._id)};canvasOptions.start=draw=>{startAnim(canvasOptions._id,draw)};canvasOptions.set=settings=>{setDraw(settings,canvasOptions._id)};if(typeof canvasOptions.draw==="function"&&canvasOptions.animating){let draw=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw(s,canvas,context)})}};draw(canvasOptions,canvasOptions.canvas,canvasOptions.context)}}if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)return canvasOptions._id;else return canvasOptions}function drawFrame(props,_id){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}if(canvasopts){if(props)Object.assign(canvasopts,props);if(canvasopts.draw){canvasopts.draw(canvasopts,canvasopts.canvas,canvasopts.context);return _id}}return void 0}function clearCanvas(_id){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}if(canvasopts?.clear){canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}function initCanvas(_id){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}if(canvasopts?.init){canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}function updateCanvas(input,_id){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}if(canvasopts?.update){canvasopts.update(canvasopts,canvasopts.canvas,canvasopts.context,input);return _id}return void 0}function setProps(props,_id){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}if(canvasopts){Object.assign(canvasopts,props);if(props.width)canvasopts.canvas.width=props.width;if(props.height)canvasopts.canvas.height=props.height;return _id}return void 0}function startAnim(_id,draw){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}canvasopts.animating=true;if(canvasopts&&draw){if(typeof draw==="string")draw=parseFunctionFromText3(draw);if(typeof draw==="function"){canvasopts.draw=draw}return _id}if(typeof canvasopts?.draw==="function"){let draw2=(s,canvas,context)=>{if(s.animating){s.draw(s,canvas,context);requestAnimationFrame(()=>{draw2(s,canvas,context)})}};if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);if(typeof canvasopts.init==="function")canvasopts.init(canvasopts,canvasopts.canvas,canvasopts.context);draw2(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}function stopAnim(_id){let canvasopts;if(this.graph){if(!_id)canvasopts=this.graph.CANVASES?.[Object.keys(this.graph.CANVASES)[0]];else canvasopts=this.graph.CANVASES?.[_id]}else{if(!_id)canvasopts=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]];else canvasopts=globalThis.CANVASES?.[_id]}if(canvasopts){canvasopts.animating=false;if(typeof canvasopts.clear==="function")canvasopts.clear(canvasopts,canvasopts.canvas,canvasopts.context);return _id}return void 0}var workerCanvasRoutes={...proxyElementWorkerRoutes,Renderer,transferCanvas,setupCanvas,setDraw,drawFrame,clearCanvas,initCanvas,updateCanvas,setProps,startAnim,stopAnim};function parseFunctionFromText3(method=""){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf("=>")+1;if(startindex<=0){startindex=methodString.indexOf("){")}if(startindex<=0){startindex=methodString.indexOf(") {")}return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch{}}}return newFunc}var algorithms={};var loadAlgorithms=settings=>{return Object.assign(algorithms,settings)};function createSubprocess(options,inputs){let ctx={_id:options._id?options._id:`algorithm${Math.floor(Math.random()*1e15)}`,ondata:options.ondata,run:data=>{return ctx.ondata(ctx,data)}};if(options.structs)recursivelyAssign(ctx,JSON.parse(JSON.stringify(options.structs)));if(inputs)recursivelyAssign(ctx,JSON.parse(JSON.stringify(inputs)));if(options.oncreate){ctx.oncreate=options.oncreate}if(ctx.oncreate){ctx.oncreate(ctx)}return ctx}var recursivelyAssign=(target,obj)=>{for(const key in obj){if(typeof obj[key]==="object"&&!Array.isArray(obj[key])){if(typeof target[key]==="object"&&!Array.isArray(target[key]))recursivelyAssign(target[key],obj[key]);else target[key]=recursivelyAssign({},obj[key])}else target[key]=obj[key]}return target};var subprocessRoutes={...unsafeRoutes,loadAlgorithms,"initSubprocesses":async function initSubprocesses(subprocesses,service){if(!service)service=this.graph;if(!service)return void 0;for(const p in subprocesses){let s=subprocesses[p];if(!s.worker&&s.url)s.worker=service.addWorker({url:s.url});if(!s.worker)continue;let w=s.worker;let wpId;wpId=service.establishMessageChannel(w.worker,s.source?.worker);if(!s.source)s.source=service;if(typeof s.subprocess==="object"){const p2=s.subprocess;if(!p2.name)continue;if(typeof p2.oncreate==="function"){p2.oncreate=p2.oncreate.toString()}if(typeof p2.ondata==="function"){p2.ondata=p2.ondata.toString()}s.worker.post("addSubprocessTemplate",[p2.name,p2.structs,p2.oncreate,p2.ondata,p2.props]);s.subprocess=p2.name}if(s.init){let r=await w.run(s.init,s.initArgs);s.otherArgs=r}if(s.otherArgs){w.run("setValue",["otherArgsProxy",Array.isArray(s.otherArgs)?s.otherArgs:[s.otherArgs]])}if(s.pipeTo){w.run("setValue",["routeProxy",s.route]);w.run("setValue",["pipeRoute",s.pipeTo.route]);if(s.url&&!s.pipeTo.worker){let w2=service.addWorker({url:s.url});s.pipeTo.portId=service.establishMessageChannel(w.worker,w2.worker);s.pipeTo.worker=w2}if(s.pipeTo.init){s.pipeTo.otherArgs=await s.pipeTo.worker.run(s.pipeTo.init,s.pipeTo.initArgs)}w.run("setValue",["pipePort",s.pipeTo.portId]);if(s.pipeTo.otherArgs)w.run("setValue",["otherPipeArgs",s.pipeTo.otherArgs]);service.transferFunction(w,function pipeResults(data){let inp=data;if(this.graph.otherArgsProxy)inp=[data,...this.graph.otherArgsProxy];let r=this.graph.run(this.graph.routeProxy,inp);if(!s.blocking)return new Promise(res=>{if(r instanceof Promise){r.then(rr=>{if(rr!==void 0){let args=rr;if(this.graph.otherPipeArgs)args=[rr,...this.graph.otherPipeArgs];if(this.workers[this.graph.pipePort]){s.blocking=true;this.workers[this.graph.pipePort].run(this.graph.pipeRoute,args).then(result=>{s.blocking=false;res(result)})}}})}else if(r!==void 0){let args=r;if(this.graph.otherPipeArgs)args=[r,...this.graph.otherPipeArgs];if(this.workers[this.graph.pipePort]){s.blocking=true;this.workers[this.graph.pipePort].run(this.graph.pipeRoute,args).then(result=>{s.blocking=false;res(result)})}}});return void 0},s.route+"_pipeResults");s.route=s.route+"_pipeResults"}else{w.run("setValue",["routeProxy",s.route]);service.transferFunction(w,function routeProxy(data){let r;if(this.graph.otherArgsProxy)r=this.graph.nodes.get(this.graph.routeProxy).operator(data,...this.graph.otherArgsProxy);else r=this.graph.nodes.get(this.graph.routeProxy).operator(data);if(this.graph.state.triggers[this.graph.routeProxy]){if(r instanceof Promise){r.then(rr=>{this.setState({[this.graph.routeProxy]:rr})})}else this.setState({[this.graph.routeProxy]:r})}return r},s.route+"_routeProxy");s.route=s.route+"_routeProxy";if(!s.stopped)w.run("subscribeToWorker",[s.subscribeRoute,wpId,s.route]).then(sub=>{s.sub=sub})}s.stop=async()=>{if(s.source&&typeof s.sub==="number"){s.source.unsubscribe(s.subscribeRoute,s.sub);return true}return void 0};s.start=async()=>{if(typeof s.sub!=="number")return w.run("subscribeToWorker",[s.subscribeRoute,wpId,s.route,s.blocking]).then(sub=>{s.sub=sub})};s.setArgs=async args=>{if(Array.isArray(args))await w.run("setValue",["otherArgsProxy",args]);else if(typeof args==="object"){for(const key in args){await w.run("setValue",[key,args[key]])}}return true};s.terminate=()=>{w.terminate();if(s.source?.worker&&typeof s.sub==="number"){s.source.post("unsubscribe",s.sub)}if(s.pipeTo?.worker){s.pipeTo.worker.terminate()}};if(s.callback)w.subscribe(s.route,res=>{if(typeof s.callback==="string")this.graph.run(s.callback,res);else s.callback(res)})}return subprocesses},"addSubprocessTemplate":function subprocesstempalte(name,structs,oncreate,ondata,props){if(typeof oncreate==="string")oncreate=parseFunctionFromText(oncreate);if(typeof ondata==="string")ondata=parseFunctionFromText(ondata);if(typeof ondata==="function"){algorithms[name]={ondata,oncreate:typeof oncreate==="function"?oncreate:null,structs};if(typeof props==="object")Object.assign(algorithms[name],props);return true}},"updateSubprocess":function updatesubprocess(structs,_id){if(!this.graph.ALGORITHMS)this.graph.ALGORITHMS={};if(!_id)_id=Object.keys(this.graph.ALGORITHMS)[0];if(!_id)return;Object.assign(this.graph.ALGORITHMS[_id],structs)},"createSubprocess":function creatsubprocess(options,inputs){if(!this.graph.ALGORITHMS)this.graph.ALGORITHMS={};if(typeof options==="string"){options=algorithms[options]}if(typeof options==="object"){if(typeof options.ondata==="string")options.ondata=parseFunctionFromText(options.ondata);let ctx;if(typeof options?.ondata==="function")ctx=createSubprocess(options,inputs);if(ctx)this.graph.ALGORITHMS[ctx._id]=ctx;if(ctx)return ctx._id}return false},"runSubprocess":function runsubprocess(data,_id){if(!this.graph.ALGORITHMS)this.graph.ALGORITHMS={};if(!_id)_id=Object.keys(this.graph.ALGORITHMS)[0];if(!_id)return;let res=this.graph.ALGORITHMS[_id].run(data);if(res!==void 0){if(Array.isArray(res)){let pass=[];res.forEach(r=>{if(r!==void 0){pass.push(r);this.graph.setState({[_id]:r})}});if(pass.length>0){return pass}}else{this.graph.setState({[_id]:res});return res}}}};var SessionsService=class extends Service{constructor(options,users){super(options);this.name="sessions";this.users={};this.sessions={private:{},shared:{}};this.getSessionInfo=(sessionId,userId)=>{if(!sessionId){return this.sessions.shared}else{if(this.sessions.private[sessionId]){let s=this.sessions.private[sessionId];if(s.settings){if(s.settings.source===userId||s.settings.listener===userId||s.settings.ownerId===userId||s.settings.admins?.[userId]||s.settings.moderators?.[userId])return{private:{[sessionId]:s}}}}else if(this.sessions.shared[sessionId]){return{shared:{[sessionId]:this.sessions.shared[sessionId]}}}else{let res={};for(const id in this.sessions.shared){if(this.sessions.shared[id].settings?.name)res[id]=this.sessions.shared.settings}if(Object.keys(res).length>0)return res}}};this.openPrivateSession=(options={},userId)=>{if(!options._id){options._id=`private${Math.floor(Math.random()*1e15)}`;if(this.sessions.private[options._id]){delete options._id;this.openPrivateSession(options,userId)}}if(options._id&&userId&&this.users[userId]){if(userId){if(!options.settings)options.settings={listener:userId,source:userId,propnames:{latency:true},admins:{[userId]:true},ownerId:userId};if(!options.settings.listener)options.settings.listener=userId;if(!options.settings.source)options.settings.source=userId;if(!this.users[userId].sessions)this.users[userId].sessions={};this.users[userId].sessions[options._id]=options}if(!options.data)options.data={};if(this.sessions.private[options._id]){return this.updateSession(options,userId)}else if(options.settings?.listener&&options.settings.source)this.sessions.private[options._id]=options}return options};this.openSharedSession=(options,userId)=>{if(!options._id){options._id=`shared${Math.floor(Math.random()*1e15)}`;if(this.sessions.shared[options._id]){delete options._id;this.openSharedSession(options,userId)}}if(options._id&&userId&&this.users[userId]){if(typeof userId==="string"){if(!options.settings)options.settings={name:"shared",propnames:{latency:true},users:{[userId]:true},admins:{[userId]:true},ownerId:userId};if(!options.settings.users)options.settings.users={[userId]:true};if(!options.settings.admins)options.settings.admins={[userId]:true};if(!options.settings.ownerId)options.settings.ownerId=userId;if(!this.users[userId].sessions)this.users[userId].sessions={};this.users[userId].sessions[options._id]=options}else if(!options.settings)options.settings={name:"shared",propnames:{latency:true},users:{}};if(!options.data)options.data={private:{},shared:{}};if(!options.settings.name)options.name=options.id;if(this.sessions.shared[options._id]){return this.updateSession(options,userId)}else this.sessions.shared[options._id]=options}return options};this.updateSession=(options,userId)=>{let session;if(options._id){session=this.sessions.private[options._id];if(!session)session=this.sessions.shared[options._id];if(this.sesh.private[options._id]&&userId){let sesh=this.sessions.shared[options._id];if(sesh.settings&&(sesh?.settings.source===userId||sesh.settings.admins?.[userId]||sesh.settings.moderators?.[userId]||sesh.settings.ownerId===userId)){return Object.assign(this.session.shared[options._id],options)}}else if(options.settings?.source){return this.openPrivateSession(options,userId)}else return this.openSharedSession(options,userId)}return false};this.joinSession=(sessionId,userId,options)=>{if(!userId&&!this.users[userId])return false;if(!this.users[userId].sessions)this.users[userId].sessions={};let sesh=this.sessions.shared[sessionId];if(sesh?.settings){if(sesh.settings?.banned){if(sesh.settings.banned[userId])return false}if(sesh.settings?.password){if(!options?.settings?.password)return false;if(options.settings.password!==sesh.settings.password)return false}sesh.settings.users[userId]=true;this.users[userId].sessions[sessionId]=sesh;if(options){return this.updateSession(options,userId)};return sesh}else if(options?.source||options?.listener)return this.openPrivateSession(options,userId);else if(options)return this.openSharedSession(options,userId);return false};this.leaveSession=(sessionId,userId,clear=true)=>{let session=this.sessions.private[sessionId];if(!session)session=this.sessions.shared[sessionId];if(session){if(this.sessions.private[sessionId]){if(userId===session.settings.source||userId===session.settings.listener||session.settings.admins?.[userId]||session.settings.moderators?.[userId]){delete this.sessions.private[sessionId];delete this.users[userId].sessions[sessionId];if(clear){if(session.settings.admins?.[userId])delete(this.sessions.shared[sessionId].settings?.admins)[userId];if(session.settings.moderators?.[userId])delete(this.sessions.shared[sessionId].settings?.moderators)[userId]}}}else if(this.sessions.shared[sessionId]){delete this.sessions.shared.settings.users[userId];delete this.users[userId].sessions[sessionId];if(clear){if(session.settings.admins?.[userId])delete(this.sessions.shared[sessionId].settings?.admins)[userId];if(session.settings.moderators?.[userId])delete(this.sessions.shared[sessionId].settings?.moderators)[userId];if(session.data.shared[userId])delete this.sessions.shared[sessionId].data?.shared[userId];if(session.settings.host===userId){delete session.settings.host;delete session.data.shared;session.data.shared={};this.swapHost(session)}}}return true}return false};this.swapHost=(session,newHostId)=>{if(typeof session==="string"){if(this.sessions.private[session])session=this.sessions.private[session];else if(this.sessions.shared[session])session=this.sessions.shared[session]}if(typeof session==="object"&&session.settings){delete session.settings.host;if(newHostId){if(session.settings.users[newHostId])session.settings.host=newHostId}if(session.settings.ownerId&&!session.settings.host){if(session.settings.users[session.settings.ownerId])session.settings.host=session.settings.ownerId}if(session.settings.admins&&!session.settings.host){let match=this.getFirstMatch(session.settings.users,session.settings.admins);if(match)session.settings.host=match}if(session.settings.moderators&&!session.settings.host){let match=this.getFirstMatch(session.settings.users,session.settings.moderators);if(match)session.settings.host=match}if(!session.settings.host)session.settings.host=Object.keys(session.settings.users)[0];return true}return false};this.deleteSession=(sessionId,userId)=>{let session=this.sessions.private[sessionId];if(!session)session=this.sessions.shared[sessionId];if(session){if(session.source===userId||session.listener===userId||session.admins?.[userId]||session.ownerId===userId){for(const user in session.settings.users){if(this.users[user].sessions)delete this.users[user].sessions[sessionId]}if(this.sessions.private[sessionId])delete this.sessions.private[sessionId];else if(this.sessions.shared[sessionId])delete this.sessions.private[sessionId]}}return true};this.subscribeToSession=(session,userId,onmessage,onopen,onclose)=>{if(typeof session==="string"){let s=this.sessions.private[session];if(!s)s=this.sessions.shared[session];if(!s)return void 0;session=s}if(typeof session.onopen==="function"){let sub=this.subscribe("joinSession",res=>{if(res._id===session._id)session.onopen(session,userId);this.unsubscribe("joinSession",sub)})}if(typeof session==="object"){if(onmessage)session.onmessage=onmessage;if(onopen)session.onclose=onopen;if(onclose)session.onclose=onclose}return session};this.sessionUpdateCheck=(transmit=true)=>{let updates={private:{},shared:{}};for(const session in this.sessions.private){const sesh=this.sessions.private[session];const updateObj={_id:sesh._id,settings:{listener:sesh.listener,source:sesh.source},data:{}};if(!this.users[sesh.source]){delete this.sessions.private[session];break}if(sesh.settings&&sesh.data){for(const prop in sesh.settings.propnames){if(this.users[sesh.source][prop]){if(this.sessions.private[session].data){if(typeof sesh.data[prop]==="object"){if(this.users[sesh.source][prop]&&(stringifyFast(sesh.data[prop])!==stringifyFast(this.users[sesh.source][prop])||!(prop in sesh.data)))updateObj.data[prop]=this.users[sesh.source][prop]}else if(this.users[sesh.source][prop]&&(sesh.data[prop]!==this.users[sesh.source][prop]||!(prop in sesh.data)))updateObj.data[prop]=this.users[sesh.source][prop]}else updateObj.data[prop]=this.users[sesh.source][prop]}else if(this.sessions.private[session]?.data?.[prop])delete this.sessions.private[session].data[prop]}}if(Object.keys(updateObj.data).length>0){this.recursivelyAssign(this.sessions.private[session].data,updateObj.data);updates.private[sesh._id]=updateObj}}for(const session in this.sessions.shared){const sesh=this.sessions.shared[session];const updateObj={_id:sesh._id,settings:{name:sesh.name},data:{}};if(sesh.settings?.host){const privateData={};const sharedData={};for(const user in sesh.settings.users){if(!this.users[user]){delete sesh.settings.users[user];if(sesh.data?.shared[user])delete sesh.data.shared[user];if(sesh.data?.private?.[user])delete sesh.data.shared[user];if(sesh.settings.host===user)this.swapHost(sesh);updateObj.settings.users=sesh.settings.users;updateObj.settings.host=sesh.settings.host;continue}if(user!==sesh.settings.host){privateData[user]={};for(const prop in sesh.settings.propnames){if(this.users[user][prop]){if(sesh.data?.private&&!(user in sesh.data.private)){if(typeof this.users[user][prop]==="object")privateData[user][prop]=this.recursivelyAssign({},this.users[user][prop]);else privateData[user][prop]=this.users[user][prop]}else if(typeof privateData[user][prop]==="object"&&sesh.data){if(this.users[user][prop]&&(stringifyFast(sesh.data?.shared[user][prop])!==stringifyFast(this.users[user][prop])||!(prop in sesh.data)))privateData[user][prop]=this.users[user][prop]}else if(this.users[user][prop]&&sesh.data?.private?.[prop]!==this.users[user][prop])privateData[user][prop]=this.users[user][prop]}else if(sesh.data?.private?.[user]?.[prop])delete sesh.data.private[user][prop]}if(Object.keys(privateData[user]).length===0)delete privateData[user]}else{sharedData[user]={};for(const prop in sesh.settings.hostprops){if(this.users[user][prop]){if(sesh.data&&!(user in sesh.data.shared)){if(typeof this.users[user][prop]==="object")sharedData[user][prop]=this.recursivelyAssign({},this.users[user][prop]);else sharedData[user][prop]=this.users[user][prop]}else if(typeof sharedData[user][prop]==="object"&&sesh.data){if(this.users[user][prop]&&(stringifyFast(sesh.data?.shared[user][prop])!==stringifyFast(this.users[user][prop])||!(prop in sesh.data.shared[user])))sharedData[user][prop]=this.users[user][prop]}else if(this.users[user][prop]&&sesh.data?.shared[user][prop]!==this.users[user][prop])sharedData[user][prop]=this.users[user][prop]}else if(sesh.data?.shared[user]?.[prop])delete sesh.data.shared[user][prop]}}}if(Object.keys(privateData).length>0){updateObj.data.private=privateData}if(Object.keys(sharedData).length>0){updateObj.data.shared=sharedData}}else{const sharedData={};if(sesh.settings?.users){for(const user in sesh.settings.users){if(!this.users[user]){delete sesh.settings.users[user];if(sesh.data?.shared[user])delete sesh.data.shared[user];if(sesh.data?.private?.[user])delete sesh.data.shared[user];if(sesh.settings.host===user)this.swapHost(sesh);updateObj.settings.users=sesh.settings.users;updateObj.settings.host=sesh.settings.host;continue}sharedData[user]={};for(const prop in sesh.settings.propnames){if(this.users[user][prop]){if(sesh.data&&!(user in sesh.data.shared)){if(typeof this.users[user][prop]==="object")sharedData[user][prop]=this.recursivelyAssign({},this.users[user][prop]);else sharedData[user][prop]=this.users[user][prop]}else if(typeof sesh.data?.shared[user][prop]==="object"){if(stringifyFast(sesh.data.shared[user][prop])!==stringifyFast(this.users[user][prop])||!(prop in sesh.data.shared[user])){sharedData[user][prop]=this.users[user][prop]}}else if(sesh.data?.shared[user][prop]!==this.users[user][prop])sharedData[user][prop]=this.users[user][prop]}else if(sesh.data?.shared[user]?.[prop])delete sesh.data.shared[user][prop]}if(Object.keys(sharedData[user]).length===0)delete sharedData[user]}if(Object.keys(sharedData).length>0){updateObj.data.shared=sharedData}}}if(updateObj.data.shared||updateObj.data.private)updates.shared[sesh._id]=updateObj;if(updateObj.data.shared){this.recursivelyAssign(this.sessions.shared[session].data?.shared,updateObj.data.shared)}if(updateObj.data.private){this.recursivelyAssign(this.sessions.shared[session].data?.private,updateObj.data.private)}}if(Object.keys(updates.private).length===0)delete updates.private;if(Object.keys(updates.shared).length===0)delete updates.shared;if(Object.keys(updates).length===0)return void 0;if(transmit)this.transmitSessionUpdates(updates);return updates};this.transmitSessionUpdates=updates=>{let users={};if(updates.private){for(const s in updates.private){let session=this.sessions.private[s];if(session?.settings){let u=session.settings.listener;if(!users[u])users[u]={private:{}};else if(!users[u].private)users[u].private={};users[u].private[s]=updates.private[s]}}}if(updates.shared){for(const s in updates.shared){let session=this.sessions.shared[s];if(session?.settings){let copy;if(session.settings.host){copy=Object.assign({},updates.shared[s]);delete copy.data.private}for(const u in session.settings.users){if(!users[u])users[u]={shared:{}};else if(!users[u].shared)users[u].shared={};if(session.settings.host){if(u!==session.settings.host){users[u].shared[s]=copy}else users[u].shared[s]=updates.shared[s]}else users[u].shared[s]=updates.shared[s]}}}}let message={route:"receiveSessionUpdates",args:null};for(const u in users){message.args=[u,users[u]];if(this.users[u].send)this.users[u].send(JSON.stringify(message));this.setState({[u]:Object.create(message)})}return users};this.receiveSessionUpdates=(origin,update)=>{if(update){if(typeof update==="string")update=JSON.parse(update)}if(typeof update==="object"){let user=this.users[origin];if(!user)return void 0;if(!user.sessions)user.sessions={};if(update.private){for(const key in update.private){if(!user.sessions[key])continue;this.recursivelyAssign(user.sessions[key].data,update.private[key].data);if(user.sessions[key].onmessage)user.sessions[key].onmessage(user.sessions[key],user._id)}}if(update.shared){for(const key in update.shared){if(!user.sessions[key])continue;if(update.shared[key].settings.users)user.sessions[key].settings.users=update.shared[key].settings.users;if(update.shared[key].settings.host)user.sessions[key].settings.host=update.shared[key].settings.host;if(update.shared[key].data.private)this.recursivelyAssign(user.sessions[key].data.private,update.shared[key].data.private);if(update.shared[key].data.shared)this.recursivelyAssign(user.sessions[key].data.shared,update.shared[key].data.shared);if(user.sessions[key].onmessage)user.sessions[key].onmessage(user.sessions[key],user._id)}}return user}};this.getUpdatedUserData=user=>{const updateObj={};for(const key in user.sessions){let s=user.sessions[key];if(s.settings.users[user._id]||s.settings.source===user._id){if(!s.settings.spectators?.[user._id]){if(s.settings.host===user._id){for(const prop in s.settings.hostprops){if(!updateObj[prop]&&prop in user){if(s.data.shared?.[user._id]&&prop in s.data.shared?.[user._id]){if(typeof user[prop]==="object"){if(stringifyFast(s.data.shared[user._id][prop])!==stringifyFast(user[prop]))updateObj[prop]=user[prop]}else if(s.data.shared[user._id][prop]!==user[prop])updateObj[prop]=user[prop]}else updateObj[prop]=user[prop]}}}else{for(const prop in s.settings.propnames){if(!updateObj[prop]&&user[prop]!==void 0){if(s.settings.source){if(typeof user[prop]==="object"&&prop in s.data){if(stringifyFast(s.data[prop])!==stringifyFast(user[prop]))updateObj[prop]=user[prop]}else if(s.data[prop]!==user[prop])updateObj[prop]=user[prop]}else{if(s.data.shared?.[user._id]&&prop in s.data.shared?.[user._id]){if(typeof user[prop]==="object"){if(stringifyFast(s.data.shared[user._id][prop])!==stringifyFast(user[prop]))updateObj[prop]=user[prop]}else if(s.data.shared[user._id][prop]!==user[prop])updateObj[prop]=user[prop]}else updateObj[prop]=user[prop]}}}}}}}return updateObj};this.userUpdateCheck=user=>{if(user.sessions){const updateObj=this.getUpdatedUserData(user);if(Object.keys(updateObj).length>0){let message={route:"setUserProps",args:[user._id,updateObj]};if(user.send)user.send(message);this.setState({[user._id]:message});return updateObj}}return void 0};this.setUserProps=(user,props)=>{if(user){if(typeof user==="string"){user=this.users[user];if(!user)return false}}if(props){if(typeof props==="string"){props=JSON.parse(props)}}this.recursivelyAssign(user,props);return true};this.STREAMLATEST=0;this.STREAMALLLATEST=1;this.streamSettings={};this.streamFunctions={allLatestValues:(prop,setting)=>{let result=void 0;if(Array.isArray(prop)){if(prop.length!==setting.lastRead){result=prop.slice(setting.lastRead);setting.lastRead=prop.length}}else if(typeof prop==="object"){result={};for(const p in prop){if(Array.isArray(prop[p])){if(typeof setting==="number")setting={[p]:{lastRead:void 0}};else if(!setting[p])setting[p]={lastRead:void 0};if(prop[p].length!==setting[p].lastRead){result[p]=prop[p].slice(setting[p].lastRead);setting[p].lastRead=prop[p].length}}else{if(typeof setting==="number")setting={[p]:{lastRead:void 0}};else if(!setting[p])setting[p]={lastRead:void 0};if(setting[p].lastRead!==prop[p]){result[p]=prop[p];setting[p].lastRead=prop[p]}}}if(Object.keys(result).length===0)result=void 0}else{if(setting.lastRead!==prop){result=prop;setting.lastRead=prop}}return result},latestValue:(prop,setting)=>{let result=void 0;if(Array.isArray(prop)){if(prop.length!==setting.lastRead){result=prop[prop.length-1];setting.lastRead=prop.length}}else if(typeof prop==="object"){result={};for(const p in prop){if(Array.isArray(prop[p])){if(typeof setting==="number")setting={[p]:{lastRead:void 0}};else if(!setting[p])setting[p]={lastRead:void 0};if(prop[p].length!==setting[p].lastRead){result[p]=prop[p][prop[p].length-1];setting[p].lastRead=prop[p].length}}else{if(typeof setting==="number")setting={[p]:{lastRead:void 0}};else if(!setting[p])setting[p]={lastRead:void 0};if(setting[p].lastRead!==prop[p]){result[p]=prop[p];setting[p].lastRead=prop[p]}}}}else{if(setting.lastRead!==prop){result=prop;setting.lastRead=prop}}return result}};this.setStreamFunc=(name,key,callback=this.streamFunctions.allLatestValues)=>{if(!this.streamSettings[name].settings[key])this.streamSettings[name].settings[key]={lastRead:0};if(callback===this.STREAMLATEST)this.streamSettings[name].settings[key].callback=this.streamFunctions.latestValue;else if(callback===this.STREAMALLLATEST)this.streamSettings[name].settings[key].callback=this.streamFunctions.allLatestValues;else if(typeof callback==="string")this.streamSettings[name].settings[key].callback=this.streamFunctions[callback];else if(typeof callback==="function")this.streamSettings[name].settings[key].callback=callback;if(!this.streamSettings[name].settings[key].callback)this.streamSettings[name].settings[key].callback=this.streamFunctions.allLatestValues;return true};this.addStreamFunc=(name,callback=data=>{})=>{this.streamFunctions[name]=callback};this.setStream=(object={},settings={},streamName=`stream${Math.floor(Math.random()*1e10)}`,onupdate,onclose)=>{if(settings.keys){if(settings.keys.length===0){let k=Object.keys(object);if(k.length>0){settings.keys=Array.from(k)}}}else{settings.keys=Array.from(Object.keys(object))}this.streamSettings[streamName]={object,settings,onupdate,onclose};this.subscribe("streamName",res=>{if(this.streamSettings[streamName].onupdate)this.streamSettings[streamName].onupdate(res,this.streamSettings[streamName])});settings.keys.forEach(prop=>{if(settings[prop]?.callback)this.setStreamFunc(streamName,prop,settings[prop].callback);else this.setStreamFunc(streamName,prop,settings.callback)});return this.streamSettings[streamName]};this.removeStream=(streamName,key)=>{if(streamName&&!key){if(this.streamSettings[streamName].onclose)this.streamSettings[streamName].onclose(this.streamSettings[streamName]);this.unsubscribe(streamName);delete this.streamSettings[streamName]}else if(key&&this.streamSettings[streamName]?.settings?.keys){let idx=this.streamSettings[streamName].settings.keys.indexOf(key);if(idx>-1)this.streamSettings[streamName].settings.keys.splice(idx,1);if(this.streamSettings[streamName].settings[key])delete this.streamSettings[streamName].settings[key];return true}return false};this.updateStreamData=(streamName,data={})=>{if(this.streamSettings[streamName]){Object.assign(this.streamSettings[streamName].object,data);return this.streamSettings[streamName].object}return false};this.getStreamUpdate=streamName=>{if(!this.streamSettings[streamName])return;let streamUpdate={};this.streamSettings[streamName].settings.keys.forEach(key=>{if(this.streamSettings[streamName].settings[key]){let data=this.streamSettings[streamName].settings[key].callback(this.streamSettings[streamName].object[key],this.streamSettings[streamName].settings[key]);if(data!==void 0)streamUpdate[key]=data}});this.setState({[streamName]:streamUpdate});return streamUpdate};this.getAllStreamUpdates=()=>{let updateObj={};for(const streamName in this.streamSettings){let streamUpdate=this.getStreamUpdate(streamName);Object.assign(updateObj,streamUpdate)}return updateObj};this.routes={getSessionInfo:this.getSessionInfo,openPrivateSession:this.openPrivateSession,openSharedSession:this.openSharedSession,updateSession:this.updateSession,joinSession:this.joinSession,setUserProps:this.setUserProps,leaveSession:this.leaveSession,getFirstMatch:this.getFirstMatch,swapHost:this.swapHost,deleteSession:this.deleteSession,subscribeToSession:this.subscribeToSession,transmitSessionUpdates:this.transmitSessionUpdates,receiveSessionUpdates:this.receiveSessionUpdates,getUpdatedUserData:this.getUpdatedUserData,userUpdateCheck:this.userUpdateCheck,userUpdateLoop:{operator:this.userUpdateCheck,loop:10},sessionLoop:{operator:this.sessionUpdateCheck,loop:10},setStreamFunc:this.setStreamFunc,addStreamFunc:this.addStreamFunc,setStream:this.setStream,removeStream:this.removeStream,updateStreamData:this.updateStreamData,getStreamUpdate:this.getStreamUpdate,getAllStreamUpdates:this.getAllStreamUpdates,streamLoop:{operator:this.getAllStreamUpdates,loop:10}};this.load(this.routes);if(users)this.users=users}getFirstMatch(obj1,obj2){for(const i in obj1){for(const j in obj2){if(i===j)return i}}return false}};var Router=class extends Service{constructor(options){super(options);this.name="router";this.connections={};this.sources={};this.services={};this.serviceConnections={};this.users={};this.addUser=async(info,connections,config,receiving)=>{if(!info._id){info._id=`user${Math.floor(Math.random()*1e15)}`}let user=Object.assign({},info);if(connections){for(const key in connections){if(typeof connections[key]==="object"){if(!connections[key].connection._id){await new Promise((res,rej)=>{let start=performance.now();let checker=()=>{if(!connections[key].connection._id){if(performance.now()-start>3e3){delete connections[key];rej(false)}else{setTimeout(()=>{checker()},100)}}else{res(true)}};checker()}).catch(er=>{console.error("Connections timed out:",er)})}}}for(const key in connections){connections[key]=this.addConnection(connections[key],user._id)}}if(config){for(const c in config){this.openConnection(config[c].service,config[c],user._id,config[c].args)}}let send=(message,...a)=>{let connection=this.getConnection(user._id,"send");if(connection?.send)return connection.send(message,...a)};let request=(message,method,...a)=>{let connection=this.getConnection(user._id,"request");if(connection?.request)return connection.request(message,method,...a)};let post=(route,args,method,...a)=>{let connection=this.getConnection(user._id,"post");if(connection?.post)return connection.post(route,args,method,...a)};let run=(route,args,method,...a)=>{let connection=this.getConnection(user._id,"run");if(connection?.run)return connection.run(route,args,method,...a)};let subscribe=(route,callback,...a)=>{let connection=this.getConnection(user._id,"subscribe");if(connection?.subscribe)return connection.subscribe(route,callback,...a)};let unsubscribe=(route,sub,...a)=>{let connection=this.getConnection(user._id,"unsubscribe");if(connection?.unsubscribe)return connection.unsubscribe(route,sub,...a)};let terminate=()=>{return this.removeUser(user)};user.send=send;user.request=request;user.post=post;user.run=run;user.subscribe=subscribe;user.unsubscribe=unsubscribe;user.terminate=terminate;this.users[user._id]=user;if(connections&&!receiving){let connectionIds={};let pass=false;Object.keys(connections).map((k,i)=>{if(connections[k]?._id){connectionIds[`${i}`]=connections[k]?._id;pass=true}});if(pass){user.send({route:"addUser",args:[{_id:user._id},connectionIds,void 0,true]})}}return user};this.getConnection=(sourceId,hasMethod)=>{if(this.sources[sourceId]){if(this.order){for(let i=0;i<this.order.length;i++){let k=this.order[i];for(const key in this.sources[sourceId]){if(this.sources[sourceId][key].service){if(typeof this.sources[sourceId][key].service==="object"){if(this.sources[sourceId][key].service.tag===k){if(this.sources[sourceId][key].connectionType&&this.sources[sourceId][key].service?.name){if(!this.serviceConnections[this.sources[sourceId][key].service.name]){this.removeConnection(this.sources[sourceId][key]);continue}}return this.sources[sourceId][key]}}else if(this.sources[sourceId][key].service===k){if(this.sources[sourceId][key].connectionType&&this.sources[sourceId][key].service?.name){if(!this.serviceConnections[this.sources[sourceId][key].service.name])this.removeConnection(this.sources[sourceId][key]);continue}return this.sources[sourceId][key]}}}}}else{for(const k in this.sources[sourceId]){if(this.sources[sourceId][k].connectionType&&this.sources[sourceId][k].service?.name){if(!this.serviceConnections[this.sources[sourceId][k].service.name]){this.removeConnection(this.sources[sourceId][k]);continue}}if(hasMethod&&this.sources[sourceId][k][hasMethod]){return this.sources[sourceId][k]}else{return this.sources[sourceId][k]}}}}else if(this.order){for(let i=0;i<this.order.length;i++){let k=this.order[i];if(this.sources[k]?.[sourceId]){if(this.sources[k][sourceId].connectionType&&this.sources[k][sourceId].service?.name){if(!this.serviceConnections[this.sources[k][sourceId].service.service.name]){this.removeConnection(this.sources[k][sourceId].service);continue}}if(hasMethod&&this.sources[k][sourceId]?.[hasMethod]){return this.sources[k][sourceId]}else{return this.sources[k][sourceId]}}}}if(typeof sourceId==="string"&&this.connections[sourceId]&&this.connections[sourceId].send){return this.connections[sourceId]}};this.getConnections=(sourceId,hasMethod,props)=>{if(this.sources[sourceId]){if(!props&&!hasMethod)return this.sources[sourceId];let found={};for(const key in this.sources[sourceId]){if(typeof this.sources[sourceId][key]==="object"){if(!this.sources[sourceId][key]._id){for(const k in this.sources[sourceId][key]){if(typeof this.sources[sourceId][key][k]==="object"){let pass=true;if(hasMethod&&!this.sources[sourceId][key][k][hasMethod])pass=false;for(const p in props){if(typeof this.sources[sourceId][key][k][p]==="object"&&typeof props[p]==="object"){for(const pp in props[p]){if(props[p][pp]!==this.sources[sourceId][key][k][p][pp]){pass=false;break}}}else if(this.sources[sourceId][key][k][p]!==props[p]){pass=false}else{pass=false;break}}if(pass){found[this.sources[sourceId][key][k]._id]=this.sources[sourceId][key][k]}}}}else{let pass=true;if(hasMethod&&!this.sources[sourceId][key][hasMethod])pass=false;for(const p in props){if(typeof this.sources[sourceId][key][p]==="object"&&typeof props[p]==="object"){for(const pp in props[p]){if(props[p][pp]!==this.sources[sourceId][key][p][pp]){pass=false;break}}}else if(this.sources[sourceId][key][p]!==props[p]){pass=false}else{pass=false;break}}if(pass){if(this.getConnection(this.sources[sourceId][key],hasMethod))found[this.sources[sourceId][key]._id]=this.sources[sourceId][key]}}}}}};this.addConnection=(options,source)=>{let settings={};if(typeof options==="string"){if(this.connections[options]){options=this.connections[options]}else{for(const j in this.serviceConnections){for(const k in this.serviceConnections[j]){if(this.serviceConnections[j][k][options]){options={connection:this.serviceConnections[j][k][options]};options.service=j;settings.connectionType=j;settings.connectionsKey=k;break}}}}if(typeof options==="string"&&this.nodes.get(options))options={connection:this.nodes.get(options)}}if(!options||typeof options==="string")return void 0;if(source)settings.source=source;if(options.connection instanceof GraphNode){settings.connection=options.connection;let node=settings.connection;settings.send=async message=>{if(message.method){if(Array.isArray(message.args)){return node[message.method]?.(...message.args)}else return node[message.method]?.(message.args)}else{if(Array.isArray(message.args)){return node.run(...message.args)}else return node.run(message.args)}};settings.request=async(message,method)=>{if(method){if(Array.isArray(message.args)){return node[method]?.(...message.args)}else return node[method]?.(message.args)}else{if(Array.isArray(message.args)){return node.run(...message.args)}else return node.run(message.args)}};settings.post=async(route,args,method)=>{if(route&&node.get(route)){let n=node.get(route);if(method){if(Array.isArray(args)){return n[method]?.(...args)}else return n[method]?.(args)}else{if(Array.isArray(args)){return n.run(...args)}else return n.run(args)}}else{if(method){if(Array.isArray(args)){return node[method]?.(...args)}else return node[method]?.(args)}else{if(Array.isArray(args)){return node.run(...args)}else return node.run(args)}}};settings.run=settings.post;settings.subscribe=async(route,callback)=>{return node.subscribe(callback,route)};settings.unsubscribe=async(route,sub)=>{return node.unsubscribe(sub,route)};settings.terminate=()=>{node.graph.remove(node);return true};settings.onclose=options.onclose;if(settings.onclose){let oldondelete;if(node.ondelete)oldondelete=node.ondelete;node.ondelete=n=>{if(settings.onclose)settings.onclose(settings,n);if(oldondelete)oldondelete(n)}}}else if(options.connection instanceof Graph){if(options.connection.nodes.get("open"))settings.service=options.connection;let graph=settings.connection;settings.send=async message=>{if(Array.isArray(message.args))graph.run(message.route,...message.args);else graph.run(message.route,message.args)};settings.request=async(message,method)=>{if(!message.route)return void 0;if(method){if(Array.isArray(message.args)){return graph.nodes.get(message.route)[method]?.(...message.args)}else return graph.nodes.get(message.route)[method]?.(message.args)}else{if(Array.isArray(message.args)){return graph.run(message.route,...message.args)}else return graph.run(message.route,message.args)}};settings.post=async(route,args,method)=>{if(route&&graph.get(route)){let n=graph.get(route);if(method){if(Array.isArray(args)){return n[method]?.(...args)}else return n[method]?.(args)}else{if(Array.isArray(args)){return n.run(...args)}else return n.run(args)}}};settings.run=settings.post;settings.subscribe=async(route,callback)=>{return graph.subscribe(route,callback)};settings.unsubscribe=async(route,sub)=>{return graph.unsubscribe(route,sub)};settings.terminate=n=>{graph.remove(n);return true}}else if(!(options._id&&this.connections[options._id])){let c=options.connection;if(typeof c==="string"){if(this.connections[c])c=this.connections[c];else if(options.service){if(typeof options.service==="string"){options.service=this.services[options.service]}if(typeof options.service==="object"){if(options.service.connections){for(const key in options.service.connections){if(options.service.connections[key][c]){c=options.service.connections[key][c];settings.connectionType=key;settings.connectionsKey=c;break}}}}}else{for(const j in this.serviceConnections){for(const k in this.serviceConnections[j]){if(this.serviceConnections[j][k][c]){c=this.serviceConnections[j][k][c];options.service=j;settings.connectionType=j;settings.connectionsKey=k;break}}}}}if(typeof c!=="object")return void 0;settings._id=c._id;settings.send=c.send;settings.request=c.request;settings.run=c.run;settings.post=c.post;settings.subscribe=c.subscribe;settings.unsubscribe=c.unsubscribe;settings.terminate=c.terminate;settings.onclose=options.onclose;if(settings.onclose){if(!(c.onclose&&settings.onclose.toString()===c.onclose.toString())){let oldonclose=c.onclose;c.onclose=(...args)=>{if(settings.onclose)settings.onclose(settings,...args);if(this.users[settings.source]&&Object.keys(this.sources[settings.source]).length===0){this.removeUser(settings.source,false)}if(oldonclose)oldonclose(...args)}}}else{let oldonclose=c.onclose;c.onclose=(...args)=>{this.removeConnection(settings);if(this.users[settings.source]&&Object.keys(this.sources[settings.source]).length===0){this.removeUser(settings.source,false)}if(oldonclose)oldonclose(...args)}}if(options.service){if(typeof options.service==="string")options.service=this.services[options.service];settings.service=options.service}else if(c.graph)settings.service=c.graph}if(!settings.source&&options.source){settings.source=options.source}else if(!settings.source&&options.service){settings.source=typeof options.service==="object"?options.service.name:void 0}else if(!settings.source&&(settings.connection instanceof GraphNode||settings.connection instanceof Graph)){settings.source="local";if(!this.order.indexOf("local"))this.order.unshift("local")}if(!settings._id)settings._id=`connection${Math.floor(Math.random()*1e15)}`;if(settings.source){if(!this.sources[settings.source])this.sources[settings.source]={};this.sources[settings.source][settings._id]=settings}if(!this.connections[settings._id])this.connections[settings._id]=settings;return settings};this.removeConnection=(connection,terminate=false)=>{if(typeof connection==="object"&&connection._id)connection=connection._id;if(typeof connection==="string"){if(this.connections[connection]){if(terminate&&this.connections[connection])this.connections[connection].terminate();delete this.connections[connection];for(const key in this.sources){if(this.sources[key][connection])delete this.sources[key][connection];else{for(const k in this.sources[key]){if(this.sources[key][k]?.[connection]){delete this.sources[key][connection]}}}}return true}else if(this.sources[connection]){for(const key in this.sources[connection]){this.removeConnection(this.sources[connection][key],terminate)}return true}}};this.addService=(service,connections,includeClassName,routeFormat,syncServices,source,order)=>{this.load(service,includeClassName,routeFormat,this.customRoutes,this.customChildren);this.services[service.name]=service;if(connections){if(typeof connections==="string")this.addServiceConnections(service,connections,source);else{for(const c in connections){this.addServiceConnections(service,c,source)}}}if(syncServices)this.syncServices();if(order)this.order=order;else{if(!this.order)this.order=[];this.order.push(service.name)}};this.addServiceConnections=(service,connectionsKey,source)=>{if(typeof service==="string"){service=this.services[service]}if(connectionsKey&&service[connectionsKey]){let newConnections={};if(!this.serviceConnections[service.name])this.serviceConnections[service.name]={};this.serviceConnections[service.name][connectionsKey]=service[connectionsKey];for(const key in service[connectionsKey]){if(!this.connections[key]){newConnections[key]=this.addConnection({connection:service[connectionsKey][key],service},source);newConnections[key].connectionType=connectionsKey}}return newConnections}};this.openConnection=async(service,options,source,...args)=>{if(typeof service==="string"){service=this.services[service]}if(service instanceof Service){let connection=service.run("open",options,...args);if(connection instanceof Promise){return connection.then(async info=>{if(!info._id){await new Promise((res,rej)=>{let start=performance.now();let checker=()=>{if(!info._id){if(performance.now()-start>3e3){rej(false)}else{setTimeout(()=>{checker()},100)}}else{res(true)}};checker()}).catch(er=>{console.error("Connections timed out:",er)})}if(info._id)this.addConnection({connection:info,service},source)})}else if(connection){if(!connection._id){await new Promise((res,rej)=>{let start=performance.now();let checker=()=>{if(!connection._id){if(performance.now()-start>3e3){rej(false)}else{setTimeout(()=>{checker()},100)}}else{res(true)}};checker()}).catch(er=>{console.error("Connections timed out:",er)})}if(connection._id)return this.addConnection({connection,service},source)}}};this.terminate=connection=>{if(typeof connection==="string")connection=this.connections[connection];return connection.terminate()};this.subscribeThroughConnection=(route,relay,endpoint,callback,...args)=>{if(typeof relay==="string"){relay=this.getConnection(relay,"run")}if(typeof relay==="object")return new Promise((res,rej)=>{relay.run("routeConnections",[route,endpoint,relay._id,...args]).then(sub=>{this.subscribe(endpoint,res2=>{if(res2?.callbackId===route){if(!callback)this.setState({[endpoint]:res2.args});else if(typeof callback==="string"){this.setState({[callback]:res2.args})}else callback(res2.args)}});res(sub)}).catch(rej)})};this.routeConnections=(route,transmitter,receiver,...args)=>{let rxsrc;if(typeof receiver==="string"){if(this.sources[receiver]){rxsrc=receiver}receiver=this.getConnection(receiver,"send")}if(typeof transmitter==="string"){transmitter=this.getConnection(transmitter,"subscribe")}if(transmitter?.subscribe&&receiver?.send){let res=new Promise((res2,rej)=>{transmitter.subscribe(route,transmitter._id,res3=>{if(!this.connections[receiver._id]&&rxsrc){if(this.sources[rxsrc]){rxsrc=receiver;Object.keys(this.sources[rxsrc]).forEach(k=>{if(this.sources[receiver][k].send){receiver=this.sources[receiver][k]}})}}if(this.connections[receiver._id])receiver.send({callbackId:route,args:res3})},...args).then(sub=>{res2(sub)})});return res}};this.syncServices=()=>{for(const name in this.services){if("users"in this.services[name])this.services[name].users=this.users;this.nodes.forEach((n,tag)=>{if(!this.services[name].nodes.get(n.tag)){this.services[name].nodes.set(n.tag,n)}else{if(!this.services[name].nodes.get(tag)&&n._UNIQUE!==this.services[name].nodes.get(n.tag)._UNIQUE)this.services[name].nodes.set(tag,n)}})}};this.setUserData=(user,data)=>{if(user){if(typeof user==="string"){user=this.users[user];if(!user)return false}}if(data){if(typeof data==="string"){data=JSON.parse(data)}}if(typeof data==="object"){this.recursivelyAssign(user,data);return true}};this.routes={addUser:this.addUser,removeUser:this.removeUser,getConnection:this.getConnection,addConnection:this.addConnection,removeConnection:this.removeConnection,addService:this.addService,addServiceConnections:this.addServiceConnections,openConnection:this.openConnection,terminate:this.terminate,routeConnections:this.routeConnections,subscribeThroughConnection:this.subscribeThroughConnection,syncServices:this.syncServices};this.load(this.routes);if(options){if(options.order)this.order=options.order;if(options.services){for(const key in options.services){let opt=options.services[key];if(opt instanceof Service){opt.service.name=key;opt.service.tag=key;this.addService(opt.service,opt.connections,options.includeClassName,options.routeFormat,options.syncServices)}else if(typeof opt==="function"){let service=new opt;service.name=key;service.tag=key;if(service)this.addService(service,service.connections,options.includeClassName,options.routeFormat,options.syncServices)}else{if(typeof opt.service==="function"){let service=new opt.service({name:key});service.name=key;service.tag=key;if(service)this.addService(service,void 0,options.includeClassName,options.routeFormat,options.syncServices);opt.service=service}else if(opt.service instanceof Service){opt.service.name=key;opt.service.tag=key;this.addService(opt.service,void 0,options.includeClassName,options.routeFormat,options.syncServices)}if(typeof opt.service==="object"){if(opt.connections){if(Array.isArray(opt.connections)){opt.connections.forEach(k=>{this.addServiceConnections(opt[key].service,k)})}else this.addServiceConnections(opt.service,opt.connections)}if(opt.config){for(const c in opt.config){this.openConnection(opt.service,opt.config[c],opt.config[c].source,opt.config[c].args)}}}}}}}}removeUser(profile,terminate){if(terminate)this.removeConnection(profile,terminate);if(typeof profile==="string")profile=this.users[profile];if(typeof profile==="object"&&profile._id){delete this.users[profile._id];if(profile.onclose)profile.onclose(profile)}return true}};})();
